<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>LeetCode 0054. èºæ—‹çŸ©é˜µ</title>
    <url>/posts/fcfca138/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>æŒ‰å±‚ä»å¤–åˆ°å†…ä¾æ¬¡å¤„ç†çŸ©é˜µ</li>
</ul>
</blockquote>
<a id="more"></a>
<p>ç»™å®šä¸€ä¸ªåŒ…å«Â m x nÂ ä¸ªå…ƒç´ çš„çŸ©é˜µï¼Œè¯·æŒ‰ç…§é¡ºæ—¶é’ˆèºæ—‹é¡ºåºï¼Œè¿”å›çŸ©é˜µä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚</p>
<p>ç¤ºä¾‹Â 1:<br>
è¾“å…¥:<br>
[<br>
[ 1, 2, 3 ],<br>
[ 4, 5, 6 ],<br>
[ 7, 8, 9 ]<br>
]<br>
è¾“å‡º: [1,2,3,6,9,8,7,4,5]</p>
<p>ç¤ºä¾‹Â 2:<br>
è¾“å…¥:<br>
[<br>
[1, 2, 3, 4],<br>
[5, 6, 7, 8],<br>
[9,10,11,12]<br>
]<br>
è¾“å‡º: [1,2,3,4,8,12,11,10,9,5,6,7]</p>
<p>æ€è·¯ä¸€ï¼š<br>
æ¯”è¾ƒæµ…æ˜¾æ˜“æ‡‚çš„æ€è·¯ï¼Œä»å¤–åˆ°å†…ä¸€åœˆä¸€åœˆå¤„ç†ï¼Œæ¯æ¬¡å¤„ç†å®Œä¸€åœˆéƒ½å°†å·¦ä¸Šè§’åæ ‡åŠ ä¸€ï¼Œå³ä¸‹è§’åæ ‡å‡ä¸€ï¼Œå½“å·¦ä¸Šè§’çš„åæ ‡å¤§äºå³ä¸‹è§’çš„åæ ‡æ—¶ï¼Œè¯´æ˜çŸ©é˜µä¸­çš„å…ƒç´ å·²ç»å…¨éƒ¨å¤„ç†å®Œæˆäº†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">spiralOrder</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt;&amp; matrix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (matrix.<span class="built_in">size</span>() == <span class="number">0</span> || matrix[<span class="number">0</span>].<span class="built_in">size</span>() == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">        <span class="keyword">int</span> tR = <span class="number">0</span>, tC = <span class="number">0</span>, dR = matrix.<span class="built_in">size</span>() - <span class="number">1</span>, dC = matrix[<span class="number">0</span>].<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (tR &lt;= dR &amp;&amp; tC &lt;= dC) &#123;</span><br><span class="line">            <span class="built_in">process</span>(matrix, tR++, tC++, dR--, dC--);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt;&amp; matrix, <span class="keyword">int</span> tR, <span class="keyword">int</span> tC, <span class="keyword">int</span> dR, <span class="keyword">int</span> dC)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (tR == dR) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = tC; i &lt;= dC; ++i) &#123;</span><br><span class="line">                res.push_back(matrix[tR][i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tC == dC) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = tR; i &lt;= dR; ++i) &#123;</span><br><span class="line">                res.push_back(matrix[i][tC]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> curC = tC, curR = tR;</span><br><span class="line">            <span class="keyword">while</span> (curC != dC) &#123;</span><br><span class="line">                res.push_back(matrix[tR][curC++]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (curR != dR) &#123;</span><br><span class="line">                res.push_back(matrix[curR++][dC]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (curC != tC) &#123;</span><br><span class="line">                res.push_back(matrix[dR][curC--]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (curR != tR) &#123;</span><br><span class="line">                res.push_back(matrix[curR--][tC]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; res;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
        <tag>Array</tag>
      </tags>
  </entry>
  <entry>
    <title>LeetCode 0238. é™¤è‡ªèº«ä»¥å¤–æ•°ç»„çš„ä¹˜ç§¯</title>
    <url>/posts/cc86ed49/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>å‰ç¼€ç§¯ä¸åç¼€ç§¯</li>
<li>å¤ç”¨è¾“å‡ºæ•°ç»„ä»¥ä¿è¯ O(1) é¢å¤–ç©ºé—´å¤æ‚åº¦</li>
</ul>
</blockquote>
<a id="more"></a>
<p>ç»™ä½ ä¸€ä¸ªé•¿åº¦ä¸ºÂ nÂ çš„æ•´æ•°æ•°ç»„Â numsï¼Œå…¶ä¸­Â n &gt; 1ï¼Œè¿”å›è¾“å‡ºæ•°ç»„Â outputï¼Œå…¶ä¸­ output[i]Â ç­‰äºÂ numsÂ ä¸­é™¤Â nums[i]Â ä¹‹å¤–å…¶ä½™å„å…ƒç´ çš„ä¹˜ç§¯ã€‚</p>
<p>ç¤ºä¾‹:<br>
è¾“å…¥: [1,2,3,4]<br>
è¾“å‡º: [24,12,8,6]<br>
æç¤ºï¼šé¢˜ç›®æ•°æ®ä¿è¯æ•°ç»„ä¹‹ä¸­ä»»æ„å…ƒç´ çš„å…¨éƒ¨å‰ç¼€å…ƒç´ å’Œåç¼€ï¼ˆç”šè‡³æ˜¯æ•´ä¸ªæ•°ç»„ï¼‰çš„ä¹˜ç§¯éƒ½åœ¨ 32 ä½æ•´æ•°èŒƒå›´å†…ã€‚<br>
è¯´æ˜: è¯·ä¸è¦ä½¿ç”¨é™¤æ³•ï¼Œä¸”åœ¨Â O(n) æ—¶é—´å¤æ‚åº¦ä¸å¸¸æ•°ç©ºé—´å¤æ‚åº¦å†…å®Œæˆæ­¤é¢˜ã€‚</p>
<p>æ€è·¯ä¸€ï¼š<br>
æ•°ç»„ä¸­é™¤æ‰æŸä¸€ä¸ªæ•°åå…¶ä»–æ•°çš„ä¹˜ç§¯å…¶å®å°±ç›¸å½“äºè¯¥æ•°å·¦è¾¹å­æ•°ç»„çš„ä¹˜ç§¯ä¹˜ä»¥å³è¾¹å­æ•°ç»„çš„ä¹˜ç§¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸¤ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«ä¿å­˜ä»å·¦è‡³å³å’Œä»å³è‡³å·¦ä¸¤æ¬¡éå†è®¡ç®—çš„å…ƒç´ ä¹˜ç§¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ•°ç»„ arr ä¸­çš„æŸä¸€ä¸ªå…ƒç´  arr[i] æ¥è¯´ï¼Œleft[i] ç­‰äºä» arr[0] ä¸€ç›´ä¹˜åˆ° arr[i - 1] çš„ç§¯ï¼Œright[i] ç­‰äºä» arr[n] ä¸€ç›´ä¹˜åˆ° arr[i + 1] çš„ç§¯ï¼Œé‚£ä¹ˆ res[i] å…¶å®å°±ç­‰äº left[i] * right[i]ã€‚<br>
è¿›ä¸€æ­¥ï¼Œå› ä¸ºè®¡ç®— left å’Œ right æ•°ç»„æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¤ç”¨ res æ•°ç»„ï¼š<br>
å°† left æ•°ç»„ç›´æ¥æ”¾å…¥ res æ•°ç»„ä¸­ï¼Œé‚£ä¹ˆ res[i] è¡¨ç¤ºçš„å…¶å®å°±æ˜¯ arr æ•°ç»„ä¸­ç¬¬ i ä¸ªå…ƒç´ ä¹‹å‰æ‰€æœ‰å…ƒç´ çš„ä¹˜ç§¯ï¼Œè®¡ç®—å®Œä¹‹åï¼Œæˆ‘ä»¬å†åœ¨ res æ•°ç»„ä¸Šç›´æ¥è®¡ç®—ç»“æœï¼Œå‡è®¾å˜é‡ right = 1ï¼Œå®ƒçš„å«ä¹‰å°±æ˜¯ä¸Šé¢è¯´çš„ right æ•°ç»„ä¸­å½“å‰å…ƒç´ çš„å€¼ï¼Œé‚£ä¹ˆä» res[n] å¼€å§‹ï¼Œä¾æ¬¡å°† right çš„å€¼ä¹˜å…¥ res æ•°ç»„ä¸­ï¼Œæœ€åå¾—åˆ°çš„ res å³ä¸ºæ‰€æ±‚ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">productExceptSelf</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">res</span><span class="params">(nums.<span class="built_in">size</span>(), <span class="number">0</span>)</span></span>;</span><br><span class="line">        res[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; nums.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">            res[i] = res[i - <span class="number">1</span>] * nums[i - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> right = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = nums.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            res[i] = res[i] * right;</span><br><span class="line">            right *= nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
        <tag>Array</tag>
      </tags>
  </entry>
  <entry>
    <title>LeetCode 0837. æ–° 21 ç‚¹</title>
    <url>/posts/3da3e5d5/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>ä»åå‘å‰åå‘é€’æ¨çš„åŠ¨æ€è§„åˆ’</li>
</ul>
</blockquote>
<a id="more"></a>
<p>çˆ±ä¸½ä¸å‚ä¸ä¸€ä¸ªå¤§è‡´åŸºäºçº¸ç‰Œæ¸¸æˆ â€œ21ç‚¹â€ è§„åˆ™çš„æ¸¸æˆï¼Œæè¿°å¦‚ä¸‹ï¼š<br>
çˆ±ä¸½ä¸ä»¥ 0 åˆ†å¼€å§‹ï¼Œå¹¶åœ¨å¥¹çš„å¾—åˆ†å°‘äº K åˆ†æ—¶æŠ½å–æ•°å­—ã€‚æŠ½å–æ—¶ï¼Œå¥¹ä» [1, W] çš„èŒƒå›´ä¸­éšæœºè·å¾—ä¸€ä¸ªæ•´æ•°ä½œä¸ºåˆ†æ•°è¿›è¡Œç´¯è®¡ï¼Œå…¶ä¸­ W æ˜¯æ•´æ•°ã€‚ æ¯æ¬¡æŠ½å–éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå…¶ç»“æœå…·æœ‰ç›¸åŒçš„æ¦‚ç‡ã€‚<br>
å½“çˆ±ä¸½ä¸è·å¾—ä¸å°‘äº K åˆ†æ—¶ï¼Œå¥¹å°±åœæ­¢æŠ½å–æ•°å­—ã€‚æ±‚çˆ±ä¸½ä¸çš„åˆ†æ•°ä¸è¶…è¿‡ N çš„æ¦‚ç‡æ˜¯å¤šå°‘ã€‚</p>
<p>ç¤ºä¾‹ 1ï¼š<br>
è¾“å…¥ï¼šN = 10, K = 1, W = 10<br>
è¾“å‡ºï¼š1.00000<br>
è¯´æ˜ï¼šçˆ±ä¸½ä¸å¾—åˆ°ä¸€å¼ å¡ï¼Œç„¶ååœæ­¢ã€‚</p>
<p>ç¤ºä¾‹ 2ï¼š<br>
è¾“å…¥ï¼šN = 6, K = 1, W = 10<br>
è¾“å‡ºï¼š0.60000<br>
è¯´æ˜ï¼šçˆ±ä¸½ä¸å¾—åˆ°ä¸€å¼ å¡ï¼Œç„¶ååœæ­¢ã€‚åœ¨ W = 10 çš„ 6 ç§å¯èƒ½ä¸‹ï¼Œå¥¹çš„å¾—åˆ†ä¸è¶…è¿‡ N = 6 åˆ†ã€‚</p>
<p>ç¤ºä¾‹ 3ï¼š<br>
è¾“å…¥ï¼šN = 21, K = 17, W = 10<br>
è¾“å‡ºï¼š0.73278</p>
<p>æ€è·¯ä¸€ï¼šåŠ¨æ€è§„åˆ’<br>
é¦–å…ˆï¼ŒæŠ½å¡èƒ½è·å¾—çš„æœ€å¤§ç‚¹æ•°ä¸º K - 1 + Wï¼Œå¼€å§‹çš„æ—¶å€™ç‚¹æ•°ä¸º 0ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªå¤§å°ä¸º K + W çš„æ•°ç»„æ¥è¡¨ç¤ºæ•´ä¸ªæŠ½å¡è¿‡ç¨‹ä¸­æ‰€æœ‰çš„å¯èƒ½å€¼ã€‚æ•°ç»„ä¸‹æ ‡ä¸ºç‚¹æ•°ï¼Œé‡Œé¢ä¿å­˜çš„æ˜¯å¯¹åº”ç‚¹æ•°æ—¶ä¸è¶…è¿‡ N çš„æ¦‚ç‡ã€‚<br>
æˆ‘ä»¬å‡è®¾å½“å‰ç‚¹æ•°ä¸º iï¼Œé‚£ä¹ˆ dp[i] çš„å€¼å…¶å®å’Œä¸‹ä¸€æ¬¡æŠ½åˆ°çš„ç‚¹æ•°æœ‰å…³ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ª dp æ•°ç»„çš„æ›´æ–°æ–¹å‘åº”è¯¥æ˜¯ä»åå‘å‰çš„ï¼Œæˆ‘ä»¬å‡è®¾ä¸‹ä¸€æ¬¡æŠ½åˆ°çš„ç‚¹æ•°ä¸º jï¼ŒæŠ½åˆ°è¿™ä¸ªç‚¹æ•°çš„æ¦‚ç‡ä¸º 1/Wï¼Œé‚£ä¹ˆæ­¤æ—¶å¯¹åº”çš„ä¸è¶…è¿‡ N çš„æ¦‚ç‡åº”è¯¥ä¸º 1/W * dp[i + j]ï¼Œj çš„å–å€¼èŒƒå›´ä¸º 1 åˆ° Wï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥çŸ¥é“ dp[i] = 1/W * (dp[i + 1] + â€¦ + dp[i + W])ã€‚<br>
å½“å‰ç‚¹æ•°å¤§äº K - 1 æ—¶ï¼Œä¸å†æŠ½å¡ï¼Œé‚£ä¹ˆä» dp[K] ä¸€ç›´åˆ° dp[K + W - 1]ï¼Œå¦‚æœ K &lt;= Nï¼Œå¯¹åº”çš„ dp[K] = 1.0ï¼Œå¦åˆ™å°±ç­‰äº 0ï¼Œä»åé¢ä¸€ç›´é€’æ¨åˆ° dp[0]ï¼Œå°±æ˜¯ä¸è¶…è¿‡ N çš„æ¦‚ç‡ã€‚<br>
æ­¤å¤–ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸ªç‰¹æ®Šçš„åˆå§‹æ¡ä»¶ï¼Œç”±ä¸Šé¢çš„åˆ†æå¯ä»¥æ¨å‡ºï¼Œå¦‚æœè¾¾åˆ°äº†æœ€å¤§å€¼ K - 1ï¼Œå†æŠ½ä¸€ä¸ªæœ€å¤§å€¼ Wï¼Œæ­¤æ—¶ K + W - 1 ä»ç„¶ä¸¥æ ¼å°äº Nï¼Œé‚£ä¹ˆå¯ä»¥åˆ¤æ–­æ— è®ºæ€ä¹ˆæŠ½ï¼Œåˆ†æ•°éƒ½ä¸å¯èƒ½è¶…è¿‡ Nï¼Œæ¦‚ç‡å°±ä¸º 1ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">new21Game</span><span class="params">(<span class="keyword">int</span> N, <span class="keyword">int</span> K, <span class="keyword">int</span> W)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (K == <span class="number">0</span> || K + W &lt;= N) <span class="keyword">return</span> <span class="number">1.0</span>;</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">double</span>&gt; <span class="title">dp</span><span class="params">(K + W + <span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = K; i &lt;= N &amp;&amp; i &lt;= K + W; ++i) &#123;</span><br><span class="line">            dp[i] = <span class="number">1.0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">double</span> pr = <span class="number">1.0</span> / W;</span><br><span class="line">        dp[K - <span class="number">1</span>] = (N - K + <span class="number">1</span>) * pr;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = K - <span class="number">2</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="comment">// dp[i] = dp[i + 1] - 1/w * dp[i + 1 + w] + 1/w * dp[i + 1]</span></span><br><span class="line">            dp[i] = dp[i + <span class="number">1</span>] - pr * (dp[i + W + <span class="number">1</span>] - dp[i + <span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
        <tag>Dynamic-Programming</tag>
      </tags>
  </entry>
  <entry>
    <title>LCOF 064. æ±‚ 1+2+...+n</title>
    <url>/posts/5559b584/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>é€šè¿‡é€»è¾‘è¿ç®—ç¬¦çŸ­è·¯æ¥è®¾ç½®é€’å½’ç»ˆæ­¢æ¡ä»¶</li>
</ul>
</blockquote>
<a id="more"></a>
<p>æ±‚ 1+2+â€¦+nï¼Œè¦æ±‚ä¸èƒ½ä½¿ç”¨ä¹˜é™¤æ³•ã€forã€whileã€ifã€elseã€switchã€case ç­‰å…³é”®å­—åŠæ¡ä»¶åˆ¤æ–­è¯­å¥ï¼ˆA?B:Cï¼‰ã€‚</p>
<p>ç¤ºä¾‹ 1ï¼š<br>
è¾“å…¥: n = 3<br>
è¾“å‡º:Â 6</p>
<p>ç¤ºä¾‹ 2ï¼š<br>
è¾“å…¥: n = 9<br>
è¾“å‡º:Â 45</p>
<p>æ€è·¯ä¸€ï¼š<br>
è¿™ç§å åŠ æ±‚å’Œã€æ±‚ç§¯çš„é¢˜ç›®å¾ˆå®¹æ˜“æƒ³åˆ°ç”¨é€’å½’æ¥å¤„ç†ï¼Œå› ä¸ºä¸èƒ½ä½¿ç”¨ if æ¡ä»¶åˆ¤æ–­ï¼Œé‚£ä¹ˆé€’å½’ç»“æŸå¯ä»¥ç”¨ &amp;&amp; çŸ­è·¯æ¥åˆ¤æ–­ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sumNums</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        n &amp;&amp; (n += sumNums(n - <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
        <tag>Recursion</tag>
      </tags>
  </entry>
  <entry>
    <title>LeetCode 1431. æ‹¥æœ‰æœ€å¤šç³–æœçš„å­©å­</title>
    <url>/posts/d68966ad/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>å„¿ç«¥èŠ‚å¿«ä¹ï¼ï¼ï¼</li>
</ul>
</blockquote>
<a id="more"></a>
<p>ç»™ä½ ä¸€ä¸ªæ•°ç»„Â candiesÂ å’Œä¸€ä¸ªæ•´æ•°Â extraCandiesï¼Œå…¶ä¸­Â candies[i]Â ä»£è¡¨ç¬¬ i ä¸ªå­©å­æ‹¥æœ‰çš„ç³–æœæ•°ç›®ã€‚<br>
å¯¹æ¯ä¸€ä¸ªå­©å­ï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ç§æ–¹æ¡ˆï¼Œå°†é¢å¤–çš„Â extraCandiesÂ ä¸ªç³–æœåˆ†é…ç»™å­©å­ä»¬ä¹‹åï¼Œæ­¤å­©å­æœ‰æœ€å¤šçš„ç³–æœã€‚æ³¨æ„ï¼Œå…è®¸æœ‰å¤šä¸ªå­©å­åŒæ—¶æ‹¥æœ‰æœ€å¤šçš„ç³–æœæ•°ç›®ã€‚</p>
<p>ç¤ºä¾‹ 1ï¼š<br>
è¾“å…¥ï¼šcandies = [2,3,5,1,3], extraCandies = 3<br>
è¾“å‡ºï¼š[true,true,true,false,true]</p>
<p>ç¤ºä¾‹ 2ï¼š<br>
è¾“å…¥ï¼šcandies = [4,2,1,1,2], extraCandies = 1<br>
è¾“å‡ºï¼š[true,false,false,false,false]</p>
<p>ç¤ºä¾‹ 3ï¼š<br>
è¾“å…¥ï¼šcandies = [12,1,12], extraCandies = 10<br>
è¾“å‡ºï¼š[true,false,true]</p>
<p>æ€è·¯ä¸€ï¼šéå†æšä¸¾<br>
éå†æ•°ç»„ï¼Œæ‰¾åˆ°æœ€å¤šçš„ç³–æœæ•°é‡ï¼Œå†éå†ä¸€éå°±å¥½ï¼›<br>
æ­£å¦‚ LeetCode å®˜æ–¹è¯´çš„ï¼Œä¸€èµ·åœ¨åšé¢˜ä¸­æ‰¾å›ã€Œç®€å•ã€çš„å¿«ä¹ï¼›<br>
å¤§æœ‹å‹å°æœ‹å‹ä»¬ï¼Œå„¿ç«¥èŠ‚å¿«ä¹ğŸ˜‰</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt; <span class="title">kidsWithCandies</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; candies, <span class="keyword">int</span> extraCandies)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> candyNum = candies.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">int</span> mostCandy = *<span class="built_in">std</span>::max_element(candies.<span class="built_in">begin</span>(), candies.<span class="built_in">end</span>());</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">bool</span>&gt; res;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; item : candies) &#123;</span><br><span class="line">            <span class="keyword">if</span> (item + extraCandies &gt;= mostCandy) &#123;</span><br><span class="line">                res.push_back(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                res.push_back(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
        <tag>Array</tag>
      </tags>
  </entry>
  <entry>
    <title>LeetCode 101. å¯¹ç§°äºŒå‰æ ‘</title>
    <url>/posts/3c1e41f/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>æ·±åº¦ä¼˜å…ˆéå†</li>
<li>å¹¿åº¦ä¼˜å…ˆéå†</li>
</ul>
</blockquote>
<a id="more"></a>
<p>ç»™å®šä¸€ä¸ªäºŒå‰æ ‘ï¼Œæ£€æŸ¥å®ƒæ˜¯å¦æ˜¯é•œåƒå¯¹ç§°çš„ã€‚<br>
ä¾‹å¦‚ï¼ŒäºŒå‰æ ‘Â [1,2,2,3,4,4,3] æ˜¯å¯¹ç§°çš„ï¼Œ<br>
è€ŒÂ [1,2,2,null,3,null,3] åˆ™ä¸æ˜¯é•œåƒå¯¹ç§°çš„ã€‚</p>
<p>æ€è·¯ä¸€ï¼šæ·±åº¦ä¼˜å…ˆéå†<br>
å¦‚æœä¸€ä¸ªæ ‘çš„å·¦å­æ ‘ä¸å³å­æ ‘æ˜¯å¯¹ç§°çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ ‘å°±æ˜¯é•œåƒå¯¹ç§°çš„ï¼›<br>
ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸¤ä¸ªå­æ ‘æ ¹èŠ‚ç‚¹å€¼ç›¸ç­‰ï¼Œå¹¶ä¸”æ¯ä¸ªç»“ç‚¹å·¦å­æ ‘ä¸å¦ä¸€ä¸ªç»“ç‚¹å³å­æ ‘å¯¹ç§°ï¼Œä¸¤æ£µæ ‘å°±æ˜¯é•œåƒå¯¹ç§°çš„ï¼Œæˆ‘ä»¬è®©ä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«ä»å·¦å³å­æ ‘çš„ç›¸åŒç»“ç‚¹å‡ºå‘ï¼Œå¯¹ç§°éå†ï¼Œå¦‚æœå¯¹åº”ç»“ç‚¹å€¼ç›¸ç­‰ï¼Œå†å°†æŒ‡é’ˆåˆ†åˆ«å‘å·¦å³å¯¹ç§°ç§»åŠ¨ã€‚<br>
æ—¶é—´å¤æ‚åº¦ï¼šç”±äºéœ€è¦éå†æ•´æ£µæ ‘ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚<br>
ç©ºé—´å¤æ‚åº¦ï¼šé€’å½’éœ€è¦é¢å¤–ä½¿ç”¨ç©ºé—´ä¸º O(n) çš„é€’å½’æ ˆã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TreeNode</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    TreeNode *left;</span><br><span class="line">    TreeNode *right;</span><br><span class="line">    TreeNode(<span class="keyword">int</span> x) : val(x), left(<span class="literal">nullptr</span>), right(<span class="literal">nullptr</span>) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isSymmetric</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!root)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> isMirror(root-&gt;left, root-&gt;right);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isMirror</span><span class="params">(TreeNode* leftChild, TreeNode* rightChild)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!leftChild &amp;&amp; !rightChild) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!leftChild || !rightChild) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (leftChild-&gt;val == rightChild-&gt;val) &#123;</span><br><span class="line">            <span class="keyword">return</span> isMirror(leftChild-&gt;left, rightChild-&gt;right) &amp;&amp; isMirror(leftChild-&gt;right, rightChild-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ€è·¯äºŒï¼šå¹¿åº¦ä¼˜å…ˆéå†<br>
æ€è·¯ä¸€ä¸­çš„é€’å½’å¯ä»¥æ”¹å†™ä¸ºè¿­ä»£çš„æ–¹æ³•ï¼Œè¿­ä»£éœ€è¦ä½¿ç”¨ä¸€ä¸ªé˜Ÿåˆ— nodeQueueï¼Œæ¯æ¬¡éœ€è¦å‡ºé˜Ÿä¸¤ä¸ªç»“ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨å…¥é˜Ÿçš„æ—¶å€™å°±éœ€è¦å°†é•œåƒå¯¹åº”çš„ç»“ç‚¹ä¾æ¬¡å…¥é˜Ÿï¼›ä¹Ÿå°±æ˜¯å½“å‰å‡ºé˜Ÿç»“ç‚¹çš„ a çš„å·¦å­èŠ‚ç‚¹å’Œ b çš„å³å­èŠ‚ç‚¹ã€‚<br>
æ—¶é—´å¤æ‚åº¦ï¼šæ¯ä¸ªç»“ç‚¹éƒ½éœ€è¦éå†ä¸€æ¬¡ï¼Œä¸º O(n)ã€‚<br>
ç©ºé—´å¤æ‚åº¦ï¼šéœ€è¦ç”¨é˜Ÿåˆ—æ¥ç»´æŠ¤èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ€å¤šè¿›é˜Ÿä¸€æ¬¡ï¼Œå‡ºé˜Ÿä¸€æ¬¡ï¼Œç©ºé—´å¤æ‚åº¦ä¸º O(n)ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">TreeNode</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    TreeNode *left;</span><br><span class="line">    TreeNode *right;</span><br><span class="line">    TreeNode(<span class="keyword">int</span> x) : val(x), left(<span class="literal">nullptr</span>), right(<span class="literal">nullptr</span>) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isSymmetric</span><span class="params">(TreeNode* root)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">queue</span>&lt;TreeNode*&gt; nodeQueue;</span><br><span class="line">        nodeQueue.push(root-&gt;left);</span><br><span class="line">        nodeQueue.push(root-&gt;right);</span><br><span class="line">        <span class="keyword">while</span>(!nodeQueue.empty()) &#123;</span><br><span class="line">            <span class="keyword">auto</span> node1 = nodeQueue.front();</span><br><span class="line">            nodeQueue.pop();</span><br><span class="line">            <span class="keyword">auto</span> node2 = nodeQueue.front();</span><br><span class="line">            nodeQueue.pop();</span><br><span class="line">            <span class="keyword">if</span> (!node1 &amp;&amp; !node2) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!node1 || !node2) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (node1-&gt;val != node2-&gt;val) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            nodeQueue.push(node1-&gt;left);</span><br><span class="line">            nodeQueue.push(node2-&gt;right);</span><br><span class="line">            nodeQueue.push(node1-&gt;right);</span><br><span class="line">            nodeQueue.push(node2-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
        <tag>Binary-Tree</tag>
        <tag>DFS</tag>
        <tag>BFS</tag>
      </tags>
  </entry>
  <entry>
    <title>æµ…æ Linux å†…æ ¸ï¼šconnect ä¸ä¸‰æ¬¡æ¡æ‰‹</title>
    <url>/posts/4bc0bb9f/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>å‰–æ connect ç³»ç»Ÿè°ƒç”¨çš„å†…æ ¸å®ç°</li>
<li>å‰–æå†…æ ¸ç½‘ç»œåè®®æ ˆä¸­ä¸‰æ¬¡æ¡æ‰‹çš„ç»†èŠ‚</li>
</ul>
</blockquote>
<a id="more"></a>
<p>å‰ä¸€ç¯‡æ–‡ç« æåˆ°äº† socket çš„åˆ›å»ºä¸ä½¿ç”¨ï¼Œè¿™ç¯‡æ¥ç€ä¸Šä¸€ç¯‡æ¥è°ˆè°ˆ connect ç³»ç»Ÿè°ƒç”¨ä¸å†…æ ¸ç½‘ç»œåè®®æ ˆä¸­çš„ä¸‰æ¬¡æ¡æ‰‹ã€‚<br>
ä¸‰æ¬¡æ¡æ‰‹ä¸€èˆ¬æ˜¯ç”±å®¢æˆ·ç«¯è°ƒç”¨ connect å‘èµ·çš„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE3(connect, <span class="keyword">int</span>, fd, struct sockaddr __user *, uservaddr, <span class="keyword">int</span>, addrlen) &#123;</span><br><span class="line">    <span class="keyword">return</span> __sys_connect(fd, uservaddr, addrlen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __sys_connect(<span class="keyword">int</span> fd, struct sockaddr __user *uservaddr, <span class="keyword">int</span> addrlen) &#123;</span><br><span class="line">    <span class="keyword">int</span> ret = -EBADF;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– fd å¯¹åº”çš„ struct file</span></span><br><span class="line">    f = fdget(fd);</span><br><span class="line">    <span class="keyword">if</span> (f.file) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">address</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†åœ°å€æ‹·è´åˆ°å†…æ ¸ç©ºé—´</span></span><br><span class="line">        ret = move_addr_to_kernel(uservaddr, addrlen, &amp;address);</span><br><span class="line">        <span class="keyword">if</span> (!ret)</span><br><span class="line">            ret = __sys_connect_file(f.file, &amp;address, addrlen, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (f.flags)</span><br><span class="line">            fput(f.file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __sys_connect_file(struct file *file, struct sockaddr_storage *address, <span class="keyword">int</span> addrlen, <span class="keyword">int</span> file_flags) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä» struct file çš„ private_data ä¸­è·å– struct socket</span></span><br><span class="line">    sock = sock_from_file(file, &amp;err);</span><br><span class="line">    <span class="keyword">if</span> (!sock)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œç›´æ¥è¿”å›çš„æ˜¯ 0, è¿˜ä¸çŸ¥é“æœ‰ä»€ä¹ˆä½œç”¨</span></span><br><span class="line">    err = security_socket_connect(sock, (struct sockaddr *)address, addrlen);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨çš„æ˜¯ inet_stream_ops ä¸­çš„ inet_stream_connect</span></span><br><span class="line">    err = sock-&gt;ops-&gt;connect(sock, (struct sockaddr *)address, addrlen, sock-&gt;file-&gt;f_flags | file_flags);</span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœçœ‹äº†ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œè¿™é‡Œçš„è°ƒç”¨é“¾å°±å¾ˆç®€å•äº†ï¼Œé¦–å…ˆå†…æ ¸ä¼šä»åˆ›å»ºçš„ socket çš„ fd ä¸­è·å–å¯¹åº”çš„ struct fileï¼Œè¿™ä¸ª struct file ç”¨äº __sys_connect_file çš„å‚æ•°ï¼Œæ¥ç€å°†åœ°å€æ‹·è´åˆ°å†…æ ¸æ€ã€‚ç„¶åé€šè¿‡å‰é¢å–å‡ºçš„ struct file ä¸­çš„ private_data æ‰¾åˆ° struct socketï¼Œå¹¶ä¸”è°ƒç”¨ sock-&gt;ops-&gt;connectï¼ŒæŒ‰ç…§ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°çš„åˆå§‹åŒ–ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ inet_stream_ops ä¸­çš„ inet_stream_connectã€‚æˆ‘ä»¬å…ˆæ€»ä½“è¯´ä¸€ä¸‹å‡½æ•°çš„æµç¨‹ï¼Œå†ä¾æ¬¡å•ç‹¬åˆ†æã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_stream_connect</span><span class="params">(struct socket *sock, struct sockaddr *uaddr, <span class="keyword">int</span> addr_len, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="comment">// è·å–é”</span></span><br><span class="line">    lock_sock(sock-&gt;sk);</span><br><span class="line">    err = __inet_stream_connect(sock, uaddr, addr_len, flags, <span class="number">0</span>);</span><br><span class="line">    release_sock(sock-&gt;sk);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(inet_stream_connect);</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> __inet_stream_connect(struct socket *sock, struct sockaddr *uaddr, <span class="keyword">int</span> addr_len, <span class="keyword">int</span> flags, <span class="keyword">int</span> is_sendmsg) &#123;</span><br><span class="line">    <span class="comment">// è·å– struct socket å¯¹åº”çš„ struct sock</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> = <span class="title">sock</span>-&gt;<span class="title">sk</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="keyword">long</span> timeo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uaddr) &#123;</span><br><span class="line">        <span class="keyword">if</span> (addr_len &lt; <span class="keyword">sizeof</span>(uaddr-&gt;sa_family))</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åè®®æ—å‚æ•°æœªæŒ‡å®š</span></span><br><span class="line">        <span class="keyword">if</span> (uaddr-&gt;sa_family == AF_UNSPEC) &#123;</span><br><span class="line">            err = sk-&gt;sk_prot-&gt;disconnect(sk, flags);</span><br><span class="line">            sock-&gt;state = err ? SS_DISCONNECTING : SS_UNCONNECTED;</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// connect æ ¹æ® struct socket ä¸­ä¿å­˜çš„ state åˆ¤æ–­ä¸‹ä¸€æ­¥çš„è¡Œä¸º</span></span><br><span class="line">    <span class="keyword">switch</span> (sock-&gt;state) &#123;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        err = -EINVAL;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    <span class="comment">// å·²ç»è¿æ¥äº†, ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">case</span> SS_CONNECTED:</span><br><span class="line">        err = -EISCONN;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    <span class="keyword">case</span> SS_CONNECTING:</span><br><span class="line">        <span class="keyword">if</span> (inet_sk(sk)-&gt;defer_connect)</span><br><span class="line">            err = is_sendmsg ? -EINPROGRESS : -EISCONN;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            err = -EALREADY;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// æ¡æ‰‹åˆšå¼€å§‹ socket å¤„äºæœªè¿æ¥çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">case</span> SS_UNCONNECTED:</span><br><span class="line">        err = -EISCONN;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ä¸‹å±‚ struct sock çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (sk-&gt;sk_state != TCP_CLOSE)</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (BPF_CGROUP_PRE_CONNECT_ENABLED(sk)) &#123;</span><br><span class="line">            err = sk-&gt;sk_prot-&gt;pre_connect(sk, uaddr, addr_len);</span><br><span class="line">            <span class="keyword">if</span> (err)</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨ tcp_prot ä¸­çš„ tcp_v4_connect å‘é€ SYN åŒ…</span></span><br><span class="line">        err = sk-&gt;sk_prot-&gt;connect(sk, uaddr, addr_len);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘é€ SYN åå°† struct socket çŠ¶æ€è®¾ç½®ä¸º SS_CONNECTING</span></span><br><span class="line">        sock-&gt;state = SS_CONNECTING;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!err &amp;&amp; inet_sk(sk)-&gt;defer_connect)</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">        err = -EINPROGRESS;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–è¿æ¥è¶…æ—¶æ—¶é—´, å³ç­‰å¾… SYN-ACK çš„æ—¶é—´, å¦‚æœè®¾ç½®äº†éé˜»å¡å°±ç›´æ¥è¿”å›</span></span><br><span class="line">    timeo = sock_sndtimeo(sk, flags &amp; O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="number">1</span> &lt;&lt; sk-&gt;sk_state) &amp; (TCPF_SYN_SENT | TCPF_SYN_RECV)) &#123;</span><br><span class="line">        <span class="keyword">int</span> writebias = (sk-&gt;sk_protocol == IPPROTO_TCP) &amp;&amp;</span><br><span class="line">                                tcp_sk(sk)-&gt;fastopen_req &amp;&amp;</span><br><span class="line">                                tcp_sk(sk)-&gt;fastopen_req-&gt;data ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// inet_wait_for_connect ç­‰å¾…æœåŠ¡ç«¯è¿”å›çš„ ACK</span></span><br><span class="line">        <span class="keyword">if</span> (!timeo || !inet_wait_for_connect(sk, timeo, writebias))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">        err = sock_intr_errno(timeo);</span><br><span class="line">        <span class="keyword">if</span> (signal_pending(current))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥è¢« RST/timeout/ICMP error/å¦ä¸€ä¸ªè¿›ç¨‹ å…³é—­, è¿æ¥å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_state == TCP_CLOSE)</span><br><span class="line">        <span class="keyword">goto</span> sock_error;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿æ¥æˆåŠŸå»ºç«‹</span></span><br><span class="line">    sock-&gt;state = SS_CONNECTED;</span><br><span class="line">    err = <span class="number">0</span>;</span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">sock_error:</span><br><span class="line">    err = sock_error(sk) ?: -ECONNABORTED;</span><br><span class="line">    sock-&gt;state = SS_UNCONNECTED;</span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_prot-&gt;disconnect(sk, flags))</span><br><span class="line">        sock-&gt;state = SS_DISCONNECTING;</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__inet_stream_connect);</span><br></pre></td></tr></table></figure>
<p>inet_stream_connect ä¼šè°ƒç”¨ __inet_stream_connectï¼Œæ¡æ‰‹å¼€å§‹æ—¶ socket å¤„äº SS_UNCONNECTED çŠ¶æ€ï¼ŒåŒæ—¶ä¸‹å±‚çš„ struct sock å¤„äº TCP_CLOSE çŠ¶æ€ï¼Œæ¥ç€ä¼šè°ƒç”¨ sk-&gt;sk_prot-&gt;connectï¼Œä¹Ÿå°±æ˜¯ tcp_prot ä¸­çš„ tcp_v4_connectï¼Œä¹‹å socket çš„çŠ¶æ€è¢«è®¾ç½®ä¸º SS_CONNECTINGï¼Œå‘é€å®Œ SYN åï¼Œå®¢æˆ·ç«¯ä¼šåœ¨ inet_wait_for_connect ç­‰å¾…æœåŠ¡ç«¯è¿”å›çš„ ACK æˆ–è€… timeo è¶…æ—¶ï¼Œå¦‚æœè¿æ¥æˆåŠŸï¼Œè¿˜éœ€è¦ä¿®æ”¹ struct socket çš„çŠ¶æ€ä¸º SS_CONNECTEDã€‚<br>
ä¸‹é¢å…ˆçœ‹å‘é€ SYN åŒ…çš„ tcp_v4_connectï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_v4_connect</span><span class="params">(struct sock *sk, struct sockaddr *uaddr, <span class="keyword">int</span> addr_len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°†é€šç”¨åœ°å€ç»“æ„è½¬æ¢ä¸º struct sockaddr_in IPv4 åœ°å€</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">usin</span> = (<span class="title">struct</span> <span class="title">sockaddr_in</span> *)<span class="title">uaddr</span>;</span></span><br><span class="line">    <span class="comment">// struct sock çš„æ‰©å±•, åŒ…å«äº†åœ°å€, ç«¯å£å·, TTL ç­‰å±äºç½‘ç»œå±‚çš„ä¿¡æ¯</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span> = <span class="title">inet_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="comment">// struct tcp_sock æ˜¯ struct inet_connection_sock çš„æ‰©å±•</span></span><br><span class="line">    <span class="comment">// é‡Œé¢åŒ…å«äº†æ¥æ”¶çª—å£, æ‹¥å¡çª—å£ç­‰ TCP ç‰¹æœ‰çš„ç»“æ„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    __be16 orig_sport, orig_dport;</span><br><span class="line">    __be32 daddr, nexthop;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">flowi4</span> *<span class="title">fl4</span>;</span></span><br><span class="line">    <span class="comment">// struct rtable æ˜¯è·¯ç”±è¡¨é¡¹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rtable</span> *<span class="title">rt</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_options_rcu</span> *<span class="title">inet_opt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_timewait_death_row</span> *<span class="title">tcp_death_row</span> = &amp;<span class="title">sock_net</span>(<span class="title">sk</span>)-&gt;<span class="title">ipv4</span>.<span class="title">tcp_death_row</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¡éªŒåœ°å€é•¿åº¦</span></span><br><span class="line">    <span class="keyword">if</span> (addr_len &lt; <span class="keyword">sizeof</span>(struct sockaddr_in))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¡éªŒåœ°å€æ—æ˜¯å¦ä¸º AF_INET</span></span><br><span class="line">    <span class="keyword">if</span> (usin-&gt;sin_family != AF_INET)</span><br><span class="line">        <span class="keyword">return</span> -EAFNOSUPPORT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ä¸‹ä¸€è·³åœ°å€å’Œç›®çš„åœ°å€è®¾ç½®ä¸ºç”¨æˆ·ä¼ å…¥çš„åœ°å€</span></span><br><span class="line">    nexthop = daddr = usin-&gt;sin_addr.s_addr;</span><br><span class="line">    inet_opt = rcu_dereference_protected(inet-&gt;inet_opt, lockdep_sock_is_held(sk));</span><br><span class="line">    <span class="keyword">if</span> (inet_opt &amp;&amp; inet_opt-&gt;opt.srr) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!daddr)</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        nexthop = inet_opt-&gt;opt.faddr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    orig_sport = inet-&gt;inet_sport;</span><br><span class="line">    orig_dport = usin-&gt;sin_port;</span><br><span class="line">    fl4 = &amp;inet-&gt;cork.fl.u.ip4;</span><br><span class="line">    <span class="comment">// ip_route_connect è¿›è¡Œè·¯ç”±é€‰æ‹©å¹¶èµ‹ç»™ struct rtable</span></span><br><span class="line">    rt = ip_route_connect(fl4, nexthop, inet-&gt;inet_saddr,</span><br><span class="line">                          RT_CONN_FLAGS(sk), sk-&gt;sk_bound_dev_if,</span><br><span class="line">                          IPPROTO_TCP,</span><br><span class="line">                          orig_sport, orig_dport, sk);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(rt)) &#123;</span><br><span class="line">        err = PTR_ERR(rt);</span><br><span class="line">        <span class="keyword">if</span> (err == -ENETUNREACH)</span><br><span class="line">            IP_INC_STATS(sock_net(sk), IPSTATS_MIB_OUTNOROUTES);</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TCP ä¸èƒ½ä½¿ç”¨å¤šæ’­å’Œç»„æ’­</span></span><br><span class="line">    <span class="keyword">if</span> (rt-&gt;rt_flags &amp; (RTCF_MULTICAST | RTCF_BROADCAST)) &#123;</span><br><span class="line">        ip_rt_put(rt);</span><br><span class="line">        <span class="keyword">return</span> -ENETUNREACH;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰å¯ç”¨æºè·¯ç”±é€‰é¡¹æŒ‡å®šå‘é€è·¯ç”±, å°±ä½¿ç”¨è·¯ç”±ç¼“å­˜é¡¹ä¸­çš„ç›®çš„åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (!inet_opt || !inet_opt-&gt;opt.srr)</span><br><span class="line">        daddr = fl4-&gt;daddr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰æŒ‡å®šå‘é€æºåœ°å€, å°±ä½¿ç”¨è·¯ç”±ç¼“å­˜é¡¹ä¸­çš„æºåœ°å€</span></span><br><span class="line">    <span class="comment">// ä»å“ªä¸ªç½‘å¡å‡ºå», æºåœ°å€å°±åº”è¯¥å¡«å“ªä¸ªç½‘å¡çš„ IP åœ°å€</span></span><br><span class="line">    <span class="keyword">if</span> (!inet-&gt;inet_saddr)</span><br><span class="line">        inet-&gt;inet_saddr = fl4-&gt;saddr;</span><br><span class="line">    sk_rcv_saddr_set(sk, inet-&gt;inet_saddr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tp-&gt;rx_opt.ts_recent_stamp &amp;&amp; inet-&gt;inet_daddr != daddr) &#123;</span><br><span class="line">        tp-&gt;rx_opt.ts_recent = <span class="number">0</span>;</span><br><span class="line">        tp-&gt;rx_opt.ts_recent_stamp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (likely(!tp-&gt;repair))</span><br><span class="line">            WRITE_ONCE(tp-&gt;write_seq, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®ç›®æ ‡ç«¯å£</span></span><br><span class="line">    inet-&gt;inet_dport = usin-&gt;sin_port;</span><br><span class="line">    sk_daddr_set(sk, daddr);</span><br><span class="line"></span><br><span class="line">    inet_csk(sk)-&gt;icsk_ext_hdr_len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (inet_opt)</span><br><span class="line">        inet_csk(sk)-&gt;icsk_ext_hdr_len = inet_opt-&gt;opt.optlen;</span><br><span class="line"></span><br><span class="line">    tp-&gt;rx_opt.mss_clamp = TCP_MSS_DEFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½® struct sock çŠ¶æ€ä¸º TCP_SYN_SENT</span></span><br><span class="line">    tcp_set_state(sk, TCP_SYN_SENT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æœ¬åœ°ç«¯å£</span></span><br><span class="line">    err = inet_hash_connect(tcp_death_row, sk);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">goto</span> failure;</span><br><span class="line"></span><br><span class="line">    sk_set_txhash(sk);</span><br><span class="line"></span><br><span class="line">    rt = ip_route_newports(fl4, rt, orig_sport, orig_dport, inet-&gt;inet_sport, inet-&gt;inet_dport, sk);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(rt)) &#123;</span><br><span class="line">        err = PTR_ERR(rt);</span><br><span class="line">        rt = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">goto</span> failure;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sk-&gt;sk_gso_type = SKB_GSO_TCPV4;</span><br><span class="line">    sk_setup_caps(sk, &amp;rt-&gt;dst);</span><br><span class="line">    rt = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (likely(!tp-&gt;repair)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!tp-&gt;write_seq)</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–åºåˆ—å· TCP seq num</span></span><br><span class="line">            WRITE_ONCE(tp-&gt;write_seq,</span><br><span class="line">                       secure_tcp_seq(inet-&gt;inet_saddr,</span><br><span class="line">                                      inet-&gt;inet_daddr,</span><br><span class="line">                                      inet-&gt;inet_sport,</span><br><span class="line">                                      usin-&gt;sin_port));</span><br><span class="line">        tp-&gt;tsoffset = secure_tcp_ts_off(sock_net(sk),</span><br><span class="line">                                         inet-&gt;inet_saddr,</span><br><span class="line">                                         inet-&gt;inet_daddr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    inet-&gt;inet_id = prandom_u32();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcp_fastopen_defer_connect(sk, &amp;err))</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">goto</span> failure;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€  SYN åŒ…å¹¶å‘é€</span></span><br><span class="line">    err = tcp_connect(sk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">goto</span> failure;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">failure:</span><br><span class="line">    tcp_set_state(sk, TCP_CLOSE);</span><br><span class="line">    ip_rt_put(rt);</span><br><span class="line">    sk-&gt;sk_route_caps = <span class="number">0</span>;</span><br><span class="line">    inet-&gt;inet_dport = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(tcp_v4_connect);</span><br></pre></td></tr></table></figure>
<p>åœ¨ tcp_v4_connect ä¸­æœ‰ä¸€ä¸ªæ–°çš„ struct tcp_sockï¼Œè¿™ä¸ªç»“æ„å…¶å®æ˜¯ struct inet_connection_sock æ‰©å±•ï¼Œæ–¹æ³•å’Œä¸Šä¸€ç¯‡æ–‡ç« è®²çš„ä¸€æ ·ï¼Œè¿™ä¸ªç»“æ„ç»´æŠ¤äº†æ›´å¤š TCP çš„çŠ¶æ€ï¼Œå®ƒä¹Ÿè¢«ç§°ä¸º TCP çš„ä¼ è¾“æ§åˆ¶å—ã€‚<br>
tcp_v4_connect å‡½æ•°ä¸­ï¼Œé¦–å…ˆé€šè¿‡ ip_route_connect è¿›è¡Œè·¯ç”±é€‰æ‹©ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ä¸€ä¸ªè·¯ç”±è¡¨é¡¹ struct rtableï¼Œè¿™å…¶å®æ˜¯ä¸ºæˆ‘ä»¬åé¢å‘é€ SYN åŒ…åšå‡†å¤‡ï¼Œå› ä¸ºè¦å‘ç½‘ç»œåŒ…ï¼Œå°±å¾—æœ‰æºåœ°å€å’Œç«¯å£ã€ç›®æ ‡åœ°å€å’Œç«¯å£ï¼Œè·¯ç”±é€‰æ‹©çš„æ—¶å€™å°±ç¡®å®šäº†æºåœ°å€å’Œç›®æ ‡åœ°å€ï¼Œæºç«¯å£æ˜¯å®¢æˆ·ç«¯åœ¨ inet_hash_connect å‡½æ•°ä¸­éšæœºåˆ†é…çš„ï¼Œç›®æ ‡ç«¯å£åœ¨åé¢é€šè¿‡ struct sockaddr_in è¿›è¡Œäº†èµ‹å€¼ã€‚éšåå†…æ ¸ä¿®æ”¹äº†ç½‘ç»œå±‚ struct sock çš„çŠ¶æ€ä¸º TCP_SYN_SENTï¼Œè¿™ä¸ªçŠ¶æ€å’Œæˆ‘ä»¬å¸¸è§çš„ä¸‰æ¬¡æ¡æ‰‹ç¤ºæ„å›¾ä¸Šçš„çŠ¶æ€æ˜¯å¯¹åº”çš„ã€‚<br>
æ¥ä¸‹æ¥è¿›å…¥äº†å‘é€ç¯èŠ‚ï¼Œè°ƒç”¨ tcp_connect æ„é€  SYN åŒ…å¹¶å‘é€ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_connect</span><span class="params">(struct sock *sk)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ­£å¼è¿›å…¥äº† TCP ä¼ è¾“é˜¶æ®µ, éœ€è¦è½¬æ¢å‡º struct tcp_sock</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">buff</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    tcp_call_bpf(sk, BPF_SOCK_OPS_TCP_CONNECT_CB, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inet_csk(sk)-&gt;icsk_af_ops-&gt;rebuild_header(sk))</span><br><span class="line">        <span class="keyword">return</span> -EHOSTUNREACH;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– struct sock ä¸­ä¸è¿æ¥ç›¸å…³çš„åŠŸèƒ½</span></span><br><span class="line">    tcp_connect_init(sk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(tp-&gt;repair))</span><br><span class="line">    &#123;</span><br><span class="line">        tcp_finish_connect(sk, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸º SYN åˆ†é…ç©ºé—´</span></span><br><span class="line">    buff = sk_stream_alloc_skb(sk, <span class="number">0</span>, sk-&gt;sk_allocation, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(!buff))</span><br><span class="line">        <span class="keyword">return</span> -ENOBUFS;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–äº†ä¸€ä¸ª SYN åŒ…</span></span><br><span class="line">    tcp_init_nondata_skb(buff, tp-&gt;write_seq++, TCPHDR_SYN);</span><br><span class="line">    tcp_mstamp_refresh(tp);</span><br><span class="line">    tp-&gt;retrans_stamp = tcp_time_stamp(tp);</span><br><span class="line">    tcp_connect_queue_skb(sk, buff);</span><br><span class="line">    tcp_ecn_send_syn(sk, buff);</span><br><span class="line">    tcp_rbtree_insert(&amp;sk-&gt;tcp_rtx_queue, buff);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ²¡æœ‰ä½¿ç”¨ fastopen åŠŸèƒ½çš„æ—¶å€™, tcp_transmit_skb å°† SYN åŒ…å‘é€å‡ºå»</span></span><br><span class="line">    err = tp-&gt;fastopen_req ? tcp_send_syn_data(sk, buff) : tcp_transmit_skb(sk, buff, <span class="number">1</span>, sk-&gt;sk_allocation);</span><br><span class="line">    <span class="keyword">if</span> (err == -ECONNREFUSED)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    WRITE_ONCE(tp-&gt;snd_nxt, tp-&gt;write_seq);</span><br><span class="line">    tp-&gt;pushed_seq = tp-&gt;write_seq;</span><br><span class="line">    buff = tcp_send_head(sk);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(buff)) &#123;</span><br><span class="line">        WRITE_ONCE(tp-&gt;snd_nxt, TCP_SKB_CB(buff)-&gt;seq);</span><br><span class="line">        tp-&gt;pushed_seq = TCP_SKB_CB(buff)-&gt;seq;</span><br><span class="line">    &#125;</span><br><span class="line">    TCP_INC_STATS(sock_net(sk), TCP_MIB_ACTIVEOPENS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®äº† timer, åœ¨ SYN å‘é€å¤±è´¥æ—¶ä¼šå†æ¬¡å‘é€</span></span><br><span class="line">    inet_csk_reset_xmit_timer(sk, ICSK_TIME_RETRANS, inet_csk(sk)-&gt;icsk_rto, TCP_RTO_MAX);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(tcp_connect);</span><br></pre></td></tr></table></figure>
<p>åœ¨å‘é€äº† SYN åŒ…ä¹‹åï¼Œå®¢æˆ·ç«¯ä¼šåœ¨ inet_wait_for_connect å‡½æ•°ä¸­ç­‰å¾…ï¼Œæ¥çœ‹ä¸€ä¸‹å®ƒçš„å®ç°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">inet_wait_for_connect</span><span class="params">(struct sock *sk, <span class="keyword">long</span> timeo, <span class="keyword">int</span> writebias)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰ä¸€ä¸ª struct_queue_entry, åŠŸèƒ½æ˜¯ç­‰å¾… condition ç”Ÿæ•ˆæ—¶å”¤é†’</span></span><br><span class="line">    DEFINE_WAIT_FUNC(wait, woken_wake_function);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ä¸Šé¢çš„ wait å¯¹è±¡åŠ å…¥ sk_sleep çš„ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    add_wait_queue(sk_sleep(sk), &amp;wait);</span><br><span class="line">    sk-&gt;sk_write_pending += writebias;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((<span class="number">1</span> &lt;&lt; sk-&gt;sk_state) &amp; (TCPF_SYN_SENT | TCPF_SYN_RECV)) &#123;</span><br><span class="line">        release_sock(sk);</span><br><span class="line">        <span class="comment">// å®šæ—¶åé€šè¿‡ schedule_timeout ä¸»åŠ¨è°ƒåº¦ CPU</span></span><br><span class="line">        timeo = wait_woken(&amp;wait, TASK_INTERRUPTIBLE, timeo);</span><br><span class="line">        lock_sock(sk);</span><br><span class="line">        <span class="comment">// å¦‚æœæ”¶åˆ°äº†ä¿¡å·å”¤é†’å°±è¦æå‰é€€å‡ºå¹¶è„±é“¾</span></span><br><span class="line">        <span class="keyword">if</span> (signal_pending(current) || !timeo)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    remove_wait_queue(sk_sleep(sk), &amp;wait);</span><br><span class="line">    sk-&gt;sk_write_pending -= writebias;</span><br><span class="line">    <span class="keyword">return</span> timeo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬å…ˆå°†ä¸‹å±‚çš„åè®®æ ˆçœ‹ä½œä¸€ä¸ªé»‘ç›’ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°çš„ IP åŒ…é‡Œé¢çš„ protocol åº”è¯¥æ˜¯ TCP åè®®ï¼Œè¿™è¡¨æ˜æ¥æ”¶ç«¯çš„ä¸Šå±‚åº”è¯¥ä½¿ç”¨ TCP åè®®æ¥å¤„ç†æ”¶åˆ°çš„åŒ…ï¼Œåœ¨ <code>/include/net/protocol.h</code> ä¸­èƒ½å¤Ÿæ‰¾åˆ° struct net_protocol çš„å®šä¹‰ï¼Œè¿™ä¸ªç»“æ„ä½“ç”¨äºæ³¨å†Œåè®®ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net_protocol</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> (*early_demux)(struct sk_buff *skb);</span><br><span class="line">    <span class="keyword">int</span> (*early_demux_handler)(struct sk_buff *skb);</span><br><span class="line">    <span class="keyword">int</span> (*handler)(struct sk_buff *skb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This returns an error if we weren't able to handle the error. */</span></span><br><span class="line">    <span class="keyword">int</span> (*err_handler)(struct sk_buff *skb, u32 info);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> no_policy : <span class="number">1</span>,</span><br><span class="line">        netns_ok : <span class="number">1</span>,</span><br><span class="line">        icmp_strict_tag_validation : <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>èƒ½çœ‹åˆ°ä¸€ä¸ªæˆå‘˜å‡½æ•°æŒ‡é’ˆ handlerï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥å¤„ç†æ”¶åˆ°çš„ç½‘ç»œåŒ…ã€‚å†…æ ¸åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šç”³è¯·ä¸€ä¸ª inet_protos æ•°ç»„ï¼Œæ•°ç»„å…ƒç´ æ˜¯ struct net_protocol ç±»å‹çš„æŒ‡é’ˆï¼Œç„¶åå† inet_init ä¸­åˆå§‹åŒ–è¿™ä¸ªæ•°ç»„ä¸­çš„åè®®å¤„ç†å‡½æ•°ï¼Œè¿™é‡Œçš„ä¸‹æ ‡å…¶å®å°±æ˜¯åˆå§‹åŒ– socket æ—¶æˆ‘ä»¬æŒ‡å®šçš„åè®®å·ï¼Œåªæ˜¯ç°åœ¨æˆ‘ä»¬ä¸è¿™ä¹ˆç”¨äº†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net_protocol</span> __<span class="title">rcu</span> *<span class="title">inet_protos</span>[<span class="title">MAX_INET_PROTOS</span>] __<span class="title">read_mostly</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// idx: IPPROTO_TCP</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_protocol</span> <span class="title">tcp_protocol</span> = &#123;</span></span><br><span class="line">    .early_demux = tcp_v4_early_demux,</span><br><span class="line">    .early_demux_handler = tcp_v4_early_demux,</span><br><span class="line">    .handler = tcp_v4_rcv,</span><br><span class="line">    .err_handler = tcp_v4_err,</span><br><span class="line">    .no_policy = <span class="number">1</span>,</span><br><span class="line">    .netns_ok = <span class="number">1</span>,</span><br><span class="line">    .icmp_strict_tag_validation = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// idx: IPPROTO_UDP</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_protocol</span> <span class="title">udp_protocol</span> = &#123;</span></span><br><span class="line">    .early_demux = udp_v4_early_demux,</span><br><span class="line">    .early_demux_handler = udp_v4_early_demux,</span><br><span class="line">    .handler = udp_rcv,</span><br><span class="line">    .err_handler = udp_err,</span><br><span class="line">    .no_policy = <span class="number">1</span>,</span><br><span class="line">    .netns_ok = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// idx: IPPROTO_IGMP</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_protocol</span> <span class="title">icmp_protocol</span> = &#123;</span></span><br><span class="line">    .handler = icmp_rcv,</span><br><span class="line">    .err_handler = icmp_err,</span><br><span class="line">    .no_policy = <span class="number">1</span>,</span><br><span class="line">    .netns_ok = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å›åˆ°æœåŠ¡ç«¯æ”¶åŒ…çš„æ—¶å€™ï¼Œæ¥æ”¶ç«¯ä¼šè°ƒç”¨ tcp_v4_rcv æ¥æ¥æ”¶å®¢æˆ·ç«¯å‘æ¥çš„ SYN åŒ…ã€‚<br>
è¿™ä¸ªå‡½æ•°æœ‰ç‚¹é•¿ï¼Œå…ˆçœ‹å‚æ•°ï¼Œç½‘ç»œåŒ…çš„æ•°æ®éƒ½æ˜¯é€šè¿‡ struct sk_buff è¿™ä¸ªç»“æ„ä¿å­˜çš„ï¼Œè¿™ä¸ªç»“æ„æˆ‘æ‰“ç®—æ”¾åœ¨ä¸‹ä¸€ç¯‡å‘é€æ•°æ®çš„æ–‡ç« ä»‹ç»ã€‚<br>
æœåŠ¡ç«¯åœ¨ç¬¬ä¸€æ¬¡æ”¶åˆ° SYN åŒ…ä¹‹å‰æ˜¯å¤„äº TCP_LISTEN çŠ¶æ€ï¼Œå› æ­¤ä¼šè°ƒç”¨ tcp_v4_do_rcvã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_v4_rcv</span><span class="params">(struct sk_buff *skb)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> = <span class="title">dev_net</span>(<span class="title">skb</span>-&gt;<span class="title">dev</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">skb_to_free</span>;</span></span><br><span class="line">    <span class="keyword">int</span> sdif = inet_sdif(skb);</span><br><span class="line">    <span class="keyword">int</span> dif = inet_iif(skb);</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iph</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">th</span>;</span></span><br><span class="line">    <span class="keyword">bool</span> refcounted;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (skb-&gt;pkt_type != PACKET_HOST)</span><br><span class="line">        <span class="keyword">goto</span> discard_it;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Count it even if it's bad */</span></span><br><span class="line">    __TCP_INC_STATS(net, TCP_MIB_INSEGS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pskb_may_pull(skb, <span class="keyword">sizeof</span>(struct tcphdr)))</span><br><span class="line">        <span class="keyword">goto</span> discard_it;</span><br><span class="line"></span><br><span class="line">    th = (<span class="keyword">const</span> struct tcphdr *)skb-&gt;data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(th-&gt;doff &lt; <span class="keyword">sizeof</span>(struct tcphdr) / <span class="number">4</span>))</span><br><span class="line">        <span class="keyword">goto</span> bad_packet;</span><br><span class="line">    <span class="keyword">if</span> (!pskb_may_pull(skb, th-&gt;doff * <span class="number">4</span>))</span><br><span class="line">        <span class="keyword">goto</span> discard_it;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (skb_checksum_init(skb, IPPROTO_TCP, inet_compute_pseudo))</span><br><span class="line">        <span class="keyword">goto</span> csum_error;</span><br><span class="line"></span><br><span class="line">    th = (<span class="keyword">const</span> struct tcphdr *)skb-&gt;data;</span><br><span class="line">    iph = ip_hdr(skb);</span><br><span class="line">lookup:</span><br><span class="line">    sk = __inet_lookup_skb(&amp;tcp_hashinfo, skb, __tcp_hdrlen(th), th-&gt;source,</span><br><span class="line">                           th-&gt;dest, sdif, &amp;refcounted);</span><br><span class="line">    <span class="keyword">if</span> (!sk)</span><br><span class="line">        <span class="keyword">goto</span> no_tcp_socket;</span><br><span class="line"></span><br><span class="line"><span class="built_in">process</span>:</span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_state == TCP_TIME_WAIT)</span><br><span class="line">        <span class="keyword">goto</span> do_time_wait;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_state == TCP_NEW_SYN_RECV) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">request_sock</span> *<span class="title">req</span> = <span class="title">inet_reqsk</span>(<span class="title">sk</span>);</span></span><br><span class="line">        <span class="keyword">bool</span> req_stolen = <span class="literal">false</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">nsk</span>;</span></span><br><span class="line"></span><br><span class="line">        sk = req-&gt;rsk_listener;</span><br><span class="line">        <span class="keyword">if</span> (unlikely(tcp_v4_inbound_md5_hash(sk, skb, dif, sdif))) &#123;</span><br><span class="line">            sk_drops_add(sk, skb);</span><br><span class="line">            reqsk_put(req);</span><br><span class="line">            <span class="keyword">goto</span> discard_it;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (tcp_checksum_complete(skb)) &#123;</span><br><span class="line">            reqsk_put(req);</span><br><span class="line">            <span class="keyword">goto</span> csum_error;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (unlikely(sk-&gt;sk_state != TCP_LISTEN)) &#123;</span><br><span class="line">            inet_csk_reqsk_queue_drop_and_put(sk, req);</span><br><span class="line">            <span class="keyword">goto</span> lookup;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sock_hold(sk);</span><br><span class="line">        refcounted = <span class="literal">true</span>;</span><br><span class="line">        nsk = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (!tcp_filter(sk, skb)) &#123;</span><br><span class="line">            th = (<span class="keyword">const</span> struct tcphdr *)skb-&gt;data;</span><br><span class="line">            iph = ip_hdr(skb);</span><br><span class="line">            tcp_v4_fill_cb(skb, iph, th);</span><br><span class="line">            nsk = tcp_check_req(sk, skb, req, <span class="literal">false</span>, &amp;req_stolen);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!nsk) &#123;</span><br><span class="line">            reqsk_put(req);</span><br><span class="line">            <span class="keyword">if</span> (req_stolen) &#123;</span><br><span class="line"></span><br><span class="line">                tcp_v4_restore_cb(skb);</span><br><span class="line">                sock_put(sk);</span><br><span class="line">                <span class="keyword">goto</span> lookup;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">goto</span> discard_and_relse;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nsk == sk) &#123;</span><br><span class="line">            reqsk_put(req);</span><br><span class="line">            tcp_v4_restore_cb(skb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tcp_child_process(sk, nsk, skb)) &#123;</span><br><span class="line">            tcp_v4_send_reset(nsk, skb);</span><br><span class="line">            <span class="keyword">goto</span> discard_and_relse;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            sock_put(sk);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (unlikely(iph-&gt;ttl &lt; inet_sk(sk)-&gt;min_ttl)) &#123;</span><br><span class="line">        __NET_INC_STATS(net, LINUX_MIB_TCPMINTTLDROP);</span><br><span class="line">        <span class="keyword">goto</span> discard_and_relse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!xfrm4_policy_check(sk, XFRM_POLICY_IN, skb))</span><br><span class="line">        <span class="keyword">goto</span> discard_and_relse;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcp_v4_inbound_md5_hash(sk, skb, dif, sdif))</span><br><span class="line">        <span class="keyword">goto</span> discard_and_relse;</span><br><span class="line"></span><br><span class="line">    nf_reset_ct(skb);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcp_filter(sk, skb))</span><br><span class="line">        <span class="keyword">goto</span> discard_and_relse;</span><br><span class="line">    th = (<span class="keyword">const</span> struct tcphdr *)skb-&gt;data;</span><br><span class="line">    iph = ip_hdr(skb);</span><br><span class="line">    tcp_v4_fill_cb(skb, iph, th);</span><br><span class="line"></span><br><span class="line">    skb-&gt;dev = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡æ”¶åˆ° SYN åŒ…çš„æ—¶å€™, æœåŠ¡ç«¯å¤„åœ¨ TCP_LISTEN çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_state == TCP_LISTEN) &#123;</span><br><span class="line">        ret = tcp_v4_do_rcv(sk, skb);</span><br><span class="line">        <span class="keyword">goto</span> put_and_return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sk_incoming_cpu_update(sk);</span><br><span class="line"></span><br><span class="line">    bh_lock_sock_nested(sk);</span><br><span class="line">    tcp_segs_in(tcp_sk(sk), skb);</span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!sock_owned_by_user(sk)) &#123;</span><br><span class="line">        skb_to_free = sk-&gt;sk_rx_skb_cache;</span><br><span class="line">        sk-&gt;sk_rx_skb_cache = <span class="literal">NULL</span>;</span><br><span class="line">        ret = tcp_v4_do_rcv(sk, skb);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tcp_add_backlog(sk, skb))</span><br><span class="line">            <span class="keyword">goto</span> discard_and_relse;</span><br><span class="line">        skb_to_free = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    bh_unlock_sock(sk);</span><br><span class="line">    <span class="keyword">if</span> (skb_to_free)</span><br><span class="line">        __kfree_skb(skb_to_free);</span><br><span class="line"></span><br><span class="line">put_and_return:</span><br><span class="line">    <span class="keyword">if</span> (refcounted)</span><br><span class="line">        sock_put(sk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">no_tcp_socket:</span><br><span class="line">    <span class="keyword">if</span> (!xfrm4_policy_check(<span class="literal">NULL</span>, XFRM_POLICY_IN, skb))</span><br><span class="line">        <span class="keyword">goto</span> discard_it;</span><br><span class="line"></span><br><span class="line">    tcp_v4_fill_cb(skb, iph, th);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcp_checksum_complete(skb)) &#123;</span><br><span class="line">    csum_error:</span><br><span class="line">        __TCP_INC_STATS(net, TCP_MIB_CSUMERRORS);</span><br><span class="line">    bad_packet:</span><br><span class="line">        __TCP_INC_STATS(net, TCP_MIB_INERRS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        tcp_v4_send_reset(<span class="literal">NULL</span>, skb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">discard_it:</span><br><span class="line">    kfree_skb(skb);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">discard_and_relse:</span><br><span class="line">    sk_drops_add(sk, skb);</span><br><span class="line">    <span class="keyword">if</span> (refcounted)</span><br><span class="line">        sock_put(sk);</span><br><span class="line">    <span class="keyword">goto</span> discard_it;</span><br><span class="line"></span><br><span class="line">do_time_wait:</span><br><span class="line">    <span class="keyword">if</span> (!xfrm4_policy_check(<span class="literal">NULL</span>, XFRM_POLICY_IN, skb)) &#123;</span><br><span class="line">        inet_twsk_put(inet_twsk(sk));</span><br><span class="line">        <span class="keyword">goto</span> discard_it;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tcp_v4_fill_cb(skb, iph, th);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcp_checksum_complete(skb)) &#123;</span><br><span class="line">        inet_twsk_put(inet_twsk(sk));</span><br><span class="line">        <span class="keyword">goto</span> csum_error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (tcp_timewait_state_process(inet_twsk(sk), skb, th)) &#123;</span><br><span class="line">    <span class="keyword">case</span> TCP_TW_SYN:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk2</span> = <span class="title">inet_lookup_listener</span>(<span class="title">dev_net</span>(<span class="title">skb</span>-&gt;<span class="title">dev</span>),</span></span><br><span class="line"><span class="class">                                                &amp;<span class="title">tcp_hashinfo</span>, <span class="title">skb</span>,</span></span><br><span class="line"><span class="class">                                                __<span class="title">tcp_hdrlen</span>(<span class="title">th</span>),</span></span><br><span class="line"><span class="class">                                                <span class="title">iph</span>-&gt;<span class="title">saddr</span>, <span class="title">th</span>-&gt;<span class="title">source</span>,</span></span><br><span class="line"><span class="class">                                                <span class="title">iph</span>-&gt;<span class="title">daddr</span>, <span class="title">th</span>-&gt;<span class="title">dest</span>,</span></span><br><span class="line"><span class="class">                                                <span class="title">inet_iif</span>(<span class="title">skb</span>),</span></span><br><span class="line"><span class="class">                                                <span class="title">sdif</span>);</span></span><br><span class="line">        <span class="keyword">if</span> (sk2) &#123;</span><br><span class="line">            inet_twsk_deschedule_put(inet_twsk(sk));</span><br><span class="line">            sk = sk2;</span><br><span class="line">            tcp_v4_restore_cb(skb);</span><br><span class="line">            refcounted = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">goto</span> <span class="built_in">process</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">/* to ACK */</span></span><br><span class="line">        <span class="comment">/* fall through */</span></span><br><span class="line">    <span class="keyword">case</span> TCP_TW_ACK:</span><br><span class="line">        tcp_v4_timewait_ack(sk, skb);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TCP_TW_RST:</span><br><span class="line">        tcp_v4_send_reset(sk, skb);</span><br><span class="line">        inet_twsk_deschedule_put(inet_twsk(sk));</span><br><span class="line">        <span class="keyword">goto</span> discard_it;</span><br><span class="line">    <span class="keyword">case</span> TCP_TW_SUCCESS:;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> discard_it;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tcp_v4_do_rcv æŒ‰ç…§ struct sock ä¿å­˜çš„çŠ¶æ€ TCP_LISTENï¼Œä¼šç»§ç»­è°ƒç”¨ tcp_rcv_state_processï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é™¤äº† TCP_LISTEN socket, å…¶ä»–çŠ¶æ€çš„ socket è¿›å…¥è¯¥å‡½æ•°æ—¶å¿…é¡»æ‹¿åˆ°é”</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_v4_do_rcv</span><span class="params">(struct sock *sk, struct sk_buff *skb)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">rsk</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_state == TCP_ESTABLISHED) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span> *<span class="title">dst</span> = <span class="title">sk</span>-&gt;<span class="title">sk_rx_dst</span>;</span></span><br><span class="line"></span><br><span class="line">        sock_rps_save_rxhash(sk, skb);</span><br><span class="line">        sk_mark_napi_id(sk, skb);</span><br><span class="line">        <span class="keyword">if</span> (dst) &#123;</span><br><span class="line">            <span class="keyword">if</span> (inet_sk(sk)-&gt;rx_dst_ifindex != skb-&gt;skb_iif ||</span><br><span class="line">                !dst-&gt;ops-&gt;check(dst, <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                dst_release(dst);</span><br><span class="line">                sk-&gt;sk_rx_dst = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        tcp_rcv_established(sk, skb);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcp_checksum_complete(skb))</span><br><span class="line">        <span class="keyword">goto</span> csum_err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_state == TCP_LISTEN) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">nsk</span> = <span class="title">tcp_v4_cookie_check</span>(<span class="title">sk</span>, <span class="title">skb</span>);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!nsk)</span><br><span class="line">            <span class="keyword">goto</span> discard;</span><br><span class="line">        <span class="keyword">if</span> (nsk != sk) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tcp_child_process(sk, nsk, skb))</span><br><span class="line">            &#123;</span><br><span class="line">                rsk = nsk;</span><br><span class="line">                <span class="keyword">goto</span> reset;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        sock_rps_save_rxhash(sk, skb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥æ”¶ç½‘ç»œåŒ…åä¿®æ”¹çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (tcp_rcv_state_process(sk, skb)) &#123;</span><br><span class="line">        rsk = sk;</span><br><span class="line">        <span class="keyword">goto</span> reset;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">reset:</span><br><span class="line">    tcp_v4_send_reset(rsk, skb);</span><br><span class="line">discard:</span><br><span class="line">    kfree_skb(skb);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">csum_err:</span><br><span class="line">    TCP_INC_STATS(sock_net(sk), TCP_MIB_CSUMERRORS);</span><br><span class="line">    TCP_INC_STATS(sock_net(sk), TCP_MIB_INERRS);</span><br><span class="line">    <span class="keyword">goto</span> discard;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(tcp_v4_do_rcv);</span><br></pre></td></tr></table></figure>
<p>æ¥åˆ° tcp_rcv_state_processï¼Œæ ¹æ® struct sock çš„çŠ¶æ€æ‰¾åˆ° TCP_LISTEN çš„æ‰§è¡Œæµç¨‹ï¼Œä» struct sk_buff ä¸­å–å‡ºè¿™ä¸ªç½‘ç»œåŒ…çš„ç±»å‹ synï¼Œæ‰§è¡Œåˆ° icsk-&gt;icsk_af_ops-&gt;conn_requestï¼Œicsk å°±æ˜¯ç»´æŠ¤æœ‰è¿æ¥çš„çŠ¶æ€ç»“æ„ä½“ struct inet_connection_sockï¼Œå®ƒé‡Œé¢çš„ icsk_af_ops æ˜¯ä¸€ä¸ª struct inet_connection_sock_af_ops ç±»å‹çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæ‰€æŒ‡å¯¹è±¡åœ¨ <code>/net/ipv4/tcp_ipv4.c</code> ä¸­åˆå§‹åŒ–ï¼Œä¸éš¾çœ‹å‡ºï¼Œconn_request å¯¹åº”çš„å‡½æ•°æ˜¯ tcp_v4_conn_requestã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock_af_ops</span> <span class="title">ipv4_specific</span> = &#123;</span></span><br><span class="line">    .queue_xmit = ip_queue_xmit,</span><br><span class="line">    .send_check = tcp_v4_send_check,</span><br><span class="line">    .rebuild_header = inet_sk_rebuild_header,</span><br><span class="line">    .sk_rx_dst_set = inet_sk_rx_dst_set,</span><br><span class="line">    .conn_request = tcp_v4_conn_request,</span><br><span class="line">    .syn_recv_sock = tcp_v4_syn_recv_sock,</span><br><span class="line">    .net_header_len = <span class="keyword">sizeof</span>(struct iphdr),</span><br><span class="line">    .setsockopt = ip_setsockopt,</span><br><span class="line">    .getsockopt = ip_getsockopt,</span><br><span class="line">    .addr2sockaddr = inet_csk_addr2sockaddr,</span><br><span class="line">    .sockaddr_len = <span class="keyword">sizeof</span>(struct sockaddr_in),</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">    .compat_setsockopt = compat_ip_setsockopt,</span><br><span class="line">    .compat_getsockopt = compat_ip_getsockopt,</span><br><span class="line">#endif</span><br><span class="line">    .mtu_reduced = tcp_v4_mtu_reduced,</span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL(ipv4_specific);</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¯¥å‡½æ•°ç”¨äºæ‰§è¡Œ ESTABLISHED å’Œ TIME_WAIT ä»¥å¤–çš„æ¥æ”¶ç½‘ç»œåŒ…çš„æµç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_rcv_state_process</span><span class="params">(struct sock *sk, struct sk_buff *skb)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> = <span class="title">inet_csk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">th</span> = <span class="title">tcp_hdr</span>(<span class="title">skb</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">request_sock</span> *<span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">int</span> queued = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> acceptable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (sk-&gt;sk_state) &#123;</span><br><span class="line">    <span class="keyword">case</span> TCP_CLOSE:</span><br><span class="line">        <span class="keyword">goto</span> discard;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> TCP_LISTEN:</span><br><span class="line">        <span class="keyword">if</span> (th-&gt;ack)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (th-&gt;rst)</span><br><span class="line">            <span class="keyword">goto</span> discard;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (th-&gt;syn) &#123;</span><br><span class="line">            <span class="keyword">if</span> (th-&gt;fin)</span><br><span class="line">                <span class="keyword">goto</span> discard;</span><br><span class="line">            <span class="comment">// å› ä¸ºæˆ‘ä»¬å¾ˆæœ‰å¯èƒ½ä» backlog ä¸­å– SYN åŒ…å¤„ç†, è¿™é‡Œå¿…é¡»å…³é—­ BH å’Œ RCU</span></span><br><span class="line">            rcu_read_lock();</span><br><span class="line">            local_bh_disable();</span><br><span class="line">            <span class="comment">// åœ¨ inet_connection_sock_af_ops ä¸­æŸ¥æ‰¾å¯¹åº”æ“ä½œ</span></span><br><span class="line">            acceptable = icsk-&gt;icsk_af_ops-&gt;conn_request(sk, skb) &gt;= <span class="number">0</span>;</span><br><span class="line">            local_bh_enable();</span><br><span class="line">            rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!acceptable)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            consume_skb(skb);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> discard;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> TCP_SYN_SENT:</span><br><span class="line">        tp-&gt;rx_opt.saw_tstamp = <span class="number">0</span>;</span><br><span class="line">        tcp_mstamp_refresh(tp);</span><br><span class="line">        queued = tcp_rcv_synsent_state_process(sk, skb, th);</span><br><span class="line">        <span class="keyword">if</span> (queued &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> queued;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Do step6 onward by hand. */</span></span><br><span class="line">        tcp_urg(sk, skb, th);</span><br><span class="line">        __kfree_skb(skb);</span><br><span class="line">        tcp_data_snd_check(sk);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tcp_mstamp_refresh(tp);</span><br><span class="line">    tp-&gt;rx_opt.saw_tstamp = <span class="number">0</span>;</span><br><span class="line">    req = rcu_dereference_protected(tp-&gt;fastopen_rsk, lockdep_sock_is_held(sk));</span><br><span class="line">    <span class="keyword">if</span> (req) &#123;</span><br><span class="line">        <span class="keyword">bool</span> req_stolen;</span><br><span class="line"></span><br><span class="line">        WARN_ON_ONCE(sk-&gt;sk_state != TCP_SYN_RECV &amp;&amp; sk-&gt;sk_state != TCP_FIN_WAIT1);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!tcp_check_req(sk, skb, req, <span class="literal">true</span>, &amp;req_stolen))</span><br><span class="line">            <span class="keyword">goto</span> discard;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!th-&gt;ack &amp;&amp; !th-&gt;rst &amp;&amp; !th-&gt;syn)</span><br><span class="line">        <span class="keyword">goto</span> discard;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!tcp_validate_incoming(sk, skb, th, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* step 5: check the ACK field */</span></span><br><span class="line">    acceptable = tcp_ack(sk, skb, FLAG_SLOWPATH | FLAG_UPDATE_TS_RECENT | FLAG_NO_CHALLENGE_ACK) &gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!acceptable) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sk-&gt;sk_state == TCP_SYN_RECV)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* send one RST */</span></span><br><span class="line">        tcp_send_challenge_ack(sk, skb);</span><br><span class="line">        <span class="keyword">goto</span> discard;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (sk-&gt;sk_state)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> TCP_SYN_RECV:</span><br><span class="line">        tp-&gt;delivered++; <span class="comment">/* SYN-ACK delivery isn't tracked in tcp_ack */</span></span><br><span class="line">        <span class="keyword">if</span> (!tp-&gt;srtt_us)</span><br><span class="line">            tcp_synack_rtt_meas(sk, req);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (req) &#123;</span><br><span class="line">            tcp_rcv_synrecv_state_fastopen(sk);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            tcp_try_undo_spurious_syn(sk);</span><br><span class="line">            tp-&gt;retrans_stamp = <span class="number">0</span>;</span><br><span class="line">            tcp_init_transfer(sk, BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB);</span><br><span class="line">            WRITE_ONCE(tp-&gt;copied_seq, tp-&gt;rcv_nxt);</span><br><span class="line">        &#125;</span><br><span class="line">        smp_mb();</span><br><span class="line">        tcp_set_state(sk, TCP_ESTABLISHED);</span><br><span class="line">        sk-&gt;sk_state_change(sk);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sk-&gt;sk_socket)</span><br><span class="line">            sk_wake_async(sk, SOCK_WAKE_IO, POLL_OUT);</span><br><span class="line"></span><br><span class="line">        tp-&gt;snd_una = TCP_SKB_CB(skb)-&gt;ack_seq;</span><br><span class="line">        tp-&gt;snd_wnd = ntohs(th-&gt;window) &lt;&lt; tp-&gt;rx_opt.snd_wscale;</span><br><span class="line">        tcp_init_wl(tp, TCP_SKB_CB(skb)-&gt;seq);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tp-&gt;rx_opt.tstamp_ok)</span><br><span class="line">            tp-&gt;advmss -= TCPOLEN_TSTAMP_ALIGNED;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!inet_csk(sk)-&gt;icsk_ca_ops-&gt;cong_control)</span><br><span class="line">            tcp_update_pacing_rate(sk);</span><br><span class="line"></span><br><span class="line">        tp-&gt;lsndtime = tcp_jiffies32;</span><br><span class="line"></span><br><span class="line">        tcp_initialize_rcv_mss(sk);</span><br><span class="line">        tcp_fast_path_on(tp);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> TCP_FIN_WAIT1:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> tmo;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (req)</span><br><span class="line">            tcp_rcv_synrecv_state_fastopen(sk);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tp-&gt;snd_una != tp-&gt;write_seq)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        tcp_set_state(sk, TCP_FIN_WAIT2);</span><br><span class="line">        sk-&gt;sk_shutdown |= SEND_SHUTDOWN;</span><br><span class="line"></span><br><span class="line">        sk_dst_confirm(sk);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!sock_flag(sk, SOCK_DEAD))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* Wake up lingering close() */</span></span><br><span class="line">            sk-&gt;sk_state_change(sk);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tp-&gt;linger2 &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            tcp_done(sk);</span><br><span class="line">            NET_INC_STATS(sock_net(sk), LINUX_MIB_TCPABORTONDATA);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (TCP_SKB_CB(skb)-&gt;end_seq != TCP_SKB_CB(skb)-&gt;seq &amp;&amp;</span><br><span class="line">            after(TCP_SKB_CB(skb)-&gt;end_seq - th-&gt;fin, tp-&gt;rcv_nxt))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* Receive out of order FIN after close() */</span></span><br><span class="line">            <span class="keyword">if</span> (tp-&gt;syn_fastopen &amp;&amp; th-&gt;fin)</span><br><span class="line">                tcp_fastopen_active_disable(sk);</span><br><span class="line">            tcp_done(sk);</span><br><span class="line">            NET_INC_STATS(sock_net(sk), LINUX_MIB_TCPABORTONDATA);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        tmo = tcp_fin_time(sk);</span><br><span class="line">        <span class="keyword">if</span> (tmo &gt; TCP_TIMEWAIT_LEN)</span><br><span class="line">        &#123;</span><br><span class="line">            inet_csk_reset_keepalive_timer(sk, tmo - TCP_TIMEWAIT_LEN);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (th-&gt;fin || sock_owned_by_user(sk))</span><br><span class="line">        &#123;</span><br><span class="line">            inet_csk_reset_keepalive_timer(sk, tmo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            tcp_time_wait(sk, TCP_FIN_WAIT2, tmo);</span><br><span class="line">            <span class="keyword">goto</span> discard;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> TCP_CLOSING:</span><br><span class="line">        <span class="keyword">if</span> (tp-&gt;snd_una == tp-&gt;write_seq)</span><br><span class="line">        &#123;</span><br><span class="line">            tcp_time_wait(sk, TCP_TIME_WAIT, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">goto</span> discard;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> TCP_LAST_ACK:</span><br><span class="line">        <span class="keyword">if</span> (tp-&gt;snd_una == tp-&gt;write_seq)</span><br><span class="line">        &#123;</span><br><span class="line">            tcp_update_metrics(sk);</span><br><span class="line">            tcp_done(sk);</span><br><span class="line">            <span class="keyword">goto</span> discard;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* step 6: check the URG bit */</span></span><br><span class="line">    tcp_urg(sk, skb, th);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* step 7: process the segment text */</span></span><br><span class="line">    <span class="keyword">switch</span> (sk-&gt;sk_state)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> TCP_CLOSE_WAIT:</span><br><span class="line">    <span class="keyword">case</span> TCP_CLOSING:</span><br><span class="line">    <span class="keyword">case</span> TCP_LAST_ACK:</span><br><span class="line">        <span class="keyword">if</span> (!before(TCP_SKB_CB(skb)-&gt;seq, tp-&gt;rcv_nxt))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (sk_is_mptcp(sk))</span><br><span class="line">                mptcp_incoming_options(sk, skb, &amp;tp-&gt;rx_opt);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* fall through */</span></span><br><span class="line">    <span class="keyword">case</span> TCP_FIN_WAIT1:</span><br><span class="line">    <span class="keyword">case</span> TCP_FIN_WAIT2:</span><br><span class="line">        <span class="keyword">if</span> (sk-&gt;sk_shutdown &amp; RCV_SHUTDOWN)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (TCP_SKB_CB(skb)-&gt;end_seq != TCP_SKB_CB(skb)-&gt;seq &amp;&amp;</span><br><span class="line">                after(TCP_SKB_CB(skb)-&gt;end_seq - th-&gt;fin, tp-&gt;rcv_nxt))</span><br><span class="line">            &#123;</span><br><span class="line">                NET_INC_STATS(sock_net(sk), LINUX_MIB_TCPABORTONDATA);</span><br><span class="line">                tcp_reset(sk);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Fall through */</span></span><br><span class="line">    <span class="keyword">case</span> TCP_ESTABLISHED:</span><br><span class="line">        tcp_data_queue(sk, skb);</span><br><span class="line">        queued = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* tcp_data could move socket to TIME-WAIT */</span></span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_state != TCP_CLOSE)</span><br><span class="line">    &#123;</span><br><span class="line">        tcp_data_snd_check(sk);</span><br><span class="line">        tcp_ack_snd_check(sk);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!queued)</span><br><span class="line">    &#123;</span><br><span class="line">    discard:</span><br><span class="line">        tcp_drop(sk, skb);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(tcp_rcv_state_process);</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç»§ç»­ç‚¹è¿› tcp_v4_conn_request çœ‹çœ‹ï¼Œå®ƒé¦–å…ˆä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦å›å¤ä¸€ä¸ªå¹¿æ’­æˆ–è€…å¤šæ’­ï¼Œå¦‚æœéƒ½ä¸éœ€è¦ï¼Œå°±è°ƒç”¨ tcp_conn_requestã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_v4_conn_request</span><span class="params">(struct sock *sk, struct sk_buff *skb)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* Never answer to SYNs send to broadcast or multicast */</span></span><br><span class="line">    <span class="keyword">if</span> (skb_rtable(skb)-&gt;rt_flags &amp; (RTCF_BROADCAST | RTCF_MULTICAST))</span><br><span class="line">        <span class="keyword">goto</span> drop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tcp_conn_request(&amp;tcp_request_sock_ops, &amp;tcp_request_sock_ipv4_ops, sk, skb);</span><br><span class="line"></span><br><span class="line">drop:</span><br><span class="line">    tcp_listendrop(sk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(tcp_v4_conn_request);</span><br></pre></td></tr></table></figure>
<p>ç„¶åè¿›å…¥ tcp_conn_requestï¼Œæˆ‘ä»¬å…ˆçœ‹å‚æ•°ï¼Œä»ä¼ å…¥çš„å‚æ•°æˆ‘ä»¬èƒ½æ‰¾åˆ°å®ƒä»¬å¯¹åº”çš„æ“ä½œåˆ°åº•æ˜¯ä»€ä¹ˆï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tcp_request_sock_ops - rsk_ops</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">request_sock_ops</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> family;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> obj_size;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *slab_name;</span><br><span class="line">    <span class="keyword">int</span> (*rtx_syn_ack)(<span class="keyword">const</span> struct sock *sk,</span><br><span class="line">                       struct request_sock *req);</span><br><span class="line">    <span class="keyword">void</span> (*send_ack)(<span class="keyword">const</span> struct sock *sk, struct sk_buff *skb,</span><br><span class="line">                     struct request_sock *req);</span><br><span class="line">    <span class="keyword">void</span> (*send_reset)(<span class="keyword">const</span> struct sock *sk,</span><br><span class="line">                       struct sk_buff *skb);</span><br><span class="line">    <span class="keyword">void</span> (*destructor)(struct request_sock *req);</span><br><span class="line">    <span class="keyword">void</span> (*syn_ack_timeout)(<span class="keyword">const</span> struct request_sock *req);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">request_sock_ops</span> <span class="title">tcp_request_sock_ops</span> __<span class="title">read_mostly</span> = &#123;</span></span><br><span class="line">    .family = PF_INET,</span><br><span class="line">    .obj_size = <span class="keyword">sizeof</span>(struct tcp_request_sock),</span><br><span class="line">    .rtx_syn_ack = tcp_rtx_synack,</span><br><span class="line">    .send_ack = tcp_v4_reqsk_send_ack,</span><br><span class="line">    .destructor = tcp_v4_reqsk_destructor,</span><br><span class="line">    .send_reset = tcp_v4_send_reset,</span><br><span class="line">    .syn_ack_timeout = tcp_syn_ack_timeout,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tcp_request_sock_ipv4_ops - af_ops</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcp_request_sock_ops</span> &#123;</span></span><br><span class="line">    u16 mss_clamp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TCP_MD5SIG</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_md5sig_key</span> *(*<span class="title">req_md5_lookup</span>)(<span class="title">const</span> <span class="title">struct</span> <span class="title">sock</span> *<span class="title">sk</span>,</span></span><br><span class="line"><span class="class">                                             <span class="title">const</span> <span class="title">struct</span> <span class="title">sock</span> *<span class="title">addr_sk</span>);</span></span><br><span class="line">    <span class="keyword">int</span> (*calc_md5_hash)(<span class="keyword">char</span> *location,</span><br><span class="line">                         <span class="keyword">const</span> struct tcp_md5sig_key *md5,</span><br><span class="line">                         <span class="keyword">const</span> struct sock *sk,</span><br><span class="line">                         <span class="keyword">const</span> struct sk_buff *skb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">void</span> (*init_req)(struct request_sock *req,</span><br><span class="line">                     <span class="keyword">const</span> struct sock *sk_listener,</span><br><span class="line">                     struct sk_buff *skb);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYN_COOKIES</span></span><br><span class="line">    __u32 (*cookie_init_seq)(<span class="keyword">const</span> struct sk_buff *skb, __u16 *mss);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span> *(*<span class="title">route_req</span>)(<span class="title">const</span> <span class="title">struct</span> <span class="title">sock</span> *<span class="title">sk</span>, <span class="title">struct</span> <span class="title">flowi</span> *<span class="title">fl</span>,</span></span><br><span class="line"><span class="class">                                   <span class="title">const</span> <span class="title">struct</span> <span class="title">request_sock</span> *<span class="title">req</span>);</span></span><br><span class="line">    u32 (*init_seq)(<span class="keyword">const</span> struct sk_buff *skb);</span><br><span class="line">    u32 (*init_ts_off)(<span class="keyword">const</span> struct net *net, <span class="keyword">const</span> struct sk_buff *skb);</span><br><span class="line">    <span class="keyword">int</span> (*send_synack)(<span class="keyword">const</span> struct sock *sk, struct dst_entry *dst,</span><br><span class="line">                       struct flowi *fl, struct request_sock *req,</span><br><span class="line">                       struct tcp_fastopen_cookie *foc,</span><br><span class="line">                       <span class="keyword">enum</span> tcp_synack_type synack_type);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcp_request_sock_ops</span> <span class="title">tcp_request_sock_ipv4_ops</span> = &#123;</span></span><br><span class="line">    .mss_clamp = TCP_MSS_DEFAULT,</span><br><span class="line">#ifdef CONFIG_TCP_MD5SIG</span><br><span class="line">    .req_md5_lookup = tcp_v4_md5_lookup,</span><br><span class="line">    .calc_md5_hash = tcp_v4_md5_hash_skb,</span><br><span class="line">#endif</span><br><span class="line">    .init_req = tcp_v4_init_req,</span><br><span class="line">#ifdef CONFIG_SYN_COOKIES</span><br><span class="line">    .cookie_init_seq = cookie_v4_init_sequence,</span><br><span class="line">#endif</span><br><span class="line">    .route_req = tcp_v4_route_req,</span><br><span class="line">    .init_seq = tcp_v4_init_seq,</span><br><span class="line">    .init_ts_off = tcp_v4_init_ts_off,</span><br><span class="line">    .send_synack = tcp_v4_send_synack,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å›åˆ° tcp_conn_requestï¼Œåœ¨é‡Œé¢å¯¹ SYN-ACK åŒ…è¿›è¡Œäº†åˆå§‹åŒ–ã€è·¯ç”±ã€æœ€åè°ƒç”¨ tcp_v4_send_synack å‘é€ï¼Œéœ€è¦æ³¨æ„ï¼ŒæœåŠ¡ç«¯å›å¤äº† SYN-ACK ä¹‹åå°±å¤„äº TCP_SYN_RECV çŠ¶æ€äº†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">tcp_conn_request</span><span class="params">(struct request_sock_ops *rsk_ops,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> struct tcp_request_sock_ops *af_ops,</span></span></span><br><span class="line"><span class="function"><span class="params">                     struct sock *sk, struct sk_buff *skb)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_fastopen_cookie</span> <span class="title">foc</span> = &#123;</span>.len = <span class="number">-1</span>&#125;;</span><br><span class="line">    __u32 isn = TCP_SKB_CB(skb)-&gt;tcp_tw_isn;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_options_received</span> <span class="title">tmp_opt</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> = <span class="title">sock_net</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">fastopen_sk</span> = <span class="title">NULL</span>;</span></span><br><span class="line">    <span class="comment">// struct request_sock ç”¨äºè¡¨ç¤ºä¸€ä¸ªè¿æ¥è¯·æ±‚çš„ sock ç»“æ„, å¯ä»¥ç†è§£ä¸º tcp_request_sock çš„çˆ¶ç±»</span></span><br><span class="line">    <span class="comment">// å…·ä½“çš„åµŒå¥—ä¸º request_sock - inet_request_sock - tcp_request_sock</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">request_sock</span> *<span class="title">req</span>;</span></span><br><span class="line">    <span class="keyword">bool</span> want_cookie = <span class="literal">false</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dst_entry</span> *<span class="title">dst</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">flowi</span> <span class="title">fl</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((net-&gt;ipv4.sysctl_tcp_syncookies == <span class="number">2</span> || inet_csk_reqsk_queue_is_full(sk)) &amp;&amp; !isn) &#123;</span><br><span class="line">        want_cookie = tcp_syn_flood_action(sk, rsk_ops-&gt;slab_name);</span><br><span class="line">        <span class="keyword">if</span> (!want_cookie)</span><br><span class="line">            <span class="keyword">goto</span> drop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sk_acceptq_is_full(sk)) &#123;</span><br><span class="line">        NET_INC_STATS(sock_net(sk), LINUX_MIB_LISTENOVERFLOWS);</span><br><span class="line">        <span class="keyword">goto</span> drop;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ºä¸€ä¸ª struct request_sock åˆ†é…ç©ºé—´</span></span><br><span class="line">    req = inet_reqsk_alloc(rsk_ops, sk, !want_cookie);</span><br><span class="line">    <span class="keyword">if</span> (!req)</span><br><span class="line">        <span class="keyword">goto</span> drop;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿®æ”¹ struct tcp_request_sock å¯¹åº”çš„æ“ä½œä¸º tcp_request_sock_ops</span></span><br><span class="line">    tcp_rsk(req)-&gt;af_specific = af_ops;</span><br><span class="line">    tcp_rsk(req)-&gt;ts_off = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_MPTCP)</span></span><br><span class="line">    tcp_rsk(req)-&gt;is_mptcp = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    tcp_clear_options(&amp;tmp_opt);</span><br><span class="line">    tmp_opt.mss_clamp = af_ops-&gt;mss_clamp;</span><br><span class="line">    tmp_opt.user_mss = tp-&gt;rx_opt.user_mss;</span><br><span class="line">    tcp_parse_options(sock_net(sk), skb, &amp;tmp_opt, <span class="number">0</span>, want_cookie ? <span class="literal">NULL</span> : &amp;foc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (want_cookie &amp;&amp; !tmp_opt.saw_tstamp)</span><br><span class="line">        tcp_clear_options(&amp;tmp_opt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IS_ENABLED(CONFIG_SMC) &amp;&amp; want_cookie)</span><br><span class="line">        tmp_opt.smc_ok = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    tmp_opt.tstamp_ok = tmp_opt.saw_tstamp;</span><br><span class="line">    tcp_openreq_init(req, &amp;tmp_opt, skb, sk);</span><br><span class="line">    inet_rsk(req)-&gt;no_srccheck = inet_sk(sk)-&gt;transparent;</span><br><span class="line"></span><br><span class="line">    inet_rsk(req)-&gt;ir_iif = inet_request_bound_dev_if(sk, skb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ tcp_v4_init_req åˆå§‹åŒ– SYN-ACK çš„å“åº”åŒ…</span></span><br><span class="line">    af_ops-&gt;init_req(req, sk, skb);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IS_ENABLED(CONFIG_MPTCP) &amp;&amp; want_cookie)</span><br><span class="line">        tcp_rsk(req)-&gt;is_mptcp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (security_inet_conn_request(sk, skb, req))</span><br><span class="line">        <span class="keyword">goto</span> drop_and_free;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tmp_opt.tstamp_ok)</span><br><span class="line">        tcp_rsk(req)-&gt;ts_off = af_ops-&gt;init_ts_off(net, skb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ tcp_v4_route_req è¿›è¡Œè·¯ç”±</span></span><br><span class="line">    dst = af_ops-&gt;route_req(sk, &amp;fl, req);</span><br><span class="line">    <span class="keyword">if</span> (!dst)</span><br><span class="line">        <span class="keyword">goto</span> drop_and_free;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!want_cookie &amp;&amp; !isn) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!net-&gt;ipv4.sysctl_tcp_syncookies &amp;&amp;</span><br><span class="line">            (net-&gt;ipv4.sysctl_max_syn_backlog - inet_csk_reqsk_queue_len(sk) &lt;</span><br><span class="line">             (net-&gt;ipv4.sysctl_max_syn_backlog &gt;&gt; <span class="number">2</span>)) &amp;&amp;</span><br><span class="line">            !tcp_peer_is_proven(req, dst)) &#123;</span><br><span class="line">            pr_drop_req(req, ntohs(tcp_hdr(skb)-&gt;source), rsk_ops-&gt;family);</span><br><span class="line">            <span class="keyword">goto</span> drop_and_release;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        isn = af_ops-&gt;init_seq(skb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tcp_ecn_create_request(req, skb, sk, dst);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (want_cookie) &#123;</span><br><span class="line">        isn = cookie_init_sequence(af_ops, sk, skb, &amp;req-&gt;mss);</span><br><span class="line">        req-&gt;cookie_ts = tmp_opt.tstamp_ok;</span><br><span class="line">        <span class="keyword">if</span> (!tmp_opt.tstamp_ok)</span><br><span class="line">            inet_rsk(req)-&gt;ecn_ok = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tcp_rsk(req)-&gt;snt_isn = isn;</span><br><span class="line">    tcp_rsk(req)-&gt;txhash = net_tx_rndhash();</span><br><span class="line">    tcp_openreq_init_rwin(req, sk, dst);</span><br><span class="line">    sk_rx_queue_set(req_to_sk(req), skb);</span><br><span class="line">    <span class="keyword">if</span> (!want_cookie) &#123;</span><br><span class="line">        tcp_reqsk_record_syn(sk, req, skb);</span><br><span class="line">        fastopen_sk = tcp_try_fastopen(sk, skb, req, &amp;foc, dst);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fastopen_sk) &#123;</span><br><span class="line">        af_ops-&gt;send_synack(fastopen_sk, dst, &amp;fl, req,</span><br><span class="line">                            &amp;foc, TCP_SYNACK_FASTOPEN);</span><br><span class="line">        <span class="comment">/* Add the child socket directly into the accept queue */</span></span><br><span class="line">        <span class="keyword">if</span> (!inet_csk_reqsk_queue_add(sk, req, fastopen_sk)) &#123;</span><br><span class="line">            reqsk_fastopen_remove(fastopen_sk, req, <span class="literal">false</span>);</span><br><span class="line">            bh_unlock_sock(fastopen_sk);</span><br><span class="line">            sock_put(fastopen_sk);</span><br><span class="line">            <span class="keyword">goto</span> drop_and_free;</span><br><span class="line">        &#125;</span><br><span class="line">        sk-&gt;sk_data_ready(sk);</span><br><span class="line">        bh_unlock_sock(fastopen_sk);</span><br><span class="line">        sock_put(fastopen_sk);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        tcp_rsk(req)-&gt;tfo_listener = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!want_cookie)</span><br><span class="line">            inet_csk_reqsk_queue_hash_add(sk, req, tcp_timeout_init((struct sock *)req));</span><br><span class="line">        <span class="comment">// è°ƒç”¨ tcp_v4_send_synack å‘é€ synack</span></span><br><span class="line">        af_ops-&gt;send_synack(sk, dst, &amp;fl, req, &amp;foc,</span><br><span class="line">                            !want_cookie ? TCP_SYNACK_NORMAL : TCP_SYNACK_COOKIE);</span><br><span class="line">        <span class="keyword">if</span> (want_cookie) &#123;</span><br><span class="line">            reqsk_free(req);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    reqsk_put(req);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">drop_and_release:</span><br><span class="line">    dst_release(dst);</span><br><span class="line">drop_and_free:</span><br><span class="line">    __reqsk_free(req);</span><br><span class="line">drop:</span><br><span class="line">    tcp_listendrop(sk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(tcp_conn_request);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬ä»ç„¶å¿½ç•¥ç½‘ç»œåŒ…å‘é€çš„åº•å±‚è¿‡ç¨‹ï¼Œå‡è®¾è¿™ä¸ª SYN-ACK æˆåŠŸå‘é€äº†ï¼Œé‚£ä¹ˆç°åœ¨åˆå›åˆ°äº†å®¢æˆ·ç«¯æ”¶åŒ…çš„çŠ¶æ€ï¼Œè¿˜è®°å¾—å‰é¢æœåŠ¡ç«¯æ”¶åŒ…çš„æ—¶å€™è°ƒç”¨çš„ tcp_rcv_state_process å—ï¼Œå®¢æˆ·ç«¯è¿™é‡Œä¾ç„¶ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œåªæ˜¯å®¢æˆ·ç«¯èµ°çš„æ˜¯ TCP_SYN_SENT è¿™ä¸ªæµç¨‹äº†ï¼Œä¼šè¿›å…¥ tcp_rcv_synsent_state_process å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸­ä¼šè°ƒç”¨ tcp_send_ackï¼Œæœ€åè°ƒç”¨ tcp_transmit_skb å‘å‡ºè¿™ä¸ª ACK-ACKï¼Œå‘é€ä¹‹åçš„å®¢æˆ·ç«¯è¿›å…¥äº† TCP_ESTABLISHED çŠ¶æ€ã€‚<br>
æœåŠ¡ç«¯æ”¶åˆ°ç½‘ç»œåŒ…åä»ç„¶ä¼šè¿›å…¥ tcp_rcv_state_process å‡½æ•°ï¼Œå› ä¸ºæœåŠ¡ç«¯æ­¤æ—¶å¤„äº TCP_SYN_RECV çŠ¶æ€ï¼Œå®ƒèµ°å¯¹åº”çš„åˆ†æ”¯æœ€åä¹Ÿä¼šå¤„äº TCP_ESTABLISHED çŠ¶æ€ï¼Œä¸‰æ¬¡æ¡æ‰‹ç»“æŸã€‚</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linux-Kernel</tag>
        <tag>Socket</tag>
      </tags>
  </entry>
  <entry>
    <title>æµ…æ Linux å†…æ ¸ï¼šé“¾è¡¨çš„å®ç°</title>
    <url>/posts/e0e3a2af/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>è§£æ Linux å†…æ ¸ä¸­é“¾è¡¨çš„å®ç°æ–¹å¼</li>
</ul>
</blockquote>
<a id="more"></a>
<p>ç›¸ä¿¡é˜…è¯»è¿‡ Linux æºç çš„æœ‹å‹éƒ½å‘ç°äº†ä¸€ä¸ªå†…æ ¸ä¸­å¥‡æ€ªçš„å†™æ³•ï¼š<br>
æ™®é€šçš„é“¾è¡¨æ˜¯åœ¨æ•°æ®ç»“æ„ä¸­åµŒå…¥è¯¥ç»“æ„çš„æŒ‡é’ˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linkNode</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">linkNode</span>* <span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è€Œ Linux å†…æ ¸ä¸­æ˜¯å°†é“¾è¡¨ç»“ç‚¹åˆ‡åµŒå…¥æ•°æ®ç»“æ„ä¸­ï¼Œè¯¥ç»“æ„å®šä¹‰åœ¨ <code>/include/linux/types.h</code> ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸ªéœ€è¦ç”¨é“¾è¡¨è¿æ¥çš„ç»“æ„é‡Œé¢éƒ½ä¼šåŒ…å«è¿™æ ·ä¸€ä¸ªæˆå‘˜å¯¹è±¡ï¼Œè¿™äº›ç»“æ„çš„ç›¸è¿å…¶å®å°±æ˜¯ <code>struct list_head</code> çš„ç›¸è¿ï¼Œé‚£ä¹ˆé€šè¿‡é“¾è¡¨ç»“ç‚¹æ‰¾åˆ°æ‰€å±çš„ç»“æ„å°±éœ€è¦é€šè¿‡ä¸‹é¢çš„è½¬æ¢ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * list_entry å®ç”¨äºè·å–é“¾è¡¨é¡¹å¯¹åº”çš„ç»“æ„</span></span><br><span class="line"><span class="comment"> * @ptr: struct list_head ç±»å‹çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * @type: struct list_head æ‰€åµŒå…¥çš„ç»“æ„çš„ç±»å‹</span></span><br><span class="line"><span class="comment"> * @member: è¯¥ç»“æ„ä¸­ struct list_head çš„åå­—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> list_entry(ptr, type, member) \</span></span><br><span class="line">    container_of(ptr, type, member)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * container_of å®èƒ½å¤Ÿé€šè¿‡ä¸€ä¸ªæˆå‘˜å˜é‡è½¬æ¢å‡ºåŒ…å«å®ƒçš„ç»“æ„ä½“</span></span><br><span class="line"><span class="comment"> * @ptr: ç»“æ„ä½“æˆå‘˜çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * @type: ç»“æ„ä½“æˆå‘˜æ‰€åµŒå…¥çš„ç»“æ„çš„ç±»å‹</span></span><br><span class="line"><span class="comment"> * @member: è¯¥ç»“æ„ä¸­å¯¹åº”ç»“æ„ä½“æˆå‘˜çš„åå­—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> container_of(ptr, type, member) (&#123;  \</span></span><br><span class="line">    <span class="keyword">void</span> *__mptr = (<span class="keyword">void</span> *)(ptr);           \</span><br><span class="line">    BUILD_BUG_ON_MSG(!__same_type(*(ptr), ((type *)<span class="number">0</span>)-&gt;member) &amp;&amp; \</span><br><span class="line">        !__same_type(*(ptr), <span class="keyword">void</span>), <span class="string">"pointer type mismatch in container_of()"</span>); \</span><br><span class="line">    ((type *)(__mptr - offsetof(type, member))); &#125;)</span><br></pre></td></tr></table></figure>
<p>ä¸éš¾çœ‹å‡ºï¼Œä½¿ç”¨ <code>container_of</code> å®èƒ½å¤Ÿå–å‡ºé“¾è¡¨æŒ‡é’ˆçš„çˆ¶ç»“æ„ï¼Œæˆ‘ä»¬é€ä¸ªæ¥åˆ†æã€‚<br>
è¿™é‡Œæˆ‘ä»¬å°±å‡è®¾ <code>container_of</code> ä¸­çš„ ptr å°±æ˜¯ struct list_head ç±»å‹çš„æŒ‡é’ˆï¼Œé¦–å…ˆè¯¥ ptr ä¼šè¢«å¼ºåˆ¶è½¬æ¢ä¸º void ç±»å‹çš„æŒ‡é’ˆå¹¶èµ‹å€¼ç»™ __mptrã€‚<br>
<code>BUILD_BUG_ON_MSG</code> è¿™ä¸ªå®ä¼šåœ¨å‚æ•° condition ä¸º true çš„æ—¶å€™æŠ¥é”™å¹¶åœæ­¢ç¼–è¯‘åŒæ—¶è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼Œè¿™é‡Œå¯ä»¥çœ‹å‡ºè¯¥å®æ£€æŸ¥çš„æ˜¯æˆ‘ä»¬ä½œä¸ºå‚æ•°ä¼ å…¥æŒ‡é’ˆç±»å‹ä¸æˆ‘ä»¬æƒ³è¦å–å‡ºçš„ç»“æ„ä¸­å¯¹åº”çš„ç±»å‹æ˜¯å¦åŒ¹é…ã€‚<br>
ANSI C æ ‡å‡†å…è®¸å¸¸é‡ 0 å€¼è¢«å¼ºåˆ¶è½¬æ¢ä¸ºä»»ä½•ä¸€ç§ç±»å‹çš„æŒ‡é’ˆï¼Œ<code>((type *)0)</code> å°±æ˜¯ä¸€ä¸ªç±»å‹ä¸º type çš„ NULL æŒ‡é’ˆï¼Œå¦‚æœç”¨è¿™ä¸ªæŒ‡é’ˆæ¥å– type ä¸­çš„æˆå‘˜å˜é‡ member æ˜¯éæ³•æ“ä½œï¼Œä½†æ˜¯æˆ‘ä»¬æ‰“å¼€ <code>__same_type</code> çš„å®šä¹‰ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __same_type(a, b) __builtin_types_compatible_p(typeof(a), typeof(b))</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºå®ƒå…¶å®åªæ˜¯å–è¯¥ç»“æ„ä¸­å¯¹åº” member çš„ç±»å‹ <code>typeof(((type *)0)-&gt;member)</code>ï¼Œ<strong>typeof ä¸­çš„å‚æ•°éƒ¨åˆ†æ˜¯ä¸ä¼šç”Ÿæˆä»£ç ä¹Ÿä¸ä¼šæ‰§è¡Œçš„</strong>ã€‚<br>
å†çœ‹ <code>offsetof</code>ï¼Œå®ƒä¹Ÿæ˜¯ä½¿ç”¨äº†åŒæ ·çš„æ–¹å¼ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> offsetof(TYPE, MEMBER)    ((size_t)&amp;((TYPE *)0)-&gt;MEMBER)</span></span><br></pre></td></tr></table></figure>
<p><code>&amp;((TYPE *)0)-&gt;MEMBER)</code> èƒ½å¤Ÿå–å‡ºæ•°æ®æˆå‘˜çš„åç§»åœ°å€ï¼Œç„¶åç”¨ __mptr å‡å»è¿™ä¸ªåç§»åœ°å€ï¼Œå°±èƒ½å¾—åˆ°è¿™ä¸ªé“¾è¡¨æ‰€åœ¨ç»“æ„çš„é¦–åœ°å€ï¼Œæœ€åå°†å…¶å¼ºåˆ¶è½¬æ¢ä¸º type ç±»å‹çš„æŒ‡é’ˆï¼Œå°±å¾—åˆ°äº† struct list_head æ‰€åµŒå…¥çš„ç»“æ„ä½“æŒ‡é’ˆã€‚</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linked-List</tag>
        <tag>Linux-Kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>æµ…æ Linux å†…æ ¸ï¼šSocket çš„åˆ›å»ºä¸ç›¸å…³ç³»ç»Ÿè°ƒç”¨çš„å®ç°</title>
    <url>/posts/89581d24/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>å‰–æ socket ç³»ç»Ÿè°ƒç”¨çš„å†…æ ¸å®ç°</li>
<li>å‰–æ bindã€listenã€accept ç³»ç»Ÿè°ƒç”¨çš„å†…æ ¸å®ç°</li>
</ul>
</blockquote>
<a id="more"></a>
<p>äº”ä¸€åœ¨å®¶èŠ±äº†ä¸¤å¤©æ—¶é—´å°† Linux ç½‘ç»œç³»ç»Ÿä¸­çš„æºç çœ‹äº†ä¸ªå¤§æ¦‚ï¼Œåœ¨æ­¤æ€»ç»“ï¼Œä»¥å…é—å¿˜ã€‚ç›¸æ¯”äº UDPï¼ŒTCP çš„ä¸‰æ¬¡æ¡æ‰‹æ˜¯åœ¨å†…æ ¸ä¸­å®Œæˆçš„ï¼Œä»£ç ä¼šæ¯” UDP æ›´åŠ å¤æ‚ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å°±åªåˆ†æ TCPï¼ŒUDP çš„å¦‚æœåé¢æœ‰æ—¶é—´å†æ›´æ–°ã€‚<br>
é‚£ä¹ˆå°±æŒ‰ç…§æœ€åŸºç¡€çš„ç½‘ç»œç¼–ç¨‹çš„è¿‡ç¨‹æ¥ä¸€æ­¥æ­¥åˆ†æï¼Œåˆ†åˆ«æ˜¯ â€œåˆ›å»º socketâ€ã€â€œç»‘å®šç«¯å£ bindâ€ã€â€œç›‘å¬ç«¯å£ listenâ€ã€â€œå®¢æˆ·ç«¯è¿æ¥ connectâ€ã€â€œæœåŠ¡ç«¯å–å‡ºè¿æ¥ acceptâ€ äº”ä¸ªéƒ¨åˆ†ã€‚<br>
å®¢æˆ·ç«¯è¿æ¥ connect æ¶‰åŠäº†ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ï¼Œä¸ºäº†å‡å°‘ç¯‡å¹…ï¼Œå•ç‹¬å°†è¿™ä¸ªéƒ¨åˆ†æå‡ºæ¥æ”¾åœ¨ä¸‹ä¸€ç¯‡è®²è¿°ã€‚<br>
å†…æ ¸ä»£ç ç”¨çš„æ˜¯ Linux v5.6.10ï¼Œ<a href="https://elixir.bootlin.com/linux/latest/source" target="_blank" rel="noopener">ä»£ç åœ¨çº¿åœ°å€</a></p>
<h2 id="åˆ›å»º-socket">åˆ›å»º socket</h2>
<p>socket ç³»ç»Ÿè°ƒç”¨çš„ä»£ç ä½äº <code>/net/socket.c</code> ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE3(socket, <span class="keyword">int</span>, family, <span class="keyword">int</span>, type, <span class="keyword">int</span>, protocol) &#123;</span><br><span class="line">    <span class="keyword">return</span> __sys_socket(family, type, protocol);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä»£ç å…¶å®åªæ˜¯è°ƒç”¨äº† <code>__sys_socket</code>ï¼Œä¹‹æ‰€ä»¥è¦è¿™æ ·åŒ…è£…ä¸€ä¸‹ï¼Œæ˜¯ä¸ºäº†è§£å†³åœ¨ 64 ä½ç³»ç»Ÿä¸­ï¼ŒåŸå…ˆçš„ 32 ä½å‚æ•°å­˜æ”¾åœ¨ 64 ä½å¯„å­˜å™¨ä¸­ä¼šå‡ºç°ç¬¦å·æ‰©å±•å‡ºé”™çš„æƒ…å†µï¼Œå¯¼è‡´ç³»ç»Ÿæ¼æ´ï¼Œç°åœ¨çš„åšæ³•å…¶å®å°±æ˜¯å°†ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ç»Ÿä¸€ä½¿ç”¨ long ç±»å‹æ¥æ”¶ï¼Œå†å¼ºåˆ¶è½¬æ¢ä¸º intï¼ŒLinux å†…æ ¸ä¸­è¿˜æœ‰å¾ˆå¤šè¿™ç§ç±»ä¼¼çš„ä¿®ä¿®è¡¥è¡¥ï¼Œä»¥åæœ‰æœºä¼šæˆ‘ä»¬éƒ½èƒ½çœ‹åˆ°ã€‚<br>
ä¸‹é¢æˆ‘ä»¬æ¥çœ‹åœ¨ <code>__sys_socket</code> ä¸­åšäº†äº›ä»€ä¹ˆï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @family: åè®®æ—, AF_INET/AF_UNIX</span></span><br><span class="line"><span class="comment"> * @type: é€šä¿¡ç±»å‹, SOCK_STREAM/SOCK_DGRAM/SOCK_RAW</span></span><br><span class="line"><span class="comment"> * @protocol: é€šä¿¡åè®®, ç°åœ¨åŸºæœ¬å·²ç»åºŸå¼ƒ, å› ä¸ºåè®®å·²ç»é€šè¿‡ä¸Šé¢ä¸¤ä¸ªå‚æ•°æŒ‡å®šäº†, ä¸€èˆ¬å†™ä¸º 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> __sys_socket(<span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol) &#123;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">    <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// BUILD_BUG_ON åœ¨åé¢å‚æ•°ä¸º true çš„æ—¶å€™ç¼–è¯‘é”™è¯¯, æ˜¯ä¸€ç§é™æ€æ£€æŸ¥æœºåˆ¶</span></span><br><span class="line">    BUILD_BUG_ON(SOCK_CLOEXEC != O_CLOEXEC);</span><br><span class="line">    BUILD_BUG_ON((SOCK_MAX | SOCK_TYPE_MASK) != SOCK_TYPE_MASK);</span><br><span class="line">    BUILD_BUG_ON(SOCK_CLOEXEC &amp; SOCK_TYPE_MASK);</span><br><span class="line">    BUILD_BUG_ON(SOCK_NONBLOCK &amp; SOCK_TYPE_MASK);</span><br><span class="line"></span><br><span class="line">    flags = type &amp; ~SOCK_TYPE_MASK;</span><br><span class="line">    <span class="keyword">if</span> (flags &amp; ~(SOCK_CLOEXEC | SOCK_NONBLOCK))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    type &amp;= SOCK_TYPE_MASK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SOCK_NONBLOCK != O_NONBLOCK &amp;&amp; (flags &amp; SOCK_NONBLOCK))</span><br><span class="line">        flags = (flags &amp; ~SOCK_NONBLOCK) | O_NONBLOCK;</span><br><span class="line"></span><br><span class="line">    retval = sock_create(family, type, protocol, &amp;sock);</span><br><span class="line">    <span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¹‹æ‰€ä»¥ sock_create å‚æ•°éœ€è¦ä½¿ç”¨ struct socket** res</span></span><br><span class="line">    <span class="comment">// å› ä¸º sock_map_fd éœ€è¦ä½¿ç”¨ä¿®æ”¹åçš„ struct socket æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">return</span> sock_map_fd(sock, flags &amp; (O_CLOEXEC | O_NONBLOCK));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‡½æ•°ä¸­é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª <code>struct socket</code>ï¼Œç„¶åç»è¿‡ä¸€ç³»åˆ—çš„å‚æ•°æ£€æŸ¥ï¼Œæœ€ç»ˆåˆ°è¾¾ä¸¤ä¸ªé‡è¦çš„å‡½æ•°ï¼š<br>
ç¬¬ä¸€ä¸ª <code>sock_create</code>ï¼Œå®ƒä¼šåˆ›é€ ä¸€ä¸ª <code>struct socket</code> ç»“æ„æ”¾åœ¨å‰é¢æ„é€ çš„ <code>sock</code> å˜é‡ä¸­ï¼›<br>
ç¬¬äºŒä¸ª <code>sock_map_fd</code>ï¼Œå®ƒä¼šå°†æ–‡ä»¶æè¿°ç¬¦å’Œè¿™ä¸ª <code>struct socket</code> å¯¹åº”èµ·æ¥ï¼Œç„¶åè¿”å› socket å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ã€‚<br>
ç‚¹è¿› <code>sock_create</code>ï¼Œå‘ç°å®ƒåˆæ˜¯ä¸€ä¸ª wrapperï¼Œæ³¨æ„è¿™ä¸ªå‚æ•° res æ˜¯ä¸€ä¸ªäºŒé‡æŒ‡é’ˆï¼Œå› ä¸ºæˆ‘ä»¬åœ¨å¤–å±‚æ˜¯ç”¨æŒ‡é’ˆæ¥æ¥è¿™ä¸ªæ–°å»ºçš„ socketï¼Œè¦ä¿®æ”¹å¹¶ä¿å­˜æŒ‡é’ˆçš„å€¼ï¼Œå°±è¦ä½¿ç”¨æŒ‡é’ˆçš„åœ°å€æ‰è¡Œã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_create</span><span class="params">(<span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> __sock_create(current-&gt;nsproxy-&gt;net_ns, family, type, protocol, res, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(sock_create);</span><br></pre></td></tr></table></figure>
<p>è¿›å…¥ <code>__sock_create</code>ï¼Œè¿™ä¸ªå‡½æ•°ç”¨äºçœŸæ­£åˆ›å»ºä¸€ä¸ªæ–°çš„ socketï¼Œå¹¶ä¸”å°†å®ƒèµ‹å€¼ç»™å‚æ•° resï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @net: net namespace</span></span><br><span class="line"><span class="comment"> * @family: protocol family (AF_INET, ...)</span></span><br><span class="line"><span class="comment"> * @type: communication type (SOCK_STREAM, ...)</span></span><br><span class="line"><span class="comment"> * @protocol: protocol (0, ...)</span></span><br><span class="line"><span class="comment"> * @res: new socket</span></span><br><span class="line"><span class="comment"> * @kern: boolean for kernel space sockets</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> __sock_create(struct net *net, <span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res, <span class="keyword">int</span> kern) &#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">    <span class="comment">// ç”¨äºä¿å­˜ä» net_families æ•°ç»„ä¸­å–å‡ºçš„æŒ‡å®šåè®®çš„åè®®æ—</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> *<span class="title">pf</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­ family å’Œ type å‚æ•°æ˜¯å¦åˆæ³•</span></span><br><span class="line">    <span class="keyword">if</span> (family &lt; <span class="number">0</span> || family &gt;= NPROTO)</span><br><span class="line">        <span class="keyword">return</span> -EAFNOSUPPORT;</span><br><span class="line">    <span class="keyword">if</span> (type &lt; <span class="number">0</span> || type &gt;= SOCK_MAX)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (family == PF_INET &amp;&amp; type == SOCK_PACKET) &#123;</span><br><span class="line">        pr_info_once(<span class="string">"%s uses obsolete (PF_INET,SOCK_PACKET)\n"</span>, current-&gt;comm);</span><br><span class="line">        family = PF_PACKET;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = security_socket_create(family, type, protocol, kern);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é…äº†ä¸€ä¸ªæ–°çš„ inode ç»“ç‚¹ä¸ socket å¯¹è±¡ç»™ sock</span></span><br><span class="line">    sock = sock_alloc();</span><br><span class="line">    <span class="keyword">if</span> (!sock) &#123;</span><br><span class="line">        net_warn_ratelimited(<span class="string">"socket: no more sockets\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENFILE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sock-&gt;type = type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line">    <span class="keyword">if</span> (rcu_access_pointer(net_families[family]) == <span class="literal">NULL</span>)</span><br><span class="line">        request_module(<span class="string">"net-pf-%d"</span>, family);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    rcu_read_lock();</span><br><span class="line">    <span class="comment">// ä» net_families[family] ä¸­å–å‡º family å¯¹åº”çš„ struct net_proto_family ä¿å­˜åœ¨ pf ä¸­</span></span><br><span class="line">    <span class="comment">// åé¢æˆ‘ä»¬éœ€è¦è°ƒç”¨ pf-&gt;create æ¥åˆ›å»º socket</span></span><br><span class="line">    pf = rcu_dereference(net_families[family]);</span><br><span class="line">    err = -EAFNOSUPPORT;</span><br><span class="line">    <span class="keyword">if</span> (!pf)</span><br><span class="line">        <span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆ‘ä»¬éœ€è¦è°ƒç”¨ -&gt;create å‡½æ•°, å®ƒä½äºä¸€ä¸ªå¯åŠ è½½æ¨¡å—ä¸­, å› æ­¤å¿…é¡»å…ˆæ›´æ”¹å¯åŠ è½½æ¨¡å—çš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (!try_module_get(pf-&gt;owner))</span><br><span class="line">        <span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line">    rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// IPv4 ä¸­è°ƒç”¨çš„å…¶å®æ˜¯ inet_create</span></span><br><span class="line">    err = pf-&gt;create(net, sock, protocol, kern);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> out_module_put;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!try_module_get(sock-&gt;ops-&gt;owner))</span><br><span class="line">        <span class="keyword">goto</span> out_module_busy;</span><br><span class="line"></span><br><span class="line">    module_put(pf-&gt;owner);</span><br><span class="line">    err = security_socket_post_create(sock, family, type, protocol, kern);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">goto</span> out_sock_release;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿®æ”¹ä¼ å…¥çš„ res åœ°å€ä¸­çš„å€¼ä¸º sock</span></span><br><span class="line">    *res = sock;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_module_busy:</span><br><span class="line">    err = -EAFNOSUPPORT;</span><br><span class="line">out_module_put:</span><br><span class="line">    sock-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line">    module_put(pf-&gt;owner);</span><br><span class="line">out_sock_release:</span><br><span class="line">    sock_release(sock);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">out_release:</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="keyword">goto</span> out_sock_release;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__sock_create);</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ struct socket çš„å®šä¹‰ï¼Œè¿™ä¸ª ops éœ€è¦æˆ‘ä»¬æ‰¾åˆ° familyã€typeã€protocol ä¸‰è€…éƒ½ç¬¦åˆçš„åè®®æ“ä½œè¿›è¡Œæ›´æ–°ã€‚æ¯ä¸ª struct socket å‘ä¸‹ä¹Ÿéƒ½ä¼šå¯¹åº”ä¸€ä¸ª struct sockï¼Œå®ƒç”¨äºå¤„ç†åº•å±‚çš„ç½‘ç»œåè®®æ ˆï¼Œ<strong>è¿™ä¸ª struct sockï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä¼ è¾“æ§åˆ¶å—ï¼Œå®ƒæ˜¯åè®®æ— å…³çš„</strong>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  struct socket - general BSD socket</span></span><br><span class="line"><span class="comment"> *  @state: socket æ‰€å¤„çŠ¶æ€ SS_CONNECTED ç­‰</span></span><br><span class="line"><span class="comment"> *  @type: socket ç±»å‹ SOCK_STREAM ç­‰</span></span><br><span class="line"><span class="comment"> *  @flags: socket æ ‡å¿—ä½ SOCK_NOSPACE ç­‰</span></span><br><span class="line"><span class="comment"> *  @ops: åè®®æŒ‡å®šçš„ socket æ“ä½œ</span></span><br><span class="line"><span class="comment"> *  @file: æ–‡ä»¶è¿”å›æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> *  @sk: å†…éƒ¨ç½‘ç»œåè®®çš„ socket è¡¨ç¤º</span></span><br><span class="line"><span class="comment"> *  @wq: ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> &#123;</span></span><br><span class="line">    socket_state state;</span><br><span class="line">    short type;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket_wq</span> <span class="title">wq</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬çœ‹ <code>net_families</code> æ•°ç»„çš„å®šä¹‰ï¼Œå®ƒä½äº <code>/net/socket.c</code> çš„èµ·å§‹ä½ç½®ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> family;</span><br><span class="line">    <span class="keyword">int</span> (*create)(struct net *net, struct socket *sock, <span class="keyword">int</span> protocol, <span class="keyword">int</span> kern);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> __<span class="title">rcu</span> *<span class="title">net_families</span>[<span class="title">NPROTO</span>] __<span class="title">read_mostly</span>;</span></span><br></pre></td></tr></table></figure>
<p>ä¸éš¾çœ‹å‡ºï¼Œå®ƒå…¶å®å°±æ˜¯ä¸€ä¸ª <code>struct net_proto_family *</code> ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„çš„ä¸‹æ ‡å°±æ˜¯ family åè®®æ—å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸€ç§åè®®å…¶å®éƒ½æ­£å¥½å¯¹åº”äº†ä¸€ä¸ª <code>struct net_proto_family</code>ï¼Œä»¥ <code>/net/ipv4/af_inet.c</code> ä¸­çš„ <code>inet_family_ops</code> ä¸ºä¾‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> <span class="title">inet_family_ops</span> = &#123;</span></span><br><span class="line">    .family = PF_INET,</span><br><span class="line">    <span class="comment">// è¿™é‡Œå°† IPv4 åè®®æ—ä¸­åˆ›å»º socket çš„å‡½æ•°è®¾ç½®ä¸º inet_create</span></span><br><span class="line">    .create = inet_create,</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥çœ‹ <code>inet_create</code> çš„å®ç°ï¼Œå®ƒä½äº <code>/net/ipv4/af_inet.c</code> ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @net: net namespace</span></span><br><span class="line"><span class="comment"> * @sock: è¿™ä¸ª sock æ˜¯æ–°å»ºçš„ struct socket ç±»å‹æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * @protocol: protocol (0, ...)</span></span><br><span class="line"><span class="comment"> * @kern: boolean for kernel space sockets</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">inet_create</span><span class="params">(struct net *net, struct socket *sock, <span class="keyword">int</span> protocol, <span class="keyword">int</span> kern)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™ä¸ª struct sock éœ€è¦å’Œ struct socket åŒºåˆ†</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ª answer æŒ‡å‘çš„å°±æ˜¯ family type protocol éƒ½ç¬¦åˆçš„ struct inet_protosw</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> *<span class="title">answer</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span>;</span></span><br><span class="line">    <span class="comment">// è¿™ä¸ª answer_prot ç”¨äºä¿å­˜å†…æ ¸ç½‘ç»œåè®®æ ˆçš„ socket æ“ä½œ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proto</span> *<span class="title">answer_prot</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> answer_flags;</span><br><span class="line">    <span class="keyword">int</span> try_loading_module = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (protocol &lt; <span class="number">0</span> || protocol &gt;= IPPROTO_MAX)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– socket çš„çŠ¶æ€åº”è¯¥æ˜¯ SS_UNCONNECTED</span></span><br><span class="line">    sock-&gt;state = SS_UNCONNECTED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾æ‰€éœ€çš„ç±»å‹/åè®®å¯¹</span></span><br><span class="line">lookup_protocol:</span><br><span class="line">    err = -ESOCKTNOSUPPORT;</span><br><span class="line">    rcu_read_lock();</span><br><span class="line">    <span class="comment">// inetsw æ•°ç»„ä¸‹æ ‡ä¸º type</span></span><br><span class="line">    list_for_each_entry_rcu(answer, &amp;inetsw[sock-&gt;type], <span class="built_in">list</span>) &#123;</span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (protocol == answer-&gt;protocol) &#123;</span><br><span class="line">            <span class="keyword">if</span> (protocol != IPPROTO_IP)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (IPPROTO_IP == protocol) &#123;</span><br><span class="line">                protocol = answer-&gt;protocol;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (IPPROTO_IP == answer-&gt;protocol)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        err = -EPROTONOSUPPORT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(err)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (try_loading_module &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (++try_loading_module == <span class="number">1</span>)</span><br><span class="line">                request_module(<span class="string">"net-pf-%d-proto-%d-type-%d"</span>, PF_INET, protocol, sock-&gt;type);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                request_module(<span class="string">"net-pf-%d-proto-%d"</span>, PF_INET, protocol);</span><br><span class="line">            <span class="keyword">goto</span> lookup_protocol;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">goto</span> out_rcu_unlock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = -EPERM;</span><br><span class="line">    <span class="keyword">if</span> (sock-&gt;type == SOCK_RAW &amp;&amp; !kern &amp;&amp; !ns_capable(net-&gt;user_ns, CAP_NET_RAW))</span><br><span class="line">        <span class="keyword">goto</span> out_rcu_unlock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿®æ”¹æ–°å»ºçš„ struct socket çš„ ops ä¸º answer-&gt;ops</span></span><br><span class="line">    sock-&gt;ops = answer-&gt;ops;</span><br><span class="line">    <span class="comment">// å–å‡º answer çš„åè®®å—ä¸ flags</span></span><br><span class="line">    answer_prot = answer-&gt;prot;</span><br><span class="line">    answer_flags = answer-&gt;flags;</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">    WARN_ON(!answer_prot-&gt;slab);</span><br><span class="line"></span><br><span class="line">    err = -ENOBUFS;</span><br><span class="line">    <span class="comment">// åˆ†é…ä¸€ä¸ª struct sock, æ–°å»º struct sock çš„æ—¶å€™éœ€è¦æŒ‡å®šä½¿ç”¨çš„åè®®æ—ä¸åè®®å—</span></span><br><span class="line">    <span class="comment">// sk-&gt;sk_family = family(PF_INET)</span></span><br><span class="line">    <span class="comment">// sk-&gt;sk_prot = prot(answer_prot)</span></span><br><span class="line">    sk = sk_alloc(net, PF_INET, GFP_KERNEL, answer_prot, kern);</span><br><span class="line">    <span class="keyword">if</span> (!sk)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    err = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (INET_PROTOSW_REUSE &amp; answer_flags)</span><br><span class="line">        sk-&gt;sk_reuse = SK_CAN_REUSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† struct sk* å¼ºåˆ¶è½¬æ¢ä¸º struct inet_sock*</span></span><br><span class="line">    <span class="comment">// åé¢çš„ä»£ç éƒ½æ˜¯å¡«å……è¿™ä¸ª TCP åè®®å¯¹åº”çš„ struct inet_sock, ä¸å†åˆ†æ</span></span><br><span class="line">    inet = inet_sk(sk);</span><br><span class="line">    inet-&gt;is_icsk = (INET_PROTOSW_ICSK &amp; answer_flags) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    inet-&gt;nodefrag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SOCK_RAW == sock-&gt;type) &#123;</span><br><span class="line">        inet-&gt;inet_num = protocol;</span><br><span class="line">        <span class="keyword">if</span> (IPPROTO_RAW == protocol)</span><br><span class="line">            inet-&gt;hdrincl = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (net-&gt;ipv4.sysctl_ip_no_pmtu_disc)</span><br><span class="line">        inet-&gt;pmtudisc = IP_PMTUDISC_DONT;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        inet-&gt;pmtudisc = IP_PMTUDISC_WANT;</span><br><span class="line"></span><br><span class="line">    inet-&gt;inet_id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    sock_init_data(sock, sk);</span><br><span class="line"></span><br><span class="line">    sk-&gt;sk_destruct = inet_sock_destruct;</span><br><span class="line">    sk-&gt;sk_protocol = protocol;</span><br><span class="line">    sk-&gt;sk_backlog_rcv = sk-&gt;sk_prot-&gt;backlog_rcv;</span><br><span class="line"></span><br><span class="line">    inet-&gt;uc_ttl = <span class="number">-1</span>;</span><br><span class="line">    inet-&gt;mc_loop = <span class="number">1</span>;</span><br><span class="line">    inet-&gt;mc_ttl = <span class="number">1</span>;</span><br><span class="line">    inet-&gt;mc_all = <span class="number">1</span>;</span><br><span class="line">    inet-&gt;mc_index = <span class="number">0</span>;</span><br><span class="line">    inet-&gt;mc_list = <span class="literal">NULL</span>;</span><br><span class="line">    inet-&gt;rcv_tos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    sk_refcnt_debug_inc(sk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inet-&gt;inet_num) &#123;</span><br><span class="line">        inet-&gt;inet_sport = htons(inet-&gt;inet_num);</span><br><span class="line">        err = sk-&gt;sk_prot-&gt;hash(sk);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            sk_common_release(sk);</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_prot-&gt;init) &#123;</span><br><span class="line">        err = sk-&gt;sk_prot-&gt;init(sk);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            sk_common_release(sk);</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!kern) &#123;</span><br><span class="line">        err = BPF_CGROUP_RUN_PROG_INET_SOCK(sk);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            sk_common_release(sk);</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">out_rcu_unlock:</span><br><span class="line">    rcu_read_unlock();</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>inet_create</code> ä¸­é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª <code>struct sock</code>ï¼Œè¿™ä¸ªç»“æ„ä½“éå¸¸å¤æ‚ï¼Œå®ƒæ˜¯ socket çš„ç½‘ç»œå±‚è¡¨ç¤ºï¼Œä¸»è¦è´Ÿè´£å‘ä¸‹å¯¹æ¥å†…æ ¸ç½‘ç»œåè®®æ ˆï¼Œè€Œ <code>struct socket</code> æ˜¯ä¼ è¾“å±‚çš„ç»“æ„ï¼Œä¸»è¦è´Ÿè´£å‘ä¸Šä¸ºç”¨æˆ·æœåŠ¡ã€‚<br>
æ¥ç€åˆ›å»ºäº†ä¸€ä¸ª <code>struct inet_protosw</code> ç±»å‹çš„æŒ‡é’ˆ answerï¼Œè¿™ä¸ªç»“æ„ä½“ç”¨äºæ³¨å†Œ IP åè®®çš„å¥—æ¥å­—æ¥å£ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢ä¸¤ä¸ªæˆå‘˜å˜é‡æ„æˆäº†æŸ¥æ‰¾ç”¨çš„ key</span></span><br><span class="line">    <span class="comment">// type æ˜¯ socket çš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line">    <span class="keyword">unsigned</span> short type;</span><br><span class="line">    <span class="keyword">unsigned</span> short protocol;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proto</span> *<span class="title">prot</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬çœ‹ <code>list_for_each_entry_rcu(answer, &amp;inetsw[sock-&gt;type], list)</code> è¿™ä¸ªå¾ªç¯ã€‚<br>
é¦–å…ˆè¦å¼„æ˜ç™½ <code>inetsw[]</code> è¿™ä¸ªæ•°ç»„æ˜¯ä»€ä¹ˆï¼Œä»ä¸‹é¢ <code>inet_init</code> å‡½æ•°ä¸­çš„æ“ä½œèƒ½å¤Ÿçœ‹å‡ºï¼Œinetsw æ•°ç»„ä¸€å¼€å§‹æ˜¯ä¸€ä¸ª <code>struct list_head</code> ç±»å‹çš„æ•°ç»„ï¼Œè¿™é‡Œç”¨åˆ°äº†é“¾è¡¨ï¼Œæ˜¯å› ä¸ºä¸€ä¸ª type å¯èƒ½å¯¹åº”å¤šä¸ª procotolã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">inetsw</span>[<span class="title">SOCK_MAX</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°† inetsw æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½åˆå§‹åŒ–ä¸ºé“¾è¡¨å¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">for</span> (r = &amp;inetsw[<span class="number">0</span>]; r &lt; &amp;inetsw[SOCK_MAX]; ++r)</span><br><span class="line">    INIT_LIST_HEAD(r);</span><br></pre></td></tr></table></figure>
<p>æ¥ç€åœ¨ <code>inet_init</code> å‡½æ•°ä¸­å°†æ•°ç»„ <code>inetsw_array</code> æ³¨å†Œåˆ°æ•°ç»„ <code>inetsw</code> ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// inetsw_array æ•°ç»„çš„æ¯ä¸€é¡¹éƒ½å¯¹åº”ä¸åŒ type/protocol çš„ struct inet_protosw</span></span><br><span class="line"><span class="comment">// å¯åŠ¨æ—¶æˆ‘ä»¬å°† inetsw_array[] ä¸­çš„æ‰€æœ‰å…ƒç´ æ’å…¥åˆ°é“¾è¡¨ inetsw[] ä¸­</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> <span class="title">inetsw_array</span>[] = &#123;</span></span><br><span class="line">    &#123;</span><br><span class="line">        .type = SOCK_STREAM,</span><br><span class="line">        .protocol = IPPROTO_TCP,</span><br><span class="line">        .prot = &amp;tcp_prot,</span><br><span class="line">        .ops = &amp;inet_stream_ops,</span><br><span class="line">        .flags = INET_PROTOSW_PERMANENT | INET_PROTOSW_ICSK,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .type = SOCK_DGRAM,</span><br><span class="line">        .protocol = IPPROTO_UDP,</span><br><span class="line">        .prot = &amp;udp_prot,</span><br><span class="line">        .ops = &amp;inet_dgram_ops,</span><br><span class="line">        .flags = INET_PROTOSW_PERMANENT,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .type = SOCK_DGRAM,</span><br><span class="line">        .protocol = IPPROTO_ICMP,</span><br><span class="line">        .prot = &amp;ping_prot,</span><br><span class="line">        .ops = &amp;inet_sockraw_ops,</span><br><span class="line">        .flags = INET_PROTOSW_REUSE,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .type = SOCK_RAW,</span><br><span class="line">        .protocol = IPPROTO_IP,</span><br><span class="line">        .prot = &amp;raw_prot,</span><br><span class="line">        .ops = &amp;inet_sockraw_ops,</span><br><span class="line">        .flags = INET_PROTOSW_REUSE,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (q = inetsw_array; q &lt; &amp;inetsw_array[INETSW_ARRAY_LEN]; ++q)</span><br><span class="line">    inet_register_protosw(q);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inet_register_protosw</span><span class="params">(struct inet_protosw *p)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">lh</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> *<span class="title">answer</span>;</span></span><br><span class="line">    <span class="comment">// å–å‡ºå½“å‰ struct inet_protosw çš„ protocol</span></span><br><span class="line">    <span class="keyword">int</span> protocol = p-&gt;protocol;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">last_perm</span>;</span></span><br><span class="line"></span><br><span class="line">    spin_lock_bh(&amp;inetsw_lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹æ ‡è¶Šç•Œ error</span></span><br><span class="line">    <span class="keyword">if</span> (p-&gt;type &gt;= SOCK_MAX)</span><br><span class="line">        <span class="keyword">goto</span> out_illegal;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ® p-&gt;type æ‰¾åˆ°ä¸ struct inet_protosw ä¸‹æ ‡å¯¹åº”çš„ inetsw[]</span></span><br><span class="line">    last_perm = &amp;inetsw[p-&gt;type];</span><br><span class="line">    <span class="comment">// #define list_for_each(pos, head) \</span></span><br><span class="line">    <span class="comment">// for (pos = (head)-&gt;next; pos != (head); pos = pos-&gt;next)</span></span><br><span class="line">    <span class="comment">// ä¸€ç›´å¾ªç¯æ‰¾åˆ°æœ€åä¸€é¡¹, ç„¶åå°† &amp;p-&gt;list æŒ‚ä¸Š</span></span><br><span class="line">    list_for_each(lh, &amp;inetsw[p-&gt;type]) &#123;</span><br><span class="line">        <span class="comment">// list_entry ç”¨äºè·å–è¯¥é“¾è¡¨é¡¹çš„ç»“æ„</span></span><br><span class="line">        answer = list_entry(lh, struct inet_protosw, <span class="built_in">list</span>);</span><br><span class="line">        <span class="keyword">if</span> ((INET_PROTOSW_PERMANENT &amp; answer-&gt;flags) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (protocol == answer-&gt;protocol)</span><br><span class="line">            <span class="keyword">goto</span> out_permanent;</span><br><span class="line">        last_perm = lh;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// last_perm-&gt;next = &amp;p-&gt;list</span></span><br><span class="line">    list_add_rcu(&amp;p-&gt;<span class="built_in">list</span>, last_perm);</span><br><span class="line">out:</span><br><span class="line">    spin_unlock_bh(&amp;inetsw_lock);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">out_permanent:</span><br><span class="line">    pr_err(<span class="string">"Attempt to override permanent protocol %d\n"</span>, protocol);</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">out_illegal:</span><br><span class="line">    pr_err(<span class="string">"Ignoring attempt to register invalid socket type %d\n"</span>, p-&gt;type);</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(inet_register_protosw);</span><br></pre></td></tr></table></figure>
<p>å›åˆ° <code>list_for_each_entry_rcu</code> å¾ªç¯ï¼Œè¿™æ—¶å€™å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼Œå®ƒå…¶å®æ˜¯æ ¹æ®æˆ‘ä»¬æŒ‡å®šçš„ç±»å‹ sock-&gt;typeï¼Œåœ¨ inetsw æ•°ç»„ï¼ˆæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼‰å¯¹åº”çš„ <code>inetsw[sock-&gt;type]</code> é“¾è¡¨ä¸­æŸ¥æ‰¾æ¯ä¸€ä¸ª <code>struct inet_protosw</code> ä¸­çš„ protocol æ˜¯å¦æ˜¯ç”¨æˆ·æŒ‡å®šçš„ protocolï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°äº†ä¸ç”¨æˆ·æŒ‡å®š protocolã€‚<br>
åˆ°äº†è¿™é‡Œï¼Œé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨çš„ create å‡½æ•° <code>inet_create</code> æ˜¯ä¸ family å¯¹åº”çš„ï¼Œç„¶åé€‰æ‹©çš„ struct inet_protosw æ˜¯ä¸ type å¯¹åº”çš„ï¼Œæœ€ååœ¨ä¸ type å¯¹åº”çš„é“¾è¡¨ä¸­æ‰¾åˆ°ä¸ protocol å¯¹åº”çš„é‚£ä¸ª <code>struct inet_protosw *answer</code>ã€‚<br>
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®é€‰å‡ºçš„ answer æ¥æ›´æ–°æ–°å»ºçš„ socket çš„æ“ä½œï¼Œä»ä¸Šé¢ struct inet_protosw å°±èƒ½å¤Ÿçœ‹å‡ºï¼Œä»¥ TCP ä¸ºä¾‹ï¼Œanswer å¯¹åº”çš„ ops ä¸º inet_stream_opsï¼Œåé¢é’ˆå¯¹è¿™ä¸ª socket çš„æ‰€æœ‰æ“ä½œä½¿ç”¨çš„éƒ½æ˜¯ inet_stream_opsã€‚</p>
<p>inet_stream_ops å®šä¹‰åœ¨ <code>/net/ipv4/af_inet.c</code> ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> <span class="title">inet_stream_ops</span> = &#123;</span></span><br><span class="line">    .family = PF_INET,</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .<span class="built_in">release</span> = inet_release,</span><br><span class="line">    .bind = inet_bind,</span><br><span class="line">    .<span class="built_in">connect</span> = inet_stream_connect,</span><br><span class="line">    .socketpair = sock_no_socketpair,</span><br><span class="line">    .accept = inet_accept,</span><br><span class="line">    .getname = inet_getname,</span><br><span class="line">    .poll = tcp_poll,</span><br><span class="line">    .ioctl = inet_ioctl,</span><br><span class="line">    .gettstamp = sock_gettstamp,</span><br><span class="line">    .<span class="built_in">listen</span> = inet_listen,</span><br><span class="line">    .<span class="built_in">shutdown</span> = inet_shutdown,</span><br><span class="line">    .setsockopt = sock_common_setsockopt,</span><br><span class="line">    .getsockopt = sock_common_getsockopt,</span><br><span class="line">    .sendmsg = inet_sendmsg,</span><br><span class="line">    .recvmsg = inet_recvmsg,</span><br><span class="line">#ifdef CONFIG_MMU</span><br><span class="line">    .mmap = tcp_mmap,</span><br><span class="line">#endif</span><br><span class="line">    .sendpage = inet_sendpage,</span><br><span class="line">    .splice_read = tcp_splice_read,</span><br><span class="line">    .read_sock = tcp_read_sock,</span><br><span class="line">    .sendmsg_locked = tcp_sendmsg_locked,</span><br><span class="line">    .sendpage_locked = tcp_sendpage_locked,</span><br><span class="line">    .peek_len = tcp_peek_len,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">    .compat_setsockopt = compat_sock_common_setsockopt,</span><br><span class="line">    .compat_getsockopt = compat_sock_common_getsockopt,</span><br><span class="line">    .compat_ioctl = inet_compat_ioctl,</span><br><span class="line">#endif</span><br><span class="line">    .set_rcvlowat = tcp_set_rcvlowat,</span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL(inet_stream_ops);</span><br></pre></td></tr></table></figure>
<p>æ¥ç€åˆå‡ºç°äº†ä¸€ä¸ªæ–°çš„ç»“æ„ <code>struct proto</code>ï¼Œå®ƒå®šä¹‰åœ¨ <code>/include/net/sock.h</code> ä¸­ï¼Œæ˜¯é™„åŠ åœ¨ socket ä¸­çš„ç½‘ç»œå±‚åè®®å—ï¼Œæ˜¯ socket å±‚åˆ°ä¼ è¾“å±‚çš„æ¥å£ï¼Œä»ä¸‹é¢çš„å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªç»“æ„ä½“ä¸­å®šä¹‰çš„éƒ½æ˜¯ <code>struct sock</code> çš„ç›¸å…³æ“ä½œï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">close</span>)(struct sock *sk, <span class="keyword">long</span> timeout);</span><br><span class="line">    <span class="keyword">int</span> (*pre_connect)(struct sock *sk, struct sockaddr *uaddr, <span class="keyword">int</span> addr_len);</span><br><span class="line">    <span class="keyword">int</span> (*<span class="built_in">connect</span>)(struct sock *sk, struct sockaddr *uaddr, <span class="keyword">int</span> addr_len);</span><br><span class="line">    <span class="keyword">int</span> (*<span class="built_in">disconnect</span>)(struct sock *sk, <span class="keyword">int</span> flags);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *(*<span class="title">accept</span>)(<span class="title">struct</span> <span class="title">sock</span> *<span class="title">sk</span>, <span class="title">int</span> <span class="title">flags</span>, <span class="title">int</span> *<span class="title">err</span>, <span class="title">bool</span> <span class="title">kern</span>);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*ioctl)(struct sock *sk, <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">    <span class="keyword">int</span> (*init)(struct sock *sk);</span><br><span class="line">    <span class="keyword">void</span> (*destroy)(struct sock *sk);</span><br><span class="line">    <span class="keyword">void</span> (*<span class="built_in">shutdown</span>)(struct sock *sk, <span class="keyword">int</span> how);</span><br><span class="line">    <span class="keyword">int</span> (*setsockopt)(struct sock *sk, <span class="keyword">int</span> level,</span><br><span class="line">                      <span class="keyword">int</span> optname, <span class="keyword">char</span> __user *optval,</span><br><span class="line">                      <span class="keyword">unsigned</span> <span class="keyword">int</span> optlen);</span><br><span class="line">    <span class="keyword">int</span> (*getsockopt)(struct sock *sk, <span class="keyword">int</span> level,</span><br><span class="line">                      <span class="keyword">int</span> optname, <span class="keyword">char</span> __user *optval,</span><br><span class="line">                      <span class="keyword">int</span> __user *option);</span><br><span class="line">    <span class="keyword">void</span> (*keepalive)(struct sock *sk, <span class="keyword">int</span> valbool);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_COMPAT</span></span><br><span class="line">    <span class="keyword">int</span> (*compat_setsockopt)(struct sock *sk,</span><br><span class="line">                             <span class="keyword">int</span> level,</span><br><span class="line">                             <span class="keyword">int</span> optname, <span class="keyword">char</span> __user *optval,</span><br><span class="line">                             <span class="keyword">unsigned</span> <span class="keyword">int</span> optlen);</span><br><span class="line">    <span class="keyword">int</span> (*compat_getsockopt)(struct sock *sk,</span><br><span class="line">                             <span class="keyword">int</span> level,</span><br><span class="line">                             <span class="keyword">int</span> optname, <span class="keyword">char</span> __user *optval,</span><br><span class="line">                             <span class="keyword">int</span> __user *option);</span><br><span class="line">    <span class="keyword">int</span> (*compat_ioctl)(struct sock *sk,</span><br><span class="line">                        <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> (*sendmsg)(struct sock *sk, struct msghdr *msg,</span><br><span class="line">                   <span class="keyword">size_t</span> len);</span><br><span class="line">    <span class="keyword">int</span> (*recvmsg)(struct sock *sk, struct msghdr *msg,</span><br><span class="line">                   <span class="keyword">size_t</span> len, <span class="keyword">int</span> noblock, <span class="keyword">int</span> flags,</span><br><span class="line">                   <span class="keyword">int</span> *addr_len);</span><br><span class="line">    <span class="keyword">int</span> (*sendpage)(struct sock *sk, struct page *page,</span><br><span class="line">                    <span class="keyword">int</span> offset, <span class="keyword">size_t</span> <span class="built_in">size</span>, <span class="keyword">int</span> flags);</span><br><span class="line">    <span class="keyword">int</span> (*bind)(struct sock *sk,</span><br><span class="line">                struct sockaddr *uaddr, <span class="keyword">int</span> addr_len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*backlog_rcv)(struct sock *sk,</span><br><span class="line">                       struct sk_buff *skb);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> (*release_cb)(struct sock *sk);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*hash)(struct sock *sk);</span><br><span class="line">    <span class="keyword">void</span> (*unhash)(struct sock *sk);</span><br><span class="line">    <span class="keyword">void</span> (*rehash)(struct sock *sk);</span><br><span class="line">    <span class="keyword">int</span> (*get_port)(struct sock *sk, <span class="keyword">unsigned</span> short snum);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PROC_FS</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> inuse_idx;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> (*stream_memory_free)(<span class="keyword">const</span> struct sock *sk, <span class="keyword">int</span> wake);</span><br><span class="line">    <span class="keyword">bool</span> (*stream_memory_read)(<span class="keyword">const</span> struct sock *sk);</span><br><span class="line">    <span class="keyword">void</span> (*enter_memory_pressure)(struct sock *sk);</span><br><span class="line">    <span class="keyword">void</span> (*leave_memory_pressure)(struct sock *sk);</span><br><span class="line">    <span class="keyword">atomic_long_t</span> *memory_allocated;          <span class="comment">/* Current allocated memory. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">percpu_counter</span> *<span class="title">sockets_allocated</span>;</span> <span class="comment">/* Current number of sockets. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *memory_pressure;</span><br><span class="line">    <span class="keyword">long</span> *sysctl_mem;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> *sysctl_wmem;</span><br><span class="line">    <span class="keyword">int</span> *sysctl_rmem;</span><br><span class="line">    u32 sysctl_wmem_offset;</span><br><span class="line">    u32 sysctl_rmem_offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> max_header;</span><br><span class="line">    <span class="keyword">bool</span> no_autobind;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> obj_size;</span><br><span class="line">    <span class="keyword">slab_flags_t</span> slab_flags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> useroffset; <span class="comment">/* Usercopy region offset */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> usersize;   <span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">percpu_counter</span> *<span class="title">orphan_count</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">request_sock_ops</span> *<span class="title">rsk_prot</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timewait_sock_ops</span> *<span class="title">twsk_prot</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">inet_hashinfo</span> *<span class="title">hashinfo</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">udp_table</span> *<span class="title">udp_table</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">raw_hashinfo</span> *<span class="title">raw_hash</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">smc_hashinfo</span> *<span class="title">smc_hash</span>;</span></span><br><span class="line">    &#125; h;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SOCK_REFCNT_DEBUG</span></span><br><span class="line">    <span class="keyword">atomic_t</span> socks;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">int</span> (*diag_destroy)(struct sock *sk, <span class="keyword">int</span> err);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹ä¸Šçš„ socket æ“ä½œéƒ½å®šä¹‰åœ¨ ops ä¸­ï¼Œè€Œå¯¹ä¸‹çš„ sock æ“ä½œéƒ½å®šä¹‰åœ¨ prot ä¸­ï¼Œä»æˆ‘ä»¬é€‰å®šçš„ answer ä¸€æ ·èƒ½å¤Ÿè·å–åˆ°å¯¹åº” TCP çš„ struct protoï¼Œå³ tcp_protï¼Œæˆ‘ä»¬ç”¨ tcp_prot åˆå§‹åŒ– struct sockï¼Œè¿™ä¸ª tcp_prot å®šä¹‰åœ¨ <code>/net/ipv4/tcp_ipv4.c</code> ä¸­ï¼Œé‡Œé¢çš„è¡Œä¸ºå¯¹åº”çš„å°±æ˜¯ TCP åè®®ä¸‹å†…æ ¸ç½‘ç»œåè®®æ ˆçš„æ‰€æœ‰æ“ä½œï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> <span class="title">tcp_prot</span> = &#123;</span></span><br><span class="line">    .name = <span class="string">"TCP"</span>,</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .<span class="built_in">close</span> = tcp_close,</span><br><span class="line">    .pre_connect = tcp_v4_pre_connect,</span><br><span class="line">    .<span class="built_in">connect</span> = tcp_v4_connect,</span><br><span class="line">    .<span class="built_in">disconnect</span> = tcp_disconnect,</span><br><span class="line">    .accept = inet_csk_accept,</span><br><span class="line">    .ioctl = tcp_ioctl,</span><br><span class="line">    .init = tcp_v4_init_sock,</span><br><span class="line">    .destroy = tcp_v4_destroy_sock,</span><br><span class="line">    .<span class="built_in">shutdown</span> = tcp_shutdown,</span><br><span class="line">    .setsockopt = tcp_setsockopt,</span><br><span class="line">    .getsockopt = tcp_getsockopt,</span><br><span class="line">    .keepalive = tcp_set_keepalive,</span><br><span class="line">    .recvmsg = tcp_recvmsg,</span><br><span class="line">    .sendmsg = tcp_sendmsg,</span><br><span class="line">    .sendpage = tcp_sendpage,</span><br><span class="line">    .backlog_rcv = tcp_v4_do_rcv,</span><br><span class="line">    .release_cb = tcp_release_cb,</span><br><span class="line">    .hash = inet_hash,</span><br><span class="line">    .unhash = inet_unhash,</span><br><span class="line">    .get_port = inet_csk_get_port,</span><br><span class="line">    .enter_memory_pressure = tcp_enter_memory_pressure,</span><br><span class="line">    .leave_memory_pressure = tcp_leave_memory_pressure,</span><br><span class="line">    .stream_memory_free = tcp_stream_memory_free,</span><br><span class="line">    .sockets_allocated = &amp;tcp_sockets_allocated,</span><br><span class="line">    .orphan_count = &amp;tcp_orphan_count,</span><br><span class="line">    .memory_allocated = &amp;tcp_memory_allocated,</span><br><span class="line">    .memory_pressure = &amp;tcp_memory_pressure,</span><br><span class="line">    .sysctl_mem = sysctl_tcp_mem,</span><br><span class="line">    .sysctl_wmem_offset = offsetof(struct net, ipv4.sysctl_tcp_wmem),</span><br><span class="line">    .sysctl_rmem_offset = offsetof(struct net, ipv4.sysctl_tcp_rmem),</span><br><span class="line">    .max_header = MAX_TCP_HEADER,</span><br><span class="line">    .obj_size = <span class="keyword">sizeof</span>(struct tcp_sock),</span><br><span class="line">    .slab_flags = SLAB_TYPESAFE_BY_RCU,</span><br><span class="line">    .twsk_prot = &amp;tcp_timewait_sock_ops,</span><br><span class="line">    .rsk_prot = &amp;tcp_request_sock_ops,</span><br><span class="line">    .h.hashinfo = &amp;tcp_hashinfo,</span><br><span class="line">    .no_autobind = <span class="literal">true</span>,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">    .compat_setsockopt = compat_tcp_setsockopt,</span><br><span class="line">    .compat_getsockopt = compat_tcp_getsockopt,</span><br><span class="line">#endif</span><br><span class="line">    .diag_destroy = tcp_abort,</span><br><span class="line">&#125;;</span><br><span class="line">EXPORT_SYMBOL(tcp_prot);</span><br></pre></td></tr></table></figure>
<p>inet_create å‡½æ•°ä¸­æˆ‘ä»¬è¿˜å·® struct inet_sock ç»“æ„æ²¡æœ‰åˆ†æï¼Œæ‰“å¼€è¿™ä¸ªç»“æ„èƒ½å¤Ÿå‘ç°å¾ˆæœ‰æ„æ€çš„ä¸€å¹•ï¼Œstruct inet_sock å…¶å®å°±æ˜¯ struct sock çš„æ‰©å±•ï¼Œåœ¨ struct sock çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸€äº›ä¸œè¥¿ï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹é¢çš„æ³¨é‡Šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œinet_sk å‡½æ•°å…¶å®æ˜¯è¿›è¡Œäº†ä¸€æ¬¡å¼ºåˆ¶è½¬æ¢ï¼Œå°† <code>struct sock*</code> è½¬æ¢æˆäº† <code>struct inet_sock</code>ï¼Œå†…æ ¸ä¸­ç»å¸¸èƒ½è§åˆ°è¿™æ ·çš„æ“ä½œï¼Œå°†ä¸€ä¸ªç»“æ„æ”¾åœ¨å¦ä¸€ä¸ªç»“æ„çš„å¼€å§‹ä½ç½®ï¼Œç„¶åå¯¹è¿™ä¸ªæ–°çš„ç»“æ„è¿›è¡Œæ‰©å±•ï¼Œå½“éœ€è¦è®¿é—®çš„æ—¶å€™ï¼Œé€šè¿‡å¯¹åŸç»“æ„æŒ‡é’ˆçš„å¼ºåˆ¶è½¬æ¢å°±èƒ½å¤Ÿè®¿é—®æ–°çš„ç»“æ„ä½“æˆå‘˜ï¼Œè¿™åœ¨æŸç§æ„ä¹‰ä¸Šæ¥è¯´å°±æ˜¯ C++ ä¸­çš„ç»§æ‰¿å’Œå¤šæ€ï¼Œæœç„¶ç¼–ç¨‹çš„åŸç†éƒ½æ˜¯ç›¸é€šçš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @sk - ç¥–å…ˆç±»</span></span><br><span class="line"><span class="comment"> * @pinet6 - IPv6 æ§åˆ¶å—çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment"> * @inet_daddr - ç›®æ ‡ IPv4 åœ°å€</span></span><br><span class="line"><span class="comment"> * @inet_rcv_saddr - ç»‘å®šæœ¬åœ° IPv4 åœ°å€</span></span><br><span class="line"><span class="comment"> * @inet_dport - ç›®æ ‡ç«¯å£</span></span><br><span class="line"><span class="comment"> * @inet_num - æœ¬åœ°ç«¯å£, ä¸»æœºåº</span></span><br><span class="line"><span class="comment"> * @inet_saddr - å‘é€æºåœ°å€</span></span><br><span class="line"><span class="comment"> * @uc_ttl - å•æ’­ TTL</span></span><br><span class="line"><span class="comment"> * @inet_sport - æºç«¯å£, ç½‘ç»œåº</span></span><br><span class="line"><span class="comment"> * @inet_id - ID counter for DF pkts</span></span><br><span class="line"><span class="comment"> * @tos - TOS</span></span><br><span class="line"><span class="comment"> * @mc_ttl - å¤šæ’­ TTL</span></span><br><span class="line"><span class="comment"> * @is_icsk - æ˜¯å¦æ˜¯ TCP çŠ¶æ€ç»´æŠ¤ç»“æ„ inet_connection_sock</span></span><br><span class="line"><span class="comment"> * @uc_index - å•æ’­å‘å‡ºè®¾å¤‡ç´¢å¼•</span></span><br><span class="line"><span class="comment"> * @mc_index - å¤šæ’­è®¾å¤‡ç´¢å¼•</span></span><br><span class="line"><span class="comment"> * @mc_list - Group array</span></span><br><span class="line"><span class="comment"> * @cork - info to build ip hdr on each ip frag while socket is corked</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// sk å’Œ pinet6 å¿…é¡»æ”¾åœ¨ç»“æ„ä½“çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> <span class="title">sk</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> IS_ENABLED(CONFIG_IPV6)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipv6_pinfo</span> *<span class="title">pinet6</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> inet_daddr sk.__sk_common.skc_daddr</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> inet_rcv_saddr sk.__sk_common.skc_rcv_saddr</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> inet_dport sk.__sk_common.skc_dport</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> inet_num sk.__sk_common.skc_num</span></span><br><span class="line"></span><br><span class="line">    __be32 inet_saddr;</span><br><span class="line">    __s16 uc_ttl;</span><br><span class="line">    __u16 cmsg_flags;</span><br><span class="line">    __be16 inet_sport;</span><br><span class="line">    __u16 inet_id;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_options_rcu</span> __<span class="title">rcu</span> *<span class="title">inet_opt</span>;</span></span><br><span class="line">    <span class="keyword">int</span> rx_dst_ifindex;</span><br><span class="line">    __u8 tos;</span><br><span class="line">    __u8 min_ttl;</span><br><span class="line">    __u8 mc_ttl;</span><br><span class="line">    __u8 pmtudisc;</span><br><span class="line">    __u8 recverr : <span class="number">1</span>,</span><br><span class="line">        is_icsk : <span class="number">1</span>,</span><br><span class="line">        freebind : <span class="number">1</span>,</span><br><span class="line">        hdrincl : <span class="number">1</span>,</span><br><span class="line">        mc_loop : <span class="number">1</span>,</span><br><span class="line">        transparent : <span class="number">1</span>,</span><br><span class="line">        mc_all : <span class="number">1</span>,</span><br><span class="line">        nodefrag : <span class="number">1</span>;</span><br><span class="line">    __u8 bind_address_no_port : <span class="number">1</span>,</span><br><span class="line">        defer_connect : <span class="number">1</span>;</span><br><span class="line">    __u8 rcv_tos;</span><br><span class="line">    __u8 convert_csum;</span><br><span class="line">    <span class="keyword">int</span> uc_index;</span><br><span class="line">    <span class="keyword">int</span> mc_index;</span><br><span class="line">    __be32 mc_addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip_mc_socklist</span> __<span class="title">rcu</span> *<span class="title">mc_list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_cork_full</span> <span class="title">cork</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œå®Œ inet_create åï¼Œsocket çš„åˆ›å»ºå·²ç»å®Œæˆäº†ï¼Œä¹‹åå›åˆ° __sys_socketï¼Œè°ƒç”¨ sock_map_fd å°†è¿™ä¸ªæ–°å»ºçš„ struct socket å’Œ fd ç»‘å®šå¹¶å°† fd è¿”å›ï¼Œsocket è°ƒç”¨å®Œæˆã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sock_map_fd</span><span class="params">(struct socket *sock, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">newfile</span>;</span></span><br><span class="line">    <span class="comment">// é€‰å–ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„ fd</span></span><br><span class="line">    <span class="keyword">int</span> fd = get_unused_fd_flags(flags);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(fd &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">        sock_release(sock);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// struct socket ä¸ä¸€ä¸ª struct file å¯¹åº”</span></span><br><span class="line">    <span class="comment">// sock-&gt;file = file</span></span><br><span class="line">    <span class="comment">// file-&gt;private_data = sock</span></span><br><span class="line">    <span class="comment">// å°† struct socket æŒ‡é’ˆæ”¾åœ¨ file çš„ private_data å­—æ®µä¸­</span></span><br><span class="line">    newfile = sock_alloc_file(sock, flags, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!IS_ERR(newfile)) &#123;</span><br><span class="line">        <span class="comment">// å°† struct file ä¸ fd å…³è”èµ·æ¥, ç›¸å½“äº socket ä¸ fd å…³è”èµ·æ¥äº†</span></span><br><span class="line">        fd_install(fd, newfile);</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    put_unused_fd(fd);</span><br><span class="line">    <span class="keyword">return</span> PTR_ERR(newfile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»‘å®šç«¯å£-bind">ç»‘å®šç«¯å£ bind</h2>
<p>åˆ›å»ºäº† socketï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™ä¸ª socket ç»‘å®šåˆ°ä¸€ä¸ªåœ°å€æ‰èƒ½ä½¿ç”¨ï¼Œè¿™å°±ç±»ä¼¼äºå»ç”µä¿¡ç™»è®°è‡ªå·±çš„æ‰‹æœºå·ã€‚bind çš„ç³»ç»Ÿè°ƒç”¨ä½äº <code>/net/socket.c</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE3(bind, <span class="keyword">int</span>, fd, struct sockaddr __user *, umyaddr, <span class="keyword">int</span>, addrlen) &#123;</span><br><span class="line">    <span class="keyword">return</span> __sys_bind(fd, umyaddr, addrlen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __sys_bind(<span class="keyword">int</span> fd, struct sockaddr __user *umyaddr, <span class="keyword">int</span> addrlen) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">address</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err, fput_needed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ® fd æ‰¾åˆ°å¯¹åº”çš„ struct socket</span></span><br><span class="line">    <span class="comment">// sockfd_lookup_light ä¼šè°ƒç”¨ sock_from_file</span></span><br><span class="line">    <span class="comment">// ä» struct file çš„ private_data ä¸­å–å‡º struct socket æŒ‡é’ˆ</span></span><br><span class="line">    sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);</span><br><span class="line">    <span class="keyword">if</span> (sock) &#123;</span><br><span class="line">        <span class="comment">// å°† sockaddr ä»ç”¨æˆ·æ€ umyaddr æ‹·è´åˆ°å†…æ ¸æ€ address, address æ˜¯å†…æ ¸ç©ºé—´çš„åœ°å€</span></span><br><span class="line">        err = move_addr_to_kernel(umyaddr, addrlen, &amp;address);</span><br><span class="line">        <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">            err = security_socket_bind(sock, (struct sockaddr *)&amp;address, addrlen);</span><br><span class="line">            <span class="keyword">if</span> (!err)</span><br><span class="line">                <span class="comment">// è°ƒç”¨çš„æ˜¯ inet_stream_ops ä¸­çš„ bind å‡½æ•°, ä¹Ÿå°±æ˜¯ inet_bind</span></span><br><span class="line">                err = sock-&gt;ops-&gt;bind(sock, (struct sockaddr *)&amp;address, addrlen);</span><br><span class="line">        &#125;</span><br><span class="line">        fput_light(sock-&gt;file, fput_needed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå…ˆçœ‹å‚æ•° <code>struct sockaddr __user *umyaddr</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªé€šç”¨åœ°å€ç»“æ„ï¼Œå›ºå®šé•¿åº¦ä¸º 16 å­—èŠ‚ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> &#123;</span></span><br><span class="line">    <span class="comment">// åœ°å€æ— AF_XX, sa_family_t å…¶å®æ˜¯ä¸€ä¸ª unsigned short</span></span><br><span class="line">    <span class="keyword">sa_family_t</span> sa_family;</span><br><span class="line">    <span class="comment">// 14 Bytes çš„åè®®åœ°å€</span></span><br><span class="line">    <span class="keyword">char</span> sa_data[<span class="number">14</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç„¶åçœ‹ address å˜é‡ï¼Œè¿™æ˜¯ä¸€ä¸ª sockaddr_storage ç»“æ„ï¼Œå®šä¹‰å¦‚ä¸‹ï¼Œè¿™æ˜¯ä¸€ä¸ª 128 å­—èŠ‚çš„åœ°å€ç»“æ„ï¼Œä¹‹æ‰€ä»¥ä¼šå‡ºç°ç¬¬äºŒä¸ªé€šç”¨åœ°å€ç»“æ„ï¼Œæ˜¯å› ä¸º struct sockaddr è¿™ä¸ªç»“æ„è£…ä¸ä¸‹ 28 ä½çš„ IPv6 çš„åœ°å€ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> sockaddr_storage __kernel_sockaddr_storage</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">kernel_sockaddr_storage</span> &#123;</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="keyword">__kernel_sa_family_t</span> ss_family;</span><br><span class="line">            <span class="comment">// #define _K_SS_MAXSIZE    128</span></span><br><span class="line">            <span class="keyword">char</span> __data[_K_SS_MAXSIZE - <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> short)];</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">void</span> *__align;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç„¶åè°ƒç”¨çš„å°±æ˜¯ sock-&gt;ops-&gt;bindï¼Œè¿˜è®°å¾—ä¸Šä¸€èŠ‚ä¸­ TCP åè®®å¯¹åº”çš„ ops å—ï¼Ÿæ²¡é”™ï¼ŒTCP åè®®å¯¹åº”çš„ ops ä¸º inet_stream_opsï¼Œé‚£ä¹ˆå¯¹åº”çš„ bind å‡½æ•°å°±æ˜¯ inet_bindï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡½æ•°çš„å‚æ•°ï¼Œä¼ å…¥çš„åœ°å€æŒ‡é’ˆæ˜¯ç»è¿‡å¼ºåˆ¶ç±»å‹è½¬æ¢æˆ struct sockaddr è¿™ä¸ªè¾ƒå°çš„é€šç”¨åœ°å€ï¼Œæ­¤å¤–è¿˜æœ‰ä¸€ä¸ª addr_len è¡¨ç¤ºåœ°å€çš„é•¿åº¦ï¼Œå†…æ ¸ä¸­å…¶å®æ­£æ˜¯ç”¨ addr_len å‚æ•°æ¥åŒºåˆ†åœ°å€çš„ç±»å‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_bind</span><span class="params">(struct socket *sock, struct sockaddr *uaddr, <span class="keyword">int</span> addr_len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä» struct socket ä¸­å–å‡ºå¯¹åº”çš„ struct sock</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> = <span class="title">sock</span>-&gt;<span class="title">sk</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœ sk_port ä¸­æœ‰ bind å‡½æ•°, å°±ç›´æ¥è°ƒç”¨, æ¯”å¦‚ SOCK_RAW</span></span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_prot-&gt;bind) &#123;</span><br><span class="line">        <span class="keyword">return</span> sk-&gt;sk_prot-&gt;bind(sk, uaddr, addr_len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (addr_len &lt; <span class="keyword">sizeof</span>(struct sockaddr_in))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    err = BPF_CGROUP_RUN_PROG_INET4_BIND(sk, uaddr);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> __inet_bind(sk, uaddr, addr_len, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(inet_bind);</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TCP æœ€åè¿˜æ˜¯ä¼šè°ƒç”¨åˆ° __inet_bind</span></span><br><span class="line"><span class="keyword">int</span> __inet_bind(struct sock *sk, struct sockaddr *uaddr, <span class="keyword">int</span> addr_len,</span><br><span class="line">                <span class="keyword">bool</span> force_bind_address_no_port, <span class="keyword">bool</span> with_lock) &#123;</span><br><span class="line">    <span class="comment">// struct sockaddr_in æ˜¯ IPv4 16 Byte çš„åœ°å€ç»“æ„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">addr</span> = (<span class="title">struct</span> <span class="title">sockaddr_in</span> *)<span class="title">uaddr</span>;</span></span><br><span class="line">    <span class="comment">// è·å– struct sk çš„ TCP æ‰©å±• struct inet_sock</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span> = <span class="title">inet_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> = <span class="title">sock_net</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="keyword">unsigned</span> short snum;</span><br><span class="line">    <span class="keyword">int</span> chk_addr_ret;</span><br><span class="line">    u32 tb_id = RT_TABLE_LOCAL;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addr-&gt;sin_family != AF_INET) &#123;</span><br><span class="line">        err = -EAFNOSUPPORT;</span><br><span class="line">        <span class="keyword">if</span> (addr-&gt;sin_family != AF_UNSPEC ||</span><br><span class="line">            addr-&gt;sin_addr.s_addr != htonl(INADDR_ANY))</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tb_id = l3mdev_fib_table_by_index(net, sk-&gt;sk_bound_dev_if) ?: tb_id;</span><br><span class="line">    chk_addr_ret = inet_addr_type_table(net, addr-&gt;sin_addr.s_addr, tb_id);</span><br><span class="line"></span><br><span class="line">    err = -EADDRNOTAVAIL;</span><br><span class="line">    <span class="keyword">if</span> (!inet_can_nonlocal_bind(net, inet) &amp;&amp;</span><br><span class="line">        addr-&gt;sin_addr.s_addr != htonl(INADDR_ANY) &amp;&amp;</span><br><span class="line">        chk_addr_ret != RTN_LOCAL &amp;&amp;</span><br><span class="line">        chk_addr_ret != RTN_MULTICAST &amp;&amp;</span><br><span class="line">        chk_addr_ret != RTN_BROADCAST)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    snum = ntohs(addr-&gt;sin_port);</span><br><span class="line">    err = -EACCES;</span><br><span class="line">    <span class="keyword">if</span> (snum &amp;&amp; inet_port_requires_bind_service(net, snum) &amp;&amp;</span><br><span class="line">        !ns_capable(net-&gt;user_ns, CAP_NET_BIND_SERVICE))</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (with_lock)</span><br><span class="line">        lock_sock(sk);</span><br><span class="line"></span><br><span class="line">    err = -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_state != TCP_CLOSE || inet-&gt;inet_num)</span><br><span class="line">        <span class="keyword">goto</span> out_release_sock;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inet_rcv_saddr æ˜¯æœ¬åœ°çš„ IPv4 åœ°å€, ç”¨ addr åœ°å€å¯¹å…¶åˆå§‹åŒ–</span></span><br><span class="line">    inet-&gt;inet_rcv_saddr = inet-&gt;inet_saddr = addr-&gt;sin_addr.s_addr;</span><br><span class="line">    <span class="keyword">if</span> (chk_addr_ret == RTN_MULTICAST || chk_addr_ret == RTN_BROADCAST)</span><br><span class="line">        inet-&gt;inet_saddr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snum || !(inet-&gt;bind_address_no_port || force_bind_address_no_port)) &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ tcp_prot ä¸­çš„ inet_csk_get_port åˆ¤æ–­ç«¯å£æ˜¯å¦è¢«å ç”¨</span></span><br><span class="line">        <span class="comment">// å¦‚æœè¢«å ç”¨, å°†ä¸Šé¢ä¿®æ”¹çš„åœ°å€æ¸…é›¶</span></span><br><span class="line">        <span class="keyword">if</span> (sk-&gt;sk_prot-&gt;get_port(sk, snum)) &#123;</span><br><span class="line">            inet-&gt;inet_saddr = inet-&gt;inet_rcv_saddr = <span class="number">0</span>;</span><br><span class="line">            err = -EADDRINUSE;</span><br><span class="line">            <span class="keyword">goto</span> out_release_sock;</span><br><span class="line">        &#125;</span><br><span class="line">        err = BPF_CGROUP_RUN_PROG_INET4_POST_BIND(sk);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            inet-&gt;inet_saddr = inet-&gt;inet_rcv_saddr = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">goto</span> out_release_sock;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inet-&gt;inet_rcv_saddr)</span><br><span class="line">        sk-&gt;sk_userlocks |= SOCK_BINDADDR_LOCK;</span><br><span class="line">    <span class="keyword">if</span> (snum)</span><br><span class="line">        sk-&gt;sk_userlocks |= SOCK_BINDPORT_LOCK;</span><br><span class="line">    <span class="comment">// è®¾ç½®æœ¬åœ°ç«¯å£</span></span><br><span class="line">    inet-&gt;inet_sport = htons(inet-&gt;inet_num);</span><br><span class="line">    <span class="comment">// å¯¹ç«¯åœ°å€å’Œç«¯å£éƒ½è®¾ç½®ä¸º 0</span></span><br><span class="line">    inet-&gt;inet_daddr = <span class="number">0</span>;</span><br><span class="line">    inet-&gt;inet_dport = <span class="number">0</span>;</span><br><span class="line">    sk_dst_reset(sk);</span><br><span class="line">    err = <span class="number">0</span>;</span><br><span class="line">out_release_sock:</span><br><span class="line">    <span class="keyword">if</span> (with_lock)</span><br><span class="line">        release_sock(sk);</span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç›‘å¬ç«¯å£-listen">ç›‘å¬ç«¯å£ listen</h2>
<p>å°† socket ä¸åœ°å€ç»‘å®šåï¼Œæ¥ä¸‹æ¥å°±éœ€è¦ listen ç›‘å¬è¿™ä¸ª socketï¼ŒåŒæ ·æˆ‘ä»¬ç»§ç»­çœ‹ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE2(<span class="built_in">listen</span>, <span class="keyword">int</span>, fd, <span class="keyword">int</span>, backlog) &#123;</span><br><span class="line">    <span class="keyword">return</span> __sys_listen(fd, backlog);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// backlog å®šä¹‰äº†æ‰€èƒ½æ¥å— SYN çš„æœ€å¤§å®¢æˆ·ç«¯æ•°é‡, å³åŠè¿æ¥ä¸Šé™</span></span><br><span class="line"><span class="keyword">int</span> __sys_listen(<span class="keyword">int</span> fd, <span class="keyword">int</span> backlog) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err, fput_needed;</span><br><span class="line">    <span class="keyword">int</span> somaxconn;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šè¿‡ fd è·å– struct socket</span></span><br><span class="line">    sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);</span><br><span class="line">    <span class="keyword">if</span> (sock) &#123;</span><br><span class="line">        <span class="comment">// somaxconn å®šä¹‰äº†æœåŠ¡ç«¯æ‰€èƒ½ accept çš„æœ€å¤§å®¢æˆ·ç«¯ä¸Šé™, å³å®Œæˆè¿æ¥ä¸Šé™</span></span><br><span class="line">        <span class="comment">// é»˜è®¤ä¸º 128, ä¸è¿‡é€šå¸¸éƒ½ä¼šä¿®æ”¹æˆ 1024 ä»¥ä¸Š</span></span><br><span class="line">        somaxconn = sock_net(sock-&gt;sk)-&gt;core.sysctl_somaxconn;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)backlog &gt; somaxconn)</span><br><span class="line">            backlog = somaxconn;</span><br><span class="line"></span><br><span class="line">        err = security_socket_listen(sock, backlog);</span><br><span class="line">        <span class="keyword">if</span> (!err)</span><br><span class="line">            <span class="comment">// è°ƒç”¨ inet_listen è¿›è¡Œç›‘å¬</span></span><br><span class="line">            err = sock-&gt;ops-&gt;<span class="built_in">listen</span>(sock, backlog);</span><br><span class="line"></span><br><span class="line">        fput_light(sock-&gt;file, fput_needed);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆä»ç„¶æ˜¯è·å– fd å¯¹åº”çš„ struct socketï¼Œç„¶åä¼šæ ¹æ®å†…æ ¸ä¸­è®¾ç½®çš„ somaxconn çš„å€¼ä¿®æ­£ backlog å‚æ•°ï¼Œç¡®ä¿åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ä¸èƒ½è¶…è¿‡æœ€å¤§ accept é˜Ÿåˆ—çš„é•¿åº¦ã€‚<br>
ç„¶åè°ƒç”¨ sock-&gt;ops-&gt;listen å¼€å§‹ç›‘å¬ï¼Œè¿˜æ˜¯å’Œä¸Šé¢ä¸€æ ·ï¼Œå…¶å®è°ƒç”¨çš„æ˜¯ inet_stream_ops ä¸­çš„ inet_listen å‡½æ•°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_listen</span><span class="params">(struct socket *sock, <span class="keyword">int</span> backlog)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> = <span class="title">sock</span>-&gt;<span class="title">sk</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> old_state;</span><br><span class="line">    <span class="keyword">int</span> err, tcp_fastopen;</span><br><span class="line"></span><br><span class="line">    lock_sock(sk);</span><br><span class="line"></span><br><span class="line">    err = -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (sock-&gt;state != SS_UNCONNECTED || sock-&gt;type != SOCK_STREAM)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    old_state = sk-&gt;sk_state;</span><br><span class="line">    <span class="keyword">if</span> (!((<span class="number">1</span> &lt;&lt; old_state) &amp; (TCPF_CLOSE | TCPF_LISTEN)))</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    WRITE_ONCE(sk-&gt;sk_max_ack_backlog, backlog);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœ socket å·²ç»å¤„åœ¨ TCP_LISTEN çŠ¶æ€, æˆ‘ä»¬å°±åªèƒ½å¤Ÿè°ƒæ•´ backlog çš„å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (old_state != TCP_LISTEN) &#123;</span><br><span class="line">        <span class="comment">// tcp_fastopen å…è®¸æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åœ¨å»ºç«‹è¿æ¥é˜¶æ®µäº¤æ¢æ•°æ®ä»¥å‡å°‘æ—¶å»¶, é»˜è®¤å…³é—­, ä¸ä½œè®¨è®º</span></span><br><span class="line">        tcp_fastopen = sock_net(sk)-&gt;ipv4.sysctl_tcp_fastopen;</span><br><span class="line">        <span class="keyword">if</span> ((tcp_fastopen &amp; TFO_SERVER_WO_SOCKOPT1) &amp;&amp;</span><br><span class="line">            (tcp_fastopen &amp; TFO_SERVER_ENABLE) &amp;&amp;</span><br><span class="line">            !inet_csk(sk)-&gt;icsk_accept_queue.fastopenq.max_qlen) &#123;</span><br><span class="line">            fastopen_queue_tune(sk, backlog);</span><br><span class="line">            tcp_fastopen_init_key_once(sock_net(sk));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// inet_csk_listen_start è¿™é‡ŒçœŸæ­£è¿›å…¥ç›‘å¬çŠ¶æ€</span></span><br><span class="line">        err = inet_csk_listen_start(sk, backlog);</span><br><span class="line">        <span class="keyword">if</span> (err)</span><br><span class="line">            <span class="keyword">goto</span> out;</span><br><span class="line">        tcp_call_bpf(sk, BPF_SOCK_OPS_TCP_LISTEN_CB, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    release_sock(sk);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(inet_listen);</span><br></pre></td></tr></table></figure>
<p>ä¸éš¾çœ‹å‡ºï¼Œinet_listen ä¼šè°ƒç”¨ inet_csk_listen_start è¿›å…¥ç›‘å¬çŠ¶æ€ï¼Œé‡Œé¢å‡ºç°äº†ä¸€ä¸ªæ–°ç»“æ„ struct inet_connection_sockï¼Œçœ‹åˆ° inet_csk è¿™ç§ç»“æ„ä½“æŒ‡é’ˆè½¬æ¢å‡½æ•°å…¶å®å°±ä¸éš¾æƒ³åˆ°ï¼Œstruct inet_connection_sock æ˜¯ struct inet_sock çš„æ‰©å±•ç»“æ„ï¼Œè€Œ struct inet_sock åˆæ˜¯ struct sock çš„æ‰©å±•ç»“æ„ï¼Œå®ƒä»¬å…¶å®æ˜¯ä¸€ä¸ªä¸æ–­åµŒå¥—çš„è¿‡ç¨‹ï¼Œå”¯ä¸€çš„è¦æ±‚æ˜¯è¿™äº›å­ç»“æ„ä½“éƒ½å¿…é¡»ä½äºæ‰©å±•ç»“æ„ä½“çš„å¤´éƒ¨ã€‚<br>
<strong>æˆ‘ä»¬è¯´ TCP æ˜¯é¢å‘è¿æ¥çš„ï¼Œå¹¶ä¸æ˜¯æŒ‡å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´æœ‰ä¸€æ¡é€šè·¯ï¼Œè€Œæ˜¯ TCP çš„ä¸¤ç«¯éƒ½æœ‰ä¸€ä¸ªç»´æŠ¤è¿æ¥çŠ¶æ€çš„ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“å°±æ˜¯ struct inet_connection_sockï¼Œè¿™æ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„ä¼ è¾“æ§åˆ¶å—</strong>ã€‚<br>
æ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ° <code>reqsk_queue_alloc(&amp;icsk-&gt;icsk_accept_queue)</code>ï¼Œçœ‹çœ‹ icsk_accept_queue æ˜¯ä»€ä¹ˆã€‚<br>
ä»å†…æ ¸çš„è§’åº¦æ¥è¯´ï¼Œæˆ‘ä»¬ä¸éœ€è¦åƒå†™ä»£ç æ—¶é‚£æ ·åœ¨æœåŠ¡ç«¯è°ƒç”¨ accept ä¹‹åæ‰èƒ½è®©å®¢æˆ·ç«¯å‘èµ· connectï¼Œäº‹å®ä¸Šåœ¨æœåŠ¡ç«¯ listen ä¹‹åå®¢æˆ·ç«¯å°±å¯ä»¥å‘èµ·è¿æ¥äº†ã€‚å†…æ ¸ä¼šä¸ºæ¯ä¸ª socket ç»´æŠ¤ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯å·²ç»æˆåŠŸå»ºç«‹è¿æ¥çš„é˜Ÿåˆ—ï¼Œå¤„äº established çŠ¶æ€ï¼Œä¸€ä¸ªæ˜¯å°šæœªå®Œæˆä¸‰æ¬¡æ¡æ‰‹çš„é˜Ÿåˆ—ï¼Œå¤„äº syn_rcvd çŠ¶æ€ï¼Œè¿™é‡Œçš„ icsk_accept_queue å…¶å®å°±æ˜¯å·²ç»æˆåŠŸè¿æ¥çš„é˜Ÿåˆ—ï¼ŒæœåŠ¡ç«¯è°ƒç”¨ accept å…¶å®å°±æ˜¯ä»è¿™ä¸ªé˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªè¿æ¥è¿›è¡Œå¤„ç†ã€‚<br>
éšåå°† socket çŠ¶æ€è®¾ç½®ä¸º TCP_LISTENï¼Œå†æ¬¡åˆ¤æ–­ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Œlisten åˆ°æ­¤ç»“æŸã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_csk_listen_start</span><span class="params">(struct sock *sk, <span class="keyword">int</span> backlog)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°† struct sock æ‰©å±•ä¸º TCP è¿æ¥ç»´æŠ¤ç»“æ„ä½“</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> = <span class="title">inet_csk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span> = <span class="title">inet_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="keyword">int</span> err = -EADDRINUSE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œé¢ä¸»è¦æ˜¯åˆå§‹åŒ–é˜Ÿåˆ—ç›¸å…³çš„é”</span></span><br><span class="line">    reqsk_queue_alloc(&amp;icsk-&gt;icsk_accept_queue);</span><br><span class="line"></span><br><span class="line">    sk-&gt;sk_ack_backlog = <span class="number">0</span>;</span><br><span class="line">    inet_csk_delack_init(sk);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† socket çŠ¶æ€è®¾ç½®ä¸º TCP_LISTEN</span></span><br><span class="line">    inet_sk_state_store(sk, TCP_LISTEN);</span><br><span class="line">    <span class="comment">// è°ƒç”¨ tcp_prot ä¸­çš„ inet_csk_get_port åˆ¤æ–­ç«¯å£æ˜¯å¦è¢«æš‚ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (!sk-&gt;sk_prot-&gt;get_port(sk, inet-&gt;inet_num)) &#123;</span><br><span class="line">        inet-&gt;inet_sport = htons(inet-&gt;inet_num);</span><br><span class="line"></span><br><span class="line">        sk_dst_reset(sk);</span><br><span class="line">        err = sk-&gt;sk_prot-&gt;hash(sk);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (likely(!err))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    inet_sk_set_state(sk, TCP_CLOSE);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL_GPL(inet_csk_listen_start);</span><br></pre></td></tr></table></figure>
<h2 id="æœåŠ¡ç«¯å–å‡ºè¿æ¥-accept">æœåŠ¡ç«¯å–å‡ºè¿æ¥ accept</h2>
<p>è¿™é‡Œæˆ‘ä»¬ä»ç„¶æŒ‰ç…§ç¼–ç é€»è¾‘ï¼Œå…ˆåˆ†æ accept å‡½æ•°ï¼ŒæœåŠ¡ç«¯åœ¨ listen ä¹‹åå°±å¯ä»¥åœ¨å¾ªç¯ä¸­è°ƒç”¨ accept ç­‰å¾…å–å‡ºæˆåŠŸçš„è¿æ¥ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">SYSCALL_DEFINE3(accept, <span class="keyword">int</span>, fd, struct sockaddr __user *, upeer_sockaddr, <span class="keyword">int</span> __user *, upeer_addrlen) &#123;</span><br><span class="line">    <span class="keyword">return</span> __sys_accept4(fd, upeer_sockaddr, upeer_addrlen, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œçš„å‚æ•° fd å°±æ˜¯å‰é¢é€šè¿‡ socket åˆ›å»ºå¹¶ä¸”ç»è¿‡ bind listen çš„ listenfd</span></span><br><span class="line"><span class="keyword">int</span> __sys_accept4(<span class="keyword">int</span> fd, struct sockaddr __user *upeer_sockaddr, <span class="keyword">int</span> __user *upeer_addrlen, <span class="keyword">int</span> flags) &#123;</span><br><span class="line">    <span class="keyword">int</span> ret = -EBADF;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰¾åˆ° listenfd å¯¹åº”çš„ struct file</span></span><br><span class="line">    f = fdget(fd);</span><br><span class="line">    <span class="keyword">if</span> (f.file) &#123;</span><br><span class="line">        ret = __sys_accept4_file(f.file, <span class="number">0</span>, upeer_sockaddr, upeer_addrlen, flags, rlimit(RLIMIT_NOFILE));</span><br><span class="line">        <span class="keyword">if</span> (f.flags)</span><br><span class="line">            fput(f.file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>__sys_accept4 æœ€åè¿˜æ˜¯è¦è°ƒç”¨ __sys_accept4_fileï¼Œé¦–å…ˆä»å‚æ•°çš„ struct file ä¸­å–å‡º struct socketï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ struct socket newsock å°†å®ƒçš„ type ä¸ ops è®¾ç½®ä¸ºä¸ç›‘å¬ socket ä¸€æ ·ï¼Œè¿™å…¶å®ä»ä¾§é¢è¯´æ˜äº†ç›‘å¬ socket ä¸é€šä¿¡ socket ä¸æ˜¯åŒä¸€ä¸ª socketã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> __sys_accept4_file(struct file *file, <span class="keyword">unsigned</span> file_flags,</span><br><span class="line">                       struct sockaddr __user *upeer_sockaddr,</span><br><span class="line">                       <span class="keyword">int</span> __user *upeer_addrlen, <span class="keyword">int</span> flags,</span><br><span class="line">                       <span class="keyword">unsigned</span> <span class="keyword">long</span> nofile) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>, *<span class="title">newsock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">newfile</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err, len, newfd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">address</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; ~(SOCK_CLOEXEC | SOCK_NONBLOCK))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (SOCK_NONBLOCK != O_NONBLOCK &amp;&amp; (flags &amp; SOCK_NONBLOCK))</span><br><span class="line">        flags = (flags &amp; ~SOCK_NONBLOCK) | O_NONBLOCK;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä» struct file ä¸­å–å‡º struct socket</span></span><br><span class="line">    sock = sock_from_file(file, &amp;err);</span><br><span class="line">    <span class="keyword">if</span> (!sock)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    err = -ENFILE;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ struct socket å¹¶ä¸”åˆ†é…ä¸€ä¸ªæ–°çš„ inode</span></span><br><span class="line">    newsock = sock_alloc();</span><br><span class="line">    <span class="keyword">if</span> (!newsock)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    newsock-&gt;type = sock-&gt;type;</span><br><span class="line">    newsock-&gt;ops = sock-&gt;ops;</span><br><span class="line"></span><br><span class="line">    __module_get(newsock-&gt;ops-&gt;owner);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€‰å–ä¸€ä¸ªæœªä½¿ç”¨çš„ fd</span></span><br><span class="line">    newfd = __get_unused_fd_flags(flags, nofile);</span><br><span class="line">    <span class="keyword">if</span> (unlikely(newfd &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">        err = newfd;</span><br><span class="line">        sock_release(newsock);</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸º newsock åˆ†é…ä¸€ä¸ªå¯¹åº”çš„ struct file å¹¶ä¸”å°† sock æŒ‡é’ˆæ”¾å…¥ file-&gt;private_data ä¸­</span></span><br><span class="line">    newfile = sock_alloc_file(newsock, flags, sock-&gt;sk-&gt;sk_prot_creator-&gt;name);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(newfile)) &#123;</span><br><span class="line">        err = PTR_ERR(newfile);</span><br><span class="line">        put_unused_fd(newfd);</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = security_socket_accept(sock, newsock);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">goto</span> out_fd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ inet_stream_ops ä¸­çš„ inet_accept å‡½æ•°</span></span><br><span class="line">    err = sock-&gt;ops-&gt;accept(sock, newsock, sock-&gt;file-&gt;f_flags | file_flags, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> out_fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (upeer_sockaddr) &#123;</span><br><span class="line">        len = newsock-&gt;ops-&gt;getname(newsock, (struct sockaddr *)&amp;address, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            err = -ECONNABORTED;</span><br><span class="line">            <span class="keyword">goto</span> out_fd;</span><br><span class="line">        &#125;</span><br><span class="line">        err = move_addr_to_user(&amp;address, len, upeer_sockaddr, upeer_addrlen);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> out_fd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† newfd ä¸æˆåŠŸå…³è” new socket çš„ struct file å…³è”èµ·æ¥, æœ€åè¿”å› newfd</span></span><br><span class="line">    fd_install(newfd, newfile);</span><br><span class="line">    err = newfd;</span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">out_fd:</span><br><span class="line">    fput(newfile);</span><br><span class="line">    put_unused_fd(newfd);</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ç€å¾€ä¸‹çœ‹ï¼Œä¼šè°ƒç”¨ sock-&gt;ops-&gt;acceptï¼ŒæŒ‰ç…§ä¸Šé¢çš„é€»è¾‘ï¼Œè°ƒç”¨çš„æ˜¯ inet_stream_ops ä¸­çš„ inet_accept å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ä¼šè°ƒç”¨ tcp_prot çš„ accept å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢çš„åˆå§‹åŒ–ä¸­èƒ½å¤ŸæŸ¥è¯¢åˆ°è¯¥å‡½æ•°æ˜¯ inet_csk_acceptã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆæ³¨æ„è¿™é‡Œçš„ sock è¿˜æ˜¯æ—§çš„ socket</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_accept</span><span class="params">(struct socket *sock, struct socket *newsock, <span class="keyword">int</span> flags, <span class="keyword">bool</span> kern)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk1</span> = <span class="title">sock</span>-&gt;<span class="title">sk</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err = -EINVAL;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ tcp_prot ä¸­çš„ inet_csk_accept</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk2</span> = <span class="title">sk1</span>-&gt;<span class="title">sk_prot</span>-&gt;<span class="title">accept</span>(<span class="title">sk1</span>, <span class="title">flags</span>, &amp;<span class="title">err</span>, <span class="title">kern</span>);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!sk2)</span><br><span class="line">        <span class="keyword">goto</span> do_err;</span><br><span class="line"></span><br><span class="line">    lock_sock(sk2);</span><br><span class="line"></span><br><span class="line">    sock_rps_record_flow(sk2);</span><br><span class="line">    WARN_ON(!((<span class="number">1</span> &lt;&lt; sk2-&gt;sk_state) &amp; (TCPF_ESTABLISHED | TCPF_SYN_RECV | TCPF_CLOSE_WAIT | TCPF_CLOSE)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// newsock-&gt;sock = sk2, accept å°†å·²è¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºçš„ struct sock ä¸ struct socket å…³è”èµ·æ¥</span></span><br><span class="line">    sock_graft(sk2, newsock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿®æ”¹å–å‡ºè¿æ¥çš„çŠ¶æ€</span></span><br><span class="line">    newsock-&gt;state = SS_CONNECTED;</span><br><span class="line">    err = <span class="number">0</span>;</span><br><span class="line">    release_sock(sk2);</span><br><span class="line">do_err:</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(inet_accept);</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ inet_csk_accept çš„å®ç°ï¼Œè¿™é‡Œé¢æœ€é‡è¦çš„æ˜¯ inet_csk_wait_for_connectï¼Œå¦‚æœå·²ç»å®Œæˆçš„é˜Ÿåˆ—ä¸ºç©ºï¼Œå°±ä¼šè¿›å…¥è¿™ä¸ªå‡½æ•°ï¼Œå¦åˆ™å°±ä»å·²å®Œæˆè¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ª struct sock å¹¶è¿”å›ï¼Œè¿™ä¸ª newsock ä¼šèµ‹ç»™ inet_accept å‡½æ•°ä¸­çš„ sk2ï¼Œåœ¨ sock_graft å‡½æ•°ä¸­ sk2 ä¼šä¸è¿™ä¸ªæ–°çš„ newsock å…³è”èµ·æ¥ï¼Œæœ€åå°† newsock-&gt;state è®¾ç½®ä¸º SS_CONNECTEDï¼Œæœ€åè¢«ä¿®æ”¹çš„ newsock ä¼šä¸ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ newfd å…³è”èµ·æ¥ï¼Œè¿”å›ç»™ç”¨æˆ·ä½¿ç”¨ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">struct sock *<span class="title">inet_csk_accept</span><span class="params">(struct sock *sk, <span class="keyword">int</span> flags, <span class="keyword">int</span> *err, <span class="keyword">bool</span> kern)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// é¦–å…ˆè½¬æ¢å‡º TCP è¿æ¥ç»´æŠ¤ç»“æ„ä½“ inet_connection_sock</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> = <span class="title">inet_csk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    <span class="comment">// å·²å®Œæˆè¿æ¥é˜Ÿåˆ—, é˜Ÿåˆ—é¡¹ä¸­èƒ½å¤Ÿç›´æ¥å–åˆ° struct sock* sk</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">request_sock_queue</span> *<span class="title">queue</span> = &amp;<span class="title">icsk</span>-&gt;<span class="title">icsk_accept_queue</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">request_sock</span> *<span class="title">req</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">newsk</span>;</span></span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line"></span><br><span class="line">    lock_sock(sk);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¡®ä¿ socket å¤„åœ¨ TCP_LISTEN çŠ¶æ€, è¿™ä¸ª sk_state è¡¨ç¤ºçš„æ˜¯ socket åº•å±‚çš„è¿æ¥çŠ¶æ€</span></span><br><span class="line">    error = -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_state != TCP_LISTEN)</span><br><span class="line">        <span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»å®Œæˆè¿æ¥çš„é˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (reqsk_queue_empty(<span class="built_in">queue</span>)) &#123;</span><br><span class="line">        <span class="keyword">long</span> timeo = sock_rcvtimeo(sk, flags &amp; O_NONBLOCK);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœè¿™ä¸ª socket æ˜¯éé˜»å¡çš„, ç›´æ¥è¿”å›</span></span><br><span class="line">        error = -EAGAIN;</span><br><span class="line">        <span class="keyword">if</span> (!timeo)</span><br><span class="line">            <span class="keyword">goto</span> out_err;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦åˆ™é˜»å¡åœ¨è¿™é‡Œ</span></span><br><span class="line">        error = inet_csk_wait_for_connect(sk, timeo);</span><br><span class="line">        <span class="keyword">if</span> (error)</span><br><span class="line">            <span class="keyword">goto</span> out_err;</span><br><span class="line">    &#125;</span><br><span class="line">    req = reqsk_queue_remove(<span class="built_in">queue</span>, sk);</span><br><span class="line">    newsk = req-&gt;sk;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sk-&gt;sk_protocol == IPPROTO_TCP &amp;&amp; tcp_rsk(req)-&gt;tfo_listener) &#123;</span><br><span class="line">        spin_lock_bh(&amp;<span class="built_in">queue</span>-&gt;fastopenq.lock);</span><br><span class="line">        <span class="keyword">if</span> (tcp_rsk(req)-&gt;tfo_listener) &#123;</span><br><span class="line">            req-&gt;sk = <span class="literal">NULL</span>;</span><br><span class="line">            req = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        spin_unlock_bh(&amp;<span class="built_in">queue</span>-&gt;fastopenq.lock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    release_sock(sk);</span><br><span class="line">    <span class="keyword">if</span> (newsk &amp;&amp; mem_cgroup_sockets_enabled) &#123;</span><br><span class="line">        <span class="keyword">int</span> amt;</span><br><span class="line">        lock_sock(newsk);</span><br><span class="line"></span><br><span class="line">        amt = sk_mem_pages(newsk-&gt;sk_forward_alloc + atomic_read(&amp;newsk-&gt;sk_rmem_alloc));</span><br><span class="line">        mem_cgroup_sk_alloc(newsk);</span><br><span class="line">        <span class="keyword">if</span> (newsk-&gt;sk_memcg &amp;&amp; amt)</span><br><span class="line">            mem_cgroup_charge_skmem(newsk-&gt;sk_memcg, amt);</span><br><span class="line">        release_sock(newsk);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req)</span><br><span class="line">        reqsk_put(req);</span><br><span class="line">    <span class="keyword">return</span> newsk;</span><br><span class="line">out_err:</span><br><span class="line">    newsk = <span class="literal">NULL</span>;</span><br><span class="line">    req = <span class="literal">NULL</span>;</span><br><span class="line">    *err = error;</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(inet_csk_accept);</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæˆ‘ä»¬å†çœ‹ä¸€ä¸‹å¦‚æœè¿æ¥å°±ç»ªé˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œinet_csk_wait_for_connect éƒ½åšäº†äº›ä»€ä¹ˆã€‚<br>
inet_csk_wait_for_connect æœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼Œä¸ºäº†é¿å…ç«æ€å‡ºç°ï¼Œè¯¥å‡½æ•°å¿…é¡»åœ¨ socket ä¸Šé”çš„æƒ…å†µä¸‹è°ƒç”¨ã€‚<br>
åœ¨ icsk_accept_queue é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ï¼Œå†…æ ¸ä¼šä¸»åŠ¨è°ƒåº¦ schedule_timeout è®©å‡º CPU ä¸€æ®µæ—¶é—´ï¼Œç­‰åˆ°é‡æ–°å”¤é†’çš„æ—¶å€™ä¼šæ£€æŸ¥ icsk_accept_queue æ˜¯å¦è¿˜ä¸ºç©ºï¼Œsocket æ˜¯å¦å¤„åœ¨ç›‘å¬çŠ¶æ€ä»¥åŠæ˜¯å¦æœ‰ä¿¡å·éœ€è¦å¤„ç†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">inet_csk_wait_for_connect</span><span class="params">(struct sock *sk, <span class="keyword">long</span> timeo)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> = <span class="title">inet_csk</span>(<span class="title">sk</span>);</span></span><br><span class="line">    DEFINE_WAIT(wait);</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// å°†è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸ºç­‰å¾…èµ„æºæœ‰æ•ˆæ—¶å”¤é†’ TASK_INTERRUPTIBLE</span></span><br><span class="line">        prepare_to_wait_exclusive(sk_sleep(sk), &amp;wait, TASK_INTERRUPTIBLE);</span><br><span class="line">        release_sock(sk);</span><br><span class="line">        <span class="keyword">if</span> (reqsk_queue_empty(&amp;icsk-&gt;icsk_accept_queue))</span><br><span class="line">            <span class="comment">// ä¸»åŠ¨è°ƒåº¦è®©å‡º CPU, timeo æ—¶é—´åå”¤é†’</span></span><br><span class="line">            timeo = schedule_timeout(timeo);</span><br><span class="line">        sched_annotate_sleep();</span><br><span class="line">        <span class="comment">// å”¤é†’åå…ˆä¸Šé”</span></span><br><span class="line">        lock_sock(sk);</span><br><span class="line">        err = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ icsk_accept_queue é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º, å¦‚æœä¸ä¸ºç©º, ç›´æ¥é€€å‡ºå¾ªç¯è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (!reqsk_queue_empty(&amp;icsk-&gt;icsk_accept_queue))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        err = -EINVAL;</span><br><span class="line">        <span class="comment">// å¦‚æœ socket é€€å‡ºç›‘å¬äº†, ç›´æ¥é€€å‡ºå¾ªç¯è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (sk-&gt;sk_state != TCP_LISTEN)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        err = sock_intr_errno(timeo);</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰ä¿¡å·å¾…å¤„ç†, ç›´æ¥é€€å‡ºå¾ªç¯è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (signal_pending(current))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        err = -EAGAIN;</span><br><span class="line">        <span class="keyword">if</span> (!timeo)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    finish_wait(sk_sleep(sk), &amp;wait);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linux-Kernel</tag>
        <tag>Socket</tag>
      </tags>
  </entry>
  <entry>
    <title>decltype é™·é˜±</title>
    <url>/posts/a4099fa0/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>decltype çš„ä¸€èˆ¬åº”ç”¨åœºæ™¯</li>
<li>decltype(auto) çš„ç”¨æ³•ç¤ºä¾‹</li>
<li>decltype ç”¨äºæ¨æ–­å·¦å€¼è¡¨è¾¾å¼çš„é™·é˜±</li>
</ul>
</blockquote>
<a id="more"></a>
<h2 id="ä¸€èˆ¬åœºæ™¯ä¸‹çš„-decltype">ä¸€èˆ¬åœºæ™¯ä¸‹çš„ decltype</h2>
<p>decltype - declared typeï¼Œç”¨äºåå­—æˆ–è¡¨è¾¾å¼çš„ç±»å‹æ¨æ–­ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ƒéƒ½æ˜¯ä¸ auto çš„æ¨å¯¼è¿‡ç¨‹ç›¸åï¼Œçœ‹å‡ ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> i = <span class="number">0</span>;              <span class="comment">// decltype(i) -&gt; const int</span></span><br><span class="line"><span class="keyword">if</span> (f(w))...                  <span class="comment">// decltype(f(w)) -&gt; bool</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> Widget&amp; w)</span></span>;      <span class="comment">// decltype(f) -&gt; bool(const Widget&amp;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">vector</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    T&amp; <span class="keyword">operator</span>[](<span class="built_in">std</span>::<span class="keyword">size_t</span> index);</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; v;                <span class="comment">// decltype(v) -&gt; vector&lt;int&gt;</span></span><br><span class="line">v[<span class="number">0</span>] = <span class="number">0</span>;                     <span class="comment">// decltype(v[0]) -&gt; int&amp;</span></span><br></pre></td></tr></table></figure>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå«æœ‰ T ç±»å‹çš„å¯¹è±¡çš„å®¹å™¨ï¼Œ<code>operator[]</code> ä¼šè¿”å› T&amp;ï¼ˆ<code>std::vector&lt;bool&gt;</code> æ˜¯ä¸ªä¾‹å¤–ï¼‰ï¼Œæˆ‘ä»¬å®é™…ç¼–ç çš„è¿‡ç¨‹ä¸­ï¼Œdecltype çš„ä¸»è¦ç”¨é€”æ˜¯ç”¨äºå£°æ˜é‚£äº›è¿”å›å€¼ç±»å‹éœ€è¦ä¾èµ–å½¢å‚ç±»å‹çš„å‡½æ•°æ¨¡æ¿ï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> Index&gt;</span><br><span class="line">auto authAndAccess(Container&amp; c, Index i) -&gt; decltype(c[i]) &#123;</span><br><span class="line">    authenticateUser();</span><br><span class="line">    <span class="keyword">return</span> c[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªä»£ç ä½¿ç”¨çš„æ˜¯è¿”å›å€¼ç±»å‹åç½®ï¼Œå› ä¸º C++11 ä¸­è¿˜ä¸æ”¯æŒå‡½æ•°è¿”å›å€¼ç±»å‹ auto æ¨æ–­ï¼Œå¦‚æœéœ€è¦åœ¨è¿”å›å€¼ä¸­ä½¿ç”¨å‡½æ•°å½¢å‚ï¼Œæˆ‘ä»¬å¿…é¡»å°†è¿”å›å€¼åç½®ï¼Œå¦åˆ™ä¼šå‡ºç°å‚æ•°æœªå£°æ˜è€Œæ— æ³•ä½¿ç”¨ã€‚è¿™æ ·çš„è¯ <code>authAndAccess</code> å‡½æ•°è¿”å›å€¼çš„ç±»å‹ä¸ <code>operator[]</code> è¿”å›å€¼ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚</p>
<h2 id="decltype-auto-ä½ çœŸçš„æ‡‚å—">decltype(auto) ä½ çœŸçš„æ‡‚å—</h2>
<p>ä» C++14 å¼€å§‹ï¼Œä¸Šé¢çš„å‡½æ•°å¯ä»¥å¾—åˆ°è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œå› ä¸ºæ–°çš„æ ‡å‡†å…è®¸å¯¹ä¸€åˆ‡ lambda è¡¨è¾¾å¼å’Œå‡½æ•°è¿›è¡Œå‹åˆ«æ¨å¯¼ï¼Œæˆ‘ä»¬å¯ä»¥å»æ‰è¿”å›å€¼åç½®çš„è¯­æ³•ï¼Œåªä¿ç•™ autoï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> Index&gt;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">authAndAccess</span><span class="params">(Container&amp; c, Index i)</span> </span>&#123;</span><br><span class="line">    authenticateUser();</span><br><span class="line">    <span class="keyword">return</span> c[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™ä¸ªæ–°ç‰ˆå‡½æ•°ä¸­å‡½æ•°è¿”å›å€¼çš„ç±»å‹æ˜¯æ ¹æ® c[i] æ¨å¯¼å‡ºæ¥çš„ï¼Œå¥½åƒ auto å·²ç»æŠŠ decltype è¯¥åšçš„äº‹æƒ…åšå®Œäº†ï¼Œé‚£ä¹ˆ decltype è¿˜æœ‰ç”¨å—ï¼Ÿ</p>
<p>å½“ç„¶æœ‰ç”¨ï¼ŒC++ æœ‰ä¸ªç‰¹æ€§ï¼ˆå¤§å‘ï¼‰ï¼Œ<strong>åœ¨æ¨¡æ¿å‹åˆ«çš„æ¨å¯¼è¿‡ç¨‹ä¸­ï¼Œå…·æœ‰å¼•ç”¨å‹åˆ«çš„å®å‚ä¼šè¢«å½“æˆéå¼•ç”¨å‹åˆ«æ¥å¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¼•ç”¨æ€§ä¼šè¢«å¿½ç•¥</strong>ã€‚<br>
è™½ç„¶ c[i] çš„å‹åˆ«æ˜¯ Container&amp;ï¼Œä½†æ˜¯ auto æ¨æ–­å‡ºæ¥çš„è¿”å›å€¼ç±»å‹ç«Ÿç„¶æ˜¯ Containerï¼é‚£ä¹ˆä¸‹é¢çš„ä»£ç æ ¹æœ¬ä¸ä¼šé€šè¿‡ç¼–è¯‘ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">deque</span>&lt;<span class="keyword">int</span>&gt; d;</span><br><span class="line">...</span><br><span class="line">authAndAccess(d, <span class="number">5</span>) = <span class="number">10</span>;   <span class="comment">// ç›¸å½“äºå°†ä¸€ä¸ªå³å€¼èµ‹ç»™äº†å¦ä¸€ä¸ªå³å€¼</span></span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶å°±è½®åˆ° <code>decltype(auto)</code> å‡ºåœºäº†ï¼Œauto æŒ‡å®šäº†æˆ‘ä»¬æ‰“ç®—æ¨å¯¼çš„å‹åˆ«ï¼Œè€Œ decltype æŒ‡å®šäº†å‹åˆ«çš„æ¨å¯¼è§„åˆ™ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> Index&gt;</span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">authAndAccess</span><span class="params">(Container&amp; c, Index i)</span> </span>&#123;</span><br><span class="line">    authenticateUser();</span><br><span class="line">    <span class="keyword">return</span> c[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ · authAndAccess çš„è¿”å›å€¼ç±»å‹ä¸ c[i] çš„ç±»å‹å°±å®Œå…¨ç›¸åŒäº†ã€‚</p>
<h2 id="å³å€¼å®¹å™¨æ€ä¹ˆå¤„ç†">å³å€¼å®¹å™¨æ€ä¹ˆå¤„ç†</h2>
<p>ç»†å¿ƒçš„æœ‹å‹ä¸éš¾å‘ç°ï¼Œä¸Šé¢ç»™å‡ºçš„ <code>authAndAccess</code> å‡½æ•°åªèƒ½å¤Ÿå¤„ç†å·¦å€¼å®¹å™¨ï¼Œå› ä¸ºå³å€¼æ˜¯æ— æ³•ç»‘å®šåˆ°å·¦å€¼å¼•ç”¨çš„ï¼Œå› æ­¤å‘è¯¥å‡½æ•°ä¼ é€’ä¸€ä¸ªå³å€¼å®¹å™¨æ˜¯éæ³•è¡Œä¸ºã€‚<br>
é‚£ä¹ˆæœ‰ä»€ä¹ˆæ–¹æ³•èƒ½å¤ŸåŒæ—¶æ”¯æŒå·¦å€¼ç»‘å®šä¸å³å€¼ç»‘å®šå‘¢ï¼Œç­”æ¡ˆå°±æ˜¯ä¸‡èƒ½å¼•ç”¨ï¼Œå¯¹äºä¸‡èƒ½å¼•ç”¨è¦ä½¿ç”¨ <code>std::forward</code>ï¼Œä¸‹é¢æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ C++14 çš„å†™æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> Index&gt;</span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">authAndAccess</span><span class="params">(Container&amp;&amp; c, Index i)</span> </span>&#123;    <span class="comment">// c ç°åœ¨æ˜¯ä¸‡èƒ½å¼•ç”¨</span></span><br><span class="line">    authenticateUser();</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::forward&lt;Container&gt;(c)[i];                 <span class="comment">// å®Œç¾è½¬å‘ Container çš„ç±»å‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å¬è¯´-decltype-è¿˜èƒ½æ¨å¯¼è¡¨è¾¾å¼">å¬è¯´ decltype è¿˜èƒ½æ¨å¯¼è¡¨è¾¾å¼</h2>
<p>æƒ³è¦å½»åº•ç†è§£ decltype çš„è¡Œä¸ºï¼Œè¿˜éœ€è¦ç†Ÿæ‚‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œè¿™é‡Œåªé€‰ä¸€ä¸ªå…·æœ‰ä»£è¡¨æ€§çš„ï¼Œä¹Ÿæ˜¯ C++ Quiz ä¸­ç»å¸¸é‡åˆ°çš„éš¾é¢˜ï¼š<br>
ä¸€ä¸ªåå­—é€šå¸¸æ˜¯å·¦å€¼è¡¨è¾¾å¼ï¼Œå¦‚æœä»…æœ‰ä¸€ä¸ªåå­—ï¼Œæ¯”å¦‚ decltype(e)ï¼Œdecltype ä¼šå‡†ç¡®åœ°æ¨å¯¼å‡º e çš„å‹åˆ«ï¼Œä½†æ˜¯<strong>å¦‚æœæ˜¯æ¯”ä»…æœ‰åå­—æ›´åŠ å¤æ‚çš„å·¦å€¼è¡¨è¾¾å¼ï¼Œdecltype éœ€è¦ä¿è¯æ¨å¯¼å‡ºçš„å‹åˆ«æ€»æ˜¯å·¦å€¼å¼•ç”¨</strong>ï¼</p>
<p>çœ‹èµ·æ¥æ˜¯ä¸ªåˆæƒ…åˆç†çš„æ¨å¯¼ï¼Œä½†æ˜¯ä¼šäº§ç”Ÿä¸€äº›è¯¡å¼‚çš„ç°è±¡ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">decltype</span>(x) -&gt; <span class="keyword">int</span>      <span class="comment">// decltype(x) çš„æ¨å¯¼ç»“æœä¸º int</span></span><br><span class="line"><span class="keyword">decltype</span>((x)) -&gt; <span class="keyword">int</span>&amp;   <span class="comment">// decltype((x)) çš„æ¨å¯¼ç»“æœä¸º int&amp;</span></span><br></pre></td></tr></table></figure>
<p>çœ‹èµ·æ¥å°±åƒä¸€ä¸ªå°å½©è›‹ï¼Œä½†æ˜¯å¦‚æœé‡åˆ°ä¸‹é¢çš„æƒ…å†µå°±ä¼šå‡ºç°å¥‡å¦™çš„æœªå®šä¹‰è¡Œä¸ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">f1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">f2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> (x);       <span class="comment">// f2 è¿”å›çš„æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡çš„å¼•ç”¨ä»è€Œå¼•å‘æœªå®šä¹‰è¡Œä¸º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>Decltype</tag>
      </tags>
  </entry>
  <entry>
    <title>CMake é¡¹ç›®é“¾æ¥æ—¶æ‰¾ä¸åˆ°é™æ€åº“</title>
    <url>/posts/1c6f4546/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>è§£å†³ CLion é¡¹ç›®é“¾æ¥æ—¶æ‰¾ä¸åˆ°é“¾æ¥åº“çš„é—®é¢˜</li>
</ul>
</blockquote>
<a id="more"></a>
<p>æœ€è¿‘åœ¨ç”¨ cmake ç®¡ç†é¡¹ç›®çš„æ—¶å€™ï¼Œå†™å®Œ test åå‘ç°æ— è®ºå¦‚ä½•éƒ½æ²¡æœ‰åŠæ³•é“¾æ¥æˆåŠŸï¼ŒæŠ¥é”™å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">/usr/bin/ld: can<span class="number">'</span>t <span class="built_in">find</span> -lTripod_Lib</span><br><span class="line">error: ld returned <span class="number">1</span> <span class="built_in">exit</span> status</span><br></pre></td></tr></table></figure>
<p><code>Tripod_Lib</code> æ˜¯ä¹‹å‰ç”Ÿæˆçš„é™æ€åº“ï¼Œæ”¾åœ¨ lib ç›®å½•ä¸‹ã€‚</p>
<p>æ‰‹åŠ¨ç”¨ g++ å‘½ä»¤æµ‹è¯•èƒ½å¤ŸæˆåŠŸç¼–è¯‘é“¾æ¥ï¼Œçœ‹æ¥çœŸçš„æ˜¯å› ä¸ºæ‰¾ä¸åˆ°åº“ğŸ˜“</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">g++ test/test.cc -o tb -I ./src ./lib/Tripod_Lib.a</span><br></pre></td></tr></table></figure>
<p>æŠ˜ç£¨äº†ä¸¤å¤©ï¼Œæœ€ç»ˆè¿˜æ˜¯åœ¨ <a href="https://cmake.org/cmake/help/v3.15/command/link_directories.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a> ä¸Šæ‰¾åˆ°äº†åŸå› ï¼š<br>
<em>Specify the paths in which the linker should search for libraries. <strong>The command will apply only to targets created after it is called.</strong></em></p>
<p>ä¹Ÿæ˜¯å°±è¯´ï¼Œ<code>link_directories()</code> éœ€è¦æ”¾åœ¨ <code>add_library()</code> å’Œ <code>add_executable()</code> çš„å‰é¢ã€‚<br>
æ­¤å¤–è¿˜è¦æ³¨æ„ï¼Œæœ€åé“¾æ¥çš„é™æ€åº“åå­—é‡Œè¦å¸¦ä¸Š .a çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">cmake_minimum_required(VERSION <span class="number">3.15</span>)</span><br><span class="line">project(Tripod)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(EXECUTABLE_OUTPUT_PATH $&#123;PROJECT_SOURCE_DIR&#125;/bin)</span><br><span class="line"><span class="built_in">set</span>(LIBRARY_OUTPUT_PATH $&#123;PROJECT_SOURCE_DIR&#125;/lib)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_DEBUG_POSTFIX <span class="string">"_Base"</span>)</span><br><span class="line"></span><br><span class="line">aux_source_directory($&#123;PROJECT_SOURCE_DIR&#125;/src SRC_DIR)</span><br><span class="line"></span><br><span class="line">link_directories($&#123;PROJECT_SOURCE_DIR&#125;/lib)</span><br><span class="line"></span><br><span class="line">add_library(_Tripod STATIC $&#123;SRC_DIR&#125;)</span><br><span class="line"></span><br><span class="line">add_executable(Tripod test/test.cc)</span><br><span class="line"></span><br><span class="line">target_link_libraries(Tripod lib_Tripod$&#123;CMAKE_DEBUG_POSTFIX&#125;.a)</span><br></pre></td></tr></table></figure>
<p>å¿…é¡»è¦åæ§½ Cmake çš„æ–‡æ¡£é‡ŒçœŸæ˜¯ä¸€ä¸ªä¾‹å­éƒ½æ²¡æœ‰å•Šï¼Œçœ‹å®Œä¹‹åæ¨¡æ£±ä¸¤å¯çš„ä¸œè¥¿å¤§æŠŠï¼Œå¥½åƒè¢«äººåœ¨å˜´é‡Œç¡¬å¡äº†ä¸€æŠŠå±ä¸€æ ·ï¼Œæ•°å­¦è¯¾æœ¬éƒ½è¿˜æœ‰ä¾‹é¢˜å‘¢ï¼Œå‘è´§ğŸ˜¡ğŸ˜¡ğŸ˜¡</p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>CMake</tag>
        <tag>Debug</tag>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows ä¸‹é…ç½® CLion + Cygwin å¼€å‘ç¯å¢ƒ</title>
    <url>/posts/1f8822d7/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>Windows ä¸‹é…ç½® CLion Toolchain ä¸º Cygwin</li>
</ul>
</blockquote>
<a id="more"></a>
<p>ä¹‹å‰å·²ç»åœ¨ CLion ä¸­é…ç½®å¥½äº† MinGWï¼Œä½†æ˜¯ MinGW ä¸‹æ— æ³•è°ƒç”¨ POSIX APIï¼Œå› æ­¤åœ¨ CLion ä¸‹é‡æ–°é…ç½® Toolchain ä¸º Cygwinï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹ï¼š<br>
é¦–å…ˆè¦è¯´ï¼ŒMinGW ä¸ Cygwin è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š</p>
<ul>
<li>Cygwin æ˜¯ä½¿ç”¨ä¸€ä¸ª dll æ¥æ¨¡æ‹Ÿ Linux ç¯å¢ƒï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåœ¨ windows ä¸Šçš„å¯è¿è¡Œ POSIX åº”ç”¨ç¨‹åºçš„å·¥å…·ç¯å¢ƒ</li>
<li>MinGW æ˜¯åœ¨ç¼–è¯‘æ—¶æä¾› Linux åˆ° Win ä»£ç çš„è½¬æ¢ï¼Œç”¨åˆ°çš„å…¶å®æ˜¯ Windows è¿è¡Œåº“</li>
</ul>
<ol>
<li>
<p>åœ¨ <a href="https://www.cygwin.com/" target="_blank" rel="noopener">Cygwin</a> ä¸‹è½½å®‰è£…æ–‡ä»¶ setup-x86_64.exeï¼›</p>
</li>
<li>
<p>è¿è¡Œå®‰è£…æ–‡ä»¶ï¼Œä¸€è·¯ nextï¼Œé€‰æ‹©ç«™ç‚¹ç•Œé¢æ–°å¢ <code>http://mirrors.163.com/cygwin/</code>ï¼›</p>
</li>
<li>
<p>Select Packages ç•Œé¢ï¼Œåœ¨ View ä¸­é€‰æ‹© Fullï¼Œç„¶ååˆ†åˆ«è¾“å…¥ <code>cmake</code> <code>gcc-core</code> <code>gcc-g++</code> <code>gdb</code> <code>make</code>ï¼Œé€‰æ‹©å¯¹åº”çš„ç‰ˆæœ¬å·ï¼Œç„¶å next æ‰¹é‡å®‰è£…ï¼›</p>
</li>
<li>
<p>å®‰è£…è¿‡ç¨‹ä¸­å‘ç°å¡åœ¨äº† <code>/etc/postinstall/0p_000_autorebash.dash</code>ï¼ŒæŸ¥çœ‹äº† <a href="http://cygwin.1069669.n5.nabble.com/Autorebase-hangs-on-install-td128035.html#a128036" target="_blank" rel="noopener">è§£å†³æ–¹æ³•</a>ï¼Œå°† dash è¿›ç¨‹ç»“æŸæ‰ï¼Œæœ€åæˆåŠŸå®‰è£…ï¼›</p>
</li>
<li>
<p>åœ¨ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­æ·»åŠ  <code>C:\cygwin64\bin</code>ï¼›</p>
</li>
<li>
<p>CLion-&gt;Setting-&gt;Build Execution Deployment-&gt;Toolchain ä¸­å°† Environment é€‰ä¸º Cygwinï¼Œç›®å½•ä¸º Cygwin å®‰è£…æ–‡ä»¶å¤¹ï¼ŒCmake Debugger å‡åœ¨ <code>C:\cygwin64\bin</code> ç›®å½•ä¸‹é€‰æ‹©ï¼ŒMakeã€C Complierã€C++ Complier è¿™ä¸‰é¡¹ç•™ç»™ CLion è‡ªåŠ¨æ£€æµ‹ã€‚</p>
</li>
<li>
<p>ç‚¹å‡»å‘ä¸Šçš„ç®­å¤´ï¼ŒæŠŠ Cygwin è®¾ç½®ä¸º Defaultï¼ŒCmake ä¼šé‡æ–° Config é¡¹ç›®ä»£ç ï¼š</p>
</li>
</ol>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">C:\SOFTWARE\cygwin64\bin\cmake.exe -DCMAKE_BUILD_TYPE=Debug -G <span class="string">"CodeBlocks - Unix Makefiles"</span> /cygdrive/d/LinuxShare/Tripod-cxx</span><br><span class="line">-- The C compiler identification is GNU <span class="number">9.2</span><span class="number">.0</span></span><br><span class="line">-- The CXX compiler identification is GNU <span class="number">9.2</span><span class="number">.0</span></span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/cc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/cc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/c++.exe</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/c++.exe -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - done</span><br><span class="line">-- Configuring done</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>CLion</tag>
        <tag>Cygwin</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ Quiz é¢˜è§£ 201~300</title>
    <url>/posts/7651320d/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>C++ Quiz é¢˜è§£ 101~200 æ•´ç†</li>
<li>æœ‰è¶£çš„é¢˜ç›®ï¼š</li>
<li>206 208 217 225 226 227 228 233 249 251</li>
<li>254 261 264 273 284 287</li>
</ul>
</blockquote>
<a id="more"></a>
<h4 id="Q-205">Q 205</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> id = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="built_in">array</span>[] = &#123; id % <span class="number">3</span>, id % <span class="number">5</span> &#125;;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="built_in">array</span>[<span class="number">0</span>]) &lt;&lt; <span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="built_in">array</span>[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š10<br>
array æ˜¯ä¸€ä¸ª <code>char</code> ç±»å‹çš„æ•°ç»„ï¼Œä½†æ˜¯å´ä½¿ç”¨ unsigned int åˆå§‹åŒ–ï¼Œunsigned int è½¬æ¢ä¸º <code>char</code> å±äº narrow è½¬æ¢ï¼Œå³æ–°ç±»å‹å¹¶ä¸èƒ½å®Œæ•´åœ°è¡¨ç¤ºåŸç±»å‹ã€‚<br>
ä½†æ˜¯ä»£ç ä¸­çš„æºæ˜¯ä¸€ä¸ªå¸¸é‡è¡¨è¾¾å¼ï¼Œå®ƒç±»å‹æå‡åçš„å€¼æ˜¯èƒ½å¤Ÿé€‚åˆç›®æ ‡ç±»å‹çš„ã€‚</p>
<h4 id="Q-206">Q 206</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="keyword">sizeof</span>(<span class="number">0</span>)[<span class="string">"abcdefghij"</span>];</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
sizeof åå¯ä»¥è·Ÿç€ä¸€å…ƒè¡¨è¾¾å¼ï¼Œæ­¤å¤„çš„ä¸€å…ƒè¡¨è¾¾å¼ä¸º <code>(0)[&quot;abcdefghij&quot;]</code>ï¼›<br>
è¡¨è¾¾å¼ <code>E1[E2]</code> ç­‰ä»·äº <code>*((E1)+(E2))</code>ï¼Œå› æ­¤ä¸€å…ƒè¡¨è¾¾å¼ç»“æœä¸º <code>'a'</code>ï¼Œsizeof çš„ç»“æœä¸º 1ã€‚</p>
<h4 id="Q-208">Q 208</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> default_constructed = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">bool</span> constructed = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">bool</span> assigned = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    C() &#123; default_constructed = <span class="literal">true</span>; &#125;</span><br><span class="line">    C(<span class="keyword">int</span>) &#123; constructed = <span class="literal">true</span>; &#125;</span><br><span class="line">    C&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> C&amp;) &#123; assigned = <span class="literal">true</span>; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="keyword">int</span>, C&gt; m;</span><br><span class="line">    m[<span class="number">7</span>] = C(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; default_constructed &lt;&lt; constructed &lt;&lt; assigned;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š111<br>
å¦‚æœ key ä¸å­˜åœ¨ï¼Œoperator [] æ“ä½œä¼šæ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨ç±»çš„æƒ…å†µä¸‹ï¼Œå…ƒç´ æ˜¯é»˜è®¤æ„é€ çš„ï¼Œå› æ­¤ m[7] ä¼šè°ƒç”¨ C çš„é»˜è®¤æ„é€ å‡½æ•°ï¼ˆä¸ç®¡æˆ‘ä»¬æ˜¯å¦é©¬ä¸Šç»™å®ƒèµ‹å€¼ï¼‰ï¼Œdefault_constructed è¢«è®¾ç½®ä¸º trueã€‚<br>
è¡¨è¾¾å¼ C(1) ä½¿ç”¨æ„é€ å‡½æ•° C(int) æ„é€ äº†ä¸€ä¸ª C å®ä¾‹ï¼Œconstructed è¢«è®¾ç½®ä¸º trueã€‚<br>
m[7] = C(1) è°ƒç”¨äº†èµ‹å€¼è¿ç®—ç¬¦ï¼Œå°†æ–°å»ºçš„ C(1) èµ‹å€¼ç»™ map ä¸­é»˜è®¤åˆ›å»ºçš„ Cï¼Œassigned è¢«è®¾ç½®ä¸º trueã€‚<br>
å¦‚æœä¸æƒ³åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è°ƒç”¨åˆ°é»˜è®¤æ„é€ å‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">m.insert(pair&lt;<span class="keyword">int</span>, C&gt;(<span class="number">7</span>, C(<span class="number">1</span>)));</span><br><span class="line">m.emplace(<span class="number">7</span>, C(<span class="number">1</span>));</span><br></pre></td></tr></table></figure>
<h4 id="Q-217">Q 217</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">const</span>&amp; a = i &gt; <span class="number">0</span> ? i : <span class="number">1</span>;</span><br><span class="line">    i = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i &lt;&lt; a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š21<br>
æœ¬é¢˜çš„å…³é”®åœ¨äº a æ˜¯å¦æ˜¯ i çš„å¼•ç”¨ã€‚<br>
æ¡ä»¶è¡¨è¾¾å¼çš„ç±»å‹å’Œå€¼ç±»åˆ«éƒ½å–å†³äºç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªè¡¨è¾¾å¼çš„ç±»å‹å’Œå€¼ç±»åˆ«ï¼Œå¦‚æœä¸¤è€…éƒ½æ˜¯å·¦å€¼ï¼Œç»“æœä¼šæ˜¯å·¦å€¼ï¼Œä½†æ˜¯æ­¤æ—¶ i å’Œ 1 åˆ†åˆ«æ˜¯å·¦å€¼ä¸å³å€¼ã€‚<br>
æŒ‰ç…§ <a href="https://timsong-cpp.github.io/cppwp/n4659/expr.cond" target="_blank" rel="noopener">expr.cond 8.16.6</a> èƒ½å¤Ÿå¾—å‡ºè¡¨è¾¾å¼ i &gt; 0 ? i : 1 çš„ç»“æœæ˜¯ä¸€ä¸ªçº¯å³å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸´æ—¶é‡ï¼Œå› æ­¤ a ç»‘å®šçš„æ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œå¯¹ i çš„ä¿®æ”¹ä¸ä¼šå½±å“åˆ° a çš„å€¼ã€‚</p>
<h4 id="Q-219">Q 219</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function">T <span class="title">sum</span><span class="params">(T arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> arg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line"><span class="function">T <span class="title">sum</span><span class="params">(T arg, Args... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> arg + sum&lt;T&gt;(args...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> n1 = sum(<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">auto</span> n2 = sum(<span class="number">1</span>, <span class="number">0.5</span>, <span class="number">1</span>, <span class="number">0.5</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; n1 &lt;&lt; n2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š32<br>
<code>T sum(T arg, Args... args)</code> æ˜¯ä¸€ä¸ªè¿­ä»£ç±»å‹çš„å‡½æ•°æ¨¡æ¿ï¼Œå®ƒä¼šä¸€ç›´è°ƒç”¨è‡ªèº«ä¸€ç›´åˆ° base case <code>T sum(T arg)</code>ï¼Œå½“ T çš„ç±»å‹æ²¡æœ‰è¢«æŒ‡å®šæ—¶ï¼Œå®ƒä¼šè¢«æ¨å¯¼ä¸º <code>sum</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå½“ <code>sum</code> è¿­ä»£çš„æ—¶å€™ï¼ŒT å·²ç»æŒ‡å®šäº†ç›¸å…³ç±»å‹ï¼Œå¯¹äº n1 æ¥è¯´æ˜¯ <code>double</code>ï¼Œå¯¹äº n2 æ¥è¯´æ˜¯ <code>int</code>ã€‚</p>
<h4 id="Q-220">Q 220</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'f'</span>; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">g</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'g'</span>; <span class="keyword">return</span> <span class="string">'g'</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">char</span> <span class="title">h</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'h'</span>; <span class="keyword">return</span> <span class="string">'h'</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> result = f() ? g() : h();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šffh<br>
ä¸‰å…ƒè¿ç®—ç¬¦çš„åŸºæœ¬æ“ä½œ</p>
<h4 id="Q-222">Q 222</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;variant&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    variant&lt;<span class="keyword">int</span>, <span class="keyword">double</span>, <span class="keyword">char</span>&gt; v;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; v.index();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š0<br>
<code>variant</code> æ˜¯ç±»å‹å®‰å…¨çš„ <code>union</code>ï¼Œå®ƒå¯ä»¥åœ¨ä»»æ„æ—¶é—´ä¿å­˜æ¨¡æ¿å‚æ•°åˆ—è¡¨ä¸­æŸä¸€ç±»å‹çš„å€¼æˆ–è€…ç©ºå€¼ï¼Œ<code>variant</code> ä¸èƒ½å­˜æ”¾å¼•ç”¨ã€æ•°ç»„æˆ– <code>void</code>ï¼Œç©º <code>variant</code> åº”è¯¥å†™ä¸º <code>std::variant&lt;std::monostate&gt;</code>ã€‚<br>
ä¸ <code>union</code> ä¸€æ ·ï¼Œ<code>variant</code> é»˜è®¤åˆå§‹åŒ–ä¸ºå®ƒæ¨¡æ¿ç±»å‹åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå€¼ï¼Œé™¤éè¯¥é¡¹æ— æ³•é»˜è®¤æ„é€ ã€‚<br>
<code>variant.index()</code> è¿”å›å½“å‰ä¿æœ‰é¡¹çš„ä¸‹æ ‡ï¼Œå¦‚æœ <code>variant</code> æ— å€¼åˆ™è¿”å› <code>variant_npos</code>ã€‚</p>
<h4 id="Q-224">Q 224</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Base</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">f</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Base::f</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Derived</span> :</span> Base &#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Derived::f</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Derived object;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; object.f();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; ((Base&amp;)object).f();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š22<br>
é¦–å…ˆï¼Œä¸ºçº¯è™šå‡½æ•°æä¾›å®šä¹‰æ˜¯æœ‰æ•ˆçš„ï¼Œåªè¦å®ƒä¸æ˜¯åœ¨ç±»çš„å£°æ˜ä¸­å®ç°å³å¯ã€‚<br>
<code>((Base&amp;)object).f()</code> åœ¨è°ƒç”¨ f ä¹‹å‰å°†å¯¹è±¡å¼ºåˆ¶è½¬æ¢ä¸º <code>Base&amp;</code>ï¼Œä½†æ˜¯ç”±äº f ä¸ºè™šå‡½æ•°ï¼Œå› æ­¤ä»ç„¶è¾“å‡º 2ã€‚</p>
<h4 id="Q-225">Q 225</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> &#123;</span></span><br><span class="line">    X() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>; &#125;</span><br><span class="line">    X(<span class="keyword">const</span> X &amp;) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"3"</span>; &#125;</span><br><span class="line">    ~X() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2"</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"4"</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125; object;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    X(object);</span><br><span class="line">    object.f();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š11422<br>
é¦–å…ˆï¼Œ<code>struct X {...} object;</code> å®šä¹‰äº†ä¸€ä¸ª X ç±»å‹çš„ objectï¼Œè°ƒç”¨ 1 æ¬¡æ„é€ å‡½æ•°ï¼›<br>
<code>X(object)</code> æ˜¯ä¸€ä¸ªæ–°å˜é‡ object çš„å£°æ˜ï¼Œè€Œä¸æ˜¯å¤åˆ¶æ„é€ ä¸€ä¸ª X å¯¹è±¡ï¼Œå¦‚æœå†™æˆ <code>X object</code> å°±å¾ˆæ¸…æ¥šäº†ï¼Œå±€éƒ¨å˜é‡è¦†ç›–æ‰äº†å…¨å±€å˜é‡ï¼Œè°ƒç”¨ 1 æ¬¡æ„é€ å‡½æ•°ï¼›<br>
æœ€ååˆ«å¿˜äº†è°ƒç”¨ä¸¤æ¬¡ææ„å‡½æ•°ã€‚</p>
<h4 id="Q-226">Q 226</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> &#123;</span></span><br><span class="line">    X() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>; &#125;</span><br><span class="line">    X(X &amp;) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2"</span>; &#125;</span><br><span class="line">    X(<span class="keyword">const</span> X &amp;) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"3"</span>; &#125;</span><br><span class="line">    X(X &amp;&amp;) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"4"</span>; &#125;</span><br><span class="line">    ~X() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"5"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Y</span> &#123;</span></span><br><span class="line">    <span class="keyword">mutable</span> X x;</span><br><span class="line">    Y() = <span class="keyword">default</span>;</span><br><span class="line">    Y(<span class="keyword">const</span> Y &amp;) = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Y y1;</span><br><span class="line">    Y y2 = <span class="built_in">std</span>::<span class="built_in">move</span>(y1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1255<br>
é¦–å…ˆæ„é€ ä¸€ä¸ª Y å¯¹è±¡ï¼ŒY ä¸­æœ‰ä¸€ä¸ª X ç±»å‹çš„æˆå‘˜ç±»ï¼Œä½¿ç”¨é»˜è®¤æ„é€ ï¼Œè¾“å‡º 1ã€‚<br>
<code>std::move</code> ä¼šå°† y1 è½¬å˜ä¸ºå³å€¼ï¼Œä½†æ˜¯ Y å¹¶æ²¡æœ‰ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œå› æ­¤è°ƒç”¨çš„æ˜¯å®ƒçš„æ‹·è´æ„é€ å‡½æ•°ï¼Œè¿™ä¸ªéšå¼å®šä¹‰çš„æ‹·è´æ„é€ å‡½æ•°å°†ä¼šæ‰§è¡Œ X ç±»æˆå‘˜å¯¹è±¡çš„æ‹·è´ï¼Œç°åœ¨çš„é—®é¢˜æ˜¯åˆ°åº•ä¼šæ‰§è¡Œå“ªä¸ªæ‹·è´æ„é€ å‡½æ•°ã€‚<br>
å› ä¸º X æœ‰ <code>mutable</code> ä¿®é¥°ï¼Œå› æ­¤ X è¢«è®¤ä¸ºæ˜¯é <code>const</code> æˆå‘˜ï¼Œé‡è½½è§£æè®¤ä¸º <code>X(X &amp;)</code> æ›´åŠ åˆé€‚ï¼Œå› ä¸º <code>X(const X &amp;)</code> è¿˜éœ€è¦è¿›è¡Œå¸¸æ•°è½¬æ¢ï¼Œæ‰€ä»¥æ­¤æ—¶è¾“å‡º 2ã€‚<br>
æœ€åï¼Œå› ä¸ºè°ƒç”¨çš„æ˜¯æ‹·è´æ„é€ å‡½æ•°ï¼Œä¼šè¾“å‡ºä¸¤ä¸ª 5ï¼Œå³ææ„ä¸¤æ¬¡ã€‚</p>
<h4 id="Q-227">Q 227</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Func = <span class="keyword">int</span>();</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span> &#123;</span></span><br><span class="line">    Func f;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">S::f</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    S s;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; s.f();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
<code>using Func = int()</code> æ˜¯ä¸€ç§<strong>åˆ«åå£°æ˜</strong>ï¼Œè¿™ç§å£°æ˜æ–¹å¼æ—¢å¯ä»¥ç”¨äºæ™®é€šå‡½æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨äºæˆå‘˜å‡½æ•°ã€‚</p>
<h4 id="Q-228">Q 228</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ...Ts&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> &#123;</span></span><br><span class="line">    X(Ts ...args) : Var(<span class="number">0</span>, args...) &#123;&#125;</span><br><span class="line">    <span class="keyword">int</span> Var;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    X&lt;&gt; x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¨‹åºè¡Œä¸ºæœªå®šä¹‰<br>
é¦–å…ˆçœ‹ä¸€ä¸‹ <code>X(Ts ...args) : Var(0, args...) {}</code> çš„åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰æ¨¡æ¿å‚æ•°ï¼Œè¯¥åˆå§‹åŒ–æ˜¯æœ‰æ•ˆçš„ï¼Œå› ä¸ºå®ƒåªæ˜¯ <code>Var(0)</code>ï¼Œä½†æ˜¯å¦‚æœæœ‰ä»»ä½•æ¨¡æ¿å‚æ•°ï¼Œå®ƒä»¬å°†æ‰©å±•ä¸ºæ— æ•ˆçš„ int ç±»å‹çš„åˆå§‹åŒ–ï¼Œå› æ­¤ X å”¯ä¸€æœ‰æ•ˆçš„ç‰¹åŒ–å°±æ˜¯æ²¡æœ‰å‚æ•°çš„ç‰¹åŒ–ã€‚å› æ­¤ <code>X&lt;&gt; x</code> åœ¨æ²¡æœ‰å‚æ•°çš„æƒ…å†µä¸‹å®ä¾‹åŒ–æ¨¡æ¿æ˜¯åˆæ³•è¡Œä¸ºã€‚<br>
C++ æ ‡å‡†è§„å®šï¼Œå¦‚æœå¯å˜å‚æ•°æ¨¡æ¿çš„æ¯ä¸ªæœ‰æ•ˆç‰¹åŒ–éƒ½éœ€è¦ä¸€ä¸ªç©ºçš„æ¨¡æ¿å‚æ•°åŒ…ï¼Œé‚£ä¹ˆè¿™ä¸ªç¨‹åºæ˜¯ç—…æ€çš„ï¼Œæ— éœ€è¯Šæ–­ã€‚å› æ­¤ä¸ä¼šæŠ¥ç¼–è¯‘å‡ºé”™ï¼Œè€Œæ˜¯ç¨‹åºè¡Œä¸ºæœªå®šä¹‰ã€‚</p>
<h4 id="Q-229">Q 229</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> f = [](<span class="keyword">int</span> b) &#123; <span class="keyword">return</span> a + b; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; f(<span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š5<br>
lambda è¡¨è¾¾å¼çš„éšå¼æ•è·è§„åˆ™æ˜¯å®ƒä¸ä¼šæ˜¾ç¤ºæ•è· *this å’Œå…·æœ‰è‡ªåŠ¨å­˜å‚¨å‘¨æœŸçš„å˜é‡ï¼Œè€Œæ­¤å¤„çš„ a å…·æœ‰é™æ€å­˜å‚¨å‘¨æœŸï¼Œå› æ­¤ lambda ä¸ä¼šéšå¼æ•è· aã€‚è¿™é‡Œçš„ a ä»…ä»…ä»£è¡¨å…¨å±€å˜é‡çš„å¼•ç”¨ã€‚</p>
<h4 id="Q-230">Q 230</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> var1 : <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> var2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    X x;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (&amp;x.var1 &lt; &amp;x.var2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¼–è¯‘é”™è¯¯<br>
å–åœ°å€è¿ç®—ç¬¦ <code>&amp;</code> ä¸èƒ½ç”¨äºä½åŸŸ</p>
<h4 id="Q-231">Q 231</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">override</span> &#123;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Base</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">override</span> <span class="title">f</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Derived</span> :</span> Base &#123;</span><br><span class="line">    virtual auto f() -&gt; override override&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">override</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Derived().f();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
è¿™é“é¢˜çš„è€ƒç‚¹åœ¨äº <code>override</code> èƒ½å¦ç”¨ä½œç±»å‹åç§°ã€‚<br>
C++ æ ‡å‡†ä¸­çš„ä¿ç•™å…³é”®å­—ä¸åŒ…å« <code>override</code>ï¼Œåªæœ‰å‡ºç°åœ¨ç‰¹å®šçš„ä¸Šä¸‹æ–‡ä¸­æ—¶ï¼Œ<code>override</code> å’Œ <code>final</code> æ‰å…·æœ‰ç‰¹æ®Šæ„ä¹‰ï¼Œè€Œ <code>override</code> åªæœ‰å‡ºç°åœ¨å£°æ˜ç¬¦ä¹‹åæ‰å…·æœ‰ç‰¹æ®Šæ„ä¹‰ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ type æ›¿æ¢ç±»å‹åï¼Œ<code>Drived::f</code> å¯ä»¥å†™ä¸ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">virtual auto f() -&gt; type override&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>;</span><br><span class="line">    <span class="keyword">return</span> type();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Q-233">Q 233</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">()</span> <span class="keyword">const</span>&amp;&amp;</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> ptr = &amp;X::f;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; is_same_v&lt;<span class="keyword">decltype</span>(ptr), <span class="keyword">int</span>()&gt;</span><br><span class="line">         &lt;&lt; is_same_v&lt;<span class="keyword">decltype</span>(ptr), <span class="keyword">int</span>(X::*)()&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š00<br>
è¿”å›ç±»å‹ï¼Œå‚æ•°ç±»å‹ï¼Œå¼•ç”¨æ ‡è¯†ç¬¦ï¼Œconst &amp; volatile æ ‡è¯†ç¬¦ä»¥åŠå¼‚å¸¸è§„èŒƒï¼ˆä¸åŒ…æ‹¬ç¼ºçœå‚æ•°ï¼‰æ˜¯å‡½æ•°ç±»å‹çš„ä¸€éƒ¨åˆ†ã€‚<br>
è¿™è¯´æ˜ä»£ç ä¸­çš„ <code>ptr</code> ç±»å‹åº”è¯¥æ˜¯ <code>int(X::f)() const&amp;&amp;</code>ã€‚</p>
<h4 id="Q-236">Q 236</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">auto</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = Foo();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šA1<br>
è½¬æ¢å‡½æ•°èƒ½å¤Ÿæœ‰æ¨æ–­è¿”å›ç±»å‹ï¼ˆåªæœ‰è½¬æ¢å‡½æ•°æ¨¡æ¿ä¸èƒ½è¿™ä¹ˆåšï¼‰ã€‚</p>
<h4 id="Q-248">Q 248</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> y = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> &amp;<span class="built_in">max</span> = <span class="built_in">std</span>::<span class="built_in">max</span>(x, y);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> &amp;<span class="built_in">min</span> = <span class="built_in">std</span>::<span class="built_in">min</span>(x, y);</span><br><span class="line"></span><br><span class="line">    x = <span class="number">11</span>;</span><br><span class="line">    y = <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">max</span> &lt;&lt; <span class="built_in">min</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1111<br>
<code>std::max</code> ä¸ <code>std::min</code> å½“ä¸¤æ•°ç›¸ç­‰æ—¶è¿”å›ç¬¬ä¸€ä¸ªæ•°ã€‚</p>
<h4 id="Q-249">Q 249</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="string">'0'</span>;</span><br><span class="line">    <span class="keyword">char</span> <span class="keyword">const</span> &amp;b = a;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; b;</span><br><span class="line">    a++;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š00<br>
å¯¹äº <code>T1&amp; cv1 = (T2)cv2</code> æ¥è¯´ï¼Œ<strong>åªæœ‰å½“ T1 ä¸ T2 ä¸¤ä¸ªç±»å‹ç›¸åŒæˆ–è€…æœ‰ç»§æ‰¿å…³ç³»ï¼Œå®ƒä»¬æ‰æ˜¯å¼•ç”¨ç›¸å…³çš„ï¼Œå¦åˆ™å°±æ˜¯å¼•ç”¨æ— å…³çš„</strong>ã€‚<br>
å½“ Â·T1 ä¸ T2 å¼•ç”¨æ— å…³æ—¶ï¼Œåˆå§‹åŒ–çš„å¼•ç”¨è¡¨è¾¾å¼ä¼šå°† cv2 éšå¼è½¬æ¢å‡ºä¸€ä¸ªä¸´æ—¶çš„ T1 ç±»å‹çš„å¯¹è±¡ç”¨äºå¼•ç”¨ç»‘å®šï¼Œè¯¥å¯¹è±¡ä¸åŸå¯¹è±¡æ²¡æœ‰å…³ç³»ã€‚<br>
<code>'0'</code> æ˜¯ <code>char</code> ç±»å‹çš„å­—é¢é‡ï¼ŒASCII ç ä¸º 48ï¼Œa ä¸­ä¿å­˜çš„ä¸º <code>int</code> ç±»å‹çš„ 48ï¼Œä½†æ˜¯ b æ˜¯ <code>char const</code> ç±»å‹çš„å¼•ç”¨ï¼Œå› æ­¤ <code>char const</code> ä¸ <code>int</code> ä¸å­˜åœ¨å¼•ç”¨ç›¸å…³çš„å…³ç³»ï¼Œb ç»‘å®šçš„æ˜¯ä¸€ä¸ª a è½¬æ¢å‡ºæ¥çš„ä¸´æ—¶ <code>char const</code> ç±»å‹å¯¹è±¡ï¼Œå› æ­¤ä¸¤æ¬¡æ‰“å°éƒ½ä¸º 0ã€‚</p>
<h4 id="Q-250">Q 250</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(T...)</span> </span>&#123;<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'A'</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(T...)</span> </span>&#123;<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'B'</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;  </span><br><span class="line">    foo(<span class="number">1</span>);</span><br><span class="line">    foo(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šAB<br>
ç¬¬ä¸€ä¸ª <code>foo</code> å‡½æ•°æ˜¯è€å¼çš„å¯å˜å‚æ•°å‡½æ•°æ¨¡æ¿ï¼Œæ¥æ”¶ç±»å‹ä¸º T çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ¥ç€æ˜¯å¯å˜æ•°ç›®çš„å‚æ•°ã€‚<br>
ç¬¬äºŒä¸ª <code>foo</code> æ˜¯å¯å˜å‚å‡½æ•°æ¨¡æ¿ï¼Œå®ƒéœ€è¦æ¥æ”¶ä¸€ä¸ªå‚æ•°åŒ…ã€‚<br>
é‡è½½å‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ‰¾åˆ°å¯¹äºç»™å®šçš„å‡½æ•°è°ƒç”¨ï¼Œå“ªäº›å‡½æ•°æ˜¯å¯ç”¨çš„ï¼Œç„¶åå†è¿™äº›å¯ç”¨çš„å‡½æ•°ä¸­æ‰¾åˆ°æœ€åˆé€‚çš„ï¼Œå¯¹äºå‡½æ•°æ¨¡æ¿æ¥è¯´ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹æ¨¡æ¿å‚æ•°è¿›è¡Œæ¨å¯¼æ¥ç”Ÿæˆè¿™äº›å€™é€‰çš„ç‰¹åŒ–å‡½æ•°ã€‚<br>
å…ˆçœ‹è°ƒç”¨ <code>foo(1)</code>ï¼š<br>
å¯¹äºç¬¬ä¸€ä¸ªå‡½æ•°æ¨¡æ¿ <code>foo</code> æ¥è¯´ï¼ŒT è¢«æ¨å¯¼ä¸º <code>int</code>ï¼Œé‡è½½è§£æä¸­å‚æ•°åˆ—è¡¨ â€¦ ä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºå®ƒæ²¡æœ‰åŒ¹é…å‚æ•°ï¼Œæœ€åå¾—åˆ° <code>foo(int)</code>ã€‚å¯¹äºç¬¬äºŒä¸ªå‡½æ•°æ¨¡æ¿ <code>foo</code> æ¥è¯´ï¼Œä¹Ÿä¼šæ¨æ–­å‡º <code>foo(int)</code>ï¼Œæ‰€ä»¥è¿™ä¸¤ç§éƒ½æ˜¯å¯è¡Œçš„ï¼Œæˆ‘ä»¬å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªæ›´åˆé€‚çš„ã€‚<br>
C++ è§„èŒƒ<strong>é¦–å…ˆä¼šæ¯”è¾ƒå“ªä¸€ä¸ªæ¨¡æ¿çš„è½¬æ¢åºåˆ—æ›´ä½³</strong>ï¼Œä½†æ˜¯åœ¨è¿™é‡Œä¸¤ä¸ªæ¨¡æ¿çš„è½¬æ¢åºåˆ—æ˜¯ä¸€æ ·çš„ï¼›<br>
<strong>æ¥ç€æ¯”è¾ƒå“ªä¸€ä¸ªæ¨¡æ¿æ›´åŠ ç‰¹åŒ–</strong> - <em>more specialized</em> - æˆ‘ä»¬èƒ½å¤Ÿä» <code>foo2</code> ä¸­æ¨å¯¼å‡º <code>foo1</code> å´æ— æ³•ä» <code>foo1</code> ä¸­æ¨å¯¼å‡º <code>foo2</code>ï¼Œå› æ­¤å¯¹äº <code>foo(1)</code> æ¥è¯´ï¼Œç¬¬ä¸€ä¸ªæ¨¡æ¿æ›´åˆé€‚ã€‚<br>
å†çœ‹ <code>foo(1,2)</code>ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°æ¨¡æ¿ <code>foo</code> éœ€è¦çœç•¥ <code>...</code> æ¥åŒ¹é…è½¬æ¢åºåˆ—ï¼Œè€Œç¬¬äºŒä¸ªå‡½æ•°æ¨¡æ¿ <code>foo</code> åˆ™ä¸éœ€è¦çœç•¥ï¼Œä»æ¯”è¾ƒæ¨¡æ¿è½¬æ¢åºåˆ—çš„è§’åº¦æ¥è¯´ï¼Œç¬¬äºŒä¸ª <code>foo</code> æ›´åˆé€‚ã€‚</p>
<h4 id="Q-251">Q 251</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">f</span>(<span class="title">T</span>) &#123;</span> <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">void</span> f&lt;&gt;(<span class="keyword">int</span>*) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">f</span>(<span class="title">T</span>*) &#123;</span> <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">3</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> *p = <span class="literal">nullptr</span>;</span><br><span class="line">    f( p );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š3<br>
é‡è½½è§£æå€¼è€ƒè™‘å‡½æ•°æ¨¡æ¿ï¼Œè€Œä¸ä¼šè€ƒè™‘å·²ç»æ˜¾å¼ç‰¹åŒ–çš„ <code>void f&lt;&gt;(int*)</code>ï¼Œå› æ­¤æ˜¯åœ¨ f(T) å’Œ f(T*) ä¸­é€‰æ‹©ä¸€ä¸ªæ›´å¥½çš„å‡½æ•°æ¨¡æ¿ã€‚<br>
ç®€å•æ¥è¯´ï¼Œf(T*) æ¥å—çš„ä»»ä½•å‚æ•°éƒ½ä¼šè¢« f(T) æ¥å—ï¼Œåä¹‹åˆ™ä¸ä¼šï¼Œå› æ­¤ f(T*) æ˜¯ä¸€ä¸ªæ›´åŠ ä¸“ä¸šçš„æ¨¡æ¿ï¼Œç¼–è¯‘å™¨æ›´åå‘é€‰æ‹©å®ƒã€‚<br>
ç°åœ¨é‡è½½è§£æé€‰æ‹©äº† <code>void f(T*)</code>ï¼Œé‚£ä¹ˆç‰¹åŒ–åº”è¯¥é€‰æ‹©å“ªä¸€ä¸ªå‘¢ï¼Ÿ<br>
<code>void f&lt;&gt;(int*)</code> æ˜¯ <code>void f(T)</code> çš„æ˜¾å¼ç‰¹åŒ–ï¼Œå› ä¸º f(T) æ˜¯åœ¨å…¶ä¹‹å‰çš„å”¯ä¸€å‡½æ•°æ¨¡æ¿å£°æ˜ï¼Œå› ä¸ºé‡è½½è§£æå·²ç»é€‰æ‹©äº†å¦ä¸€ä¸ªå‡½æ•°æ¨¡æ¿ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨è¯¥æ¨¡æ¿çš„éšå¼ç‰¹åŒ–ï¼Œæ‰“å° 3ã€‚</p>
<h4 id="Q-252">Q 252</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="string">'3'</span> - <span class="string">'2'</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
C++ æ ‡å‡†ä¸­ï¼Œåªèƒ½ä¿è¯åè¿›åˆ¶æ•°å­—ä¹‹é—´çš„é—´éš”ç›¸å·® 1ï¼Œä¸èƒ½ä¿è¯ <code>'b' - 'a' = 1</code>ã€‚</p>
<h4 id="Q-254">Q 254</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::is_same_v&lt;<span class="keyword">void</span>(<span class="keyword">int</span>), <span class="keyword">void</span>(<span class="keyword">const</span> <span class="keyword">int</span>)&gt;;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::is_same_v&lt;<span class="keyword">void</span>(<span class="keyword">int</span>*), <span class="keyword">void</span>(<span class="keyword">const</span> <span class="keyword">int</span>*)&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š10<br>
å½“ T å’Œ U ç±»å‹ç›¸åŒæ—¶è¿”å› trueã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt; <span class="class"><span class="keyword">class</span> <span class="title">T</span>, <span class="title">class</span> <span class="title">U</span> &gt;</span></span><br><span class="line"><span class="class"><span class="title">inline</span> <span class="title">constexpr</span> <span class="title">bool</span> <span class="title">is_same_v</span> = <span class="title">is_same</span>&lt;T, U&gt;:</span>:value;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°çš„å¸¸é‡ä¸æ˜¯å‡½æ•°ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨ç”Ÿæˆå‡½æ•°ç±»å‹æ—¶ä¼šåˆ é™¤é¡¶çº§ cv é™å®šç¬¦ã€‚<br>
å› æ­¤ <code>void(const int)</code> çš„ç±»å‹å…¶å®æ˜¯ <code>void(int)</code>ï¼›<br>
è€Œç¬¬äºŒç§æƒ…å†µä¸­å‚æ•°åˆ†åˆ«æ˜¯æŒ‡å‘ int ç±»å‹çš„æŒ‡é’ˆå’ŒæŒ‡å‘ const int ç±»å‹çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆå‚æ•°æœ¬èº«å¹¶ä¸æ˜¯ constï¼Œå› æ­¤ä¸éœ€è¦åˆ é™¤ const é™å®šç¬¦ï¼›<br>
ä¸ºä»€ä¹ˆå‚æ•°çš„å¸¸é‡ä¸æ˜¯å‡½æ•°ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼šå½“ä¸€ä¸ªå‚æ•°é€šè¿‡å€¼ä¼ é€’æ—¶ï¼Œå°±ä¼šå¤åˆ¶è¯¥å‚æ•°ï¼Œè€ŒåŸå§‹å‚æ•°æ°¸è¿œä¸ä¼šè¢«ä¿®æ”¹ã€‚å› æ­¤ï¼Œå¯¹äºè°ƒç”¨è€…æ¥è¯´ï¼Œå‚æ•°æ˜¯å¦ä¸º const å¹¶ä¸é‡è¦ï¼Œå®ƒåªä¸å‡½æ•°å†…éƒ¨ç›¸å…³ã€‚</p>
<h4 id="Q-259">Q 259</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span>)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"u"</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>)</span>          </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"i"</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">char</span>)</span>         </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"c"</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">char</span> y = <span class="number">2</span>;</span><br><span class="line">    f(x + y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¨‹åºè¾“å‡ºæœªå®š<br>
ä¸¤ä¸ª <code>char</code> ç±»å‹çš„å’Œå¹¶ä¸æ˜¯å”¯ä¸€ç¡®å®šçš„ï¼Œè™½ç„¶èƒ½è‚¯å®šç»“æœä¸æ˜¯ <code>char</code>ã€‚<br>
åœ¨è¿ç®—ä¹‹å‰æ“ä½œæ•°ä¼šè¿›è¡Œé€šç”¨ç±»å‹è½¬æ¢ï¼Œè€Œ <code>char</code> åœ¨ä¸åŒçš„åœºåˆå¯èƒ½ä¼šè¢«æå‡ä¸º <code>int</code> æˆ– <code>unsigned int</code>ã€‚</p>
<h4 id="Q-261">Q 261</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">stringstream</span> <span class="title">ss</span><span class="params">(<span class="string">"a"</span>)</span></span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; ss.str();</span><br><span class="line">    ss &lt;&lt; <span class="string">"b"</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; ss.str();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šab<br>
stringstream æœ‰ä¸€ä¸ªå­—ç¬¦ç¼“å†²åŒºï¼Œä½¿ç”¨å­—ç¬¦ä¸²åˆå§‹åŒ–åå®ƒå°†ä½¿ç”¨è¯¥å­—ç¬¦ä¸²åˆå§‹åŒ–å­—ç¬¦ç¼“å†²åŒºï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ aã€‚<br>
è¾“å‡º a åï¼Œæ“ä½œç¬¦ <code>operator &lt;&lt;</code> å°†å‘ç¼“å†²åŒºçš„ä¸‹ä¸€ä¸ªä½ç½®å†™å…¥å­—ç¬¦ï¼Œåœ¨æœ¬é¢˜ä¸­æ˜¯ç¼“å†²åŒºçš„å¼€å¤´ï¼Œå³å†™å…¥ b è¦†ç›–æ‰å…ˆå‰å†™çš„ aã€‚<br>
æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„åˆå§‹åŒ–æ–¹å¼æ¥æ”¹å˜è¾“å‡ºçš„ç»“æœï¼š<br>
<code>std::stringstream ss(&quot;a&quot;, std::ios_base::out|std::ios_base::ate);</code><br>
å…¶ä¸­ <code>std::ios_base::out|std::ios_base::ate</code> è¡¨ç¤ºå†™æ‰“å¼€ï¼Œå¹¶ä¸”æ‰“å¼€åç«‹å³å°†å…‰æ ‡æ”¾åœ¨æ–‡æœ¬æœ«å°¾<br>
è¿™æ · a ä¸ä¼šè¢«è¦†ç›–ï¼Œè¾“å‡º aabï¼Œç¬¬ä¸€ä¸ª a æ¥è‡ª <code>ss.str()</code> çš„ç¬¬ä¸€ä¸ªè°ƒç”¨ï¼Œab æ¥è‡ª <code>ss.str()</code> çš„ç¬¬äºŒä¸ªè°ƒç”¨ã€‚</p>
<h4 id="Q-264">Q 264</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">C</span> &#123;</span></span><br><span class="line">    C() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> C c;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; c.i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¼–è¯‘é”™è¯¯<br>
ç”±äº c æ˜¯ const å¹¶ä¸”æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œæ˜¯ä¸èƒ½é»˜è®¤åˆå§‹åŒ– c çš„ã€‚<br>
C++ æ ‡å‡†è§„å®šï¼Œå¦‚æœç¨‹åºè°ƒç”¨ <code>const</code> é™å®šç±»å‹ T å¯¹è±¡çš„é»˜è®¤åˆå§‹åŒ–ï¼Œé‚£ä¹ˆ T åº”è¯¥æ˜¯ - <em>const-default-constructible</em> - å¸¸é‡é»˜è®¤å¯æ„é€ çš„ï¼Œå¸¸é‡é»˜è®¤å¯æ„é€ æŒ‡çš„æ˜¯<strong>ç±»ç±»å‹ T çš„é»˜è®¤åˆå§‹åŒ–è°ƒç”¨äº†ç”¨æˆ·æä¾›çš„ T çš„æ„é€ å‡½æ•°</strong>æˆ–è€…<strong>æ¯ä¸ªç›´æ¥çš„éå˜é‡éé™æ€æ•°æ®æˆå‘˜æœ‰é»˜è®¤æˆå‘˜åˆå§‹åŒ–</strong>ï¼Œå¦‚æœè¦å°†æœ¬é¢˜ä¿®æ”¹æ­£ç¡®æœ‰ä¸¤ç§æ–¹æ³•ï¼š<br>
ç»™ <code>int i</code> ä¸€ä¸ªåˆå§‹å€¼ <code>int i{0}</code>ï¼›<br>
ä¸º C æä¾›æ„é€ å‡½æ•°ï¼Œç§»é™¤ <code>= default</code>ï¼Œæ‰§è¡Œ <code>C::C() = default</code>ã€‚</p>
<h4 id="Q-265">Q 265</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">char</span>*&amp;&amp;)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">1</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">char</span>*&amp;)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> c = <span class="string">'a'</span>;</span><br><span class="line">    f(&amp;c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
<code>&amp;c</code> è¿”å›çš„æ˜¯å·¦å€¼ c çš„åœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯å³å€¼ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ª <code>operator&amp;</code> è¿”å›çš„åŒ¿åä¸´æ—¶å¯¹è±¡ã€‚</p>
<h4 id="Q-273">Q 273</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span></span><br><span class="line">    A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">    ~A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"a"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"main"</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">sizeof</span> <span class="keyword">new</span> A;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šmain<br>
<code>sizeof</code> è¿ç®—ç¬¦çš„æ“ä½œæ•°å¯ä»¥æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¸¦åœ†æ‹¬å·çš„ type-idã€‚<br>
æœ¬é¢˜ä¸­ <code>sizeof</code> çš„æ“ä½œæ•°æ˜¯è¡¨è¾¾å¼ <code>new A</code>ï¼Œå®ƒçš„ç±»å‹æ˜¯æŒ‡å‘ A å¯¹è±¡çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆçš„å¤§å°åœ¨æ¯ä¸ªå¹³å°æ˜¯ä¸åŒçš„ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬å¹¶ä¸å…³ç³»ï¼Œå› ä¸ºæ— éœ€æ‰“å°å®ƒï¼Œé—®é¢˜æ˜¯ <code>new A</code> æ˜¯å¦æ„é€ äº†ä¸€ä¸ªæ–°çš„ A å¯¹è±¡ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦ææ„å®ƒã€‚<br>
C++ æ ‡å‡†è§„å®šï¼Œ<code>sizeof</code> çš„æ“ä½œæ•°å¦‚æœæ˜¯è¡¨è¾¾å¼ï¼Œå®ƒä¼šæ˜¯ä¸€ä¸ªæœªæ±‚å€¼çš„æ“ä½œæ•° - an unevaluated operandï¼Œå› æ­¤è¡¨è¾¾å¼ <code>new A</code> ä¸ä¼šè¢«æ±‚å€¼ï¼ŒA å¹¶ä¸ä¼šè¢«æ„é€ ï¼Œè¡¨è¾¾å¼ä»…ä»…ç”¨äºè®¡ç®— <code>sizeof</code>ã€‚</p>
<h4 id="Q-283">Q 283</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">show_id</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ~show_id() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; id; &#125;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">delete</span>[] <span class="keyword">new</span> show_id[<span class="number">3</span>]&#123; &#123;<span class="number">0</span>&#125;, &#123;<span class="number">1</span>&#125;, &#123;<span class="number">2</span>&#125; &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š210<br>
è¿™é“é¢˜çš„æ ¸å¿ƒåœ¨äºå¯¹è±¡ææ„çš„é¡ºåºæ˜¯æ€æ ·çš„ï¼ŒC++ ä¸­ï¼Œå¯¹è±¡é€šå¸¸æŒ‰ç…§å®ƒä»¬æ„é€ çš„ç›¸åé¡ºåºææ„ï¼ŒåŒ…æ‹¬ <code>delete[]</code> è¿ç®—ã€‚</p>
<h4 id="Q-284">Q 284</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line">auto main() -&gt; int &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> out&#123;<span class="string">"Hello world"</span>&#125;;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (out[out.<span class="built_in">size</span>()] == <span class="string">'\0'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
å½“ pos ä¸å­—ç¬¦ä¸²é•¿åº¦ç›¸ç­‰æ—¶ï¼Œstd::string çš„ operator[size_type pos] æ“ä½œç¬¦å¿…é¡»è¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ã€‚</p>
<h4 id="Q-286">Q 286</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> short x=<span class="number">0xFFFF</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> short y=<span class="number">0xFFFF</span>;</span><br><span class="line">    <span class="keyword">auto</span> z=x*y;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (z &gt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¨‹åºè¡Œä¸ºæœªå®šä¹‰<br>
x å’Œ y åœ¨è¿ç®—ä¹‹å‰éƒ½ä¼šè¢«è½¬æ¢æˆå¦å¤–ä¸€ç§ç±»å‹ï¼Œåœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸Šè¿™ä¸ªç±»å‹ä¸º <code>int</code>ï¼Œå³ 32 ä½æœ‰ç¬¦å·ã€‚<br>
ä½† 0xFFFF * 0xFFFF çš„ä¹˜ç§¯ä¸º 4294836225 å·²ç»è¶…è¿‡äº† int èƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼ 2147483647ï¼Œæœ‰ç¬¦å·æ•´æ•°æº¢å‡ºï¼Œå±äºæœªå®šä¹‰è¡Œä¸ºã€‚</p>
<h4 id="Q-287">Q 287</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>::string_literals;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">s1</span><span class="params">(<span class="string">"hello world"</span>, <span class="number">5</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">s2</span><span class="params">(<span class="string">"hello world"</span>s, <span class="number">5</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; s1 &lt;&lt; s2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šhello world<br>
ç›¸åŒçš„æ„é€ å‡½æ•°åœ¨ä½¿ç”¨ C é£æ ¼å­—ç¬¦ä¸²å’Œä½¿ç”¨ basic_string æ‰€è¡¨ç°å‡ºæ¥çš„è¡Œä¸ºæ˜¯ä¸ä¸€æ ·çš„ï¼Œå¯¹äºå‰è€…æ¥è¯´ï¼Œå®ƒè¡¨ç¤ºåˆ°è¾¾æ­¤ä½ç½®ï¼Œå¯¹äºåè€…æ¥è¯´ï¼Œå®ƒè¡¨ç¤ºä»æ­¤ä½ç½®å¼€å§‹ã€‚<br>
<code>basic_string(const charT* s, size_type n, const Allocator&amp; a = Allocator());</code><br>
ç¬¬äºŒä¸ªå‚æ•° n è¡¨ç¤ºä» C æ ·å¼å­—ç¬¦ä¸²çš„å¼€å§‹å¤„å–å¤šå°‘ä¸ªå­—ç¬¦ã€‚<br>
<code>basic_string(const basic_string&amp; str, size_type pos, const Allocator&amp; a = Allocator());</code><br>
åˆå§‹åŒ–ä» pos å¼€å§‹é•¿åº¦ä¸º str.size() - pos çš„å­—ç¬¦ä¸²ã€‚</p>
<h4 id="Q-288">Q 288</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> I = <span class="number">1</span>, J = <span class="number">1</span>, K = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (++I || ++J &amp;&amp; ++K);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; I &lt;&lt; J &lt;&lt; K;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1211<br>
è¿ç®—ç¬¦ &amp;&amp; çš„ä¼˜å…ˆçº§é«˜äº ||ï¼ŒåŸè¡¨è¾¾å¼ç­‰ä»·äº <code>(++I || (++J &amp;&amp; ++K))</code>ï¼Œå…ˆè®¡ç®— ++Iï¼Œè¡¨è¾¾å¼ä¸º trueï¼Œåé¢çš„è¡¨è¾¾å¼è¢«çŸ­è·¯ï¼Œä¸ä¼šå†è®¡ç®—äº†ã€‚</p>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>C++ Quiz</tag>
        <tag>Programming-Language</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ Quiz é¢˜è§£ 101~200</title>
    <url>/posts/467b42a7/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>C++ Quiz é¢˜è§£ 101~200 æ•´ç†</li>
<li>æœ‰è¶£çš„é¢˜ç›®ï¼š</li>
<li>105 111 116 122 127 129 130 133 135 148</li>
<li>160 163 190 193 195 198</li>
</ul>
</blockquote>
<a id="more"></a>
<h4 id="Q-105">Q 105</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A() &#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"a"</span>; &#125;</span><br><span class="line">    ~A() &#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">label:</span><br><span class="line">    A a;</span><br><span class="line">    <span class="keyword">if</span> (i--)</span><br><span class="line">        <span class="keyword">goto</span> label;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šaAaA<br>
C++ æ ‡å‡†å¯¹äº <code>goto</code> è¯­å¥æœ‰å¦‚ä¸‹è¦æ±‚ï¼š<br>
å…·æœ‰è‡ªåŠ¨å­˜å‚¨æœŸçš„å˜é‡ä¼šåœ¨è·³è½¬ä¹‹å‰è¢«é”€æ¯è€Œä¸æ˜¯åœ¨è·³è½¬ä¹‹åè¢«é”€æ¯ã€‚</p>
<h4 id="Q-106">Q 106</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">int</span> x;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123; <span class="keyword">int</span> y; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; x &lt;&lt; y;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¨‹åºé“¾æ¥é”™è¯¯ï¼Œè¡Œä¸ºæœªå®šä¹‰<br>
C++ ä¸ºäº†æ”¯æŒå‡½æ•°é‡è½½ï¼Œå…¶ä¸­çš„å‡½æ•°åœ¨è¢« C++ ç¼–è¯‘ååœ¨ç¬¦å·åº“ä¸­çš„åå­—ä¸ C è¯­è¨€çš„ä¸åŒã€‚ä¸ºäº†å®ç° C++ ä¸ C çš„æ··åˆç¼–ç¨‹ï¼ŒC++ å¼•å…¥äº† <code>extern &quot;C&quot;</code>ï¼Œè¢« <code>extern &quot;C&quot;</code> ä¿®é¥°çš„å‡½æ•°æˆ–è€…å˜é‡æ˜¯æŒ‰ç…§Cè¯­è¨€æ–¹å¼ç¼–è¯‘å’Œé“¾æ¥çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> a;       <span class="comment">//å£°æ˜ä¸€ä¸ªå…¨å±€å˜é‡</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> a = <span class="number">0</span>;   <span class="comment">//å®šä¹‰å…¨å±€å˜é‡å¹¶ç»™åˆå€¼</span></span><br></pre></td></tr></table></figure>
<p>åŸä»£ç ä¸­çš„<code>extern &quot;C&quot; int x;</code> è¡¨ç¤ºè¢«å®ƒä¿®é¥°çš„ç›®æ ‡æ˜¯ extern çš„ï¼›å…¶æ¬¡ï¼Œè¢«å®ƒä¿®é¥°çš„ç›®æ ‡ä»£ç æ˜¯ â€œCâ€ çš„ã€‚æ‰€ä»¥è¯´è¿™æ¡è¯­å¥è¡¨ç¤ºçš„æ˜¯<strong>å£°æ˜ä¸€ä¸ª C ç±»å‹çš„å˜é‡</strong>ã€‚<br>
è€Œ<code>extern &quot;C&quot; { int y; }</code> è¡¨ç¤ºåˆ™çš„æ˜¯å®šä¹‰ä¸€ä¸ª C ç±»å‹çš„å˜é‡ã€‚</p>
<h4 id="Q-107">Q 107</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"f"</span>; <span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">g</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"g"</span>; <span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">h</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; v)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    h(&#123;f(), g()&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šfg<br>
è¿™é“é¢˜çš„è€ƒç‚¹æ˜¯åˆå§‹åŒ–åˆ—è¡¨ä¸­å‚æ•°çš„è®¡ç®—é¡ºåºï¼ŒC++ æ ‡å‡†è§„å®šï¼Œåˆå§‹åŒ–åˆ—è¡¨ä¸­çš„å­å¥æŒ‰ç…§å®ƒä»¬å‡ºç°çš„é¡ºåºè¿›è¡Œè®¡ç®—ã€‚</p>
<h4 id="Q-109">Q 109</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_with</span><span class="params">(<span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(T)&gt; f, T val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    f(val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> <span class="built_in">print</span> = [] (<span class="keyword">int</span> x) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; x; &#125;;</span><br><span class="line">    call_with(<span class="built_in">print</span>, <span class="number">42</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¼–è¯‘é”™è¯¯<br>
ç¼–è¯‘å™¨ä¼šæ¨å¯¼æ¯ä¸ªå‚æ•°çš„ <code>T</code> å¹¶æ£€æŸ¥æ¨å¯¼ç±»å‹æ˜¯å¦åŒ¹é…ã€‚<br>
<code>lambda</code> æ˜¯å®Œå…¨ä¸åŒçš„ç±»å‹ï¼Œä¸èƒ½ä¸ <code>std::function&lt;void(T)</code>&gt; åŒ¹é…ï¼Œè¿™ç§æƒ…å†µéœ€è¦å°†ç¬¬ä¸€ä¸ªå‚æ•°è½¬æ¢ä¸ºéæ¨å¯¼ä¸Šä¸‹æ–‡ - <em>nondeduced context</em> - æ¥è§£å†³ã€‚<br>
éæ¨å¯¼ä¸Šä¸‹æ–‡æ˜¯ä¸€ç§ç±»å‹çš„åµŒå¥—åç§°è¯´æ˜ç¬¦ã€‚<br>
ä¸¾å‡ ä¸ªä¾‹å­ï¼š<br>
ç±»å‹ <code>A&lt;T&gt;::B&lt;T2&gt;</code> ä¸­ <code>T</code> ä¸ <code>T2</code> éƒ½æ˜¯éæ¨å¯¼çš„ï¼›<br>
<code>void f(typename A&lt;T&gt;::B, A&lt;T&gt;)</code> ä¸­çš„ç¬¬ä¸€ä¸ª <code>T</code> æ˜¯éæ¨å¯¼çš„ï¼Œç¬¬äºŒä¸ª <code>T</code> æ˜¯æ¨å¯¼çš„ã€‚<br>
ä½¿ç”¨ä¸€ä¸ª helper struct è¾…åŠ©ç»“æ„æ¨¡æ¿å¯ä»¥å°† <code>std::function&lt;void(T)&gt;</code> è½¬æ¢ä¸ºéæ¨å¯¼ä¸Šä¸‹æ–‡ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">type_identity</span> &#123;</span></span><br><span class="line">    <span class="keyword">typedef</span> T type;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_with</span><span class="params">(<span class="keyword">typename</span> type_identity&lt;<span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(T)&gt;&gt;::type f, T val)</span> </span>&#123;</span><br><span class="line">    f(val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åƒä¸‹é¢è¿™æ ·æ˜ç¡®æŒ‡å®šæ¨¡æ¿å‚æ•°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">call_with&lt;<span class="keyword">int</span>&gt;(<span class="built_in">print</span>, <span class="number">42</span>);</span><br></pre></td></tr></table></figure>
<h4 id="Q-111">Q 111</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span>(i &lt; <span class="number">3</span>) <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
<code>continue</code> è¯­å¥ä¼šå°†æ§åˆ¶ä¼ é€’ç»™æœ€å°å°é—­è¿­ä»£è¯­å¥çš„å¾ªç¯å»¶ç»­éƒ¨åˆ†ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯<strong>å¾ªç¯çš„æœ«å°¾è€Œä¸æ˜¯èµ·å§‹</strong>ã€‚</p>
<h4 id="Q-112">Q 112</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span></span><br><span class="line">    A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>; &#125;</span><br><span class="line">    A(<span class="keyword">const</span> A&amp;) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2"</span>; &#125;</span><br><span class="line">    A(A&amp;&amp;) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"3"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span> &#123;</span></span><br><span class="line">    A a;</span><br><span class="line">    B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"4"</span>; &#125;</span><br><span class="line">    B(<span class="keyword">const</span> B&amp; b) : a(b.a) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"5"</span>; &#125;</span><br><span class="line">    B(B&amp;&amp; b) : a(b.a) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"6"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    B b1;</span><br><span class="line">    B b2 = <span class="built_in">std</span>::<span class="built_in">move</span>(b1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1426<br>
b1 é»˜è®¤æ„é€ æˆåŠŸä¹‹å‰ a å…ˆé»˜è®¤æ„é€ ï¼Œå› æ­¤è¾“å‡º 14.<br>
æ¥ç€ç”¨ç§»åŠ¨æ„é€ å‡½æ•°åˆå§‹åŒ– b2ï¼Œ<code>std::move(b1)</code> å°† b1 çš„å¼•ç”¨è½¬åŒ–ä¸ºä¸€ä¸ªå°†äº¡å€¼ï¼Œåœ¨ B çš„ç§»åŠ¨æ„é€ å‡½æ•°ä¸­ï¼Œa åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­è¢«æ„é€ ï¼Œå°½ç®¡æ­¤å¤„çš„ b æ˜¯ä¸€ä¸ªç»‘å®šäº†å³å€¼çš„å³å€¼å¼•ç”¨ï¼Œb æœ¬èº«ä»ç„¶æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå› æ­¤è°ƒç”¨çš„æ˜¯ A çš„æ‹·è´æ„é€ å‡½æ•°ï¼Œæœ€åè¾“å‡º 26ã€‚</p>
<h4 id="Q-113">Q 113</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(T)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f(<span class="number">0.0</span>);</span><br><span class="line">    f(<span class="number">0</span>);</span><br><span class="line">    f&lt;&gt;(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š132<br>
å¯¹äº f(0.0) æ¥è¯´ï¼ŒT è¢«æ¨å¯¼ä¸º doubleï¼Œå‡½æ•°æ¨¡æ¿çš„ä¸€ä¸ªç‰¹åŒ–è¢«åŠ å…¥åˆ°é‡è½½è§£æçš„å€™é€‰ä¸­ï¼Œåœ¨æ‰€æœ‰çš„å€™é€‰å‡½æ•°ä¸­ <code>f(double)</code> æ˜¯ä¸€ä¸ªæœ€å¥½çš„åŒ¹é…ï¼Œè¾“å‡º 1ã€‚<br>
å¯¹äº f(0) æ¥è¯´ï¼Œå‡½æ•°æ¨¡æ¿ä¸­çš„ T è¢«æ¨å¯¼ä¸º intï¼Œå‡½æ•°æ¨¡æ¿çš„ä¸€ä¸ªç‰¹åŒ– <code>void f(int)</code> è¢«åŠ å…¥åˆ°é‡è½½è§£æçš„å€™é€‰ä¸­ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯éæ¨¡æ¿å‡½æ•°çš„ <code>void f(int)</code>ï¼ŒC++ æ ‡å‡†è§„å®šï¼Œä¸€ä¸ªéæ¨¡æ¿å‡½æ•°æ¯”ä¸€ä¸ªç‰¹åŒ–çš„æ¨¡æ¿å‡½æ•°æ›´åŠ é€‚åˆé‡è½½ï¼Œå› æ­¤è¾“å‡º 3ã€‚<br>
æœ€å f&lt;&gt;(0) ä¸­çš„ &lt;&gt; æ˜¯ä¸€ä¸ªç©ºæ¨¡æ¿å‚æ•°åˆ—è¡¨ï¼Œå¯ä»¥ä¸ºæ¨¡æ¿å‡½æ•°æŒ‡å®šï¼Œä½†æ˜¯ä¸å¯ä»¥ä¸ºéæ¨¡æ¿å‡½æ•°æŒ‡å®šï¼Œå› æ­¤ f&lt;&gt;(0) æ˜¾å¼åœ°è¦æ±‚å‡½æ•°æ¨¡æ¿ï¼ŒC++ æ ‡å‡†è§„å®šï¼Œä¸€ä¸ªç©ºçš„æ¨¡æ¿å‚æ•°åˆ—è¡¨å¯ä»¥ç”¨äºæŒ‡å®šä½¿ç”¨ç‰¹åŒ–çš„å‡½æ•°æ¨¡æ¿ï¼Œå³ä½¿åŒæ—¶å­˜åœ¨éæ¨¡æ¿å‡½æ•°ã€‚<br>
T è¢«æ¨å¯¼ä¸º intï¼Œint çš„ç‰¹åŒ–æ˜¯å”¯ä¸€çš„å€™é€‰é¡¹ï¼Œæ‰“å° 2ã€‚</p>
<h4 id="Q-114">Q 114</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span>       </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"B"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span> &#123;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;C&gt; v;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;C&gt; u;</span><br><span class="line">    C *<span class="keyword">const</span> p;</span><br><span class="line">    S() : v(<span class="number">1</span>), u(<span class="keyword">new</span> C()), p(u.<span class="built_in">get</span>()) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    S s;</span><br><span class="line">    <span class="keyword">const</span> S &amp;r = s;</span><br><span class="line"></span><br><span class="line">    s.v[<span class="number">0</span>].foo();</span><br><span class="line">    s.u-&gt;foo();</span><br><span class="line">    s.p-&gt;foo();</span><br><span class="line"></span><br><span class="line">    r.v[<span class="number">0</span>].foo();</span><br><span class="line">    r.u-&gt;foo();</span><br><span class="line">    r.p-&gt;foo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šAAABAA<br>
C++ æ ‡å‡†è§„å®šï¼Œcv é™å®šç¬¦åº”ç”¨äºæŒ‡é’ˆè€Œä¸æ˜¯æŒ‡å‘çš„å¯¹è±¡ã€‚<br>
å› æ­¤å¯¹äºåŸå§‹æŒ‡é’ˆå’Œå¼•ç”¨ï¼ŒåŒ…æ‹¬è¯•å›¾æ¨¡æ‹Ÿå®ƒä»¬çš„æ ‡å‡†ç±»å‹ <code>std::unique_ptr</code> æ¥è¯´ï¼Œ<code>const</code> é™å®šç¬¦å±äºæµ…é™å®šï¼Œè€Œå¯¹äºæ ‡å‡†å®¹å™¨æ¥è¯´ï¼Œ<code>const</code> åˆ™ä¸æ˜¯æµ…é™å®šã€‚<br>
ä¸Šé¢çš„ä»£ç ä¸­å¯¹è±¡ s æ˜¯ non-const çš„ï¼Œå› æ­¤è¯¥å¯¹è±¡çš„æˆå‘˜éƒ½ä¿ç•™äº†å®ƒçš„é»˜è®¤å¸¸é‡å±æ€§ï¼Œå³ non-constï¼Œå¹¶ä¸”æ‰€æœ‰å¯¹è¯¥å¯¹è±¡æˆå‘˜çš„è°ƒç”¨éƒ½ä½¿ç”¨ <code>C::foo()</code> çš„ non-const ç‰ˆæœ¬ã€‚<br>
ç„¶è€Œï¼Œr æ˜¯å¯¹è±¡ s çš„å¸¸é‡å¼•ç”¨ï¼Œconst é™å®šç¬¦æ”¹å˜äº†å®ƒçš„æˆå‘˜ v çš„è¡Œä¸ºï¼Œæ­¤æ—¶ <code>std::vector</code> çš„ <code>operator[]</code> è¿”å›çš„æ˜¯ <code>const C&amp;</code>ï¼Œå› æ­¤è°ƒç”¨çš„æ˜¯ <code>C::foo()</code> çš„ const ç‰ˆæœ¬ï¼ŒåŒæ—¶ r çš„ const å±æ€§ä¹Ÿä¼ é€’ç»™å®ƒçš„æˆå‘˜ u å’Œ pï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡é’ˆæœ¬èº«å˜æˆäº†å¸¸é‡ï¼Œä½†æŒ‡å‘çš„å¯¹è±¡å¹¶ä¸æ˜¯å¸¸é‡ï¼Œå› æ­¤å®ƒä»¬ä»ç„¶è°ƒç”¨ <code>C::foo()</code> çš„ non-const ç‰ˆæœ¬ã€‚<br>
æœ€åï¼Œè¿˜è¦æ³¨æ„ <code>C* const p</code> æ˜¯ä¸€ä¸ªæŒ‡å‘éå¸¸é‡å¯¹è±¡çš„å¸¸é‡æŒ‡é’ˆã€‚</p>
<h4 id="Q-115">Q 115</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"i"</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">double</span>)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"d"</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">float</span>)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"f"</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f(<span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šd<br>
æµ®ç‚¹æ•°å­—é¢é‡çš„ç±»å‹ä¸º <code>double</code>ï¼Œé™¤éæ˜ç¡®åœ°ç”¨åç¼€æŒ‡å®šã€‚</p>
<h4 id="Q-116">Q 116</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">y</span><span class="params">(<span class="keyword">int</span> &amp;)</span> </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">y</span><span class="params">(<span class="keyword">int</span> &amp;&amp;)</span> </span>&#123; <span class="keyword">return</span> <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">int</span> <span class="title">f</span>(<span class="title">T</span> &amp;&amp;<span class="title">x</span>) &#123;</span> <span class="keyword">return</span> y(x); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">int</span> <span class="title">g</span>(<span class="title">T</span> &amp;&amp;<span class="title">x</span>) &#123;</span> <span class="keyword">return</span> y(<span class="built_in">std</span>::<span class="built_in">move</span>(x)); &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">int</span> <span class="title">h</span>(<span class="title">T</span> &amp;&amp;<span class="title">x</span>) &#123;</span> <span class="keyword">return</span> y(<span class="built_in">std</span>::forward&lt;T&gt;(x)); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; f(i) &lt;&lt; f(<span class="number">20</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; g(i) &lt;&lt; g(<span class="number">20</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; h(i) &lt;&lt; h(<span class="number">20</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š112212<br>
<strong>æ¨¡æ¿åŒ–å‡½æ•°ä¸­çš„ T&amp;&amp; ä¸ä¸€å®šè¡¨ç¤ºå³å€¼å¼•ç”¨ï¼Œå¦‚æœç”¨å·¦å€¼å®ä¾‹åŒ–ï¼Œå®ƒä¼šåç¼©æˆå·¦å€¼å¼•ç”¨ï¼Œå¦‚æœç”¨å³å€¼å®ä¾‹åŒ–ï¼Œåˆ™ä¼šåç¼©æˆå³å€¼å¼•ç”¨</strong>ã€‚<br>
è¿™ä¸‰ä¸ªå‡½æ•°åˆ†åˆ«ä½¿ç”¨å·¦å€¼å’Œå³å€¼è°ƒç”¨äº†ä¸€æ¬¡ï¼Œä¸‰ç§æƒ…å†µä¸‹éƒ½ä¼šåˆ†åˆ«åç¼©æˆå·¦å€¼å’Œå³å€¼å¼•ç”¨ï¼Œä½†æ˜¯<strong>åœ¨å‡½æ•°å†…éƒ¨ï¼Œx æœ¬èº«å°±æ˜¯å·¦å€¼ï¼Œä¸ç®¡å®ƒçš„ç±»å‹æ˜¯å·¦å€¼å¼•ç”¨è¿˜æ˜¯å³å€¼å¼•ç”¨</strong>ã€‚</p>
<h4 id="Q-118">Q 118</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">char</span> <span class="keyword">const</span> *str)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; str; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(short num)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; num; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"abc"</span>);</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'A'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¼–è¯‘é”™è¯¯ï¼Œ<code>print(0)</code> é‡è½½å‡½æ•°è°ƒç”¨ä¸æ˜ç¡®<br>
ç©ºæŒ‡é’ˆå¸¸é‡æ—¢å¯ä»¥æ˜¯ä¸€ä¸ªå€¼ä¸º 0 çš„æ•´å‹å­—é¢é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ std::nullptr_t ç±»å‹çš„å³å€¼ã€‚<br>
å› æ­¤ 0 æ—¢å¯ä»¥éšå¼è½¬åŒ–ä¸ºä»»ä½•æŒ‡é’ˆç±»å‹ï¼Œä¹Ÿå¯ä»¥éšå¼è½¬åŒ–ä¸º short ç±»å‹ã€‚</p>
<h4 id="Q-119">Q 119</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span> * p = &amp;p;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="keyword">bool</span>(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
p ä¸­ä¿å­˜çš„æ˜¯å®ƒè‡ªå·±çš„åœ°å€ã€‚</p>
<h4 id="Q-120">Q 120</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    x = a, b;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š10<br>
é€—å·è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§åœ¨ C++ ä¸­æ˜¯æœ€ä½çš„ã€‚</p>
<h4 id="Q-121">Q 121</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">int</span> b = <span class="number">20</span>;</span><br><span class="line">  <span class="keyword">int</span> x;</span><br><span class="line">  x = (a, b);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š20<br>
å…ˆæ‰§è¡Œå®Œæ‹¬å·å†…çš„è¡¨è¾¾å¼ï¼Œç„¶åå°† b èµ‹å€¼ç»™ xã€‚</p>
<h4 id="Q-122">Q 122</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">unsigned</span> ll)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    foo(<span class="number">2u</span>ll);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š2<br>
é»˜è®¤æƒ…å†µä¸‹ <code>signed</code> <code>unsigned</code> <code>long</code> <code>short</code> éƒ½æš—æŒ‡ <code>int</code>ï¼Œå› æ­¤åœ¨è¿™äº›ç¬¦å·ç±»å‹ä¹‹åå‡ºç°çš„ç±»å‹åç§°å‡è¢«è§†ä¸ºå£°æ˜çš„åç§°ã€‚<br>
å› æ­¤ <code>void foo(unsigned ll)</code> è¢«ç¼–è¯‘å™¨è®¤ä¸ºæ˜¯éœ€è¦ä¸€ä¸ª <code>unsigned(int)</code> ç±»å‹çš„å˜é‡ï¼Œåç§°ä¸º <code>ll</code>ã€‚</p>
<h4 id="Q-124">Q 124</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span>&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span> &#123;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T = A&gt;</span><br><span class="line">struct X;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span>&lt;A&gt; &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="number">1</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span>&lt;B&gt; &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">cout</span> &lt;&lt; <span class="number">2</span> &lt;&lt; <span class="built_in">endl</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt; <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T = B&gt; class C&gt;</span><br><span class="line"><span class="keyword">void</span> g() &#123;</span><br><span class="line">    C&lt;&gt;::f();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    g&lt;X&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š2<br>
æ¨¡æ¿çš„æ¨¡æ¿å‚æ•°ä¸º Cï¼ŒC çš„èŒƒå›´æ˜¯å‡½æ•° gï¼Œå› æ­¤é»˜è®¤çš„ T = B è¢«ä½œä¸º C çš„é»˜è®¤å‚æ•°ï¼›<br>
ä¹Ÿå°±æ˜¯è¯´ï¼Œg éœ€è¦æ¨¡æ¿å‚æ•° Cï¼Œæ­¤æ—¶ä¼ å…¥ Xï¼Œè€Œ X ä½œä¸ºæ¨¡æ¿å‚æ•°è¿˜éœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œé»˜è®¤æ˜¯ Aï¼Œä½†æ˜¯è°ƒç”¨ <code>C::f</code> æ—¶çš„é»˜è®¤å‚æ•°ä¸º Bï¼Œå› æ­¤è°ƒç”¨çš„æ˜¯ <code>X&lt;B&gt;::f</code>ï¼Œå› æ­¤è¾“å‡º 2ã€‚</p>
<h4 id="Q-125">Q 125</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">void</span> <span class="title">f</span>(<span class="title">T</span>) &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; ++i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f(<span class="number">1</span>);</span><br><span class="line">    f(<span class="number">1.0</span>);</span><br><span class="line">    f(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š112<br>
æ¯ä¸ªå®ä¾‹åŒ–åçš„å‡½æ•°æ¨¡æ¿éƒ½æœ‰å®ƒè‡ªå·±çš„ä¸€ä»½é™æ€å˜é‡çš„æ‹·è´ã€‚<br>
æœ¬é¢˜ä¸­æˆ‘ä»¬æœ‰ä¸¤ä¸ª f çš„å®ä¾‹åŒ–ï¼Œä¸€ä¸ª T = intï¼Œå¦ä¸€ä¸ª T = doubleï¼Œf(double) ä¸­çš„é™æ€å˜é‡ i ä¸ f(int) ä¸­çš„é™æ€å˜é‡ i ä¸æ˜¯åŒä¸€ä¸ª iã€‚</p>
<h4 id="Q-126">Q 126</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foobar</span> &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> x;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> foobar::x = foo();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; foobar::x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š11<br>
åœ¨ç±»çš„é™æ€æˆå‘˜å®šä¹‰ä¸­ä½¿ç”¨çš„åç§°å’Œç±»ä¸­æˆå‘˜å‡½æ•°çš„åç§°æ˜¯ä¸€è‡´çš„ï¼Œæ¢å¥è¯è¯´ï¼Œå°½ç®¡ <code>foo()</code> è°ƒç”¨å‘ç”Ÿåœ¨ç±»å¤–ï¼Œä½†æ˜¯å®ƒä½äºé™æ€æ•°æ®æˆå‘˜çš„å®šä¹‰ä¸­ï¼Œå¯ä»¥çœ‹ä½œ <code>foo()</code> æ˜¯ <code>footbar</code> çš„æˆå‘˜å‡½æ•°è°ƒç”¨ï¼Œè€Œä¸æ˜¯å…¨å±€ <code>foo()</code> çš„è°ƒç”¨ã€‚</p>
<h4 id="Q-127">Q 127</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, &amp;j = i;</span><br><span class="line">    [=] &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; is_same&lt;<span class="keyword">decltype</span>   ((j)),     <span class="keyword">int</span>         &gt;::value</span><br><span class="line">            &lt;&lt; is_same&lt;<span class="keyword">decltype</span>   (((j))),    <span class="keyword">int</span>      &amp;  &gt;::value</span><br><span class="line">            &lt;&lt; is_same&lt;<span class="keyword">decltype</span>  ((((j)))),   <span class="keyword">int</span> <span class="keyword">const</span>&amp;  &gt;::value</span><br><span class="line">            &lt;&lt; is_same&lt;<span class="keyword">decltype</span> (((((j))))),  <span class="keyword">int</span>      &amp;&amp; &gt;::value</span><br><span class="line">            &lt;&lt; is_same&lt;<span class="keyword">decltype</span>((((((j)))))), <span class="keyword">int</span> <span class="keyword">const</span>&amp;&amp; &gt;::value;</span><br><span class="line">    &#125;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š00100(01000)<br>
è¿™å…¶å®æ˜¯ä¸€é“æœ‰ç‚¹äº‰è®®çš„é¢˜ç›®ï¼Œç­”æ¡ˆæ˜¯ 00100ï¼ŒVS2019 ä¸Šæ˜¯ 01000ã€‚<br>
å…³é”®åœ¨äº lambda è¡¨è¾¾å¼ä¸­æ•è·çš„ j æ˜¯å¦å¸¦æœ‰ const é™å®šç¬¦ã€‚<br>
å› ä¸º lambda æ²¡æœ‰å£°æ˜ä¸º mutableï¼Œå› æ­¤é—­åŒ…ç±»å‹é‡è½½ operator() ä¼šæ˜¯ä¸€ä¸ª const æˆå‘˜å‡½æ•°ã€‚<br>
è€Œå½“è¡¨è¾¾å¼å‡ºç°åœ¨ const æˆå‘˜å‡½æ•°ä¸­æ—¶ï¼Œè¿™ä¸ªè¡¨è¾¾å¼ä¹Ÿæ˜¯ const è¡¨è¾¾å¼ã€‚<br>
ä»…ä¾›å‚è€ƒã€‚</p>
<h4 id="Q-129">Q 129</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">char</span>&gt; delimiters = &#123; <span class="string">","</span>, <span class="string">";"</span> &#125;;  </span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; delimiters[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¨‹åºè¡Œä¸ºæœªå®šä¹‰<br>
è¿™é“é¢˜ç”¨ä¸¤ä¸ªå­—ç¬¦ä¸²å­—é¢é‡æ¥åˆå§‹åŒ– <code>vector&lt;char&gt;</code>ï¼Œæ¨¡æ¿ç±» <code>template &lt;class T&gt; vector</code> çš„åˆå§‹åŒ–åˆ—è¡¨çš„æ„é€ å‡½æ•°ä¸º <code>vector(initializer_list&lt;T&gt;)</code> ï¼Œæœ¬é¢˜ä¸­ä¸º <code>vector(initializer_list&lt;char&gt;)</code>ï¼Œè€Œå­—ç¬¦ä¸²å­—é¢é‡çš„ç±»å‹ä¸º - <em>array of n const char</em> - å¸¸é‡å­—ç¬¦æ•°ç»„ï¼Œå¹¶ä¸åŒ¹é…ã€‚<br>
ä½†æ˜¯è¿™é¢˜ä¸ºä»€ä¹ˆæ²¡æœ‰å‡ºç°ç¼–è¯‘é”™è¯¯ï¼Œæ˜¯å› ä¸ºç¼–è¯‘å™¨æ‰¾åˆ°äº†å¦ä¸€ä¸ªåŒ¹é…çš„æ„é€ å‡½æ•°ã€‚<br>
C++ æ ‡å‡†è§„å®šï¼Œå½“ç±»å‹ä¸º T çš„ç±»å¯¹è±¡é‡‡ç”¨åˆ—è¡¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé‡è½½è§£æä¼šæœ‰ä¸¤ä¸ªé€‰æ‹©æ„é€ å‡½æ•°çš„é˜¶æ®µï¼š<br>
é¦–å…ˆï¼Œå€™é€‰å‡½æ•°æ˜¯ç±» T çš„åˆå§‹åŒ–åˆ—è¡¨æ„é€ å‡½æ•°ï¼Œå‚æ•°åˆ—è¡¨åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå³åˆå§‹åŒ–åˆ—è¡¨ï¼›<br>
å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ„é€ å‡½æ•°ï¼Œé‡è½½è§£æä¼šä»ç±» T çš„æ‰€æœ‰æ„é€ å‡½æ•°ä¸­å¯»æ‰¾å€™é€‰å‡½æ•°ï¼Œå‚æ•°åˆ—è¡¨ç”±åˆå§‹åŒ–åˆ—è¡¨ä¸­çš„å…ƒç´ ç»„æˆï¼›<br>
å¯¹äºæœ¬é¢˜æ¥è¯´ï¼Œ<code>template &lt;class InputIterator&gt; vector(InputIterator first, InputIterator last)</code> æ°å¥½æ»¡è¶³ç¬¬äºŒç§æƒ…å†µï¼Œæ„é€ å‡½æ•°è®¤ä¸ºå®ƒä¼ å…¥äº†ä¸¤ä¸ªæ­£ç¡®çš„è¿­ä»£å™¨ç±»å‹ï¼Œä½†æ˜¯å…¶å®è¿™ä¸¤ä¸ªè¿­ä»£å™¨åˆ†åˆ«å±äºä¸¤ä¸ªä¸åŒçš„åºåˆ—ï¼Œå› æ­¤è¿™ä¸ªç¨‹åºè¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚</p>
<h4 id="Q-130">Q 130</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">adl</span><span class="params">(T)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"T"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span> &#123;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_adl</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    adl(S());</span><br><span class="line">    adl(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">adl</span><span class="params">(S)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"S"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    call_adl(S());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šTS<br>
å½“æŸ¥æ‰¾æ¨¡æ¿å®šä¹‰ä¸­ä½¿ç”¨çš„åç§°çš„å£°æ˜æ—¶ï¼Œå¯¹äºéä¾èµ–æ¨¡æ¿å‚æ•°çš„åç§°æŸ¥æ‰¾ä½¿ç”¨çš„æ˜¯é€šå¸¸çš„æŸ¥æ‰¾è§„åˆ™ï¼Œè€Œä¾èµ–æ¨¡æ¿å‚æ•°çš„åç§°æŸ¥æ‰¾ä¼šå»¶è¿Ÿåˆ°å®é™…æ¨¡æ¿å‚æ•°å·²çŸ¥æ—¶ã€‚<br>
adl(s()) å±äºéä¾èµ–è°ƒç”¨ï¼Œå› æ­¤åœ¨å®šä¹‰å‡½æ•°æ¨¡æ¿çš„æ—¶å€™å°±è¿›è¡Œäº†åç§°æŸ¥æ‰¾ï¼›<br>
adl(t) å±äºä¾èµ–è°ƒç”¨ï¼Œè¯¥è°ƒç”¨çš„è§£ææ¨è¿Ÿåˆ°æ¨¡æ¿å®ä¾‹åŒ–ä¹‹åï¼›<br>
å½“åœ¨å®šä¹‰å‡½æ•°æ¨¡æ¿æ—¶æŸ¥æ‰¾ adl æ—¶ï¼Œå­˜åœ¨çš„ adl çš„å”¯ä¸€ç‰ˆæœ¬å°±æ˜¯ adl(t)ï¼Œæ­¤æ—¶ adl(S) è¿˜ä¸å­˜åœ¨ï¼Œå› æ­¤åªä¼šè°ƒç”¨ adl(T)ã€‚</p>
<h4 id="Q-131">Q 131</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">C</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"i"</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    C(<span class="keyword">double</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"d"</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">C <span class="title">c1</span><span class="params">(<span class="number">7</span>)</span></span>;</span><br><span class="line">    C c2 = <span class="number">7</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šid<br>
ç”±äº explicit å…³é”®å­—çš„å­˜åœ¨ï¼Œ<code>C c2 = 7</code> ä¸­æ˜¯ä¸ä¼šè°ƒç”¨éšå¼è½¬åŒ–æ„é€ å‡½æ•°çš„ï¼Œåœ¨ç¬¬äºŒç§æƒ…å†µä¸‹æ•´å‹å­—é¢é‡ä¼šè¢«è½¬åŒ–ä¸º <code>double</code> ç±»å‹æ„é€ å‡½æ•°ã€‚</p>
<h4 id="Q-132">Q 132</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">int</span> i = foo())</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    bar();</span><br><span class="line">    bar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š11<br>
<code>foo()</code> è¢«è°ƒç”¨äº†ä¸¤æ¬¡</p>
<h4 id="Q-133">Q 133</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A() &#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">    A(<span class="keyword">const</span> A &amp;) &#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"a"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>:</span> <span class="keyword">public</span> <span class="keyword">virtual</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    B() &#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"B"</span>; &#125;</span><br><span class="line">    B(<span class="keyword">const</span> B &amp;) &#123; <span class="built_in">cout</span>&lt;&lt; <span class="string">"b"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>:</span> <span class="keyword">public</span> <span class="keyword">virtual</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    C() &#123; <span class="built_in">cout</span>&lt;&lt; <span class="string">"C"</span>; &#125;</span><br><span class="line">    C(<span class="keyword">const</span> C &amp;) &#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"c"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span>:</span>B,C &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    D() &#123; <span class="built_in">cout</span>&lt;&lt; <span class="string">"D"</span>; &#125;</span><br><span class="line">    D(<span class="keyword">const</span> D &amp;) &#123; <span class="built_in">cout</span> &lt;&lt; <span class="string">"d"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    D d1;</span><br><span class="line">    <span class="function">D <span class="title">d2</span><span class="params">(d1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šABCDABCd<br>
æ„é€  d1 çš„æ—¶å€™ï¼Œæ´¾ç”Ÿç±»æ˜¯æŒ‰ç…§åŸºç±»è¯´æ˜åˆ—è¡¨ä¸­çš„é¡ºåºæ¥æ„é€ çš„ï¼Œå› æ­¤è¾“å‡º ABCDï¼›<br>
å¯¹äº d2 æ¥è¯´ï¼Œä¸€ä¸ªéšå¼å®šä¹‰çš„æ‹·è´/ç§»åŠ¨æ„é€ å‡½æ•°æ˜¯ä¼šè°ƒç”¨å®ƒåŸºç±»çš„æ‹·è´/ç§»åŠ¨æ„é€ å‡½æ•°çš„ï¼Œä½†æ˜¯å¦‚æœæä¾›äº†ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„æ‹·è´æ„é€ å‡½æ•°ï¼Œå°±å¿…é¡»è¦æ‰‹åŠ¨è®¾ç½®è°ƒç”¨åŸºç±»çš„æ‹·è´/ç§»åŠ¨æ„é€ å‡½æ•°ã€‚</p>
<h4 id="Q-135">Q 135</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="keyword">bool</span>,<span class="keyword">int</span>&gt; mb = &#123;&#123;<span class="number">1</span>,<span class="number">2</span>&#125;,&#123;<span class="number">3</span>,<span class="number">4</span>&#125;,&#123;<span class="number">5</span>,<span class="number">0</span>&#125;&#125;;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; mb.<span class="built_in">size</span>();</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; mi = &#123;&#123;<span class="number">1</span>,<span class="number">2</span>&#125;,&#123;<span class="number">3</span>,<span class="number">4</span>&#125;,&#123;<span class="number">5</span>,<span class="number">0</span>&#125;&#125;;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; mi.<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š13<br>
<code>map</code> ä¸­çš„ <code>key</code> æ˜¯å”¯ä¸€çš„ï¼Œè€Œ mb ä¸­çš„ä¸‰ä¸ª <code>key</code> éƒ½æ˜¯ <code>true</code>ï¼Œå› æ­¤ size ä¸º 1ã€‚</p>
<h4 id="Q-140">Q 140</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">get_size_1</span><span class="params">(<span class="keyword">int</span>* arr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">sizeof</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">get_size_2</span><span class="params">(<span class="keyword">int</span> arr[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">sizeof</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">get_size_3</span><span class="params">(<span class="keyword">int</span> (&amp;arr)[<span class="number">10</span>])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">sizeof</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="comment">//Assume sizeof(int*) != sizeof(int[10])</span></span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; (<span class="keyword">sizeof</span>(<span class="built_in">array</span>) == get_size_1(<span class="built_in">array</span>));</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; (<span class="keyword">sizeof</span>(<span class="built_in">array</span>) == get_size_2(<span class="built_in">array</span>));</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; (<span class="keyword">sizeof</span>(<span class="built_in">array</span>) == get_size_3(<span class="built_in">array</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š001<br>
é¦–å…ˆï¼Œ<code>sizeof(array)</code> è¿”å›çš„æ˜¯æ•°ç»„ array çš„å¤§å°ã€‚<br>
åœ¨ <code>get_size_3</code> å‡½æ•°ä¸­ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªå¤§å°ä¸º 10 çš„ <code>int</code> ç±»å‹æ•°ç»„çš„å¼•ç”¨ï¼ŒC++ æ ‡å‡†è§„å®šï¼Œå¯¹ä¸€ä¸ªå¼•ç”¨ç±»å‹ä½¿ç”¨ <code>sizeof</code> è¿ç®—ç¬¦ï¼Œç»“æœæ˜¯è¢«å¼•ç”¨ç±»å‹çš„å¤§å°ï¼Œå› æ­¤ <code>get_size_3</code> è¿”å› 10ã€‚<br>
è€Œ <code>get_size_1</code> <code>get_size_2</code> çš„å‚æ•°å‡ä¸ºæŒ‡é’ˆï¼Œå…¶ä¸­ <code>get_size_2</code> çš„å‚æ•°ä¼šä»æ•°ç»„é€€åŒ–æˆæŒ‡é’ˆï¼Œ<code>sizeof</code> è¿ç®—ç¬¦è¿”å›æŒ‡é’ˆå˜é‡çš„å¤§å°ã€‚</p>
<h4 id="Q-144">Q 144</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> N[] = &#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">long</span> <span class="keyword">int</span>&gt;::digits==<span class="number">63</span> &amp;&amp;</span><br><span class="line">    <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">int</span>&gt;::digits==<span class="number">31</span> &amp;&amp;</span><br><span class="line">    <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::digits==<span class="number">32</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> <span class="keyword">int</span> i = <span class="number">-0xffffffff</span>; i ; --i) &#123;</span><br><span class="line">            N[i] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;  </span><br><span class="line">        N[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; N[<span class="number">0</span>] &lt;&lt; N[<span class="number">1</span>] &lt;&lt; N[<span class="number">2</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š010<br>
æ— ç¬¦å·é‡çš„è´Ÿå€¼æ˜¯ä» 2 ^ n å‡å»å®ƒçš„å€¼è®¡ç®—å‡ºæ¥çš„ï¼Œå…¶ä¸­ n æ˜¯æå‡æ“ä½œæ•°ä¸­çš„ä½æ•°ã€‚<br>
æœ¬é¢˜ä¸­ n ä¸º 32ï¼Œå› æ­¤ i = 1ã€‚</p>
<h4 id="Q-145">Q 145</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">E</span> &#123;</span></span><br><span class="line">    E() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>; &#125;</span><br><span class="line">    E(<span class="keyword">const</span> E&amp;) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2"</span>; &#125;</span><br><span class="line">    ~E() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"3"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">E <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> E();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š13<br>
è¿™é“é¢˜çš„å…³é”®åœ¨äº E() åˆ°åº•æ˜¯ä»€ä¹ˆã€‚<br>
C++ æ ‡å‡†è§„å®šï¼Œçº¯å³å€¼æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¯¥è¡¨è¾¾å¼çš„å€¼ç”¨äºåˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡ã€ä½åŸŸæˆ–è€…è®¡ç®—è¿ç®—ç¬¦çš„æ“ä½œå€¼ã€‚<br>
return è¯­å¥é€šè¿‡æ‹·è´æ„é€ å‡½æ•°å°†å‡½æ•°è°ƒç”¨å¯¹è±¡åˆå§‹åŒ–ä¸ºå…¨å±€å·¦å€¼æˆ–çº¯å³å€¼ã€‚<br>
E() åªæ˜¯ä¸€ä¸ªçº¯å³å€¼ã€‚</p>
<h4 id="Q-147">Q 147</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">0</span>; <span class="comment">//What is wrong here??/</span></span><br><span class="line">    x = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
<code>??/</code> åœ¨ C++17 ä¸­å·²ç»è¢« <code>\</code> å–ä»£äº†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ <a href="https://stackoverflow.com/questions/1234582/purpose-of-trigraph-sequences-in-c" target="_blank" rel="noopener">C++ Trigraph</a></p>
<h4 id="Q-148">Q 148</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">volatile</span> <span class="keyword">int</span> a;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (a + a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¨‹åºè¡Œä¸ºæœªå®šä¹‰<br>
è¿™é‡Œçš„é—®é¢˜ä¸æ˜¯ç¼ºå°‘å˜é‡ a çš„åˆå§‹åŒ– - è¿™é‡Œä¼šéšå¼åˆå§‹åŒ–ä¸º 0ï¼Œè€Œæ˜¯ä¸¤æ¬¡è®¿é—®å˜é‡ a çš„é¡ºåºæ²¡æœ‰æ’åºã€‚<br>
C++ æ ‡å‡†è§„å®šï¼Œè®¿é—® volatile ç±»å‹çš„ glvalueï¼ˆå·¦å€¼æˆ–å°†äº¡å€¼ï¼‰ä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼Œé’ˆå¯¹åŒä¸€ç‰‡å†…å­˜åŒºåŸŸçš„æ— åºè®¿é—®å±äºæœªå®šä¹‰è¡Œä¸ºã€‚</p>
<h4 id="Q-151">Q 151</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::is_signed&lt;<span class="keyword">char</span>&gt;::value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¨‹åºè¾“å‡ºæœªæŒ‡å®š<br>
char å¯¹è±¡èƒ½å¦ä¿å­˜è´Ÿå€¼å®Œå…¨æ˜¯ç”±å®ç°å†³å®šçš„ã€‚</p>
<h4 id="Q-152">Q 152</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">std</span>::is_signed&lt;<span class="keyword">char</span>&gt;::value)&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::is_same&lt;<span class="keyword">char</span>, <span class="keyword">signed</span> <span class="keyword">char</span>&gt;::value;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::is_same&lt;<span class="keyword">char</span>, <span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;::value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š0<br>
<code>char</code> <code>unsigned char</code> <code>signed char</code> æ˜¯ä¸‰ç§å®Œå…¨ä¸åŒçš„ç±»å‹ã€‚</p>
<h4 id="Q-153">Q 153</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* str = <span class="string">"X"</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¼–è¯‘é”™è¯¯<br>
å­—ç¬¦ä¸²å­—é¢é‡çš„ç±»å‹ä¸º <code>const</code> å­—ç¬¦æ•°ç»„ï¼Œè™½ç„¶å¤§å¤šæ•°ç¼–è¯‘å™¨å…è®¸ <code>char const []</code> ç±»å‹è½¬æ¢ä¸º <code>char*</code>ï¼Œä½†æ˜¯ C++11 å¼€å§‹è¿™æ˜¯ä¸åˆæ³•çš„æ“ä½œã€‚</p>
<h4 id="Q-157">Q 157</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;typeinfo&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt; (&amp;<span class="keyword">typeid</span>(A) == &amp;<span class="keyword">typeid</span>(A));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šè¾“å‡ºä¸ç¡®å®š<br>
<code>typeid</code> è¡¨è¾¾å¼çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªé™æ€ç±»å‹ <code>const std::type_info</code> çš„å·¦å€¼ï¼Œå› æ­¤æˆ‘ä»¬æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªæŒ‡å‘ <code>const std::type_info</code> çš„æŒ‡é’ˆï¼ŒC++ æ ‡å‡†ä¸­å¹¶ä¸ä¿è¯æ‰€æœ‰é’ˆå¯¹ç›¸åŒç±»å‹çš„ <code>typeid</code> è¡¨è¾¾å¼çš„è®¡ç®—éƒ½ä¼šå¼•ç”¨åŒä¸€ä¸ª <code>std::type_info</code> ç±»å‹çš„å®ä¾‹ï¼Œå› æ­¤æ­¤å¤„ç­”æ¡ˆæ˜¯ä¸ç¡®å®šçš„ã€‚</p>
<h4 id="Q-158">Q 158</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Foo</span> &#123;</span></span><br><span class="line">    Foo() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">"a"</span>; &#125;</span><br><span class="line">    Foo(<span class="keyword">const</span> Foo&amp;) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span>&lt;&lt;<span class="string">"b"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Foo&gt; <span class="title">bar</span><span class="params">(<span class="number">5</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šaaaaa<br>
ä» C++11 å¼€å§‹ï¼Œ<code>std::vector</code> å…·æœ‰åªæœ‰ä¸€ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°ï¼š<code>explicit vector(size_type n, const Allocator&amp; = Allocator())</code>ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ª<strong>å…·æœ‰ n ä¸ªå·²ç»å€¼åˆå§‹åŒ–äº†çš„å…ƒç´ </strong>çš„ vectorï¼Œæ¯ä¸€ä¸ªå€¼åˆå§‹åŒ–çš„å…ƒç´ éƒ½éœ€è¦è°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°ã€‚</p>
<h4 id="Q-159">Q 159</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; x &lt;&lt; i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    i = <span class="number">3</span>;</span><br><span class="line">    f(i++);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š34<br>
C++ æ ‡å‡†è§„å®šï¼Œåœ¨è°ƒç”¨å‡½æ•°æ—¶ï¼Œè¿›å…¥å‡½æ•°ä¹‹å‰ï¼Œå¯¹å‡½æ•°æ‰€æœ‰å‚æ•°çš„è®¡ç®—éƒ½å·²ç»ç»“æŸï¼Œå› æ­¤è¿›å…¥å‡½æ•° <code>f(i++)</code> ä¹‹å‰ i å·²ç»è‡ªå¢å®Œæˆï¼Œæ‰€ä»¥å‡½æ•°ä¸­çš„ i å€¼ä¸º 4ã€‚</p>
<h4 id="Q-160">Q 160</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span> <span class="params">(<span class="keyword">int</span> a = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span> &lt;&lt; a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span> :</span> A &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span> <span class="params">(<span class="keyword">int</span> a = <span class="number">2</span>)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"B"</span> &lt;&lt; a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    A *b = <span class="keyword">new</span> B;</span><br><span class="line">    b-&gt;foo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šB1<br>
æœ¬é¢˜åˆ›å»ºäº†ä¸€ä¸ª B ç±»å¯¹è±¡ï¼Œç„¶åç”¨ A æŒ‡é’ˆæŒ‡å‘å®ƒï¼Œç”±äº foo æ˜¯è™šå‡½æ•°ï¼Œå› æ­¤çˆ¶ç±»æŒ‡é’ˆæŒ‡å‘å­ç±»å¯¹è±¡ï¼Œè°ƒç”¨çš„æ˜¯ B ç±»ä¸­çš„ fooï¼Œä½†æ˜¯è™šå‡½æ•°è°ƒç”¨ä¸­ä½¿ç”¨çš„ç¼ºçœå‚æ•°ç”±è¡¨ç¤ºå¯¹è±¡çš„æŒ‡é’ˆæˆ–è€…å¼•ç”¨çš„é™æ€ç±»å‹å†³å®šï¼Œå› æ­¤è¿™é‡Œä½¿ç”¨çš„æ˜¯ A ç±»çš„é»˜è®¤å‚æ•°ï¼Œa ç­‰äº 1ã€‚</p>
<h4 id="Q-161">Q 161</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (n % <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                ++i;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                ++i;</span><br><span class="line">            &#125; <span class="keyword">while</span> (--n &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š5<br>
C++ æ ‡å‡†è§„å®šï¼Œ<code>switch</code> è¯­å¥åå¯ä»¥è·Ÿéšä»»ä½•æœ‰æ•ˆè¯­å¥ï¼ŒåŒ…æ‹¬å¤åˆè¯­å¥ï¼Œ<code>do-while</code> çš„æ‰§è¡Œä¸ä¼šè¢« <code>case</code> æ ‡ç­¾æ‰€æ”¹å˜ã€‚</p>
<h4 id="Q-162">Q 162</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span>&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">D</span> :</span> B&lt;T&gt;&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">g</span><span class="params">()</span></span>&#123;</span><br><span class="line">        f();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    D&lt;<span class="keyword">int</span>&gt; d;</span><br><span class="line">    d.g();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
æ ¹æ® C++ æ ‡å‡†ï¼Œåœ¨ç±»æˆ–ç±»æ¨¡æ¿çš„å®šä¹‰ä¸­ï¼Œå¦‚æœåŸºç±»ä¾èµ–äºæ¨¡æ¿å‚æ•°ï¼Œåˆ™åœ¨ç±»æ¨¡æ¿çš„å®šä¹‰å¤„ä»¥åŠç±»æ¨¡æ¿çš„å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ä¸ä¼šæ£€æŸ¥åŸºç±»çš„èŒƒå›´ã€‚å› æ­¤å½“ç¼–è¯‘å™¨çœ‹åˆ° <code>g()</code> è°ƒç”¨ <code>f()</code> çš„æ—¶å€™ï¼Œåº”è¯¥ä»å…¨å±€ä½œç”¨åŸŸä¸­é€‰æ‹©ä¸€ä¸ªã€‚</p>
<h4 id="Q-163">Q 163</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> foo = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span>&amp; <span class="title">getFoo</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> foo; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printFoo</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; foo; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> bar = a.getFoo();</span><br><span class="line">    ++bar;</span><br><span class="line"></span><br><span class="line">    a.printFoo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š0<br>
å¯¹äºå‡½æ•°æ¨¡æ¿æ¥è¯´ï¼Œæ¯ä¸ªå·²å£°æ˜å˜é‡çš„ç±»å‹éƒ½æ˜¯ç”±å ä½ç¬¦ç±»å‹æ¨å¯¼å†³å®šçš„ã€‚<br>
ä¸‹é¢ä¸¤ç§å†™æ³•æ˜¯ä¸€è‡´ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Method 1</span></span><br><span class="line"><span class="keyword">auto</span> bar = a.getFoo();</span><br><span class="line"><span class="comment">// Method 2</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="keyword">void</span> <span class="title">f</span><span class="params">(T t)</span></span>;</span><br><span class="line">f(a.getFoo());</span><br></pre></td></tr></table></figure>
<p>è€Œå‡½æ•°æ¨¡æ¿å‚æ•°çš„æ¨æ–­è¿‡ç¨‹ä¼šå°è¯•ç€å»æ‰¾åˆ°ä¸€ä¸ªå‚æ•°<strong>ä½¿å¾—æ¨æ–­å‡ºçš„å‚æ•°ä¸è°ƒç”¨çš„å‚æ•°ä¿æŒä¸€è‡´</strong> - <em>the deduction process attempts to find template argument values that will make the deduced A identical to A where A is the type of the argument of the call</em><br>
<code>getFoo()</code> è¿”å› <code>int&amp;</code> ç±»å‹ï¼ŒC++ æ ‡å‡†è§„å®šï¼Œå¦‚æœè¡¨è¾¾å¼æœ€åˆå…·æœ‰ <code>T&amp;</code> ç±»å‹ï¼Œåœ¨è¿›è¡Œä»»ä½• further analysis ä¹‹å‰ç±»å‹éƒ½ä¼šè¢«è°ƒæ•´ä¸º <code>T</code>ã€‚<br>
å› æ­¤ <code>a.getFoo()</code> çš„ç±»å‹è¢«æ¨æ–­ä¸º <code>int</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>f(T t)</code> ä¸­ <code>T</code> ä¹Ÿä¸º <code>int</code>ï¼Œ<code>bar</code> çš„ç±»å‹ä¹Ÿä¸º <code>int</code>ã€‚</p>
<h4 id="Q-174">Q 174</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>&amp; a, <span class="keyword">const</span> <span class="keyword">int</span>&amp; b)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; b;</span><br><span class="line">    a = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line">    f(x,x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š01<br>
å˜é‡ a å’Œ b éƒ½ç»‘å®šåœ¨åŒä¸€ä¸ª x ä¸Šï¼Œconst int&amp; b è¡¨ç¤ºå‡½æ•°ä¸­ä¸èƒ½é€šè¿‡å¼•ç”¨ä¿®æ”¹ä¼ å…¥å‚æ•°çš„å€¼ã€‚</p>
<h4 id="Q-177">Q 177</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt;::digits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šè¾“å‡ºä¸ç¡®å®šï¼ˆå¯èƒ½ä¸º 8ï¼‰<br>
å¤§æ¦‚ç‡çš„æç¬‘é¢˜ï¼Œ<code>unsigned char</code> å’Œ <code>char</code> å¤§å°ç›¸åŒï¼Œ<code>char</code> çš„å¤§å°è¶³ä»¥å­˜å‚¨å®ç°çš„åŸºæœ¬å­—ç¬¦é›†çš„ä»»ä½•æˆå‘˜å³å¯ã€‚</p>
<h4 id="Q-178">Q 178</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">5</span>,b = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a+++++b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¼–è¯‘é”™è¯¯<br>
<code>a+++++b</code> ä¼šè¢«è§£æä¸º <code>a++ ++ + b</code>ï¼Œä½†æ˜¯ a++ çš„ç»“æœæ˜¯ä¸ªçº¯å³å€¼ï¼Œè€Œåç½®è‡ªå¢è¿ç®—ç¬¦éœ€è¦å‚æ•°ä¸ºå¯ä¿®æ”¹çš„å·¦å€¼ï¼Œå› æ­¤ç¼–è¯‘é”™è¯¯ã€‚</p>
<h4 id="Q-184">Q 184</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Base</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"i"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Derived</span> :</span> Base &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">double</span>)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"d"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Derived d;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    d.f(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šd<br>
é‡è½½è§£æä¹‹æ‰€ä»¥æ²¡æœ‰é€‰æ‹©æ˜æ˜¾æ›´ä¼˜çš„å‡½æ•° void f(int)ï¼Œå› ä¸º void f(int) æ ¹æœ¬ä¸åœ¨é‡è½½è§£æçš„èŒƒå›´å†…ã€‚<br>
æ´¾ç”Ÿç±»ä¸­å¼•å…¥å‡½æ•°åç§° f æ—¶å°†ä¼šéšè—åŸºç±»ä¸­çš„åŒåå‡½æ•°ã€‚</p>
<h4 id="Q-185">Q 185</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> stat = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; stat++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">    f&lt;<span class="keyword">int</span>&gt;();</span><br><span class="line">    f&lt;<span class="keyword">const</span> <span class="keyword">int</span>&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š010<br>
<code>f&lt;int&gt;()</code> å’Œ <code>f&lt;const int&gt;()</code> æ˜¯ä¸åŒçš„å‡½æ•°ï¼Œå› æ­¤å®ƒä»¬çš„ static int stat ä¸æ˜¯å…±äº«çš„ã€‚</p>
<h4 id="Q-186">Q 186</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;typeinfo&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">takes_pointer</span><span class="params">(<span class="keyword">int</span>* pointer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeid</span>(pointer) == <span class="keyword">typeid</span>(<span class="keyword">int</span>[])) <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'a'</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeid</span>(pointer) == <span class="keyword">typeid</span>(<span class="keyword">int</span>*)) <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'p'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">takes_array</span><span class="params">(<span class="keyword">int</span> <span class="built_in">array</span>[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeid</span>(<span class="built_in">array</span>) == <span class="keyword">typeid</span>(<span class="keyword">int</span>[])) <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'a'</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeid</span>(<span class="built_in">array</span>) == <span class="keyword">typeid</span>(<span class="keyword">int</span>*)) <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'p'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>* pointer = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">array</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    takes_pointer(<span class="built_in">array</span>);</span><br><span class="line">    takes_array(pointer);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (<span class="keyword">typeid</span>(<span class="keyword">int</span>*) == <span class="keyword">typeid</span>(<span class="keyword">int</span>[]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼špp0<br>
æ¥æ”¶æŒ‡é’ˆä½œä¸ºå‚æ•°çš„å‡½æ•°ä¹Ÿèƒ½å¤Ÿä½¿ç”¨æ•°ç»„æ¥è°ƒç”¨ï¼Œåä¹‹äº¦ç„¶ã€‚<br>
å…ˆçœ‹ <code>takes_pointer(array)</code>ï¼Œå½“å‡½æ•°éœ€è¦ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºå‚æ•°æ—¶ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¯¥æ•°ç»„ä¼šé€€åŒ–æˆä¸€ä¸ªæŒ‡é’ˆã€‚<br>
æ›´å‡†ç¡®åœ°è¯´ï¼Œä¸€ä¸ªå…ƒç´ ç±»å‹ä¸º T çš„æ•°ç»„ç±»å‹çš„å·¦å€¼æˆ–è€…å³å€¼å¯ä»¥è½¬åŒ–ä¸ºæŒ‡å‘ T ç±»å‹çš„æŒ‡é’ˆçš„çº¯å³å€¼ã€‚<br>
å› æ­¤æ•°ç»„ array ä¼šè½¬åŒ–æˆæŒ‡å‘ <code>int</code> ç±»å‹çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæ˜¯ä¸€ä¸ªçº¯å³å€¼ã€‚<br>
å†çœ‹ <code>takes_array(pointer)</code>ï¼ŒC++ æ ‡å‡†è§„å®šï¼Œåœ¨ç¡®å®šäº†æ¯ä¸ªå‚æ•°çš„ç±»å‹åï¼Œä»»ä½• T ç±»å‹çš„æ•°ç»„éƒ½ä¼šè¢«è½¬æ¢æˆ T ç±»å‹çš„æŒ‡é’ˆã€‚<br>
å› æ­¤ <code>takes_array(int array[])</code> ä¸­çš„ array[] å…¶å®å·²ç»è¢«è½¬æ¢ä¸º <code>int*</code> äº†ã€‚</p>
<h4 id="Q-187">Q 187</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">C</span> &#123;</span></span><br><span class="line">    C() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>; &#125;</span><br><span class="line">    C(<span class="keyword">const</span> C&amp; other) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2"</span>; &#125;</span><br><span class="line">    C&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> C&amp; other) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"3"</span>; <span class="keyword">return</span> *<span class="keyword">this</span>;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    C c1;</span><br><span class="line">    C c2 = c1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š12<br>
æ‹·è´æ„é€ æŒ‡çš„æ˜¯é€šè¿‡ <em>brace-or-equal-initializer</em> æ–¹å¼åˆå§‹åŒ–çš„æ„é€ ï¼Œ<code>C c2 = c1</code> å°±æ˜¯é€šè¿‡ equal æ¥<strong>æ„é€ ä¸€ä¸ªæ–°çš„å¯¹è±¡</strong>ã€‚</p>
<h4 id="Q-188">Q 188</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* a = <span class="keyword">const_cast</span>&lt;<span class="keyword">char</span>*&gt;(<span class="string">"Hello"</span>);</span><br><span class="line">    a[<span class="number">4</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šæœªå®šä¹‰è¡Œä¸º<br>
ä¿®æ”¹å­—ç¬¦ä¸²å­—é¢é‡æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼Œå®é™…ä¸Šï¼Œå­—ç¬¦ä¸²å­—é¢é‡çš„å­˜å‚¨æ˜¯åœ¨åªè¯»å­˜å‚¨åŒºå†…ã€‚<br>
æ­¤å¤–ï¼Œå¯¹äºä½¿ç”¨ <code>const_cast</code> å»é™¤ <code>const</code> é™å®šçš„ç›®çš„ç»å¯¹ä¸æ˜¯ä¸ºäº†ä¿®æ”¹å®ƒçš„å†…å®¹ï¼Œåªæ˜¯å‡ºäºæ— å¥ˆã€‚</p>
<h4 id="Q-190">Q 190</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span></span><br><span class="line">    A(<span class="keyword">int</span> i) : m_i(i) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> m_i &gt; <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="keyword">int</span> m_i;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a1(1), a2(2);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a1 + a2 &lt;&lt; (a1 == a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š21<br>
<code>a1 + a2</code> å’Œ <code>a1 == a2</code> ä½¿ç”¨çš„éƒ½æ˜¯ <code>int</code> ç±»å‹çš„å†…å»ºè¿ç®—ç¬¦ã€‚a1 å’Œ a2 å…ˆæ˜¯éšå¼è½¬æ¢ä¸º <code>bool</code> ç„¶åå†éšå¼è½¬æ¢ä¸º <code>int</code>ã€‚<br>
ç”±äºç»“æ„ä½“ A å¹¶æ²¡æœ‰é‡è½½ <code>operator+</code>ï¼Œä½¿ç”¨çš„æ˜¯ <code>int</code> çš„å†…å»ºè¿ç®—ç¬¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥å°† a1 å’Œ a2 è½¬æ¢æˆè¯­ <code>operator+</code> å…¼å®¹å‘¢ï¼Œé¦–å…ˆå°è¯•çš„æ˜¯ç”¨æˆ·è‡ªåŠ¨ä¸€çš„è½¬æ¢å‡½æ•° <code>bool()</code>ï¼Œå› ä¸ºä¸€ä¸ªçº¯å³å€¼çš„ <code>bool</code> é‡èƒ½å¤Ÿè½¬æ¢æˆ <code>int</code> ç±»å‹ï¼Œå› æ­¤éšå¼è½¬æ¢ç»§ç»­æ‰§è¡Œï¼Œtrue ä¼šè¢«è½¬æ¢ä¸º 1ï¼Œfalse ä¼šè¢«è½¬æ¢ä¸º 0ï¼Œ<code>operator==</code> ä¹Ÿæ˜¯åŒæ ·çš„è½¬æ¢æ–¹å¼ã€‚</p>
<h4 id="Q-191">Q 191</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> A&#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">int</span> x;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> B&#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">int</span> x;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> A::x = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; B::x;</span><br><span class="line">    A::x = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; B::x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š01<br>
å‡ºç°åœ¨ä¸åŒå‘½åç©ºé—´èŒƒå›´å†…çš„å…·æœ‰ç›¸åŒåç§°çš„å˜é‡çš„ä¸¤ä¸ªå£°æ˜æŒ‡çš„æ˜¯åŒä¸€ä¸ªå˜é‡ã€‚</p>
<h4 id="Q-192">Q 192</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; v;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    v.push_back(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    v.push_back(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">g</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">h</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    g(f1(), f2());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    h();</span><br><span class="line">    h();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (v[<span class="number">0</span>] == v[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¨‹åºè¡Œä¸ºæœªæŒ‡å®š<br>
å‡½æ•°å‚æ•°è¡¨è¾¾å¼çš„è®¡ç®—é¡ºåºæ˜¯æœªæŒ‡å®šçš„ï¼Œæˆ‘ä»¬å”¯ä¸€èƒ½ç¡®å®šçš„å°±æ˜¯å‡½æ•° f1 å’Œ f2 ä¼šåœ¨å‡½æ•° g æ‰§è¡Œä¹‹å‰æ‰§è¡Œå®Œæ¯•ã€‚</p>
<h4 id="Q-193">Q 193</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a[] = &lt;%<span class="number">1</span>%&gt;;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a&lt;:<span class="number">0</span>:&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
C++ æ ‡å‡†ä¸ºä¸€äº›æ ‡ç‚¹ç¬¦å·æä¾›äº†å¯é€‰æ ‡è®°ï¼ŒåŸä»£ç ç­‰ä»·äºä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> a[] = &#123;<span class="number">1</span>&#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>
<p>é™¤äº†æ‹¼å†™ä¸åŒï¼Œè¿™äº›ç¬¦å·çš„è¡Œä¸ºéƒ½æ˜¯ç›¸åŒçš„ï¼Œå³ï¼š<br>
<code>&lt;%%&gt;</code> ç­‰ä»·äº <code>{}</code><br>
<code>&lt;::&gt;</code> ç­‰ä»·äº <code>[]</code></p>
<h4 id="Q-195">Q 195</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstddef&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::is_pointer_v&lt;<span class="keyword">decltype</span>(<span class="literal">nullptr</span>)&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š0<br>
<code>std::is_pointer_v</code> ç”¨äºåˆ¤æ–­å‚æ•°æ˜¯å¦ä¸ºæŒ‡é’ˆç±»å‹ã€‚<br>
nullptr æ˜¯ç±»å‹ä¸º <code>std::nullptr_t</code> çš„çº¯å³å€¼ï¼Œè¯¥ç±»å‹ä¸æ˜¯æŒ‡é’ˆç±»å‹ï¼Œäº‹å®ä¸Š nullptr æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆå¸¸é‡ï¼Œå®ƒèƒ½å¤Ÿè¢«è½¬æ¢ä¸ºæŒ‡é’ˆã€‚</p>
<h4 id="Q-196">Q 196</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> x &#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">C</span> &#123;</span>&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> C&amp; i)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> y &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> x::C&amp; i)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f(x::C());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
å‡½æ•° f(x::C()) è°ƒç”¨æ²¡æœ‰æŒ‡å®šå‘½åç©ºé—´ï¼Œä½†æ˜¯ C++ ä¸­ä½¿ç”¨äº†ä¾èµ–äºå®å‚åå­—çš„æŸ¥æ‰¾ï¼Œå‡½æ•°å‚æ•°çš„å‘½åç©ºé—´è¢«æ·»åŠ åˆ°å‡½æ•°å‘½åç©ºé—´çš„æŸ¥æ‰¾ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬å°† x::C() ä¼ é€’ç»™äº†å‡½æ•° fï¼Œå› æ­¤åœ¨ç¼–è¯‘å‡½æ•° f æ—¶ä¹Ÿä¼šæŸ¥æ‰¾å‘½åç©ºé—´ x å¹¶æ‰¾åˆ° x::fã€‚</p>
<h4 id="Q-197">Q 197</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> j = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>&amp; i = j, j;</span><br><span class="line">    j = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i &lt;&lt; j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š12<br>
å±€éƒ¨å˜é‡ j çš„ä½œç”¨åŸŸæ˜¯ä»å®ƒå®šä¹‰å¼€å§‹ä¸€ç›´åˆ° main å‡½æ•°ç»“æŸï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå±€éƒ¨çš„ j ä¼šå°†å…¨å±€çš„ j è¦†ç›–æ‰ã€‚<br>
å› æ­¤å¼•ç”¨ i ç»‘å®šçš„æ˜¯å…¨å±€çš„ jï¼Œj = 2 ä¿®æ”¹çš„æ˜¯å±€éƒ¨çš„ jï¼Œå› æ­¤ç­”æ¡ˆä¸º 12ã€‚</p>
<h4 id="Q-198">Q 198</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> A &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">"C"</span> &#123; <span class="keyword">int</span> x; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> B &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">"C"</span> &#123; <span class="keyword">int</span> x; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> A::x = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; B::x;</span><br><span class="line">    A::x = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; B::x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¼–è¯‘é”™è¯¯<br>
C++ æ ‡å‡†è§„å®šï¼Œå‡ºç°åœ¨ä¸åŒå‘½åç©ºé—´èŒƒå›´ä¸­çš„å…·æœ‰ç›¸åŒåç§°çš„ C è¯­è¨€é“¾æ¥çš„å˜é‡çš„ä¸¤ä¸ªå£°æ˜æŒ‡çš„æ˜¯åŒä¸€ä¸ªå˜é‡ã€‚å› æ­¤ A::x å’Œ B::x è¡¨ç¤ºçš„æ˜¯åŒä¸€ä¸ªå˜é‡ã€‚<br>
è¿™é“é¢˜ä¸ #191 çš„ä¸åŒä¹‹å¤„åœ¨äº int x æ˜¯ä¸€ä¸ªå®šä¹‰è€Œä¸æ˜¯å£°æ˜ï¼Œç›´æ¥åŒ…å«åœ¨é“¾æ¥è§„èŒƒä¸­çš„å£°æ˜è¢«çœ‹ä½œåŒ…å« extern è¯´æ˜ç¬¦ï¼Œè€Œå˜é‡ x å¹¶æ²¡æœ‰ç›´æ¥åŒ…å«åœ¨é“¾æ¥è§„èŒƒä¸­ï¼Œå› æ­¤å®ƒæ²¡æœ‰éšå¼çš„ extern è¯´æ˜ï¼Œè¿™ä¸¤ä¸ª x è¢«çœ‹ä½œé‡å¤å®šä¹‰ã€‚<br>
å…·ä½“çš„åŒºåˆ«è¿˜å¯ä»¥å‚è€ƒä¸‹é¢çš„ä»£ç æ¥ç†è§£ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// declaration</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="keyword">int</span> i;</span><br><span class="line"><span class="comment">// definition</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>C++ Quiz</tag>
        <tag>Programming-Language</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ Quiz é¢˜è§£ 001~100</title>
    <url>/posts/e24af74a/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>C++ Quiz é¢˜è§£ 001~100 æ•´ç†</li>
<li>æœ‰è¶£çš„é¢˜ç›®ï¼š</li>
<li>018 027 031 033 038 041 052</li>
</ul>
</blockquote>
<a id="more"></a>
<h4 id="Q-001">Q 001</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">void</span> <span class="title">f</span>(<span class="title">T</span> &amp;<span class="title">i</span>) &#123;</span> <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">1</span>; &#125;</span><br><span class="line"><span class="keyword">template</span> &lt;&gt; <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> &amp;i)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">42</span>;</span><br><span class="line">    f(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1<br>
<code>template &lt;&gt; void f(const int &amp;i)</code> ä¸­ T çš„ç±»å‹ä¸º <code>const int</code>ï¼Œ<code>f(i)</code> ä¸­çš„ i ä¸º <code>int</code> å‹ï¼Œæ¨¡æ¿å‚æ•°æ¨å¯¼å‡º <code>T = int</code>ã€‚</p>
<h4 id="Q-002">Q 002</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">1</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f(<span class="string">"foo"</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *bar = <span class="string">"bar"</span>;</span><br><span class="line">    f(bar);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š22<br>
å­—ç¬¦ä¸²å­—é¢é‡ä¸æ˜¯ <code>std::string</code> ç±»å‹ï¼Œè€Œæ˜¯ä¸€ä¸ª <code>const char*</code> ç±»å‹ï¼Œå¦‚æœè¦è®©ç¼–è¯‘å™¨é€‰æ‹© <code>f(const std::string &amp;)</code>ï¼Œç”¨æˆ·å¿…é¡»é€šè¿‡è½¬æ¢æ¥åˆ›é€ ä¸€ä¸ªä¸´æ—¶çš„ <code>std::string</code> å¯¹è±¡ï¼Œè€Œä½¿ç”¨ <code>f(const void *)</code> ä¸éœ€è¦ç”¨æˆ·è‡ªå®šä¹‰çš„è½¬æ¢ã€‚</p>
<h4 id="Q-003">Q 003</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">1</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">unsigned</span>)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f(<span class="number">-2.5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¼–è¯‘é”™è¯¯<br>
é‡è½½é€‰æ‹©ä¸æ˜ç¡®ï¼Œè°ƒç”¨ f(-2.5) æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼Œä¸ºäº†è®©ç¼–è¯‘å™¨é€‰æ‹©å…¶ä¸­ä¸€ä¸ªï¼Œå¿…é¡»è¦ä¸€ä¸ªæ¯”å¦å¤–ä¸€ä¸ªæ›´åŠ åˆé€‚æ‰è¡Œã€‚<br>
è€Œæ­¤é¢˜ä¸­ double ç±»å‹è½¬æ¢æˆ int å’Œ unsigned int éƒ½å±äºæµ®ç‚¹æ•°-æ•´æ•°è½¬æ¢ï¼Œå®ƒä»¬çš„ rank æ˜¯ç›¸åŒçš„ï¼Œæ²¡æœ‰å‘ç”Ÿä¸€ä¸ªè½¬æ¢ä¼˜äºå¦ä¸€ä¸ªè½¬æ¢çš„æƒ…å†µï¼Œå› æ­¤ç¼–è¯‘å™¨ä¸çŸ¥é“å¦‚ä½•è¿›è¡Œé‡è½½é€‰æ‹©ã€‚</p>
<h4 id="Q-004">Q 004</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">float</span>)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">1</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">(<span class="keyword">double</span>)</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">2</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    f(<span class="number">2.5</span>);</span><br><span class="line">    f(<span class="number">2.5f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š21<br>
æµ®ç‚¹æ•°å­—é¢é‡ 2.5 æ˜¯ <code>double</code> ç±»å‹çš„ï¼Œ2.5f æ˜¯ <code>float</code> ç±»å‹çš„</p>
<h4 id="Q-006">Q 006</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i)</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š012012<br>
å‰ç½®å’Œåç½®åœ¨æ‰§è¡Œå®Œä¹‹å i çš„å€¼éƒ½æ˜¯ç›¸åŒçš„ã€‚</p>
<h4 id="Q-007">Q 007</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"B"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">g</span><span class="params">(A &amp;a)</span> </span>&#123; a.f(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    B b;</span><br><span class="line">    g(b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šA<br>
å› ä¸º <code>A::f()</code> ä¸æ˜¯è™šå‡½æ•°ï¼Œå› æ­¤å³ä½¿æœ‰åŸºç±»æŒ‡é’ˆæˆ–å¼•ç”¨æŒ‡å‘ B ç±»ï¼Œè°ƒç”¨çš„ä¹Ÿæ€»æ˜¯ <code>A::f()</code>ã€‚</p>
<h4 id="Q-008">Q 008</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"B"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">g</span><span class="params">(A a)</span> </span>&#123; a.f(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    B b;</span><br><span class="line">    g(b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šA<br>
<code>g(A a)</code> æ˜¯é€šè¿‡å€¼ä¼ é€’æ¥æ”¶ä¸€ä¸ª A ç±»å‹çš„å¯¹è±¡è€Œä¸æ˜¯é€šè¿‡å¼•ç”¨ä¼ é€’ï¼Œå› æ­¤è¿™é‡Œä¼šè°ƒç”¨ A çš„æ‹·è´æ„é€ å‡½æ•°ç”Ÿæˆä¸€ä¸ªä¸´æ—¶å¯¹è±¡ä¼ ç»™å‡½æ•°ï¼Œå› æ­¤å‡½æ•° <code>g(A a)</code> ä¸­çš„ a æ˜¯ä¸€ä¸ªå…¨æ–°çš„ Aï¼Œè¿™ä¹Ÿæ˜¯å¸¸è§çš„å¯¹è±¡åˆ‡ç‰‡é—®é¢˜ã€‚</p>
<h4 id="Q-009">Q 009</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">(<span class="keyword">int</span> &amp;a, <span class="keyword">int</span> &amp;b)</span> </span>&#123;</span><br><span class="line">    a = <span class="number">3</span>;</span><br><span class="line">    b = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> c = f(a, a);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a &lt;&lt; b &lt;&lt; c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š428<br>
ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯å˜é‡ aï¼Œå› æ­¤ b ä¸ä¼šè¢«ä¿®æ”¹</p>
<h4 id="Q-011">Q 011</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š0<br>
ç”±äº a æ˜¯åœ¨å‘½åç©ºé—´èŒƒå›´å†…å£°æ˜çš„ï¼Œå®ƒå…·æœ‰é™æ€å­˜å‚¨æœŸï¼Œå¹¶ä¸”å®ƒæœªåˆå§‹åŒ–ï¼Œå› æ­¤é»˜è®¤åˆå§‹åŒ–ä¸º 0ï¼Œæ­¤æ—¶ä¸éœ€è¦åœ¨å‰é¢æ·»åŠ  <code>static</code> å…³é”®å­—ï¼Œå¦åˆ™åªæ˜¯è¡¨ç¤ºå†…éƒ¨è¿æ¥ï¼Œå¤–éƒ¨ä¸å¯è§ã€‚</p>
<h4 id="Q-012">Q 012</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> a;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š0<br>
å±€éƒ¨é™æ€å˜é‡ä¼šè¢«åˆå§‹åŒ–ä¸º 0ã€‚</p>
<h4 id="Q-013">Q 013</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"a"</span>; &#125;</span><br><span class="line">    ~A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"b"</span>; &#125;</span><br><span class="line">    ~B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"B"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    C() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"c"</span>; &#125;</span><br><span class="line">    ~C() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"C"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">A a;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    C c;</span><br><span class="line">    B b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šacbBCA<br>
a ä¸€å®šä¼šåœ¨ c å’Œ b ä¹‹å‰åˆå§‹åŒ–ã€‚</p>
<h4 id="Q-014">Q 014</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"a"</span>; &#125;</span><br><span class="line">    ~A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"b"</span>; &#125;</span><br><span class="line">    ~B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"B"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    C() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"c"</span>; &#125;</span><br><span class="line">    ~C() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"C"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">A a;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; <span class="keyword">static</span> C c; &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    B b;</span><br><span class="line">    foo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šabcBCA<br>
a ä¸æ˜¯ constexprï¼Œå› æ­¤ a çš„åˆå§‹åŒ–æ˜¯åŠ¨æ€çš„å¹¶ä¸”å…·æœ‰å…¨å±€ä½œç”¨åŸŸ<br>
æ¥ä¸‹æ¥åˆå§‹åŒ– bï¼Œé™æ€å±€éƒ¨å˜é‡ä¼šåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œåˆ°å®ƒçš„æ—¶å€™åˆå§‹åŒ–<br>
å½“ main é€€å‡ºæ—¶ï¼Œb è¶…å‡ºä½œç”¨åŸŸå…ˆè¢«ææ„ï¼Œæ‰€æœ‰é™æ€å˜é‡æŒ‰ç…§åˆå§‹åŒ–çš„ç›¸åé¡ºåºææ„</p>
<h4 id="Q-015">Q 015</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;exception&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> x = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A() &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'a'</span>;</span><br><span class="line">        <span class="keyword">if</span> (x++ == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="built_in">std</span>::exception();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ~A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'A'</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'b'</span>; &#125;</span><br><span class="line">    ~B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'B'</span>; &#125;</span><br><span class="line">    A a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; <span class="keyword">static</span> B b; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        foo();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (<span class="built_in">std</span>::exception &amp;) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'c'</span>;</span><br><span class="line">        foo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šacabBA<br>
é™æ€å±€éƒ¨å˜é‡åœ¨ç¬¬ä¸€æ¬¡è®¿é—®å®ƒçš„æ—¶å€™åˆå§‹åŒ–ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ <code>foo</code> æ—¶ï¼Œå°è¯•åˆå§‹åŒ– bï¼Œåœ¨è°ƒç”¨ B çš„æ„é€ å‡½æ•°ä¹‹å‰é¦–å…ˆæ„é€ ç±» B çš„æˆå‘˜å˜é‡ï¼Œå› æ­¤å…ˆè°ƒç”¨ <code>A::A()</code>ï¼Œæ‰“å° aï¼Œè¯¥æ„é€ å‡½æ•°æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œä¸­æ­¢æ„é€ ï¼Œè¢« <code>catch(std::exception &amp;)</code> æ•æ‰åˆ°ï¼Œæ‰“å° cï¼Œç¬¬äºŒæ¬¡è°ƒç”¨ <code>foo</code> å‡½æ•°ï¼Œå› ä¸º b ç¬¬ä¸€æ¬¡æ²¡æœ‰è¢«æˆåŠŸåˆå§‹åŒ–ï¼Œæ­¤æ—¶ä¼šå†æ¬¡å°è¯•æ„é€  bï¼Œè¿™æ¬¡æ„é€ æˆåŠŸï¼Œæ‰“å° abï¼Œå½“ main ç»“æŸåï¼Œé™æ€å˜é‡ b è¢«ææ„ï¼Œæœ€åææ„æˆå‘˜å˜é‡ aã€‚</p>
<h4 id="Q-016">Q 016</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'a'</span>; &#125;</span><br><span class="line">    ~A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'A'</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'b'</span>; &#125;</span><br><span class="line">    ~B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'B'</span>; &#125;</span><br><span class="line">    A a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; B b; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šabBA<br>
å…ˆæ„é€ çˆ¶ç±»å†æ„é€ å­ç±»ï¼Œå…ˆææ„å­ç±»å†ææ„çˆ¶ç±»</p>
<h4 id="Q-017">Q 017</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'a'</span>; &#125;</span><br><span class="line">    ~A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'A'</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'b'</span>; &#125;</span><br><span class="line">    ~B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'B'</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; B b; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šabBA<br>
æ„é€ å…ˆ A å Bï¼Œææ„å…ˆ B å Aã€‚</p>
<h4 id="Q-018">Q 018</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"B"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">g</span><span class="params">(A &amp;a)</span> </span>&#123; a.f(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    B b;</span><br><span class="line">    g(b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šB<br>
è¿™é“é¢˜çš„éš¾ç‚¹åœ¨äºå°½ç®¡ B::f() æ˜¯ç§æœ‰çš„ï¼Œå®ƒä»ç„¶èƒ½å¤Ÿè¢«å®ƒçš„åŸºç±»å¼•ç”¨æˆåŠŸè°ƒç”¨ã€‚</p>
<h4 id="Q-024">Q 024</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">max</span>();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; ++i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š0<br>
<code>numeric_limits</code> ç±»æ¨¡æ¿ç”¨äºæä¾›æŸ¥è¯¢å„ç§ç®—æœ¯ç±»å‹å±æ€§çš„æ ‡å‡†åŒ–æ–¹å¼ï¼Œ<code>std::numeric_limits&lt;unsigned int&gt;::max()</code> è¡¨ç¤ºçš„æ˜¯æ— ç¬¦å·æ•´å‹çš„æœ€å¤§å¯èƒ½å€¼ï¼ŒåŠ  1 ä¹‹åæº¢å‡ºäº†ï¼Œi é‡æ–°å›åˆ°äº† 0ã€‚</p>
<h4 id="Q-025">Q 025</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">int</span>&gt;::<span class="built_in">max</span>();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; ++i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¨‹åºè¡Œä¸ºæœªå®šä¹‰<br>
C++ æ ‡å‡†è§„å®šï¼Œæœ‰ç¬¦å·æ•´æ•°æº¢å‡ºæ˜¯æœªå®šä¹‰çš„è¡Œä¸º - å¦‚æœåœ¨è®¡ç®—ä¸€ä¸ªè¡¨è¾¾å¼æ—¶ï¼Œç»“æœåœ¨æ•°å­¦ä¸Šæ²¡æœ‰å®šä¹‰æˆ–è€…ä¸åœ¨å…¶ç±»å‹çš„å¯è¡¨ç¤ºå€¼çš„èŒƒå›´å†…ï¼Œé‚£ä¹ˆè¯¥è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚</p>
<h4 id="Q-026">Q 026</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">42</span>;</span><br><span class="line">    <span class="keyword">int</span> j = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i / --j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¨‹åºè¡Œä¸ºæœªå®šä¹‰<br>
å¯¹ 0 çš„ <code>/</code> æ“ä½œä¸ <code>%</code> æ“ä½œéƒ½æ˜¯æœªå®šä¹‰è¡Œä¸ºã€‚</p>
<h4 id="Q-027">Q 027</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="built_in">std</span>::ostream &amp;<span class="title">put</span><span class="params">(<span class="built_in">std</span>::ostream &amp;o)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> o &lt;&lt; <span class="string">'A'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span> :</span> A &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="built_in">std</span>::ostream &amp;<span class="title">put</span><span class="params">(<span class="built_in">std</span>::ostream &amp;o)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> o &lt;&lt; <span class="string">'B'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::ostream &amp;<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::ostream &amp;o, <span class="keyword">const</span> A &amp;a) &#123;</span><br><span class="line">    <span class="keyword">return</span> a.<span class="built_in">put</span>(o);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    B b;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šB<br>
è¿™æ˜¯ä¸€ç§è·å¾— <code>operator &lt;&lt;</code> å¤šæ€çš„æ–¹æ³•ã€‚</p>
<h4 id="Q-028">Q 028</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span></span><br><span class="line">    A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">    A(<span class="keyword">const</span> A &amp;a) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"B"</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"C"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> x : a) &#123;</span><br><span class="line">        x.f();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šAABCBC<br>
æ•°ç»„åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°ï¼Œè¾“å‡º AAï¼Œå¾ªç¯æ•°ç»„çš„æ—¶å€™ <code>auto</code> æ¨æ–­ x çš„ç±»å‹ä¸º Aï¼Œå› æ­¤è°ƒç”¨æ‹·è´æ„é€ å‡½æ•°åå†è°ƒç”¨ fï¼Œè¾“å‡º BCBCã€‚</p>
<h4 id="Q-029">Q 029</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span></span><br><span class="line">    A() &#123; foo(); &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~A() &#123; foo(); &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123; foo(); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span> :</span> <span class="keyword">public</span> A &#123;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    B b;</span><br><span class="line">    b.bar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š121<br>
è™½ç„¶ <code>foo()</code> æ˜¯è™šå‡½æ•°ï¼Œä½†æ˜¯åœ¨åŸºç±»çš„æ„é€ å’Œææ„å‡½æ•°è°ƒç”¨æ—¶ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºæ­¤æ—¶çš„æ´¾ç”Ÿç±»ä¸å­˜åœ¨ã€‚<br>
åŸºç±»ææ„å‡½æ•°å†™æˆè™šå‡½æ•°æ˜¯ä¸ºäº†é˜²æ­¢åŸºç±»æŒ‡é’ˆåœ¨ææ„æ´¾ç”Ÿç±»å¯¹è±¡æ—¶åªèƒ½ææ„åŸºç±»å¯¹è±¡é€ æˆå†…å­˜æ³„éœ²ã€‚</p>
<h4 id="Q-030">Q 030</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> &#123;</span></span><br><span class="line">    X() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"X"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; <span class="function">X <span class="title">x</span><span class="params">()</span></span>; &#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šè¾“å‡ºä¸ºç©º<br>
<code>X x()</code> æ˜¯å‡½æ•°åŸå‹ï¼Œä¸æ˜¯å®ä¾‹åŒ–ç±» Xï¼Œå¦‚æœè¦è¾“å‡º Xï¼Œå¯ä»¥å°†ä»£ç ä¿®æ”¹ä¸º <code>X x{}</code></p>
<h4 id="Q-031">Q 031</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> &#123;</span></span><br><span class="line">    X() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"X"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Y</span> &#123;</span></span><br><span class="line">    Y(<span class="keyword">const</span> X &amp;x) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Y"</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"f"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">Y <span class="title">y</span><span class="params">(X())</span></span>;</span><br><span class="line">    y.f();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¼–è¯‘é”™è¯¯<br>
<code>Y y(X())</code> åŸå…ˆçš„æ„å›¾æ˜¯å®šä¹‰ä¸€ä¸ª Y ç±»å‹çš„å˜é‡ï¼Œè€Œæœ¬é¢˜ä¸­çš„ y æ˜¯ä¸€ä¸ªå‚æ•°ä¸ºå‡½æ•° X()ï¼ˆæ— å‚æ•°ï¼Œè¿”å›å€¼ä¸º Xï¼‰ï¼Œè¿”å›å€¼ä¸º Y çš„å‡½æ•°ï¼Œå¦‚æœè¦ä¿®æ”¹ï¼Œåº”æ”¹ä¸º <code>Y y{X{}}</code>ã€‚</p>
<h4 id="Q-032">Q 032</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> &#123;</span></span><br><span class="line">    X() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"a"</span>; &#125;</span><br><span class="line">    X(<span class="keyword">const</span> X &amp;x) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"b"</span>; &#125;</span><br><span class="line">    <span class="keyword">const</span> X &amp;<span class="keyword">operator</span>=(<span class="keyword">const</span> X &amp;x) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"c"</span>;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    X x;</span><br><span class="line">    <span class="function">X <span class="title">y</span><span class="params">(x)</span></span>;</span><br><span class="line">    X z = y;</span><br><span class="line">    z = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šABBC<br>
<code>X y(x)</code> è°ƒç”¨çš„æ˜¯æ‹·è´æ„é€ å‡½æ•°ã€‚</p>
<h4 id="Q-033">Q 033</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">GeneralException</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"G"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SpecialException</span> :</span> <span class="keyword">public</span> GeneralException &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"S"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="keyword">throw</span> SpecialException(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        f();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (GeneralException e) &#123;</span><br><span class="line">        e.<span class="built_in">print</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šG<br>
æˆ‘ä»¬æŠ›å‡ºäº†ä¸€ä¸ª SpecialException å¼‚å¸¸ï¼Œè¿™æ˜¯ä¸€ä¸ª GeneralException çš„æ´¾ç”Ÿç±»ï¼Œä½†æ˜¯è¯¥å¼‚å¸¸æ˜¯è¢«å€¼æ•è·çš„ï¼Œå› æ­¤ e å…·æœ‰çš„æ˜¯åŠ¨æ€ç±»å‹ GeneralException è€Œä¸æ˜¯ SpecialExceptionï¼Œè¿™å°±æ˜¯å¯¹è±¡åˆ‡ç‰‡ã€‚<br>
æˆ‘ä»¬åº”è¯¥é€šè¿‡ <code>catch(GeneralException&amp; e)</code> æ¥æ•è·è¿™ä¸ªå¼‚å¸¸ï¼Œè¿™æ ·ç¨‹åºè¾“å‡ºæ‰ä¸º Sã€‚</p>
<h4 id="Q-035">Q 035</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">v1</span><span class="params">(<span class="number">1</span>, <span class="number">2</span>)</span></span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; v2&#123; <span class="number">1</span>, <span class="number">2</span> &#125;;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; v1.<span class="built_in">size</span>() &lt;&lt; v2.<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š12<br>
v1 åˆå§‹åŒ–ä¸º 1 ä¸ª 2ï¼›<br>
v2 åˆå§‹åŒ–ä¸º 1 å’Œ 2ã€‚</p>
<h4 id="Q-037">Q 037</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">decltype</span>(a) b = a;</span><br><span class="line">    b++;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a &lt;&lt; b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š01<br>
<code>auto</code> å¿½ç•¥é¡¶å±‚ <code>const</code>ï¼Œ<code>decltype</code> ä¿ç•™é¡¶å±‚ <code>const</code><br>
å¯¹å¼•ç”¨æ“ä½œï¼Œ<code>auto</code> æ¨æ–­å‡ºåŸæœ‰ç±»å‹ï¼Œ<code>decltype</code> æ¨æ–­å‡ºå¼•ç”¨<br>
å¯¹è§£å¼•ç”¨æ“ä½œï¼Œ<code>auto</code> æ¨æ–­å‡ºåŸæœ‰ç±»å‹ï¼Œ<code>decltype</code> æ¨æ–­å‡ºå¼•ç”¨</p>
<h4 id="Q-038">Q 038</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">decltype</span>((a)) b = a;</span><br><span class="line">    b++;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a &lt;&lt; b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š11<br>
ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ<code>decltype</code> åªä¼šè¿”å›ç»™å®šçš„åç§°æˆ–è¡¨è¾¾å¼çš„ç¡®åˆ‡ç±»å‹ï¼›<br>
C++14 å¼€å§‹ï¼Œ<code>auto</code> å¯ä»¥ç”¨äºå‡½æ•°è¿”å›å€¼ç±»å‹çš„æ¨å¯¼ï¼Œä½†æ˜¯å½“å‡½æ•°è¿”å›å€¼ç”¨äºè¢«åˆå§‹åŒ–çš„åœºæ™¯ä¸‹ï¼Œåˆå§‹åŒ–è¡¨è¾¾çš„å¼•ç”¨æ€§ä¼šè¢«å¿½ç•¥ã€‚è€Œ <code>decltype(auto)</code> èƒ½å¤Ÿè§£å†³è¿™ä¸ªé—®é¢˜ã€‚<br>
å½“ <code>decltype(e)</code> ä¸­çš„ e æ˜¯æ¯”ä»…æœ‰åç§°æ›´å¤æ‚çš„å·¦å€¼è¡¨è¾¾å¼æ—¶ï¼Œ<code>decltype(e)</code> å°±ä¿è¯å¾—å‡ºçš„å‹åˆ«æ€»æ˜¯å·¦å€¼å¼•ç”¨ã€‚<br>
å› æ­¤ <code>decltype((a))</code> æ¨æ–­å‡ºçš„ç±»å‹ä¸º <code>int&amp;</code>ï¼Œb æ˜¯ a çš„å¼•ç”¨ï¼Œå› æ­¤ a å’Œ b éƒ½ä¸º 1ã€‚</p>
<h4 id="Q-041">Q 041</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">1</span>[<span class="string">"ABC"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šB<br>
è¡¨è¾¾å¼ <code>E1[E2]</code> å«ä¹‰æ˜¯ <code>*((E1) + (E2))</code>ï¼Œæ‰€ä»¥ <code>1[&quot;ABC&quot;]</code> å¯ä»¥å†™ä¸º <code>*(&quot;ABC&quot; + 1)</code>ï¼Œè¿™ç›¸å½“äºç›´æ¥å–å‡ºå­—æ¯ Bã€‚</p>
<h4 id="Q-042">Q 042</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;initializer_list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span></span><br><span class="line">    A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"1"</span>; &#125;</span><br><span class="line">    A(<span class="keyword">int</span>) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"2"</span>; &#125;</span><br><span class="line">    A(<span class="built_in">std</span>::<span class="built_in">initializer_list</span>&lt;<span class="keyword">int</span>&gt;) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"3"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    A a1;</span><br><span class="line">    A a2&#123;&#125;;</span><br><span class="line">    A a3&#123; <span class="number">1</span> &#125;;</span><br><span class="line">    A a4&#123; <span class="number">1</span>, <span class="number">2</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š1133<br>
åˆå§‹åŒ–åˆ—è¡¨æ„é€ å‡½æ•°æ˜¯è´ªå©ªçš„ï¼Œå¯¹äº a3 æ¥è¯´ï¼Œå³ä½¿ <code>A(int)</code> ä¹Ÿæ˜¯æ»¡è¶³æ¡ä»¶çš„æ„é€ å‡½æ•°ï¼Œç¼–è¯‘å™¨ä»ç„¶ä¼šä¼˜å…ˆè€ƒè™‘ <code>initializer_list&lt;int&gt;</code>ã€‚</p>
<h4 id="Q-044">Q 044</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">X</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"X"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Y</span> :</span> <span class="keyword">public</span> X &#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Y"</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">const</span> X &amp;x)</span> </span>&#123; x.f(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    X arr[<span class="number">1</span>];</span><br><span class="line">    Y y1;</span><br><span class="line">    arr[<span class="number">0</span>] = y1;</span><br><span class="line">    <span class="built_in">print</span>(y1);</span><br><span class="line">    <span class="built_in">print</span>(arr[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šYX<br>
<code>arr</code> æ˜¯ X çš„æ•°ç»„ï¼Œè€Œä¸æ˜¯æŒ‡å‘ X çš„æŒ‡é’ˆï¼Œå½“ç±»å‹ä¸º Y çš„å¯¹è±¡å­˜å…¥è¯¥æ•°ç»„ä¸­æ—¶ä¼šè¢«è½¬åŒ–ä¸º X ç±»å‹ï¼Œå› æ­¤å­˜å…¥æ•°ç»„ <code>arr</code> ä¸­çš„å¯¹è±¡ y1 å¤±å»å¯¹è±¡çš„ Y çš„é‚£ä¸€éƒ¨åˆ†ï¼Œè¿™ç§ç°è±¡ä¹Ÿè¢«ç§°ä¸ºå¯¹è±¡åˆ‡ç‰‡ã€‚</p>
<h4 id="Q-049">Q 049</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    C(<span class="keyword">int</span> i) : i(i) &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i; &#125;</span><br><span class="line">    ~C() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i + <span class="number">5</span>; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> C &amp;c = C(<span class="number">1</span>);</span><br><span class="line">    C(<span class="number">2</span>);</span><br><span class="line">    C(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼š127386<br>
ä¸´æ—¶å˜é‡ä¸€èˆ¬åœ¨è¯¥è¡Œè¿è¡Œç»“æŸæ—¶å°±è¦è¢«é”€æ¯ï¼Œè€Œç¬¬ä¸€ä¸ªå˜é‡ C(1) å› ä¸ºä¸å˜é‡ c å¼•ç”¨ç»‘å®šï¼Œè¯¥ä¸´æ—¶å˜é‡çš„ç”Ÿå­˜æœŸè¢«å»¶é•¿åˆ°å’Œ c ä¸€æ ·ï¼Œæ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹æ˜¯ <code>C(1) C(2) ~C(2) C(3) ~C(3) ~C(1)</code>ã€‚</p>
<h4 id="Q-052">Q 052</h4>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    B() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"B"</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">friend</span> B <span class="title">A::createB</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A() &#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"A"</span>; &#125;</span><br><span class="line">    <span class="function">B <span class="title">createB</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> B(); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a;</span><br><span class="line">    B b = a.createB();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>A</strong>ï¼šç¼–è¯‘é”™è¯¯<br>
å½“å£°æ˜å‡½æ•° <code>A::createB()</code> ä¸ºç±» B çš„å‹å…ƒå‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨å¹¶ä¸çŸ¥é“è¿™ä¸ªå‡½æ•°å­˜åœ¨ï¼Œå› ä¸ºå®ƒåªçœ‹åˆ°äº†ç±» A çš„å£°æ˜è€Œä¸æ˜¯ç±» A çš„å®šä¹‰ã€‚</p>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>C++ Quiz</tag>
        <tag>Programming-Language</tag>
      </tags>
  </entry>
  <entry>
    <title>åœ¨åšå®¢ä¸­æ˜¾ç¤ºæ–‡ç« é˜…è¯»é‡æ’è¡Œ</title>
    <url>/posts/a510178f/</url>
    <content><![CDATA[<blockquote>
<p>è§£å†³ Hexo åšå®¢å‡çº§åæ–‡ç« é˜…è¯»é‡æ’è¡Œå¤±æ•ˆçš„é—®é¢˜</p>
</blockquote>
<a id="more"></a>
<p>åšå®¢ä» <code>Hexo-3.8</code> <code>Next-6.7.0</code> æ›´æ–°åˆ°äº† <code>Hexo-4.2</code> <code>Next-7.7.1</code> ä¹‹åï¼ŒåŸæ¥çš„æ–‡ç« é˜…è¯»é‡æ’è¡Œå¤±æ•ˆäº†ï¼Œ<code>F12</code> å‘ç°ä¸‹é¢çš„ URL æŠ¥é”™ <code>401 - unauthorized</code>ï¼š<br>
<code>https://us.leancloud.cn/1.1/classes/Comment?redirectByAPI=cn</code></p>
<p>é”™è¯¯åŸå› æ˜¯åŸ SDK ç‰ˆæœ¬å¤ªä½ï¼Œå°† <code>top/index.md</code> ä¸­çš„<br>
<code>&lt;script src=&quot;https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js&quot;&gt;&lt;/script&gt;</code><br>
ä¿®æ”¹ä¸ºï¼š<br>
<code>&lt;script src=&quot;https://cdn1.lncld.net/static/js/3.10.0/av-min.js&quot;&gt;&lt;/script&gt;</code></p>
<p>é‡æ–° hexo ä¸‰è¿ï¼Œé—®é¢˜è§£å†³ã€‚</p>
<p>å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;div id=<span class="string">"top"</span>&gt;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;script src="https:/</span><span class="regexp">/cdn1.lncld.net/</span><span class="keyword">static</span>/js/<span class="number">3.10</span><span class="number">.0</span>/av-min.js<span class="string">"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">AV.initialize("</span>APP-ID<span class="string">", "</span>APP-KEY<span class="string">");</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;script type="</span>text/javascript<span class="string">"&gt;</span></span><br><span class="line"><span class="string">  var time=0</span></span><br><span class="line"><span class="string">  var title="</span><span class="string">"</span></span><br><span class="line"><span class="string">  var url="</span><span class="string">"</span></span><br><span class="line"><span class="string">  var query = new AV.Query('Counter');</span></span><br><span class="line"><span class="string">  query.notEqualTo('id',0);</span></span><br><span class="line"><span class="string">  query.descending('time');</span></span><br><span class="line"><span class="string">  query.limit(1000);</span></span><br><span class="line"><span class="string">  query.find().then(function (todo) &#123;</span></span><br><span class="line"><span class="string">    for (var i=0;i&lt;1000;i++)&#123;</span></span><br><span class="line"><span class="string">      var result=todo[i].attributes;</span></span><br><span class="line"><span class="string">      time=result.time;</span></span><br><span class="line"><span class="string">      title=result.title;</span></span><br><span class="line"><span class="string">      url=result.url;</span></span><br><span class="line"><span class="string">      var content="</span>&lt;p&gt;<span class="string">"+"</span>&lt;font color=<span class="string">'#1C1C1C'</span>&gt;<span class="string">"+"</span>&lt;<span class="regexp">/font&gt;"+"&lt;a href='"+"https:/</span><span class="regexp">/archiescott.github.io/</span><span class="string">"+url+"</span><span class="string">'&gt;"+title+"&lt;/a&gt;"+"&lt;br&gt;"+"é˜…è¯»æ¬¡æ•°ï¼š"+time+"&lt;br&gt;"+"&lt;/p&gt;";</span></span><br><span class="line"><span class="string">      document.getElementById("top").innerHTML+=content</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;, function (error) &#123;</span></span><br><span class="line"><span class="string">    console.log("error");</span></span><br><span class="line"><span class="string">  &#125;);</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Blog</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>Next</tag>
        <tag>Blog</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ ä¸­çš„ syncPrimitivesï¼šlock</title>
    <url>/posts/47473230/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>æœ€åŸºç¡€çš„é”ç®¡ç† lock_guard</li>
<li>æ”¯æŒåŒæ—¶é”å®šå¤šä¸ªäº’æ–¥é‡çš„ lock æ–¹æ³•</li>
<li>é€šè¿‡ lock æ–¹æ³•æ‰¹é‡ç®¡ç†äº’æ–¥é‡çš„ scoped_lock</li>
<li>æ”¯æŒåŒæ—¶å°è¯•é”å®šå¤šä¸ªäº’æ–¥é‡çš„ try_lock æ–¹æ³•</li>
<li>æ”¯æŒå¤šç§ locktag ç®¡ç†çš„ç‹¬å å‹ unique_lock</li>
<li>æ”¯æŒå¤šç§ locktag ç®¡ç†çš„å…±äº«å‹ shared_lock</li>
<li>ä¿è¯åªæ‰§è¡Œä¸€æ¬¡çš„ call_once æ–¹æ³•</li>
</ul>
</blockquote>
<a id="more"></a>
<h2 id="std-lock-guard">std::lock_guard</h2>
<h3 id="std-lock-guard-ç‰¹æ€§"><code>std::lock_guard</code> ç‰¹æ€§</h3>
<p><code>lock_guard</code> æ˜¯ä¸€ç§äº’æ–¥å°è£…å™¨ï¼Œåˆ©ç”¨ RAII æœºåˆ¶ä¸ºä»£ç å—æä¾› <code>mutex</code> çš„æ‰€æœ‰æƒã€‚</p>
<p><code>lock_guard</code> çš„æ‹·è´æ„é€ ä¸èµ‹å€¼å‡½æ•°å‡ä¸º <code>delete</code>ã€‚</p>
<p><code>explicit lock_guard(mutex_type&amp; m)</code> ç›¸å½“äºè°ƒç”¨ <code>m.lock()</code>ï¼Œå¦‚æœå½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº† mutexï¼Œåˆ™è¯¥è¡Œä¸ºæœªå®šä¹‰ã€‚</p>
<p><code>lock_guard(mutex_type&amp; m, std::adopt_lock_t t)</code> ç”¨åˆ°äº†åé¢çš„ <code>locktag</code>ï¼Œ<strong>ç”¨äºè¯¥çº¿ç¨‹å·²ç»è·å– <code>mutex</code> çš„æƒ…å†µä¸‹å°† <code>mutex</code> äº¤ç»™ <code>lock_guard</code> æ¥ç®¡</strong>ï¼Œçœ‹ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::mutex mtx;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process</span> <span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    mtx.lock();</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mtx, <span class="built_in">std</span>::adopt_lock)</span></span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"thread id: "</span> &lt;&lt; id &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::thread threads[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i)</span><br><span class="line">        threads[i] = <span class="built_in">std</span>::thread(<span class="built_in">process</span>, i);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; t : threads)</span><br><span class="line">        t.join();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="std-lock-guard-ç¤ºä¾‹"><code>std::lock_guard</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> g_i = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">std</span>::mutex g_i_mutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">safe_increment</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// g_i_mutex åœ¨é”ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨é‡Šæ”¾</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(g_i_mutex)</span></span>;</span><br><span class="line">    ++g_i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">": "</span> &lt;&lt; g_i &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"main: "</span> &lt;&lt; g_i &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t1</span><span class="params">(safe_increment)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t2</span><span class="params">(safe_increment)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"main: "</span> &lt;&lt; g_i &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-lock">std::lock</h2>
<h3 id="std-lock-ç‰¹æ€§"><code>std::lock</code> ç‰¹æ€§</h3>
<p>å½“éœ€è¦åŒæ—¶æ“ä½œä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šå¯¹è±¡æ—¶ï¼Œå°±éœ€è¦åŒæ—¶é”å®šè¿™äº›å¯¹è±¡ï¼Œè€Œä¸æ˜¯å°†å®ƒä»¬ä¾æ¬¡é”å®šã€‚</p>
<p><code>lock(Lockable1&amp; lock1, ..., LockableN&amp; lockn)</code> èƒ½å¤Ÿä»¥é¿å…æ­»é”çš„æ–¹å¼é”å®šç»™å®šçš„å¯¹è±¡ï¼Œå¦‚æœåœ¨è°ƒç”¨ <code>lock</code> æˆ– <code>unlock</code> æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œä¼šå°†å·²ä¸Šé”çš„å¯¹è±¡å…¨éƒ¨è§£é”ã€‚</p>
<h3 id="std-lock-ç¤ºä¾‹"><code>std::lock</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// class Employeeï¼Œå°†ä»–çš„ lunch_partners æ”¾å…¥ vector ä¸­è¾“å‡º</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Employee</span> &#123;</span></span><br><span class="line">    Employee(<span class="built_in">std</span>::<span class="built_in">string</span> id) : id(id) &#123;&#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> id;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; lunch_partners;</span><br><span class="line">    <span class="built_in">std</span>::mutex m;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">output</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> ret = <span class="string">"Employee "</span> + id + <span class="string">" has lunch partners: "</span>;</span><br><span class="line">        <span class="keyword">for</span>( <span class="keyword">const</span> <span class="keyword">auto</span>&amp; partner : lunch_partners )</span><br><span class="line">            ret += partner + <span class="string">" "</span>;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_mail</span><span class="params">(Employee &amp;, Employee &amp;)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿè€—æ—¶çš„å‘ä¿¡æ“ä½œ</span></span><br><span class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">assign_lunch_partner</span><span class="params">(Employee &amp;e1, Employee &amp;e2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// é™æ€ mutex å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">std</span>::mutex io_mutex;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// æ’é˜Ÿ wait for lock</span></span><br><span class="line">        <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lk</span><span class="params">(io_mutex)</span></span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; e1.id &lt;&lt; <span class="string">" and "</span> &lt;&lt; e2.id &lt;&lt; <span class="string">" are waiting for locks"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­¤æ—¶ä½¿ç”¨ lock åŒæ—¶é”å®šä¸¤ä¸ªéœ€è¦æ“ä½œçš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯å…ˆé”ä¸€ä¸ªå†é”ä¸€ä¸ª</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ lock_guard + std::adopt_lock æ¥ç®¡ï¼Œæ–¹ä¾¿è§£é”</span></span><br><span class="line">    <span class="comment">// æ­¤æ—¶ e1 ä¸ e2 å·²ç»è¢«é”å®šï¼Œä¸èƒ½å†å’Œåˆ«çš„ employee have lunch äº†</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">std</span>::lock(e1.m, e2.m);</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lk1</span><span class="params">(e1.m, <span class="built_in">std</span>::adopt_lock)</span></span>;</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lk2</span><span class="params">(e2.m, <span class="built_in">std</span>::adopt_lock)</span></span>;</span><br><span class="line"><span class="comment">// ç­‰ä»·ä»£ç ï¼ˆè‹¥éœ€è¦ unique_locks ï¼Œä¾‹å¦‚å¯¹äºæ¡ä»¶å˜é‡ï¼‰</span></span><br><span class="line"><span class="comment">//        std::unique_lock&lt;std::mutex&gt; lk1(e1.m, std::defer_lock);</span></span><br><span class="line"><span class="comment">//        std::unique_lock&lt;std::mutex&gt; lk2(e2.m, std::defer_lock);</span></span><br><span class="line"><span class="comment">//        std::lock(lk1, lk2);</span></span><br><span class="line"><span class="comment">// C++17 ä¸­å¯ç”¨çš„è¾ƒä¼˜è§£æ³•</span></span><br><span class="line"><span class="comment">//        std::scoped_lock lk(e1.m, e2.m);</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lk</span><span class="params">(io_mutex)</span></span>;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; e1.id &lt;&lt; <span class="string">" and "</span> &lt;&lt; e2.id &lt;&lt; <span class="string">" got locks"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        e1.lunch_partners.push_back(e2.id);</span><br><span class="line">        e2.lunch_partners.push_back(e1.id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‘ŠçŸ¥åˆé¤æŒ‡æ´¾</span></span><br><span class="line">    send_mail(e1, e2);</span><br><span class="line">    send_mail(e2, e1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Employee alice("alice"), bob("bob"), christina("christina"), dave("dave");</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨å¹³è¡Œçº¿ç¨‹æŒ‡æ´¾ï¼Œå› ä¸ºå‘é‚®ä»¶ç»™ç”¨æˆ·å‘ŠçŸ¥åˆé¤æŒ‡æ´¾ï¼Œä¼šæ¶ˆè€—é•¿æ—¶é—´</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt; threads;</span><br><span class="line">    threads.emplace_back(assign_lunch_partner, <span class="built_in">std</span>::ref(alice), <span class="built_in">std</span>::ref(bob));</span><br><span class="line">    threads.emplace_back(assign_lunch_partner, <span class="built_in">std</span>::ref(christina), <span class="built_in">std</span>::ref(bob));</span><br><span class="line">    threads.emplace_back(assign_lunch_partner, <span class="built_in">std</span>::ref(christina), <span class="built_in">std</span>::ref(alice));</span><br><span class="line">    threads.emplace_back(assign_lunch_partner, <span class="built_in">std</span>::ref(dave), <span class="built_in">std</span>::ref(bob));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// èµ„æºå›æ”¶</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;thread : threads) thread.join();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; alice.output() &lt;&lt; <span class="string">'\n'</span>  &lt;&lt; bob.output() &lt;&lt; <span class="string">'\n'</span></span><br><span class="line">              &lt;&lt; christina.output() &lt;&lt; <span class="string">'\n'</span> &lt;&lt; dave.output() &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-scoped-lock">std::scoped_lock</h2>
<h3 id="std-scoped-lock-ç‰¹æ€§"><code>std::scoped_lock</code> ç‰¹æ€§</h3>
<p><code>scoped_lock</code> åœ¨ä½œç”¨åŸŸå—çš„å­˜åœ¨æœŸé—´å æœ‰ä¸€æˆ–å¤šä¸ªäº’æ–¥ï¼Œå½“ <code>scoped_lock</code> ææ„æ—¶ä»¥é€†åºé‡Šæ”¾é”ã€‚</p>
<p><code>scoped_lock(MutexTypes&amp; ... m)</code><br>
å½“ <code>sizeof(MutexTypes) == 0</code> æ—¶æ— äº‹å‘ç”Ÿ<br>
å½“ <code>sizeof(MutexTypes) == 1</code> æ—¶ç­‰æ•ˆäº <code>m.lock()</code><br>
å¦åˆ™ç­‰æ•ˆäº <code>std::lock(m...)</code></p>
<p><code>scoped_lock( std::adopt_lock_t, MutexTypes&amp;... m )</code><br>
<code>scoped_lock</code> ä¹Ÿå¯ä»¥æ‰¹é‡æ¥ç®¡ <code>mutex</code>ã€‚</p>
<p><code>scoped_lock</code> ä¸èƒ½å¤åˆ¶ï¼Œä½†æ˜¯å¯ä»¥ç§»åŠ¨ã€‚</p>
<h3 id="std-scoped-lock-ç¤ºä¾‹"><code>std::scoped_lock</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Employee</span> &#123;</span></span><br><span class="line">    Employee(<span class="built_in">std</span>::<span class="built_in">string</span> id) : id(id) &#123;&#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> id;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; lunch_partners;</span><br><span class="line">    <span class="built_in">std</span>::mutex m;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">output</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> ret = <span class="string">"Employee "</span> + id + <span class="string">" has lunch partners: "</span>;</span><br><span class="line">        <span class="keyword">for</span>( <span class="keyword">const</span> <span class="keyword">auto</span>&amp; partner : lunch_partners )</span><br><span class="line">            ret += partner + <span class="string">" "</span>;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">send_mail</span><span class="params">(Employee &amp;, Employee &amp;)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">assign_lunch_partner</span><span class="params">(Employee &amp;e1, Employee &amp;e2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">std</span>::mutex io_mutex;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lk</span><span class="params">(io_mutex)</span></span>;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; e1.id &lt;&lt; <span class="string">" and "</span> &lt;&lt; e2.id &lt;&lt; <span class="string">" are waiting for locks"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ç”¨ scoped_lock ç›¸å½“äºé”å®šå¹¶æ¥ç®¡äº† e1.m e2.m</span></span><br><span class="line">        <span class="function"><span class="built_in">std</span>::scoped_lock <span class="title">lock</span><span class="params">(e1.m, e2.m)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç­‰ä»·ä»£ç  1 ï¼ˆç”¨ std::lock å’Œ std::lock_guard ï¼‰</span></span><br><span class="line">        <span class="comment">// std::lock(e1.m, e2.m);</span></span><br><span class="line">        <span class="comment">// std::lock_guard&lt;std::mutex&gt; lk1(e1.m, std::adopt_lock);</span></span><br><span class="line">        <span class="comment">// std::lock_guard&lt;std::mutex&gt; lk2(e2.m, std::adopt_lock);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç­‰ä»·ä»£ç  2 ï¼ˆè‹¥éœ€è¦ unique_lock ï¼Œä¾‹å¦‚å¯¹äºæ¡ä»¶å˜é‡ï¼‰</span></span><br><span class="line">        <span class="comment">// std::unique_lock&lt;std::mutex&gt; lk1(e1.m, std::defer_lock);</span></span><br><span class="line">        <span class="comment">// std::unique_lock&lt;std::mutex&gt; lk2(e2.m, std::defer_lock);</span></span><br><span class="line">        <span class="comment">// std::lock(lk1, lk2);</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lk</span><span class="params">(io_mutex)</span></span>;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; e1.id &lt;&lt; <span class="string">" and "</span> &lt;&lt; e2.id &lt;&lt; <span class="string">" got locks"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        e1.lunch_partners.push_back(e2.id);</span><br><span class="line">        e2.lunch_partners.push_back(e1.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    send_mail(e1, e2);</span><br><span class="line">    send_mail(e2, e1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Employee alice("alice"), bob("bob"), christina("christina"), dave("dave");</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨å¹¶è¡Œçº¿ç¨‹ä¸­æŒ‡æ´¾ï¼Œsend_mail è€—æ—¶è¾ƒé•¿</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt; threads;</span><br><span class="line">    threads.emplace_back(assign_lunch_partner, <span class="built_in">std</span>::ref(alice), <span class="built_in">std</span>::ref(bob));</span><br><span class="line">    threads.emplace_back(assign_lunch_partner, <span class="built_in">std</span>::ref(christina), <span class="built_in">std</span>::ref(bob));</span><br><span class="line">    threads.emplace_back(assign_lunch_partner, <span class="built_in">std</span>::ref(christina), <span class="built_in">std</span>::ref(alice));</span><br><span class="line">    threads.emplace_back(assign_lunch_partner, <span class="built_in">std</span>::ref(dave), <span class="built_in">std</span>::ref(bob));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;thread : threads) thread.join();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; alice.output() &lt;&lt; <span class="string">'\n'</span>  &lt;&lt; bob.output() &lt;&lt; <span class="string">'\n'</span></span><br><span class="line">              &lt;&lt; christina.output() &lt;&lt; <span class="string">'\n'</span> &lt;&lt; dave.output() &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-try-lock">std::try_lock</h2>
<h3 id="std-try-lock-ç‰¹æ€§"><code>std::try_lock</code> ç‰¹æ€§</h3>
<p><code>int try_lock( Lockable1&amp; lock1, ..., LockableN&amp;... lockn)</code><br>
ä¼šå°è¯•ç»™ <code>lock1</code> åˆ° <code>lockn</code> ä¾æ¬¡ <code>try_lock</code>ï¼Œå½“ <code>try_lock</code> å¤±è´¥æ—¶å°±ä¸å†ç»§ç»­è°ƒç”¨ <code>try_lock</code>ï¼Œå¹¶ä¸”å·²é”å¯¹è±¡ä¼šä¾æ¬¡ <code>unlock</code>ã€‚é”å®šå¤±è´¥è¿”å›å¯¹è±¡ä¸‹æ ‡ï¼Œå¦‚æœé”å®šæˆåŠŸè¿”å› -1ã€‚</p>
<p>ç”¨é™ˆç¡•çš„è¯æ¥è¯´ï¼Œ<code>try_lock</code> åœ¨ç”Ÿäº§ä»£ç ä¸­å¹¶ä¸å¤šè§ï¼Œå› ä¸ºç¨‹åºå¤§å¤šæ—¶å€™éƒ½ä¸éœ€è¦è¯•ç€å»é”ä¸€é”ã€‚</p>
<h3 id="std-try-lock-ç¤ºä¾‹"><code>std::try_lock</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> foo_count = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">std</span>::mutex foo_count_mutex;</span><br><span class="line">    <span class="keyword">int</span> bar_count = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">std</span>::mutex bar_count_mutex;</span><br><span class="line">    <span class="keyword">int</span> overall_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> done = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">std</span>::mutex done_mutex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> increment = [](<span class="keyword">int</span> &amp;counter, <span class="built_in">std</span>::mutex &amp;m, <span class="keyword">const</span> <span class="keyword">char</span> *desc) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">            <span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; lock(m);</span><br><span class="line">            ++counter;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; desc &lt;&lt; <span class="string">": "</span> &lt;&lt; counter &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">            lock.unlock();</span><br><span class="line">            <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è·å–è‡ªèº«çš„ mutex åä¿®æ”¹è‡ªèº«çš„ count</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">increment_foo</span><span class="params">(increment, <span class="built_in">std</span>::ref(foo_count), <span class="built_in">std</span>::ref(foo_count_mutex), <span class="string">"foo"</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">increment_bar</span><span class="params">(increment, <span class="built_in">std</span>::ref(bar_count), <span class="built_in">std</span>::ref(bar_count_mutex), <span class="string">"bar"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼•ç”¨æ•è·åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">update_overall</span><span class="params">([&amp;]() &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        done_mutex.lock();</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">while</span> (!done) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">            done_mutex.unlock();</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> result = <span class="built_in">std</span>::try_lock(foo_count_mutex, bar_count_mutex);</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="comment">// å¦‚æœé”å®šæˆåŠŸå°†ä¸¤ä¸ª count è®¡å…¥æ€»æ•°</span></span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">                overall_count += foo_count + bar_count;</span></span></span><br><span class="line"><span class="function"><span class="params">                foo_count = <span class="number">0</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">                bar_count = <span class="number">0</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"overall: "</span> &lt;&lt; overall_count &lt;&lt; <span class="string">'\n'</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">                foo_count_mutex.unlock();</span></span></span><br><span class="line"><span class="function"><span class="params">                bar_count_mutex.unlock();</span></span></span><br><span class="line"><span class="function"><span class="params">            &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">2</span>));</span></span></span><br><span class="line"><span class="function"><span class="params">            done_mutex.lock();</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">        done_mutex.unlock();</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;)</span></span>;</span><br><span class="line"></span><br><span class="line">    increment_foo.join();</span><br><span class="line">    increment_bar.join();</span><br><span class="line">    <span class="comment">// ç­‰å¾…ä¸¤ä¸ªçº¿ç¨‹éƒ½ç»“æŸäº†å†ä¿®æ”¹ done</span></span><br><span class="line">    <span class="comment">// done å¿…é¡»è¦åœ¨ while å¾ªç¯ä¸­ä¿®æ”¹æ‰è¡Œ</span></span><br><span class="line">    done_mutex.lock();</span><br><span class="line">    done = <span class="literal">true</span>;</span><br><span class="line">    done_mutex.unlock();</span><br><span class="line">    update_overall.join();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Done processing\n"</span></span><br><span class="line">              &lt;&lt; <span class="string">"foo: "</span> &lt;&lt; foo_count &lt;&lt; <span class="string">'\n'</span></span><br><span class="line">              &lt;&lt; <span class="string">"bar: "</span> &lt;&lt; bar_count &lt;&lt; <span class="string">'\n'</span></span><br><span class="line">              &lt;&lt; <span class="string">"overall: "</span> &lt;&lt; overall_count &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-unique-lock">std::unique_lock</h2>
<h3 id="std-unique-lock-ç‰¹æ€§"><code>std::unique_lock</code> ç‰¹æ€§</h3>
<p><code>unique_lock( unique_lock&amp;&amp; other ) noexcept</code><br>
<code>unique_lock</code> ä¸æ”¯æŒå¤åˆ¶æ„é€ ï¼Œä½†æ”¯æŒç§»åŠ¨æ„é€ ï¼Œç”¨å…¶ä»–çš„ <code>unique_lock</code> å¯¹è±¡åˆå§‹åŒ–æ–° <code>unique_lock</code> å¯¹è±¡</p>
<p><code>unique_lock( mutex_type&amp; m, locktag t )</code><br>
<code>locktag</code> å¯ä»¥ä¸ºä¸‹é¢ä¸‰ç§ï¼š<br>
<code>std::defer_lock</code> æ¥ç®¡ <code>mutex</code> ä½†ä¸é”å®š<br>
<code>std::try_to_lock</code> æ¥ç®¡ <code>mutex</code> åå°è¯•é”å®šï¼Œé”å®šå¤±è´¥ä¹Ÿä¸ä¼šé˜»å¡<br>
<code>std::adopt_lock</code> é”å®šåæ¥ç®¡ <code>mutex</code></p>
<p><code>unique_lock( mutex_type&amp; m, const std::chrono::duration&lt;Rep,Period&gt;&amp; timeout_duration )</code><br>
<code>unique_lock</code> é˜»å¡ç›´è‡³ç»è¿‡æŒ‡å®šçš„ <code>timeout_duration</code> æˆ–è€…è·å¾—é”ã€‚</p>
<p><code>unique_lock( mutex_type&amp; m, const std::chrono::time_point&lt;Clock,Duration&gt;&amp; timeout_time )</code><br>
<code>unique_lock</code> é˜»å¡ç›´è‡³åˆ°è¾¾æŒ‡å®šçš„ <code>timeout_time</code> æˆ–è€…è·å¾—é”ã€‚</p>
<p><code>unique_lock</code> æ¥ç®¡ <code>mutex</code> ä¹‹åå¯ä»¥è°ƒç”¨ <code>lock</code> å’Œ <code>unlock</code> æ¥ä¸´æ—¶é”å®šå’Œè§£é”çº¿ç¨‹ï¼Œ<code>unique_lock</code> è¿˜å¯ä»¥é€šè¿‡ <code>release</code> é‡Šæ”¾å¯¹ <code>mutex</code> çš„ç®¡ç†ã€‚</p>
<h3 id="std-unique-lock-ç¤ºä¾‹"><code>std::unique_lock</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Box</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Box</span><span class="params">(<span class="keyword">int</span> num)</span> : num_things</span>&#123;num&#125; &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> num_things;</span><br><span class="line">    <span class="built_in">std</span>::mutex m;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä» from å– num ç»™ to</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Box &amp;from, Box &amp;to, <span class="keyword">int</span> num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// åªæ˜¯æ¥ç®¡ï¼Œå¹¶æœªé”å®š</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock1</span><span class="params">(from.m, <span class="built_in">std</span>::defer_lock)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock2</span><span class="params">(to.m, <span class="built_in">std</span>::defer_lock)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”ä¸¤ä¸ª unique_lock è€Œä¸æ­»é”</span></span><br><span class="line">    <span class="built_in">std</span>::lock(lock1, lock2);</span><br><span class="line"></span><br><span class="line">    from.num_things -= num;</span><br><span class="line">    to.num_things += num;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 'from.m' ä¸ 'to.m' äº’æ–¥è§£é”äº 'unique_lock' ææ„å‡½æ•°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Box <span class="title">acc1</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">    <span class="function">Box <span class="title">acc2</span><span class="params">(<span class="number">50</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t1</span><span class="params">(<span class="built_in">transfer</span>, <span class="built_in">std</span>::ref(acc1), <span class="built_in">std</span>::ref(acc2), <span class="number">10</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t2</span><span class="params">(<span class="built_in">transfer</span>, <span class="built_in">std</span>::ref(acc2), <span class="built_in">std</span>::ref(acc1), <span class="number">5</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::mutex m_a, m_b, m_c;</span><br><span class="line"><span class="keyword">int</span> a, b, c = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    &#123;   <span class="comment">// æ³¨æ„ï¼šå¯ç”¨ std::lock_guard æˆ– atomic&lt;int&gt; ä»£æ›¿</span></span><br><span class="line">        <span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lk</span><span class="params">(m_a)</span></span>;</span><br><span class="line">        a++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// æ³¨æ„ï¼šç»†èŠ‚å’Œæ›¿ä»£å“è§ std::lock åŠ std::scoped_lock</span></span><br><span class="line">        <span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lk_b</span><span class="params">(m_b, <span class="built_in">std</span>::defer_lock)</span></span>;</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lk_c</span><span class="params">(m_c, <span class="built_in">std</span>::defer_lock)</span></span>;</span><br><span class="line">        <span class="built_in">std</span>::lock(lk_b, lk_c);</span><br><span class="line">        <span class="comment">// ç”¨ newValue(b+c) æ›¿æ¢ c çš„å€¼ï¼Œè¿”å›çš„ oldValue èµ‹å€¼ç»™ b</span></span><br><span class="line">        b = <span class="built_in">std</span>::exchange(c, b+c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt; threads;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> i = <span class="number">0</span>; i &lt; <span class="number">12</span>; ++i)</span><br><span class="line">        threads.emplace_back(update);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; i: threads)</span><br><span class="line">        i.join();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; a &lt;&lt; <span class="string">"'th and "</span> &lt;&lt; a + <span class="number">1</span> &lt;&lt; <span class="string">"'th Fibonacci numbers: "</span></span><br><span class="line">            &lt;&lt; b &lt;&lt; <span class="string">" and "</span> &lt;&lt; c &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-shared-lock">std::shared_lock</h2>
<h3 id="std-shared-lock-ç‰¹æ€§"><code>std::shared_lock</code> ç‰¹æ€§</h3>
<p><code>shared_lock</code> ä¼šä»¥å…±äº«æ¨¡å¼é”å®š <code>mutex</code>ï¼Œæ³¨æ„ä¸ <code>unique_lock</code> çš„æ’ä»–æ€§é”å®šç›¸åŒºåˆ†ï¼Œ<code>shared_lock</code> ç±»å¯ç§»åŠ¨ï¼Œä½†ä¸å¯å¤åˆ¶ã€‚</p>
<p><code>explicit shared_lock( mutex_type&amp; m )</code><br>
ç›¸å½“äºè°ƒç”¨ <code>m.lock_shared()</code>ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œ<code>shared_lock</code> ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>locktag</code>ã€<code>try_lock_shared_for</code>ã€<code>try_lock_shared_until</code>ã€‚</p>
<p>å†™åˆ°è¿™é‡Œéœ€è¦æé†’ä¸€ä¸‹ <code>mutex</code> ä¸ <code>lock</code> çš„å…³ç³»ï¼Œ<code>mutex</code> æ˜¯åº•å±‚åŒæ­¥åŸè¯­ï¼Œè€Œ <code>lock</code> æ˜¯é€šè¿‡ RAII æ¥ç®¡ç† <code>mutex</code> çš„å¯¹è±¡ï¼Œå› æ­¤ <code>lock</code> ä¸­çš„é”å®šä¸è§£é”å…¶å®æ˜¯å¯¹ <code>mutex</code> ä¸­é”å®šä¸è§£é”çš„å°è£…ã€‚</p>
<h3 id="std-shared-lock-ç¤ºä¾‹"><code>std::shared_lock</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;shared_mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::shared_timed_mutex m;</span><br><span class="line"><span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">// ä¸¤ä¸ªçº¿ç¨‹éƒ½è·å¾—å¯¹æ•´æ•° i çš„è®¿é—®</span></span><br><span class="line">   <span class="function"><span class="built_in">std</span>::shared_lock&lt;<span class="built_in">std</span>::shared_timed_mutex&gt; <span class="title">slk</span><span class="params">(m)</span></span>;</span><br><span class="line">   <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"read i as "</span> &lt;&lt; i &lt;&lt; <span class="string">"...\n"</span>;</span><br><span class="line">   <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::milliseconds(<span class="number">10</span>));</span><br><span class="line">   <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"woke up...\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="function"><span class="built_in">std</span>::thread <span class="title">r1</span><span class="params">(<span class="built_in">read</span>)</span></span>;</span><br><span class="line">   <span class="function"><span class="built_in">std</span>::thread <span class="title">r2</span><span class="params">(<span class="built_in">read</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">   r1.join();</span><br><span class="line">   r2.join();</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="locktag">locktag</h2>
<h3 id="locktag-å±æ€§"><code>locktag</code> å±æ€§</h3>
<p><code>std::defer_lock</code> ä¸ºç©ºæ ‡ç­¾ç±» <code>std::defer_lock_t</code> çš„å®ä¾‹ï¼Œåªæ¥ç®¡ä¸ä¸Šé”</p>
<p><code>std::try_to_lock</code> ä¸ºç©ºæ ‡ç­¾ç±» <code>std::try_to_lock_t</code> çš„å®ä¾‹ï¼Œæ¥ç®¡åå°è¯•ä¸Šé”ï¼Œå¤±è´¥ä¹Ÿä¸é˜»å¡</p>
<p><code>std::adopt_lock</code> ä¸ºç©ºæ ‡ç­¾ç±» <code>std::adopt_lock_t</code> çš„å®ä¾‹ï¼Œä¸Šé”åæ‰æ¥ç®¡</p>
<h3 id="locktag-ç¤ºä¾‹"><code>locktag</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// mutex æ”¾åœ¨ struct ä¸­é˜²æ­¢å¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹ bank_account</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bank_account</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">bank_account</span><span class="params">(<span class="keyword">int</span> balance)</span> : <span class="title">balance</span><span class="params">(balance)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="keyword">int</span> balance;</span><br><span class="line">    <span class="built_in">std</span>::mutex m;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(bank_account &amp;from, bank_account &amp;to, <span class="keyword">int</span> amount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// é”å®šä¸¤ä¸ªäº’æ–¥è€Œä¸æ­»é”</span></span><br><span class="line">    <span class="built_in">std</span>::lock(from.m, to.m);</span><br><span class="line">    <span class="comment">// ä¿è¯äºŒä¸ªå·²é”å®šäº’æ–¥åœ¨ä½œç”¨åŸŸç»“å°¾è§£é”</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock1</span><span class="params">(from.m, <span class="built_in">std</span>::adopt_lock)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock2</span><span class="params">(to.m, <span class="built_in">std</span>::adopt_lock)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰ä»·æ–¹æ³•ï¼š</span></span><br><span class="line"><span class="comment">//    std::unique_lock&lt;std::mutex&gt; lock1(from.m, std::defer_lock);</span></span><br><span class="line"><span class="comment">//    std::unique_lock&lt;std::mutex&gt; lock2(to.m, std::defer_lock);</span></span><br><span class="line"><span class="comment">//    std::lock(lock1, lock2);</span></span><br><span class="line"></span><br><span class="line">    from.balance -= amount;</span><br><span class="line">    to.balance += amount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">bank_account <span class="title">my_account</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">    <span class="function">bank_account <span class="title">your_account</span><span class="params">(<span class="number">50</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t1</span><span class="params">(<span class="built_in">transfer</span>, <span class="built_in">std</span>::ref(my_account), <span class="built_in">std</span>::ref(your_account), <span class="number">10</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t2</span><span class="params">(<span class="built_in">transfer</span>, <span class="built_in">std</span>::ref(your_account), <span class="built_in">std</span>::ref(my_account), <span class="number">5</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-call-once">std::call_once</h2>
<h3 id="std-call-once-å±æ€§"><code>std::call_once</code> å±æ€§</h3>
<p>æ— è®ºæœ‰å¤šå°‘ä¸ªçº¿ç¨‹è°ƒç”¨ï¼Œ<code>call_once</code> åªæ‰§è¡Œä¸€æ¬¡ã€‚</p>
<p><code>void call_once( std::once_flag&amp; flag, Callable&amp;&amp; f, Args&amp;&amp;... args )</code><br>
å¦‚æœ <code>once_flag</code> æ˜¾ç¤º <code>f</code> å·²ç»è¢«è°ƒç”¨è¿‡äº†ï¼Œ<code>call_once</code> ç«‹å³è¿”å›ï¼Œå¦åˆ™ä»¥å‚æ•° <code>args</code> è°ƒç”¨ <code>f</code>ï¼›è°ƒç”¨è¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿäº†å¼‚å¸¸ï¼Œ<code>once_flag</code> ä¸ä¼šç¿»è½¬ã€‚</p>
<p>å¦‚æœå¯¹äºåŒä¸€ä¸ª <code>once_flag</code>ï¼Œ<code>call_once</code> è°ƒç”¨ä¸åŒçš„ <code>f</code>ï¼Œæ— æ³•ç¡®å®šè°ƒç”¨çš„å…·ä½“æ˜¯å“ªä¸€ä¸ª <code>f</code>ã€‚</p>
<h3 id="std-call-once-ç¤ºä¾‹"><code>std::call_once</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::once_flag flag1, flag2;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">simple_do_once</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::call_once(flag1, []()&#123; <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Simple example: called once\n"</span>; &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">may_throw_function</span><span class="params">(<span class="keyword">bool</span> do_throw)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (do_throw) &#123;</span><br><span class="line">        <span class="comment">// å¯èƒ½æœ‰å¤šæ¬¡</span></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"throw: call_once will retry\n"</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">std</span>::exception();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åªä¼šå‡ºç°ä¸€æ¬¡</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Didn't throw, call_once will not attempt again\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_once</span><span class="params">(<span class="keyword">bool</span> do_throw)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">std</span>::call_once(flag2, may_throw_function, do_throw);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (...) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ­¤å¤„åªä¼šæ‰§è¡Œä¸€æ¬¡ flag1 å¯¹åº”çš„ lambda è¡¨è¾¾å¼</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">st1</span><span class="params">(simple_do_once)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">st2</span><span class="params">(simple_do_once)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">st3</span><span class="params">(simple_do_once)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">st4</span><span class="params">(simple_do_once)</span></span>;</span><br><span class="line">    st1.join();</span><br><span class="line">    st2.join();</span><br><span class="line">    st3.join();</span><br><span class="line">    st4.join();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t1</span><span class="params">(do_once, <span class="literal">true</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t2</span><span class="params">(do_once, <span class="literal">true</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t3</span><span class="params">(do_once, <span class="literal">false</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t4</span><span class="params">(do_once, <span class="literal">true</span>)</span></span>;</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line">    t3.join();</span><br><span class="line">    t4.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MultiThreading</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>Multithreading</tag>
        <tag>Inter-Threading-Communication</tag>
        <tag>Lock</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ ä¸­çš„ syncPrimitivesï¼šmutex</title>
    <url>/posts/2f6c672d/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>æœ€åŸºç¡€çš„äº’æ–¥é‡ mutex</li>
<li>èƒ½å¤Ÿå®šæ—¶å°è¯•ä¸Šé”çš„äº’æ–¥é‡ timed_mutex</li>
<li>å¯é‡å…¥çš„ recursive_mutex ä¸ recursive_timed_mutex</li>
<li>åŒæ—¶æ”¯æŒç‹¬å ä¸å…±äº«ç®¡ç†çš„ shared_mutex ä¸ shared_timed_mutex</li>
</ul>
</blockquote>
<a id="more"></a>
<p>æœ€è¿‘åœ¨æ’¸æ—¥å¿—åº“çš„æ—¶å€™å‘ç°äº† C++11 ç«Ÿç„¶æœ‰è¿™ä¹ˆå¤šçš„ <code>mutex</code> ç±»å‹ä¸ <code>lock</code> ç±»å‹ï¼Œæœ¬ç¯‡å…ˆæ€»ç»“ä¸€ä¸‹ <code>mutex</code> ç±»å‹ã€‚<br>
æœ¬æ–‡ä¸­çš„ç¤ºä¾‹å‡æ¥è‡ª <em>CppReference</em>ï¼Œä»…æ·»åŠ éƒ¨åˆ†æ³¨é‡Šï¼Œä¸å†åšç‰¹æ®Šè¯´æ˜ã€‚</p>
<h2 id="std-mutex">std::mutex</h2>
<h3 id="std-mutex-ç‰¹æ€§"><code>std::mutex</code> ç‰¹æ€§</h3>
<p><code>mutex</code> ç±»èƒ½å¤Ÿä¿æŠ¤å…±äº«æ•°æ®æŸä¸ªæ—¶åˆ»åªèƒ½å…è®¸å•ä¸ªçº¿ç¨‹è®¿é—®ã€‚</p>
<p>å½“æŸä¸ªçº¿ç¨‹å æœ‰ <code>mutex</code> æ—¶ï¼Œ<strong>å…¶ä»–</strong>è¯•å›¾è·å– <code>mutex</code> æ‰€æœ‰æƒçš„çº¿ç¨‹å°†ä¼šé˜»å¡ - é€šè¿‡ <code>lock</code> è°ƒç”¨ï¼Œæˆ–è€…æ”¶åˆ° <code>false</code> - é€šè¿‡ <code>try_lock</code> è°ƒç”¨ã€‚</p>
<p>å½“æŸä¸ªçº¿ç¨‹å æœ‰ <code>mutex</code> æ—¶ï¼Œ<strong>è¯¥çº¿ç¨‹</strong>å†æ¬¡å°è¯• <code>lock</code> ä¼šå‡ºç°æœªå®šä¹‰è¡Œä¸ºï¼Œæ¯”å¦‚æ­»é”ï¼ŒC++ æ ‡å‡†æ¨èæ­¤æ—¶èƒ½å¤ŸæŠ›å‡º <code>std::system_error(resource_deadlock_would_occur)</code> æ¥å–ä»£æ­»é”ã€‚</p>
<p><code>mutex</code> çš„å¤åˆ¶æ„é€ å‡½æ•°ä¸èµ‹å€¼è¿ç®—ç¬¦éƒ½è¢« <code>delete</code> æ‰ï¼Œå› ä¸ºæ²¡æœ‰æ„ä¹‰ã€‚</p>
<p><code>mutex</code> ç±»çš„æˆå‘˜å‡½æ•° <code>lock</code> ä¸ <code>unlock</code> ä¸åº”è¯¥æ‰‹å·¥è°ƒç”¨ï¼Œè€Œåº”è¯¥äº¤ç»™æ ˆä¸Šçš„é”ç®¡ç†å¯¹è±¡é€šè¿‡æ„é€ å’Œææ„ç®¡ç†ã€‚</p>
<h3 id="std-mutex-ç¤ºä¾‹"><code>std::mutex</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt; g_pages;</span><br><span class="line"><span class="built_in">std</span>::mutex g_pages_mutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_page</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿé•¿é¡µé¢è¯»å–</span></span><br><span class="line">    <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">2</span>));</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> result = <span class="string">"fake content"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// save_page ç»“æŸå mutex é‡Šæ”¾</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">guard</span><span class="params">(g_pages_mutex)</span></span>;</span><br><span class="line">    g_pages[url] = result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// t1 t2 ä¾æ¬¡å°†ç½‘é¡µå†…å®¹å¡«å…¥ map ä¸­</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t1</span><span class="params">(save_page, <span class="string">"http://foo"</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t2</span><span class="params">(save_page, <span class="string">"http://bar"</span>)</span></span>;</span><br><span class="line">    t1.join();</span><br><span class="line">    t2.join();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç°åœ¨è®¿é—® g_pages æ˜¯å®‰å…¨çš„ï¼Œå› ä¸º t1 t2 ç”Ÿå‘½å‘¨æœŸå·²ç»“æŸ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;pair : g_pages) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; pair.first &lt;&lt; <span class="string">" =&gt; "</span> &lt;&lt; pair.second &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-timed-mutex">std::timed_mutex</h2>
<h3 id="std-timed-mutex-ç‰¹æ€§"><code>std::timed_mutex</code> ç‰¹æ€§</h3>
<p><code>timed_mutex</code> åœ¨ <code>mutex</code> çš„åŸºç¡€ä¸Šæ–°å¢äº†ä¸€äº›åŠŸèƒ½ï¼Œæ·»åŠ äº†ä¸¤ä¸ªæˆå‘˜å‡½æ•° <code>try_lock_for</code> å’Œ <code>try_lock_until</code>ã€‚</p>
<p><code>try_lock_for</code> åœ¨å°è¯•è·å–é”çš„è¿‡ç¨‹ä¸­ä¼šé˜»å¡ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœåœ¨è¿™æ®µæ—¶é—´éƒ½æ²¡æœ‰è·å–åˆ°é”å°±è¿”å› <code>false</code>ï¼Œè€Œ <code>try_lock_until</code> åˆ™ä¼šé˜»å¡åˆ°æŒ‡å®šæ—¶é—´ï¼Œé™¤éåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è·å¾—äº†é”ã€‚</p>
<h3 id="std-timed-mutex-ç¤ºä¾‹"><code>std::timed_mutex</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ§åˆ¶åˆ° std::cout çš„è®¿é—®</span></span><br><span class="line"><span class="built_in">std</span>::mutex cout_mutex;</span><br><span class="line"><span class="built_in">std</span>::timed_mutex mutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">job</span><span class="params">(<span class="keyword">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> Ms = <span class="built_in">std</span>::chrono::milliseconds;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">ostringstream</span> stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯ä¸ªçº¿ç¨‹éƒ½å°è¯• 3 æ¬¡è·å– timed_mutex</span></span><br><span class="line">    <span class="comment">// æˆåŠŸäº†æ‰“å° success å¹¶ sleep 100Ms</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mutex.try_lock_for(Ms(<span class="number">100</span>))) &#123;</span><br><span class="line">            stream &lt;&lt; <span class="string">"success "</span>;</span><br><span class="line">            <span class="built_in">std</span>::this_thread::sleep_for(Ms(<span class="number">100</span>));</span><br><span class="line">            mutex.unlock();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            stream &lt;&lt; <span class="string">"failed "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">std</span>::this_thread::sleep_for(Ms(<span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰“å°è¾“å‡ºæ—¶ä¹Ÿéœ€è¦è·å– mutex</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(cout_mutex)</span></span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"["</span> &lt;&lt; id &lt;&lt; <span class="string">"] "</span> &lt;&lt; stream.str() &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt; threads;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;</span><br><span class="line">        <span class="comment">// explicit thread(Function&amp;&amp; f, Args&amp;&amp;... args)</span></span><br><span class="line">        <span class="comment">// å€¼ä¼ é€’æ„é€ çº¿ç¨‹å¹¶å¯åŠ¨</span></span><br><span class="line">        threads.emplace_back(job, i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; i: threads) &#123;</span><br><span class="line">        i.join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::timed_mutex test_mutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> now = <span class="built_in">std</span>::chrono::steady_clock::now();</span><br><span class="line">    <span class="comment">// å¡«å…¥è¦é˜»å¡åˆ°çš„æœ€å¤§æ—¶é—´ç‚¹</span></span><br><span class="line">    test_mutex.try_lock_until(now + <span class="built_in">std</span>::chrono::seconds(<span class="number">10</span>));</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"hello world\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ä¸»çº¿ç¨‹å·²ç»è·å¾—äº† time_mutexï¼Œthread t åªèƒ½é˜»å¡ 10S</span></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::timed_mutex&gt; <span class="title">l</span><span class="params">(test_mutex)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">t</span><span class="params">(f)</span></span>;</span><br><span class="line">    t.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-recursive-mutex">std::recursive_mutex</h2>
<h3 id="std-recursive-mutex-ç‰¹æ€§"><code>std::recursive_mutex</code> ç‰¹æ€§</h3>
<p><code>recursive_mutex</code> åˆè¢«ç§°ä¸ºé€’å½’äº’æ–¥å™¨ï¼Œå®ƒä¸ <code>non-recursive mutex</code> çš„åŒºåˆ«åœ¨äºæ‹¥æœ‰é”çš„çº¿ç¨‹å†æ¬¡ <code>lock</code> æ—¶ä¸ä¼šå‡ºç°æœªå®šä¹‰è¡Œä¸ºï¼Œè€Œæ˜¯è®°å…¥åŠ é”æ¬¡æ•°ä¸­ï¼Œ<code>unlock</code> æ—¶å¿…é¡»åŒ¹é…åˆ° <code>lock</code> çš„æ¬¡æ•°æ‰èƒ½æˆåŠŸè§£é”ã€‚</p>
<p>å¯¹ <code>recursive_mutex</code> åŠ é”çš„æœ€å¤§æ¬¡æ•°æ˜¯æœªçŸ¥çš„ï¼Œè¾¾åˆ°æœ€å¤§æ¬¡æ•°æ—¶ç»§ç»­ <code>lock</code> ä¼šæŠ›å‡º <code>std::system_error</code>ã€‚</p>
<p>éƒ¨åˆ†åœºåˆä¸‹ï¼Œ<code>recursive_mutex</code> ä¼šæ©ç›–ä»£ç çš„ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ä¸‹é¢çš„æƒ…å½¢ä¸­ï¼Œå½“ <code>doit</code> ä¸å°å¿ƒé—´æ¥è°ƒç”¨åˆ°äº† <code>post</code>ï¼Œ<code>mutex</code> æœ‰å¯èƒ½ä¼šæ­»é”ï¼Œè€Œ <code>recursive_mutex</code> ä¼šå¶å°” <code>crash</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::mutex mutex;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Foo&gt; foos;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">post</span><span class="params">(<span class="keyword">const</span> Foo&amp; f)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mutex)</span></span>;</span><br><span class="line">    foos.push_back(f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">traverse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(mutex)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> it = foos.<span class="built_in">begin</span>(); it != foos.<span class="built_in">end</span>(); ++it) &#123;</span><br><span class="line">        it-&gt;doit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="std-recursive-mutex-ç¤ºä¾‹"><code>std::recursive_mutex</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::recursive_mutex test;</span><br><span class="line">    <span class="comment">// å°è¯•é”å®šå¹¶è§£é”</span></span><br><span class="line">    <span class="keyword">if</span> (test.try_lock()) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"lock acquired"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        test.unlock();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"lock not acquired"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†æ¬¡é”å®š</span></span><br><span class="line">    test.lock();</span><br><span class="line">    <span class="comment">// å†æ¬¡é”å®šä»ç„¶èƒ½å¤ŸæˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (test.try_lock()) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"lock acquired"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"lock not acquired"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    test.unlock();</span><br><span class="line">    <span class="comment">//test.unlock();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-recursive-timed-mutex">std::recursive_timed_mutex</h2>
<h3 id="std-recursive-timed-mutex-ç‰¹æ€§"><code>std::recursive_timed_mutex</code> ç‰¹æ€§</h3>
<p><code>recursive_timed_mutex</code> æ˜¯ <code>recursive_mutex</code> å’Œ <code>timed_mutex</code> çš„åˆä½“ï¼Œç‰¹æ€§ä¸ç¤ºä¾‹å‡å‚ç…§ä»¥ä¸Šã€‚</p>
<h2 id="std-shared-mutex">std::shared_mutex</h2>
<h3 id="std-shared-mutex-ç‰¹æ€§"><code>std::shared_mutex</code> ç‰¹æ€§</h3>
<p><code>shared_mutex</code> æ˜¯ C++17 ä¸­å¼•å…¥çš„æ–°ç‰¹æ€§ã€‚å®ƒæ‹¥æœ‰ä¸¤ä¸ªè®¿é—®çº§åˆ«ï¼š<br>
å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿå…±äº«åŒä¸€ä¸ª <code>shared_mutex</code> çš„æ‰€æœ‰æƒï¼›<br>
ä»…ä¸€ä¸ªçº¿ç¨‹èƒ½è·å¾— <code>shared_mutex</code> çš„æ‰€æœ‰æƒã€‚</p>
<p><code>shared_mutex</code> å³æœ‰æ’ä»–é”å®šçš„æˆå‘˜å‡½æ•° <code>lock</code>ã€<code>try_lock</code>ã€<code>unlock</code>ï¼Œåˆæœ‰å…±äº«é”å®šçš„æˆå‘˜å‡½æ•° <code>lock_shared</code>ã€<code>try_lock_shared</code>ã€<code>unlock_shared</code>ã€‚</p>
<p><code>shared_mutex</code> æœ¬è´¨æ˜¯ <code>rwlock</code>ï¼ŒåŸºæœ¬è§„åˆ™å¯ä»¥æ€»ç»“ä¸º<strong>å†™ä¼˜å…ˆã€è¯»å…±äº«ã€äº¤å‰äº’æ–¥</strong>ï¼Œä¹‹æ‰€ä»¥å†™ä¼˜å…ˆæ˜¯å› ä¸ºèƒ½å¤Ÿä¿è¯è¯»åˆ°æ•°æ®æ˜¯æœ€æ–°çš„ã€‚</p>
<p>å½“ <code>shared_mutex</code> å½“å‰æ˜¯å†™åŠ é”æ—¶ï¼Œæ‰€æœ‰å°è¯• <code>lock</code> çš„çº¿ç¨‹éƒ½ä¼šé˜»å¡ï¼›<br>
å½“ <code>shared_mutex</code> å½“å‰æ˜¯è¯»åŠ é”æ—¶ï¼Œæ‰€æœ‰å°è¯•ä»¥è¯»æ¨¡å¼ <code>lock</code> çš„çº¿ç¨‹èƒ½å¤Ÿè·å¾—è®¿é—®æƒï¼Œä»¥å†™æ¨¡å¼ <code>lock</code> çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼›<br>
å½“ <code>shared_mutex</code> è¯»åŠ é”æ—¶æœ‰å…¶å®ƒçº¿ç¨‹å°è¯•ä»¥å†™æ¨¡å¼ <code>lock</code> æ—¶ï¼Œ<code>shared_mutex</code> ä¼šé˜»å¡åé¢çš„è¯»æ¨¡å¼ï¼Œç›´åˆ°å†™æ¨¡å¼ç»“æŸé‡Šæ”¾é”ã€‚</p>
<p>å¦‚æœæ˜¯è‡ªå·±å®ç°è¯»å†™é”çš„æ—¶å€™å¯èƒ½å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œ<strong>é€šå¸¸ <code>reader lock</code> æ˜¯å¯é‡å…¥çš„ï¼Œè€Œ <code>writer lock</code> æ˜¯ä¸å¯é‡å…¥çš„ï¼Œé‚£ä¹ˆ <code>reader lock</code> é‡å…¥çš„æ—¶å€™å¯èƒ½ä¼šé€ æˆæ­»é”</strong>ã€‚</p>
<h3 id="std-shared-mutex-ç¤ºä¾‹"><code>std::shared_mutex</code> ç¤ºä¾‹</h3>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;shared_mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadSafeCounter</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ThreadSafeCounter() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»çš„æ—¶å€™ä½¿ç”¨å…±äº«é”</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::shared_lock&lt;<span class="built_in">std</span>::shared_mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> value_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™çš„æ—¶å€™ä½¿ç”¨ç‹¬å é”</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::shared_mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        value_++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡ç½®çš„æ—¶å€™ä½¿ç”¨ç‹¬å é”</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="built_in">std</span>::unique_lock&lt;<span class="built_in">std</span>::shared_mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">        value_ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// get const ä¸­éœ€è¦åŠ é”ï¼Œå› æ­¤ mutex_ éœ€è¦å®šä¹‰ä¸º mutable</span></span><br><span class="line">    <span class="keyword">mutable</span> <span class="built_in">std</span>::shared_mutex mutex_;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> value_ = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ThreadSafeCounter counter;</span><br><span class="line">    <span class="built_in">std</span>::mutex printMutex;</span><br><span class="line">    <span class="keyword">auto</span> increment_and_print = [&amp;counter, &amp;printMutex]() &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            counter.increment();</span><br><span class="line">            <span class="comment">// å†™å…¥ std::cout å®é™…ä¸Šä¹Ÿè¦ç”±å¦ä¸€äº’æ–¥åŒæ­¥</span></span><br><span class="line">            <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(printMutex)</span></span>;</span><br><span class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">' '</span> &lt;&lt; counter.<span class="built_in">get</span>() &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">thread1</span><span class="params">(increment_and_print)</span></span>;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::thread <span class="title">thread2</span><span class="params">(increment_and_print)</span></span>;</span><br><span class="line"></span><br><span class="line">    thread1.join();</span><br><span class="line">    thread2.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="std-shared-timed-mutex">std::shared_timed_mutex</h2>
<h3 id="std-shared-timed-mutex-ç‰¹æ€§"><code>std::shared_timed_mutex</code> ç‰¹æ€§</h3>
<p><code>shared_timed_mutex</code> æ˜¯ <code>shared_mutex</code> ä¸ <code>timed_mutex</code> çš„åˆä½“ï¼š<br>
æ’ä»–é”å®šæˆå‘˜å‡½æ•° <code>lock</code>ã€<code>try_lock</code>ã€<code>try_lock_for</code>ã€<code>try_lock_until</code>ã€<code>unlock</code>ï¼›<br>
å…±äº«é”å®šæˆå‘˜å‡½æ•° <code>lock_shared</code>ã€<code>try_lock_shared</code>ã€<code>try_lock_shared_for</code>ã€<code>try_lock_shared_until</code>ã€<code>unlock_shared</code>ã€‚</p>
]]></content>
      <categories>
        <category>MultiThreading</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>Inter-Threading-Communication</tag>
        <tag>MultiThreading</tag>
        <tag>Mutex</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ å’Œ Javaï¼šåŒºåˆ«åˆ°åº•åœ¨å“ªé‡Œ</title>
    <url>/posts/54e19ff4/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>ä»è¯­è¨€ç‰¹æ€§ä¸Šæ¥è¯´ï¼Œä¸»è¦æ˜¯å˜é‡è¯­ä¹‰ä¸ç¼–ç¨‹èŒƒå¼çš„åŒºåˆ«</li>
<li>ä»ç¼–ç æ–¹å¼ä¸Šæ¥è¯´ï¼Œå®ƒä»¬ç”³è¯·å¯¹è±¡çš„æ–¹å¼ã€èµ„æºç®¡ç†ã€é”™è¯¯å¤„ç†éƒ½ä¸å¤ªç›¸åŒ</li>
<li>ä»ç¼–è¯‘è¿è¡Œä¸Šæ¥è¯´ï¼Œå®ƒä»¬ç¼–è¯‘è¿è¡Œçš„æ–¹å¼ã€å¯¹å¤–æš´éœ²æ¥å£çš„æ–¹å¼ã€å¼•ç”¨å¤–éƒ¨ç±»çš„æ–¹å¼ä¹Ÿä¸ä¸€æ ·</li>
</ul>
</blockquote>
<a id="more"></a>
<p>åœ¨åš C/C++ å¼€å‘çš„æ—¶å€™ä¹Ÿä¼šç»å¸¸æ¥è§¦åˆ° Java ç›¸å…³çš„ä»£ç ä¸çŸ¥è¯†ï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹å®ƒä»¬ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ï¼š</p>
<h2 id="å˜é‡è¯­ä¹‰çš„åŒºåˆ«">å˜é‡è¯­ä¹‰çš„åŒºåˆ«</h2>
<p>C++ ä¸­æ‰€æœ‰çš„å˜é‡ç¼ºçœéƒ½æ˜¯å€¼è¯­ä¹‰ï¼Œå¦‚æœä¸ä½¿ç”¨æŒ‡é’ˆæˆ–è€…å¼•ç”¨ï¼Œå˜é‡ä¸ä¼šå¼•ç”¨ä¸€ä¸ªå †ä¸Šçš„å¯¹è±¡ã€‚<br>
å€¼è¯­ä¹‰çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ç®€å•ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯ <em>stack object</em>ï¼Œä½†æ˜¯é€šè¿‡æŒ‡é’ˆæˆ–å¼•ç”¨æ¥æ“ä½œå †ä¸Šå¯¹è±¡çš„æ—¶å€™ï¼ŒC++ å°±éœ€è¦è€ƒè™‘æ‰€æŒ‡å¯¹è±¡æ˜¯å¦æˆåŠŸé‡Šæ”¾ã€‚<strong>æ™ºèƒ½æŒ‡é’ˆèƒ½å¤Ÿå°†å¼•ç”¨è¯­ä¹‰è½¬åŒ–ä¸ºå€¼è¯­ä¹‰æ¥è§£å†³ä¸Šè¿°å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜</strong>ã€‚ç”±äº <em>memory locality</em>ï¼ŒC++ çš„å€¼è¯­ä¹‰åœ¨æ€§èƒ½ä¸Šå…·æœ‰æå¤§çš„ä¼˜åŠ¿ã€‚<br>
Java ä¸­å¤§éƒ¨åˆ†å˜é‡åˆ™æ˜¯å¼•ç”¨è¯­ä¹‰ï¼Œæ ˆç©ºé—´çš„å˜é‡éƒ½æ˜¯å¼•ç”¨ç±»å‹ï¼Œå› æ­¤å¦‚æœå‘ç”Ÿæ‹·è´éƒ½æ˜¯æµ…æ‹·è´ã€‚</p>
<h2 id="ç¼–ç¨‹èŒƒå¼çš„åŒºåˆ«">ç¼–ç¨‹èŒƒå¼çš„åŒºåˆ«</h2>
<p>C++ æ˜¯ä¸€é—¨å¤šèŒƒå¼çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ”¯æŒé¢å‘è¿‡ç¨‹ç¼–ç¨‹ã€é¢å‘å¯¹è±¡ç¼–ç¨‹ã€æ³›å‹ç¼–ç¨‹ã€å‡½æ•°å¼ç¼–ç¨‹ï¼Œå¼€å‘çµæ´»æ€§é«˜ã€‚<br>
Java æ”¯æŒé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œæˆ–è®¸è¿˜æœ‰æ³›å‹ï¼Ÿ</p>
<h2 id="ç”³è¯·å¯¹è±¡æ–¹å¼çš„åŒºåˆ«">ç”³è¯·å¯¹è±¡æ–¹å¼çš„åŒºåˆ«</h2>
<p>å˜é‡è¯­ä¹‰çš„åŒºåˆ«å¸¦æ¥äº†ç”³è¯·å¯¹è±¡æ–¹å¼çš„åŒºåˆ«ã€‚<br>
C++ å¯ä»¥è‡ªç”±æ§åˆ¶å¯¹è±¡æ˜¯åœ¨å †ä¸Šåˆ†é…è¿˜æ˜¯åœ¨æ ˆä¸Šåˆ†é…ï¼Œå †ä¸Šåˆ†é…æ—¶é—´ä¸ç¡®å®šï¼Œè€Œæ ˆä¸Šåˆ†é…é€Ÿåº¦æå¿«ã€‚<br>
Java æå€¡æ‰€æœ‰å¯¹è±¡éƒ½åœ¨å †ä¸Šåˆ†é…ï¼ˆåŸç”Ÿç±»å‹ä¹Ÿæœ‰å¯¹åº”çš„å°è£…ç±»ï¼‰ï¼Œç”± GC ç»Ÿä¸€ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚</p>
<h2 id="èµ„æºç®¡ç†æ–¹å¼çš„åŒºåˆ«">èµ„æºç®¡ç†æ–¹å¼çš„åŒºåˆ«</h2>
<p>C++ æ²¡æœ‰åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå› æ­¤ C++ åœ¨å †ä¸Šå¼€è¾Ÿäº†ä¸€æ®µæ–°ç©ºé—´å­˜æ”¾æ•°æ®ä¹‹åè¿˜éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ç©ºé—´ã€‚<br>
å¯¹äºä¸€äº›ç”Ÿå‘½å‘¨æœŸæ¨¡ç³Šçš„å¯¹è±¡ï¼ŒC++11 ä¹‹åä½¿ç”¨äº†æ”¹è¿›ç‰ˆçš„æ™ºèƒ½æŒ‡é’ˆæ¥ç®¡ç† new å‡ºæ¥çš„å¯¹è±¡ï¼Œé‡Šæ”¾å¯¹è±¡çš„ä»»åŠ¡äº¤ç»™æ™ºèƒ½æŒ‡é’ˆè‡ªåŠ¨å®Œæˆï¼Œæ•´ä¸ªè¿‡ç¨‹ä½¿ç”¨çš„æ˜¯ RAII æŠ€æœ¯ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å‚è€ƒä¸Šä¸€ç¯‡æ™ºèƒ½æŒ‡é’ˆçš„æ–‡ç« ã€‚<br>
Java ä¸­æœ‰åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œå †ä¸­ç”³è¯·çš„ç©ºé—´ GC ä¼šè‡ªåŠ¨å›æ”¶ï¼Œè€Œ Java æ²¡æœ‰ææ„å‡½æ•°ï¼Œä¹Ÿå‡ ä¹å¾ˆå°‘ç”¨ RAII æ¥ç®¡ç†èµ„æºã€‚</p>
<h2 id="é”™è¯¯å¤„ç†æ–¹å¼çš„åŒºåˆ«">é”™è¯¯å¤„ç†æ–¹å¼çš„åŒºåˆ«</h2>
<p>C++ å‡ºäºå†å²åŸå› ï¼ˆGoogle ç¼–ç é£æ ¼ï¼‰æˆ–æ˜¯æ€§èƒ½åŸå› ï¼ˆå¼‚å¸¸æŠ›å‡ºå¯¼è‡´ç³»ç»Ÿå®æ—¶æ€§å—æŸï¼‰å¯ä»¥ä¸ä½¿ç”¨å¼‚å¸¸ï¼Œå› ä¸ºå¦‚æœä½¿ç”¨å¼‚å¸¸ï¼Œä»£ç ä¸­å¯èƒ½å‡ºç°å¤§é‡çš„ <code>try{...}catch{...}</code> è¯­å¥ï¼Œä»£ç å°†ä¼šå˜å¾—å†—é•¿éš¾è¯»ï¼Œè€Œä¸”<strong>åœ¨æ³›å‹ç¼–ç¨‹çš„ä»£ç ä¸­æˆ‘ä»¬ç”šè‡³ä¸çŸ¥é“å¯èƒ½ä¼šå‡ºç°å“ªäº›å¼‚å¸¸</strong>ã€‚<br>
æ‰€ä»¥ <strong>ä» C++17 å¼€å§‹ï¼Œå¯¹å¼‚å¸¸çš„å¤„ç†æ ‡å‡†å˜æˆäº†æˆ‘ä»¬åªèƒ½å£°æ˜æŸäº›å‡½æ•°ä¸èƒ½æŠ›å‡ºå¼‚å¸¸</strong>ã€‚åœ¨è¿è¡Œä¹‹å‰ï¼Œæ— è®ºæ˜¯ä»£ç å£°æ˜è¿˜æ˜¯ç¼–è¯‘å™¨éƒ½ä¸èƒ½å‘ç°å¼‚å¸¸ã€‚<br>
Java ä¸­å¦‚æœä¸€ä¸ªå‡½æ•°æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™å¼ºåˆ¶å®ƒçš„è°ƒç”¨æ–¹å¿…é¡»è¦å¤„ç†å¼‚å¸¸ã€‚</p>
<h2 id="å¯¹å¤–æš´éœ²æ¥å£çš„åŒºåˆ«">å¯¹å¤–æš´éœ²æ¥å£çš„åŒºåˆ«</h2>
<p>C++ é™¤äº†<strong>æ¨¡æ¿ç±»éœ€è¦å°†æ¥å£å’Œå®ç°éƒ½æ”¾åœ¨å¤´æ–‡ä»¶ä¸­</strong>ï¼Œå…¶ä»–æƒ…å†µä¸‹éƒ½æ˜¯<strong>å¤´æ–‡ä»¶æä¾›å¯¹å¤–æ¥å£ï¼Œæºæ–‡ä»¶å®ç°å¯¹å¤–æ¥å£</strong>ã€‚<br>
Java ä¸»è¦æ˜¯é€šè¿‡ç»§æ‰¿å’Œå¤šæ€æ¥å®ç°è‡ªå®šä¹‰æ¥å£ã€‚</p>
<h2 id="å¼•ç”¨å¤–éƒ¨ç±»ä¸ä¾èµ–å…³ç³»çš„åŒºåˆ«">å¼•ç”¨å¤–éƒ¨ç±»ä¸ä¾èµ–å…³ç³»çš„åŒºåˆ«</h2>
<p>C++ çš„å¤´æ–‡ä»¶æœºåˆ¶ä¼šå¼•å…¥å¤§é‡ä¸ç›¸å…³çš„ä»£ç ä¾èµ–ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­ç»å¸¸å‡ºç°æŸä¸ªä¾èµ–çš„å¤´æ–‡ä»¶ä¸åŒ¹é…ï¼Œä½†æ˜¯å´æ‰¾ä¸åˆ°æ˜¯å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå¤´æ–‡ä»¶çš„ï¼ŒåŒæ ·çš„ï¼Œé“¾æ¥æ—¶ä¹Ÿä¼šå‡ºç°åº“ç‰ˆæœ¬ä¸å¯¹æˆ–è€…åº“çš„ç¼–è¯‘å‚æ•°ä¸åŒ¹é…ç­‰é”™è¯¯ã€‚<br>
Java çš„ import æœºåˆ¶ä»¥åŠ package æœºåˆ¶èƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œç”¨åˆ°å“ªä¸ªç±»å°± import å“ªä¸ªç±»ï¼Œç”¨åˆ°çš„åº“æ–‡ä»¶ä¹Ÿèƒ½å¤Ÿç¼–è¯‘æˆä¸€ä¸ª .jar åŒ…ç”¨äºå¤–éƒ¨ importï¼Œç®€å•é«˜æ•ˆã€‚</p>
<h2 id="ç¼–è¯‘è¿è¡Œæ–¹å¼çš„åŒºåˆ«">ç¼–è¯‘è¿è¡Œæ–¹å¼çš„åŒºåˆ«</h2>
<p>C++ å…ˆå°†ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å’Œå¹³å°æœ‰å…³çš„ï¼Œæ‰€ä»¥å¸¸è¯´ <strong>C++ ä¸æ˜¯è·¨å¹³å°çš„</strong>ï¼Œæ“ä½œç³»ç»Ÿå°†è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è¯»å…¥å†…å­˜æ‰§è¡Œã€‚<br>
Java æ˜¯å°†æºæ–‡ä»¶ .java ç¼–è¯‘æˆ .class å­—èŠ‚ç ï¼Œå†<strong>é€šè¿‡ Jvm å°†å­—èŠ‚ç è½½å…¥å†…å­˜ä¸­ç¿»è¯‘æ‰§è¡Œ</strong>ã€‚æ‰€ä»¥ Java çš„è·¨å¹³å°æ˜¯é€šè¿‡ä¸å¹³å°æ— å…³çš„å­—èŠ‚ç å®ç°çš„ã€‚<br>
å› ä¸º Jvm åŠ è½½å­—èŠ‚ç åæ˜¯ä¸€è¾¹ç¿»è¯‘ä¸€è¾¹æ‰§è¡Œçš„ï¼Œæ‰§è¡Œæ•ˆç‡ä¼šç•¥ä½äº C++ï¼Œä½†æ˜¯åœ¨ç¡¬ä»¶æˆæœ¬æä½çš„ç°åœ¨æ‰§è¡Œæ•ˆç‡çš„å·®å¼‚å·²ç»è¢«æ‹‰åˆ°å¾ˆä½äº†ã€‚</p>
<p>ä»¥ä¸Šï¼ŒJava ä¸ C++ ç›¸æ¯”ï¼Œç¤¾åŒºæ›´åŠ æ´»è·ƒï¼Œå·¥å…·ä¹Ÿæ›´åŠ ä¸°å¯Œï¼Œå¼€æºåº“ä¹Ÿå¤šï¼Œéš¾æ€ªåœ¨è®²ç©¶é€Ÿåº¦ä¸æ•ˆç‡çš„äº’è”ç½‘è¡Œä¸šå¦‚æ­¤å—æ¬¢è¿ã€‚</p>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>Programming-Language</tag>
      </tags>
  </entry>
  <entry>
    <title>ä» RAII åˆ° smartPtrï¼šæ™ºèƒ½æŒ‡é’ˆå‰–æ</title>
    <url>/posts/3a3d14bc/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>ä»‹ç»äº† RAII çš„åŸºæœ¬æ¦‚å¿µ</li>
<li>ä»‹ç»äº†æ™ºèƒ½æŒ‡é’ˆçš„åŸºæœ¬æ¦‚å¿µ</li>
<li>å®ç°äº† auto_ptr / unique_ptr / shared_ptr</li>
<li>ä»‹ç»äº†æ™ºèƒ½æŒ‡é’ˆçš„ Deleter ä¸å¤šçº¿ç¨‹ä¸‹çš„åº”ç”¨</li>
</ul>
</blockquote>
<a id="more"></a>
<h2 id="RAII-çš„åŸºæœ¬æ¦‚å¿µ">RAII çš„åŸºæœ¬æ¦‚å¿µ</h2>
<h3 id="ä»€ä¹ˆæ˜¯å †">ä»€ä¹ˆæ˜¯å †</h3>
<p>åœ¨å†…å­˜ç®¡ç†çš„èŒƒç•´ä¸­ï¼Œæˆ‘ä»¬å°†ç¨‹åºä¸­èƒ½å¤ŸåŠ¨æ€åˆ†é…å†…å­˜çš„åŒºåŸŸç§°ä¸ºå † - <em>heap</em>ï¼ŒC/C++ éƒ½æä¾›äº†æ“ä½œ <em>heap</em> çš„å‡½æ•°æˆ–è¿ç®—ç¬¦ï¼š</p>
<ul>
<li>
<p>C ä½¿ç”¨ <code>malloc/free</code> æ“ä½œ <em>heap</em></p>
</li>
<li>
<p>C++ ä½¿ç”¨ <code>new/delete</code> æ“ä½œ <em>heap</em></p>
</li>
</ul>
<p>ç±»ä¼¼äºä¸‹é¢çš„ä»£ç å°±ä¼šåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">auto</span> vecPtr = <span class="keyword">new</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;();</span><br></pre></td></tr></table></figure>
<p>åœ¨å †ä¸Šåˆ†é…äº†å†…å­˜ä¹‹åçš„å¦ä¸€ä¸ªé—®é¢˜å°±æ˜¯é‡Šæ”¾å†…å­˜ï¼Œå’Œ Java çš„åƒåœ¾æ”¶é›†æœºåˆ¶ä¸åŒï¼ŒC++ çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾éƒ½ç”±å†…å­˜ç®¡ç†å™¨æ¥æ“ä½œï¼Œé€šå¸¸éƒ½ä¸ä½¿ç”¨åƒåœ¾æ”¶é›†ï¼Œæˆ‘ä»¬éœ€è¦åšçš„åªæ˜¯æŠŠ <code>new</code> å‡ºæ¥çš„å†…å­˜å†é€šè¿‡ <code>delete</code> é‡Šæ”¾æ‰å³å¯ï¼Œä½†æ˜¯äº‹å®ä¸ŠçœŸçš„è¿™ä¹ˆç®€å•å—ï¼Ÿ</p>
<h3 id="ä»€ä¹ˆæ˜¯æ ˆ">ä»€ä¹ˆæ˜¯æ ˆ</h3>
<p>å‡½æ•°åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨æ•°æ®ã€ç”Ÿæˆæ•°æ®æ—¶ä½¿ç”¨çš„å†…å­˜åŒºåŸŸç§°ä¸ºæ ˆ - <em>stack</em>ï¼Œå®ƒå’Œæ•°æ®ç»“æ„ä¸­çš„æ ˆç±»ä¼¼ï¼Œéƒ½æ˜¯ LIFOã€‚ä»¥ x86 ä¸ºä¾‹ï¼Œ<strong>æ ˆçš„å¢é•¿æ–¹å‘æ˜¯ç”±é«˜åœ°å€å‘ä½åœ°å€å¢é•¿</strong>ï¼Œå‡½æ•°ä¹‹é—´è°ƒç”¨æ—¶ï¼Œè°ƒç”¨å‡½æ•°ä¼šå°†è‡ªå·±çš„å‚æ•°å‹å…¥æ ˆä¸­ï¼ŒåŒæ—¶æŠŠè‡ªå·±ä¸‹ä¸€è¡Œçš„æŒ‡ä»¤ä¹Ÿå‹å…¥æ ˆä¸­ï¼Œå†è·³è½¬åˆ°æ–°çš„å‡½æ•°å¹¶è°ƒæ•´æ ˆæŒ‡é’ˆï¼Œæ–°çš„å‡½æ•°åœ¨æ‰§è¡Œå®Œä¹‹åä¼šæ ¹æ®æ ˆä¸­ä¿å­˜çš„è°ƒç”¨å‡½æ•°çš„åœ°å€<strong>é‡æ–°å›åˆ°è°ƒç”¨å‡½æ•°æœªæ‰§è¡Œçš„åœ°æ–¹ç»§ç»­æ‰§è¡Œ</strong>ã€‚</p>
<p>ç”±æ­¤å¯è§ï¼Œæ ˆä¸Šç©ºé—´çš„åˆ†é…å’Œé‡Šæ”¾é€»è¾‘éƒ½ååˆ†ç®€å•ï¼Œåªè¦ç§»åŠ¨æ ˆæŒ‡é’ˆå³å¯ï¼Œå…·ä½“åˆ†é…ç©ºé—´çš„æ—¶å€™ï¼Œæ¯ä¸ªå‡½æ•°åˆ†åˆ°çš„å±äºè‡ªå·±çš„é‚£ä¸€ä»½ç§°ä¸ºæ ˆå¸§ - <em>stack frame</em>ï¼Œå³ä½¿æ˜¯æœ‰æ„é€ å‡½æ•°å’Œææ„å‡½æ•°çš„æƒ…å†µä¸‹ï¼ŒC++ çš„ç¼–è¯‘å™¨ä¹Ÿä¼šåœ¨æ ˆå¸§çš„é€‚å½“ä½ç½®æ·»åŠ å¯¹æ„é€ å‡½æ•°å’Œææ„å‡½æ•°çš„è°ƒç”¨ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œ<strong>å°±ç®—å‡½æ•°æŠ›å‡ºäº†å¼‚å¸¸ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šè‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•°</strong>ï¼Œæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obj</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Obj()&#123; <span class="built_in">puts</span>(<span class="string">"Obj()"</span>); &#125;</span><br><span class="line">    ~Obj()&#123; <span class="built_in">puts</span>(<span class="string">"~Obj()"</span>); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">    Obj obj;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">"func error"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        func(<span class="number">0</span>);</span><br><span class="line">        func(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (<span class="keyword">const</span> <span class="keyword">char</span>* str)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Output:</span><br><span class="line">    Obj()</span><br><span class="line">    ~Obj()</span><br><span class="line">    Obj()</span><br><span class="line">    ~Obj()</span><br><span class="line">    func error</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>func(1)</code> åœ¨å°†å¼‚å¸¸æŠ›å‡ºä¹‹å‰å°±å·²ç»è°ƒç”¨äº†è‡ªèº«çš„ææ„å‡½æ•°ï¼Œè€Œè¿™ç‚¹æ­£æ˜¯ RAII çš„åŸºç¡€ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯-RAII">ä»€ä¹ˆæ˜¯ RAII</h3>
<p>RAII - <em>Resource Acquisition Is Initialization</em>ï¼Œèµ„æºè·å–å³åˆå§‹åŒ–ï¼Œ<strong>RAII æ˜¯ä¸€ç§èµ„æºç®¡ç†æ–¹å¼ï¼Œå®ƒé€šè¿‡æ ˆå’Œææ„å‡½æ•°æ¥ç®¡ç†åŒ…æ‹¬å †åœ¨å†…çš„æ‰€æœ‰èµ„æº</strong>ï¼Œä¸»æµçš„ç¼–ç¨‹è¯­è¨€ä¸­åªæœ‰ C++ æ˜¯ä½¿ç”¨ RAII æ¥ç®¡ç†èµ„æºçš„ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸ª C++ å·¥å‚æ–¹æ³•çš„ç®€å•ç¤ºä¾‹ï¼Œä¸ºäº†é˜²æ­¢å‘ç”Ÿå¯¹è±¡åˆ‡ç‰‡çš„é”™è¯¯ï¼ˆ<strong>C++ çš„å€¼è¯­ä¹‰ç‰¹ç‚¹æ‰€å¸¦æ¥çš„çš„ç¼–ç é™·é˜±ï¼šå‡½æ•°è¿”å›ç±»å‹ä¸ºçˆ¶ç±»å¯¹è±¡ï¼Œå®é™…è¿”å›çš„ä¸ºå­ç±»å¯¹è±¡</strong>ï¼‰ï¼Œå·¥å‚æ–¹æ³•éœ€è¦è¿”å›ä¸€ä¸ªçˆ¶ç±»å¯¹è±¡çš„æŒ‡é’ˆæˆ–è€…æ˜¯å¼•ç”¨ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// C++11 åå»ºè®®ä½¿ç”¨å¼ºç±»å‹æšä¸¾</span></span><br><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">animalType</span> &#123;</span></span><br><span class="line">    cat,</span><br><span class="line">    dog,</span><br><span class="line">    fox,</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">animal</span> &#123;</span>...&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cat</span> :</span> <span class="keyword">public</span> animal &#123;...&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dog</span> :</span> <span class="keyword">public</span> animal &#123;...&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fox</span> :</span> <span class="keyword">public</span> animal &#123;...&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">animal* <span class="title">buyNewAnimal</span><span class="params">(animalType ani_type)</span></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(ani_type) &#123;</span><br><span class="line">        <span class="keyword">case</span> animalType::cat :</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> cat();</span><br><span class="line">        <span class="keyword">case</span> animalType::dog :</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> dog();</span><br><span class="line">        <span class="keyword">case</span> animalType::fox :</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> fox();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶è¿”å›çš„æ˜¯ä¸€ä¸ª <code>animal</code> ç±»å‹çš„çˆ¶ç±»æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯å­ç±»å¯¹è±¡ï¼Œé—®é¢˜æ¥äº†ï¼Œ<code>buyNewAnimal</code> å‡½æ•°è¿”å› <code>animal</code> æŒ‡é’ˆåä¾¿é€€å‡ºäº†ï¼Œå †ä¸Šå·²ç»å¼€è¾Ÿå‡ºç©ºé—´ <code>animal</code> å­ç±»çš„å¯¹åº”ç©ºé—´ï¼Œå¦‚ä½•æ‰èƒ½ä¿è¯è¿™ä¸€éƒ¨åˆ†å†…å­˜ä¸æ³„æ¼ï¼Ÿ</p>
<h2 id="æ™ºèƒ½æŒ‡é’ˆçš„åŸºæœ¬æ¦‚å¿µ">æ™ºèƒ½æŒ‡é’ˆçš„åŸºæœ¬æ¦‚å¿µ</h2>
<p>C å’Œ C++ çš„è€ç¨‹åºå‘˜éƒ½æ›¾å¤§é‡æ¥è§¦è¿‡è£¸æŒ‡é’ˆï¼Œéƒ½æ›¾ä¸€è¾¹äº«å—ç€æŒ‡é’ˆå¸¦æ¥çš„ä¾¿åˆ©ä¸€è¾¹ä¸åœåœ°ç»™è‡ªå·±æŒ–å‘åŸ‹å‘ï¼Œåœ¨ä»‹ç»æ™ºèƒ½æŒ‡é’ˆä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ä½¿ç”¨æŒ‡é’ˆçš„æ—¶å€™å¸¸è§çš„å‘æœ‰å“ªäº›ï¼š</p>
<ul>
<li>
<p>å¿˜è®° <code>delete/free</code> å¯¼è‡´å†…å­˜æ³„éœ²</p>
</li>
<li>
<p>åŒä¸€ä¸ªæŒ‡é’ˆé‡Šæ”¾å¤šæ¬¡ï¼Œç¨‹åºå´©æºƒ</p>
</li>
<li>
<p>é€»è¾‘ bugï¼Œå†™äº† <code>delete/free</code> ç»“æœæ²¡æœ‰æ‰§è¡Œåˆ°</p>
</li>
<li>
<p><code>delete/free</code> ä¹‹å‰æŠ›å‡ºäº†å¼‚å¸¸</p>
</li>
</ul>
<p>å‰é¢å·²ç»ä»‹ç»è¿‡äº†ï¼ŒC++ æ²¡æœ‰è‡ªåŠ¨å†…å­˜å›æ”¶æœºåˆ¶ï¼Œ<code>new</code> å‡ºæ¥çš„å¿…é¡»è¦è‡ªå·± <code>delete</code> æ‰ï¼Œæ™ºèƒ½æŒ‡é’ˆçš„å¼•å…¥ï¼Œè®©ç¨‹åºå‘˜å¯ä»¥ä¸å†å…³æ³¨èµ„æºçš„é‡Šæ”¾ï¼Œå®ƒèƒ½å¤Ÿä¿è¯ç¨‹åºæ— è®ºæ­£å¸¸æˆ–å¼‚å¸¸ï¼Œåœ¨åˆ°æœŸçš„æ—¶å€™éƒ½èƒ½é€šè¿‡ RAII æœºåˆ¶æˆåŠŸå›æ”¶ã€‚</p>
<p>æ¥çœ‹ä¸Šä¸€èŠ‚ä¸­ <code>buyNewAnimal</code> å‡½æ•°è¿”å›çš„ <code>animal</code> æŒ‡é’ˆï¼Œ<strong>åªéœ€è¦å°†è¿™ä¸ªè¿”å›å€¼æ”¾å…¥ä¸€ä¸ªæœ¬åœ°å˜é‡ä¸­ï¼Œç¡®ä¿è¿™ä¸ªå˜é‡ææ„çš„æ—¶å€™ä¼šåˆ é™¤ä¸Šé¢çš„å¯¹è±¡</strong>å³å¯ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smartAnimalPtr</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">smartAnimalPtr</span><span class="params">(animal* animalPtr)</span> : <span class="title">animalPtr_</span><span class="params">(animalPtr)</span></span>&#123;&#125;</span><br><span class="line">    <span class="comment">// delete nullptr is legal operation</span></span><br><span class="line">    ~smartAnimalPtr()&#123;</span><br><span class="line">        <span class="keyword">delete</span> animalPtr_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">animal* <span class="title">getPtr</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> animalPtr_;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    animal* animalPtr_&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">smartAnimalPtr <span class="title">newAnimalPtr</span><span class="params">(buyNewAnimal(dog))</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>func</code> è°ƒç”¨çš„ <code>buyNewAnimal</code> å‡½æ•°è¿”å›å€¼è¢« <code>newAnimalPtr</code> æ¥ç®¡ï¼Œä½¿ç”¨è€…å¯ä»¥ç›´æ¥è°ƒç”¨ <code>newAnimalPtr.getPtr()</code> ä½¿ç”¨åŸæŒ‡é’ˆï¼Œå½“ <code>func</code> å‡½æ•°ç»“æŸæ—¶ï¼Œ<code>newAnimalPtr</code> ææ„ï¼Œ<code>animalPtr_</code> æ‰€æŒ‡å‘çš„åŒºåŸŸè¢«é‡Šæ”¾ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>delete</code>ï¼Œè€Œæ˜¯é€šè¿‡ RAII å·§å¦™åœ°äº¤ç»™ç¼–è¯‘å™¨å¤„ç†äº†ã€‚</p>
<p>é™¤äº† <code>delete</code> ä¹‹å¤–ï¼Œåœ¨æœ¬åœ°å˜é‡çš„ææ„å‡½æ•°ä¸­è¿˜å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li>é‡Šæ”¾åŒæ­¥é”ï¼Œå¦‚ä¸‹é¢çš„å¤šçº¿ç¨‹ç´¯åŠ èŒƒä¾‹ï¼š</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">std</span>::mutex sum_lock;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span>&amp; sum, <span class="keyword">int</span>&amp; num)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="comment">// ç»“æŸä¸€è½® while å sum_lock è‡ªåŠ¨é‡Šæ”¾</span></span><br><span class="line">        <span class="function"><span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; <span class="title">lock</span><span class="params">(sum_lock)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">100</span>) &#123;</span><br><span class="line">            num += <span class="number">1</span>;</span><br><span class="line">            sum += num;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>, num = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::thread&gt; tdVec;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i)&#123;</span><br><span class="line">        <span class="built_in">std</span>::thread td = <span class="built_in">std</span>::thread(add, <span class="built_in">std</span>::ref(sum), <span class="built_in">std</span>::ref(num));</span><br><span class="line">        tdVec.emplace_back(<span class="built_in">std</span>::<span class="built_in">move</span>(td));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// std::mem_fn can generate an object for pointers to members as well as ref and pointers to an object</span></span><br><span class="line">    <span class="built_in">std</span>::for_each(tdVec.<span class="built_in">begin</span>(), tdVec.<span class="built_in">end</span>(), <span class="built_in">std</span>::mem_fn(&amp;<span class="built_in">std</span>::thread::join));</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; sum &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å…³é—­æ–‡ä»¶ï¼Œå¦‚ <code>fstream</code> ææ„æ—¶ä¼šè°ƒç”¨ <code>close</code> ä»¥é˜²æ­¢æµå¯¹è±¡é”€æ¯åè¿˜ä¸æ‰“å¼€çš„æ–‡ä»¶ç›¸å…³è”</li>
</ul>
<p>ä¸Šé¢å®ç°çš„ <code>smartAnimalPtr</code> å·²ç»å¯ä»¥ç®—æ˜¯ä¸€ä¸ªç®€å•çš„æ™ºèƒ½æŒ‡é’ˆå•¦ã€‚</p>
<h2 id="auto-ptr">auto_ptr</h2>
<p>æˆ‘ä»¬å°† <code>smartAnimalPtr</code> æ¨¡æ¿åŒ–ï¼Œå¹¶æ·»åŠ ä¸€äº›å¸¸ç”¨çš„æŒ‡é’ˆæ“ä½œï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smartAutoPtr</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">smartAutoPtr</span><span class="params">(T* ptr)</span> : <span class="title">ptr_</span><span class="params">(ptr)</span> </span>&#123;&#125;</span><br><span class="line">    ~smartAutoPtr() &#123; <span class="keyword">delete</span> ptr_; &#125;</span><br><span class="line">    <span class="function">T* <span class="title">getPtr</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line">    T* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span> &#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span> &#123; <span class="keyword">return</span> *ptr_; &#125;</span><br><span class="line">    <span class="comment">// é‡è½½ bool è½¬æ¢è¿ç®—ç¬¦</span></span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T* ptr_&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç å­˜åœ¨ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ï¼Œå½“ <code>smartAutoPtr</code> æ‹·è´æ„é€ æˆ–è€…è¢«èµ‹å€¼æ—¶ï¼Œ<strong>å› ä¸ºæœ‰ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ç‰‡åŒºåŸŸï¼ŒRAII ä¼šè®©è¿™ç‰‡åŒºåŸŸé‡Šæ”¾ä¸¤æ¬¡</strong>ï¼è§£å†³è¿™ä¸ªé—®é¢˜çš„ç¬¬ä¸€ç§æ–¹æ³•ã€ä¹Ÿæ˜¯æœ€ç®€å•çš„æ–¹æ³•æ˜¯ç¦ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">smartAutoPtr(<span class="keyword">const</span> smartAutoPtr&lt;T&gt;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">smartAutoPtr&lt;T&gt;&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> smartAutoPtr&lt;T&gt;&amp;) = <span class="keyword">delete</span>;</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒç§æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ‹·è´æ„é€ å’Œèµ‹å€¼æ—¶è½¬ç§»æŒ‡é’ˆçš„æ‰€æœ‰æƒï¼Œè€Œè¿™ä¹Ÿæ­£æ˜¯ <code>auto_ptr</code> çš„å¤„ç†æ–¹å¼ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smartAutoPtr</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">smartAutoPtr</span><span class="params">(T* ptr)</span> : <span class="title">ptr_</span><span class="params">(ptr)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    smartAutoPtr(<span class="keyword">const</span> smartAutoPtr&amp; _Right) &#123;</span><br><span class="line">        ptr_ = _Right.<span class="built_in">release</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy and swap</span></span><br><span class="line">    <span class="comment">// _Right --&gt; smartAutoPtr(_Right) --&gt; _New</span></span><br><span class="line">    smartAutoPtr&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> smartAutoPtr&amp; _Right) &#123;</span><br><span class="line">        smartAutoPtr(_Right).reset(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~smartAutoPtr() &#123; <span class="keyword">delete</span> ptr_; &#125;</span><br><span class="line">    <span class="function">T* <span class="title">getPtr</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line">    T* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span> &#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span> &#123; <span class="keyword">return</span> *ptr_; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‰¥å¤ºåŸ smartAutoPtr å¯¹æŒ‡é’ˆçš„æ‰€æœ‰æƒç»™æ–° smartAutoPtr</span></span><br><span class="line">    <span class="function">T* <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        T* _Tmp = ptr_;</span><br><span class="line">        ptr_ = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">return</span> _Tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">(smartAutoPtr&amp; _New)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="built_in">std</span>::swap;</span><br><span class="line">        swap(ptr_, _New.ptr_);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T* ptr_&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>èµ‹å€¼è¿ç®—ç¬¦çš„é‡è½½åˆ©ç”¨äº† <em>copy and swap</em> æŠ€æœ¯ï¼Œå³å…ˆé€šè¿‡æ‹·è´æ„é€ åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå†äº¤æ¢å®ƒä»¬çš„æŒ‡é’ˆï¼Œè¿™æ ·èƒ½å¤Ÿä¿è¯å¼ºå®‰å…¨æ€§ï¼Œæ„é€ æ˜¯å¦æˆåŠŸå®Œå…¨ä¸ä¼šç ´åèµ‹å€¼è¿ç®—ç¬¦ä¸¤è¾¹çš„æ•°æ®ã€‚</p>
<p>ç”±ä¸Šé¢çš„ä»£ç ä¸éš¾çœ‹å‡ºï¼Œ<code>auto_ptr</code> åœ¨æ‹·è´æ„é€ å’Œèµ‹å€¼è¿ç®—æ—¶éƒ½ä¼šå®Œå…¨å‰¥å¤ºåŸå¯¹è±¡å¯¹æŒ‡é’ˆçš„æ‰€æœ‰æƒï¼Œä¹Ÿå°±æ˜¯è¯´é™¤äº†æœ€åä¸€ä¸ª <code>auto_ptr</code>ï¼Œå…¶ä½™æ‰€æœ‰çš„ <code>auto_ptr</code> éƒ½å˜æˆäº† <code>nullptr</code>ï¼Œå…¨éƒ¨å¤±æ•ˆäº†ï¼Œè¿™æ ·ä¼šå¸¦æ¥å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>
<p><strong>STL å¯¹å®¹å™¨ç±»å‹çš„è¦æ±‚æ˜¯è¦æœ‰å€¼è¯­ä¹‰ï¼Œå³å¯ä»¥å¤åˆ¶å’Œèµ‹å€¼</strong>ã€‚<code>auto_ptr</code> çš„å¤åˆ¶å’Œèµ‹å€¼ç»è¿‡äº† <code>release</code> å’Œ <code>reset</code> çš„å¤„ç†ï¼Œ<strong>å› æ­¤ <code>auto_ptr</code> å¯¹è±¡ä¸èƒ½ä½œä¸º STL çš„å®¹å™¨å…ƒç´ </strong>ã€‚</p>
</li>
<li>
<p>å°† <code>auto_ptr</code> ä½œä¸ºå‡½æ•°å‚æ•°æŒ‰å€¼ä¼ é€’æ—¶ï¼Œå‡½æ•°ä¼šåœ¨å…¶ä½œç”¨åŸŸä¸­ç”Ÿæˆè¯¥ <code>auto_ptr</code> çš„æ‹·è´ï¼Œæ­¤æ—¶çš„æŒ‡é’ˆæ‰€æœ‰æƒå·²ç»è½¬ç§»ç»™äº†è¿™ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œå½“å‡½æ•°é€€å‡ºæ—¶ï¼Œè¯¥ä¸´æ—¶å¯¹è±¡ææ„ï¼ŒåŸ <code>auto_ptr</code> æ‰€æŒ‡å‘çš„å¯¹è±¡ä¹Ÿè¢«åˆ é™¤äº†ï¼Œ<strong>å¦‚æœä¸å¾—ä¸ä½¿ç”¨ <code>auto_ptr</code> ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œæœ€å¥½ä½¿ç”¨ <code>const auto_ptr&amp;</code> çš„æ–¹å¼</strong>ã€‚</p>
</li>
</ul>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>auto_ptr</code> å·²ç»ä» C++17 æ ‡å‡†ä¸­åˆ é™¤äº†ã€‚</p>
<h2 id="unique-ptr">unique_ptr</h2>
<p><code>unique_ptr</code> ä¸ <code>auto_ptr</code> åœ¨ç‰¹æ€§ä¸Šç›¸å·®ä¸å¤§ï¼Œ<strong>åŒä¸€æ—¶åˆ»åªèƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ª <code>unique_ptr</code> æŒ‡å‘ç»™å®šçš„å¯¹è±¡</strong>ï¼Œ<code>unique_ptr</code> åœ¨å¤„ç†æ™ºèƒ½æŒ‡é’ˆæ‹·è´æ„é€ å’Œèµ‹å€¼æ—¶å‘ç”Ÿçš„æµ…æ‹·è´é—®é¢˜ä¸Šé‡‡ç”¨äº† <code>smartAutoPtr</code> æ‰€ä½¿ç”¨çš„æ–¹æ³•ä¸€ï¼Œå³ç›´æ¥å°†æ‹·è´æ„é€ å’Œèµ‹å€¼è¿ç®—ç¦ç”¨ï¼Œæ­¤å¤–ï¼Œ<code>unique_ptr</code> è¿˜å¼•å…¥äº†ç§»åŠ¨æ„é€ ï¼Œä» C++11 å¼€å§‹ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦å¤åˆ¶å¯¹è±¡ï¼Œåªéœ€è¦ç§»åŠ¨å¯¹è±¡å³å¯ï¼Œä¹Ÿå°±æ˜¯æŠŠæºå¯¹è±¡çš„èµ„æºæ§åˆ¶æƒè½¬äº¤ç»™ç›®æ ‡å¯¹è±¡ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¸å†éœ€è¦å¤šä½™çš„å¤åˆ¶æ“ä½œã€‚è€Œåœ¨æ­¤ä¹‹å‰ï¼Œå¦‚æœæƒ³è¦å°†æºå¯¹è±¡çš„çŠ¶æ€è½¬ç§»åˆ°ç›®æ ‡å¯¹è±¡åªèƒ½é€šè¿‡æ‹·è´æ„é€ ã€‚æˆ‘ä»¬å°†ä¸Šé¢çš„ <code>auto_ptr</code> ç¨å¾®ä¿®æ”¹å¯ä»¥å¾—åˆ°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ <code>unique_ptr</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smartUniquePtr</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">smartUniquePtr</span><span class="params">(T* ptr)</span> : <span class="title">ptr_</span><span class="params">(ptr)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»åŠ¨æ„é€ å‡½æ•°ä¸ä¼šåœ¨ç±»ä¸­é»˜è®¤ç”Ÿæˆ</span></span><br><span class="line">    smartUniquePtr(smartUniquePtr&amp;&amp; _Right) &#123;</span><br><span class="line">        ptr_ = _Right.<span class="built_in">release</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç±»å‹è½¬æ¢ç§»åŠ¨æ„é€ </span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    smartUniquePtr(smartUniquePtr&lt;U&gt;&amp;&amp; _Right) &#123;</span><br><span class="line">        ptr_ = _Right.<span class="built_in">release</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// necessary</span></span><br><span class="line">    smartUniquePtr(<span class="keyword">const</span> smartUniquePtr&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    smartUniquePtr(<span class="keyword">const</span> smartUniquePtr&lt;U&gt;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// new _Right --&gt; *this</span></span><br><span class="line">    smartUniquePtr&amp; <span class="keyword">operator</span>=(smartUniquePtr _Right) &#123;</span><br><span class="line">        _Right.reset(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~smartUniquePtr() &#123; <span class="keyword">delete</span> ptr_; &#125;</span><br><span class="line">    <span class="function">T* <span class="title">getPtr</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line">    T* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span> &#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span> &#123; <span class="keyword">return</span> *ptr_; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">T* <span class="title">release</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        T* _Tmp = ptr_;</span><br><span class="line">        ptr_ = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">return</span> _Tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">(smartUniquePtr&amp; _New)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="built_in">std</span>::swap;</span><br><span class="line">        swap(ptr_, _New.ptr_);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T* ptr_&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç éœ€è¦æ³¨æ„ï¼Œ<strong>åœ¨å®šä¹‰äº†ç§»åŠ¨æ„é€ å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰æä¾›æ‹·è´æ„é€ å‡½æ•°ï¼Œä¼šè‡ªåŠ¨ç¦ç”¨æ‹·è´æ„é€ å‡½æ•°</strong>ã€‚<br>
ä½†æ˜¯ï¼Œ<strong>ç¼–è¯‘å™¨å¹¶ä¸ä¼šæŠŠ <code>smartUniquePtr(smartUniquePtr&lt;U&gt;&amp;&amp; _Right) {}</code> çœ‹ä½œæ˜¯ç§»åŠ¨æ„é€ ï¼Œæ¢å¥è¯è¯´ï¼Œç¼–è¯‘å™¨ä¸ä¼šæŠŠæ‰€æœ‰çš„æ¨¡æ¿å‡½æ•°çœ‹ä½œæ„é€ å‡½æ•°</strong>ï¼Œå¦‚æœæƒ³æ¶ˆé™¤ä»£ç é‡å¤ï¼Œä»ç„¶éœ€è¦å°†æ‹·è´æ„é€ å‡½æ•°æ‰‹åŠ¨ç¦ç”¨ã€‚<br>
å†çœ‹ <code>smartUniquePtr</code> çš„ä½¿ç”¨ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// buyNewAnimal è¿”å›çš„æ˜¯ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œè°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°</span></span><br><span class="line">smartUniquePtr&lt;animal&gt; ptr1&#123; buyNewAnimal(animalType::dog) &#125;;</span><br><span class="line">smartUniquePtr&lt;animal&gt; ptr2&#123; <span class="literal">nullptr</span> &#125;;</span><br><span class="line"><span class="comment">// ptr1 æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œéœ€è¦è½¬æ¢æˆå³å€¼</span></span><br><span class="line"><span class="comment">// ptr1 --&gt; temp rv obj --&gt; ptr3</span></span><br><span class="line">smartUniquePtr&lt;animal&gt; ptr3 = <span class="built_in">std</span>::<span class="built_in">move</span>(ptr1);</span><br><span class="line">smartUniquePtr&lt;animal&gt; ptr4&#123; <span class="built_in">std</span>::<span class="built_in">move</span>(ptr3) &#125;;</span><br></pre></td></tr></table></figure>
<p><code>unique_ptr</code> é™¤äº†èƒ½å¤Ÿæ”¯æŒç®¡ç†å †ä¸Šåˆ†é…çš„å†…å­˜ï¼Œè¿˜èƒ½å¤Ÿé€šè¿‡ç§»åŠ¨è¯­ä¹‰ä½¿ <code>unique_ptr</code> å¯¹è±¡ä¸å®¹å™¨å…¼å®¹ã€‚<br>
ä½† <code>unique_ptr</code> ä»ç„¶æœ‰ä¸€äº›ä¸è¶³ï¼Œå®ƒä»ç„¶æ— æ³•é¿å…é‡å¤é‡Šæ”¾çš„é—®é¢˜ï¼Œä½¿ç”¨ç§»åŠ¨è¯­ä¹‰ä¹‹åçš„æºå¯¹è±¡ä¹Ÿä»ç„¶å¤±å»äº†å¯¹åŸæŒ‡é’ˆçš„æ‰€æœ‰æƒï¼Œæ— æ³•å†æ¬¡ä½¿ç”¨ã€‚<br>
è¦é¿å…ä¸Šè¿°è¿™äº›æƒ…å†µï¼Œæœ€å¥½çš„åŠæ³•æ˜¯ä½¿ç”¨å¸¦æœ‰å¼•ç”¨è®¡æ•°åŠŸèƒ½çš„æ™ºèƒ½æŒ‡é’ˆã€‚</p>
<h2 id="shared-ptr">shared_ptr</h2>
<p>åœ¨ <code>unique_ptr</code> ä¸­ï¼Œä¸€ä¸ªå¯¹è±¡åªèƒ½è¢«ä¸€ä¸ª <code>unique_ptr</code> æ‹¥æœ‰ï¼Œè¿™åœ¨å¤§éƒ¨åˆ†åœºåˆæ˜¯æ— æ³•æ»¡è¶³è¦æ±‚çš„ï¼Œæ›´å¸¸è§çš„æ˜¯å¤šä¸ªæ™ºèƒ½æŒ‡é’ˆåŒæ—¶æ‹¥æœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œåªæœ‰å½“æ‰€æœ‰çš„æŒ‡é’ˆéƒ½å¤±æ•ˆäº†ï¼Œæ‰ä¼šåˆ é™¤è¯¥å¯¹è±¡ï¼Œè¿™æ ·çš„æ™ºèƒ½æŒ‡é’ˆå°±æ˜¯ <code>shared_ptr</code>ã€‚<br>
<code>shared_ptr</code> çš„åº•å±‚é€šè¿‡å¼•ç”¨è®¡æ•°æ¥è¿›è¡Œç©ºé—´ç®¡ç†ï¼Œæ¯å½“æœ‰ä¸€ä¸ªæ–°çš„æŒ‡é’ˆæŒ‡å‘è¿™å—ç©ºé—´æ—¶ï¼Œå¼•ç”¨è®¡æ•°åŠ ä¸€ï¼Œåä¹‹å‡ä¸€ï¼Œç›´åˆ°å¼•ç”¨è®¡æ•°ä¸ºé›¶æ—¶æ‰é‡Šæ”¾ç©ºé—´ã€‚<br>
æ¥çœ‹ä¸€ä¸‹ <code>shared_ptr</code> çš„ç®€å•å®ç°ï¼Œå’Œ <code>unique_ptr</code> çš„ä¸åŒä¹‹å¤„åœ¨äºå®ƒéœ€è¦å®ç°å…±äº«çš„å¼•ç”¨è®¡æ•°ï¼Œå› æ­¤æˆ‘ä»¬<strong>åœ¨å †ä¸Š <code>new</code> ä¸€ä¸ª <code>ref_count</code> å‡ºæ¥ï¼Œå¹¶åœ¨ <code>shared_ptr</code> ä¸­ä¿å­˜æŒ‡å‘å®ƒçš„æŒ‡é’ˆ</strong>ï¼Œå®Œæ•´çš„æ“ä½œéœ€è¦åŒ…å« <code>add</code>ã€<code>reduce</code> å’Œ <code>get</code> ä¸‰ç§è¡Œä¸ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ref_count</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ref_count() <span class="keyword">noexcept</span> : cnt_(<span class="number">1</span>) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123; ++cnt_; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">reduce</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123; <span class="keyword">return</span> --cnt_; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">get</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123; <span class="keyword">return</span> cnt_; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">long</span> cnt_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">smartSharedPtr</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">smartSharedPtr</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">smartSharedPtr</span><span class="params">(T* ptr = <span class="literal">nullptr</span>)</span> : <span class="title">ptr_</span><span class="params">(ptr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ptr_) &#123;</span><br><span class="line">            refptr_ = <span class="keyword">new</span> ref_count();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// copy constructor ref_count add</span></span><br><span class="line">    smartSharedPtr(<span class="keyword">const</span> smartShared&amp; _Right) &#123;</span><br><span class="line">        ptr_ = _Right.ptr_;</span><br><span class="line">        <span class="keyword">if</span> (ptr_) &#123;</span><br><span class="line">            _Right.refptr_-&gt;add();</span><br><span class="line">            refptr_ = _Right.refptr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// template copy constructor</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    smartSharedPtr(<span class="keyword">const</span> smartSharedPtr&lt;U&gt;&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        ptr_ = _Right.ptr_;</span><br><span class="line">        <span class="keyword">if</span> (ptr_) &#123;</span><br><span class="line">            _Right.refptr_-&gt;add();</span><br><span class="line">            refptr_ = _Right.refptr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// template move constructor</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">    smartSharedPtr(smartSharedPtr&lt;U&gt;&amp;&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        ptr_ = _Right.ptr_;</span><br><span class="line">        <span class="keyword">if</span> (ptr_) &#123;</span><br><span class="line">            refptr_ = _Right.refptr_;</span><br><span class="line">            _Right.ptr_ = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// overload assignment operator</span></span><br><span class="line">    smartSharedPtr&amp; <span class="keyword">operator</span>=(smartSharedPtr _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        _Right.swap(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~smartSharedPtr() &#123;</span><br><span class="line">        <span class="comment">// æ¯æ¬¡ææ„æ—¶éƒ½éœ€è¦å°† ref_count å‡ä¸€</span></span><br><span class="line">        <span class="keyword">if</span> (ptr_ &amp;&amp; !refptr_-&gt;reduce()) &#123;</span><br><span class="line">            <span class="keyword">delete</span> ptr_;</span><br><span class="line">            <span class="keyword">delete</span> ref_count_;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get ref_count</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getRefCnt</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ptr_) &#123;</span><br><span class="line">            <span class="keyword">return</span> refptr_-&gt;<span class="built_in">get</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">T* <span class="title">getptr</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span> <span class="keyword">noexcept</span> &#123; <span class="keyword">return</span> *ptr_; &#125;</span><br><span class="line">    T* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span> <span class="keyword">noexcept</span> &#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123; <span class="keyword">return</span> ptr_; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(smartSharedPtr&amp; _New)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="built_in">std</span>::swap;</span><br><span class="line">        swap(ptr_, _New.ptr_);</span><br><span class="line">        swap(refptr_, _New.refptr_);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T* ptr_;</span><br><span class="line">    ref_count* refptr_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(smartSharedPtr&lt;T&gt;&amp; _Left, smartSharedPtr&lt;T&gt;&amp; _Right)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    _Left.swap(_Right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>
<p>ä¸ºäº†è®©ç¼–è¯‘å™¨ä¼˜åŒ–ä»£ç ï¼Œéœ€è¦ä¸ºç§»åŠ¨æ„é€ å‡½æ•°æ·»åŠ  <code>noexcept</code> å£°æ˜</p>
</li>
<li>
<p><code>refptr_</code> ä¸ºæ¯ä¸ªç±»çš„ç§æœ‰æˆå‘˜ï¼Œæ˜¯ä¸èƒ½åœ¨ <code>smartSharedPtr</code> å¯¹è±¡ä¹‹é—´å…±äº«çš„ï¼Œéœ€è¦æ·»åŠ å‹å…ƒç±»çš„å£°æ˜</p>
</li>
<li>
<p>æŒ‰ç…§ç°ä»£ C++ æ ‡å‡†éœ€è¦è®¾è®¡æ”¯æŒç§»åŠ¨çš„å¯¹è±¡ï¼Œå³å¯¹è±¡ä¸ä»…è¦æœ‰ <code>swap</code> æˆå‘˜å‡½æ•°ä¸å¦ä¸€ä¸ªå¯¹è±¡äº¤æ¢ï¼Œåœ¨å…¶æ‰€å±åç©ºé—´ä¸‹è¿˜éœ€è¦éœ€è¦æœ‰ä¸€ä¸ªå…¨å±€ <code>swap</code> å‡½æ•°æä¾›ç»™å…¶ä»–å¯¹è±¡ä½¿ç”¨</p>
</li>
<li>
<p>æ™ºèƒ½æŒ‡é’ˆè¿˜éœ€è¦å®ç°ç±»å‹è½¬æ¢çš„å‡½æ•°æ¨¡æ¿ï¼Œè¿™é‡Œç»™å‡º <code>dynamic_cast</code>ï¼Œå…¶ä»–å®ç°ä¸æ­¤ç±»ä¼¼ï¼š</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// for pointer type conversion</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> U&gt;</span><br><span class="line">smartSharedPtr(<span class="keyword">const</span> smartSharedPtr&lt;U&gt;&amp; _Right, T* ptr) &#123;</span><br><span class="line">    ptr_ = ptr;</span><br><span class="line">    <span class="keyword">if</span> (ptr_) &#123;</span><br><span class="line">        _Right.refptr_-&gt;add();</span><br><span class="line">        refptr_ = _Right.refptr_;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å–å‡º _Right çš„ ptr_ è½¬æ¢æˆ T ç±»å‹åå°† ref_count++ å¹¶åŒ…è£…è¿”å›</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt;</span><br><span class="line"><span class="function">smartSharedPtr&lt;T&gt; <span class="title">dynamic_pointer_cast</span><span class="params">(<span class="keyword">const</span> smartSharedPtr&lt;U&gt;&amp; _Right)</span> </span>&#123;</span><br><span class="line">    T* _Tmp = <span class="keyword">dynamic_cast</span>&lt;T*&gt;(_Right.getptr());</span><br><span class="line">    <span class="keyword">return</span> smartSharedPtr&lt;T&gt;(_Right, _Tmp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="weak-ptr">weak_ptr</h2>
<p><code>shared_ptr</code> é€šå¸¸è¢«ç§°ä¸ºå¼ºæ™ºèƒ½æŒ‡é’ˆï¼Œè€Œ <code>weak_ptr</code> è¢«ç§°ä¸ºå¼±æ™ºèƒ½æŒ‡é’ˆï¼Œä»‹ç» <code>weak_ptr</code> ä¹‹å‰å…ˆçœ‹ä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A () &#123;&#125;</span><br><span class="line">    ~A () &#123;&#125;</span><br><span class="line">    <span class="built_in">shared_ptr</span>&lt;B&gt; ptrb;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    B () &#123;&#125;</span><br><span class="line">    ~B () &#123;&#125;</span><br><span class="line">    <span class="built_in">shared_ptr</span>&lt;A&gt; ptra;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ref_count of A is 1</span></span><br><span class="line">    <span class="function"><span class="built_in">shared_ptr</span>&lt;A&gt; <span class="title">ptra</span><span class="params">(<span class="keyword">new</span> A())</span></span>;</span><br><span class="line">    <span class="comment">// ref_count of B is 1</span></span><br><span class="line">    <span class="function"><span class="built_in">shared_ptr</span>&lt;B&gt; <span class="title">ptrb</span><span class="params">(<span class="keyword">new</span> B())</span></span>;</span><br><span class="line">    <span class="comment">// ref_count of B is 2</span></span><br><span class="line">    ptra-&gt;ptrb = ptrb;</span><br><span class="line">    <span class="comment">// ref_count of A is 2</span></span><br><span class="line">    ptrb-&gt;ptra = ptra;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; ptra.use_count() &lt;&lt; ptrb.use_count() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>main</code> ç»“æŸæ—¶ï¼Œä¸¤ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°åˆ†åˆ«å‡åˆ° 1ï¼Œå› ä¸ºä¸ç­‰äº 0ï¼Œä¸æ»¡è¶³å¯¹è±¡çš„ç©ºé—´é‡Šæ”¾æ¡ä»¶ï¼Œæœ€ç»ˆå¯¼è‡´å†…å­˜æ³„éœ²ï¼Œè¿™ä¸ªé—®é¢˜è¢«ç§°ä¸º <code>shared_ptr</code> çš„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</p>
<p>é‚£ä¹ˆæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå½“ç„¶æ˜¯é€šè¿‡ <code>weak_ptr</code>ï¼Œ<code>weak_ptr</code> å¯¹ <code>shared_ptr</code> ç®¡ç†çš„å¯¹è±¡å­˜åœ¨éæ‹¥æœ‰æ€§å¼•ç”¨ï¼Œæ¢å¥è¯è¯´ï¼Œ<strong>å®ƒè¡¨è¾¾çš„æ˜¯ä¸€ç§ä¸´æ—¶æ‰€æœ‰æƒ - å¦‚æœæŸä¸ªå¯¹è±¡åªæœ‰å­˜åœ¨çš„æ—¶å€™æ‰éœ€è¦è¢«è®¿é—®ï¼Œè€Œä¸”éšæ—¶å¯èƒ½ä¼šè¢«åˆ é™¤å¯¼è‡´æŒ‡é’ˆå¤±æ•ˆæ—¶ï¼Œå°±ä½¿ç”¨ <code>weak_ptr</code> è·Ÿè¸ªè¯¥å¯¹è±¡</strong>ï¼Œå½“ <code>weak_ptr</code> éœ€è¦ä½¿ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œéœ€è¦å°†å…¶å‡çº§ä¸º <code>shared_ptr</code>ï¼Œå¦‚æœåŸ <code>shared_ptr</code> é”€æ¯ï¼Œè¿™ä¸ªå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåˆ™ä¼šå»¶é•¿åˆ°è¿™ä¸ªå‡çº§çš„ <code>shared_ptr</code> è¢«é”€æ¯ä¸ºæ­¢ã€‚</p>
<p><code>weak_ptr</code> çš„ç‰¹ç‚¹å¯ä»¥æ€»ç»“ä¸ºä¸‹é¢å‡ ç‚¹ï¼š</p>
<ul>
<li>
<p><code>weak_ptr</code> ä¸­æ²¡æœ‰æä¾›ä¸€èˆ¬çš„æŒ‡é’ˆæ“ä½œï¼Œå¦‚æœè¦è®¿é—®èµ„æºå¿…é¡»é€šè¿‡ <code>lock</code> å°†å…¶å‡çº§ä¸º <code>shared_ptr</code></p>
</li>
<li>
<p><strong>å®šä¹‰å¯¹è±¡çš„æ—¶å€™ä½¿ç”¨ <code>shared_ptr</code> ï¼Œå¼•ç”¨å¯¹è±¡çš„æ—¶å€™ä½¿ç”¨ <code>weak_ptr</code></strong></p>
</li>
<li>
<p><code>weak_ptr</code> ä¸ä¼šæ”¹å˜å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªè§‚å¯Ÿè€…çš„è§’è‰²</p>
</li>
</ul>
<p>ä¸Šé¢çš„ä»£ç ä½¿ç”¨ <code>weak_ptr</code> å¯ä»¥ä¿®æ”¹ä¸ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    A () &#123;&#125;</span><br><span class="line">    ~A () &#123;&#125;</span><br><span class="line">    weak_ptr&lt;B&gt; ptrb;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    B () &#123;&#125;</span><br><span class="line">    ~B () &#123;&#125;</span><br><span class="line">    weak_ptr&lt;A&gt; ptra;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ref_count of A is 1</span></span><br><span class="line">    <span class="function"><span class="built_in">shared_ptr</span>&lt;A&gt; <span class="title">ptra</span><span class="params">(<span class="keyword">new</span> A())</span></span>;</span><br><span class="line">    <span class="comment">// ref_count of B is 1</span></span><br><span class="line">    <span class="function"><span class="built_in">shared_ptr</span>&lt;B&gt; <span class="title">ptrb</span><span class="params">(<span class="keyword">new</span> B())</span></span>;</span><br><span class="line">    <span class="comment">// ref_count of B is 1</span></span><br><span class="line">    ptra-&gt;ptrb = ptrb;</span><br><span class="line">    <span class="comment">// ref_count of A is 1</span></span><br><span class="line">    ptrb-&gt;ptra = ptra;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; ptra.use_count() &lt;&lt; ptrb.use_count() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ™ºèƒ½æŒ‡é’ˆçš„ä½¿ç”¨">æ™ºèƒ½æŒ‡é’ˆçš„ä½¿ç”¨</h2>
<h3 id="Deleter">Deleter</h3>
<p><code>unique_ptr</code> çš„å£°æ˜ä¸ºï¼š<code>std::unique_ptr&lt;T, Deleter&gt;::unique_ptr</code><br>
å‰é¢å·²ç»è¯´è¿‡ï¼Œæ™ºèƒ½æŒ‡é’ˆåœ¨ææ„çš„æ—¶å€™é™¤äº† <code>delete</code> å †ä¸Šç©ºé—´ï¼Œè¿˜å¯ä»¥å…³é—­æ–‡ä»¶ã€é‡Šæ”¾åŒæ­¥é”ç­‰ï¼Œ<code>unique_ptr</code> å¯ä»¥è®©æˆ‘ä»¬è‡ªå®šä¹‰æŒ‡é’ˆé‡Šæ”¾èµ„æºçš„æ–¹å¼ï¼Œæ–¹æ³•æ˜¯<strong>ä¼ å…¥ä¸€ä¸ªå‡½æ•°å¯¹è±¡</strong>ï¼Œæˆ‘ä»¬ç”¨ <em>lambda</em> è¡¨è¾¾å¼æ¥ç®€å•å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::unique_ptr&lt;FILE, std::function&lt;void(FILE*)&gt;&gt; openFile(fopen("config.yml", "w"), [](FILE* fp)-&gt;void&#123; fclose(fp); &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>shared_ptr</code> çš„ <code>Deleter</code> çš„ä½¿ç”¨æ–¹æ³•ä¸ <code>unique_ptr</code> ç¨æœ‰ä¸åŒï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> &#123;</span></span><br><span class="line">    foo() &#123;&#125;</span><br><span class="line">    ~foo() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">deleter</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(func* fp)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">delete</span> fp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;foo&gt; <span class="title">sp</span><span class="params">(<span class="keyword">new</span> foo, deleter())</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¤šçº¿ç¨‹åœºæ™¯ä¸‹çš„æ™ºèƒ½æŒ‡é’ˆ">å¤šçº¿ç¨‹åœºæ™¯ä¸‹çš„æ™ºèƒ½æŒ‡é’ˆ</h3>
<p>å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœä¸ç”¨è€ƒè™‘è¿™äº›çº¿ç¨‹åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸‹çš„è°ƒåº¦å’Œäº¤æ›¿æ‰§è¡Œï¼Œä¹Ÿä¸éœ€è¦è¿›è¡Œé¢å¤–çš„åŒæ­¥ï¼Œæˆ–è€…åœ¨è°ƒç”¨æ–¹è¿›è¡Œä»»ä½•å…¶ä»–æ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºéƒ½å¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p><code>shared_ptr/weak_ptr</code> çš„çº¿ç¨‹å®‰å…¨å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†è®¨è®ºï¼š</p>
<ul>
<li>
<p><code>shared_ptr/weak_ptr</code> ç®¡ç†çš„å¯¹è±¡æ˜¯å¦æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
</li>
<li>
<p><code>shared_ptr/weak_ptr</code> å¯¹è±¡æœ¬èº«æ˜¯å¦æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
</li>
</ul>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œ<code>shared_ptr/weak_ptr</code> èƒ½å¤Ÿå®ç°å¤šçº¿ç¨‹ä¸‹å…¶ç®¡ç†çš„å¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹ä¸‹ï¼Œä¸€ä¸ªå¸¸è§çš„é”™è¯¯æ˜¯å½“ä¸€ä¸ªçº¿ç¨‹å·²ç»å°†å †ä¸Šçš„å¯¹è±¡ææ„äº†ï¼Œæ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹å»è®¿é—®å·²ç»ææ„äº†çš„å¯¹è±¡ï¼Œäº§ç”Ÿæœªå®šä¹‰è¡Œä¸ºã€‚</p>
<p><em>muduo</em> ç½‘ç»œåº“ä¸­çš„ <em>Observable</em> ç±»ç»™å‡ºäº†ä¸€ä¸ªè§£å†³æ–¹æ³•ï¼šé€šè¿‡ <code>weak_ptr</code> æ¢æŸ¥å¯¹è±¡çš„ç”Ÿæ­»ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observable</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">register_</span><span class="params">(<span class="keyword">const</span> weak_ptr&lt;Observer&gt; x)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">notifyObservers</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> MutexLock mutex_;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;weak_ptr&lt;Observer&gt;&gt; observers_;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;weak_ptr&lt;Observer&gt;&gt;::iterator Iterator;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Observable::notifyObservers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">MutexLockGuard <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">    Iterator it = observers_.<span class="built_in">begin</span>();</span><br><span class="line">    <span class="keyword">while</span> (it != observers_.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="comment">// éå† vector ä¾æ¬¡å°è¯• promote weak_ptr</span></span><br><span class="line">        <span class="comment">// lock æ˜¯çº¿ç¨‹å®‰å…¨çš„</span></span><br><span class="line">        <span class="function"><span class="built_in">shared_ptr</span>&lt;Observer&gt; <span class="title">obj</span><span class="params">(it-&gt;lock())</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">            obj-&gt;update();</span><br><span class="line">            ++it;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// promote å¤±è´¥è¯´æ˜å¯¹è±¡å·²ç»é”€æ¯ï¼Œä» vector ä¸­åˆ é™¤ weak_ptr</span></span><br><span class="line">            it = observers_.erase(it);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œ<code>shared_ptr</code> æœ¬èº«å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒçš„å¼•ç”¨è®¡æ•°æ˜¯å®‰å…¨æ— é”çš„ï¼Œä½†æ˜¯å¯¹è±¡çš„è¯»å†™ä¸æ˜¯ï¼Œå› ä¸º <code>shared_ptr</code> æœ‰ä¸¤ä¸ªæ•°æ®æˆå‘˜ï¼Œè¯»å†™æ“ä½œä¸èƒ½åŸå­åŒ–ã€‚</p>
<p>å¦‚æœè¦é€šè¿‡å¤šä¸ªçº¿ç¨‹è¯»å†™åŒä¸€ä¸ª <code>shared_ptr</code> å¯¹è±¡ï¼Œéœ€è¦åŠ é”ã€‚<br>
ç»§ç»­çœ‹ä¸€ä¸ª <em>muduo</em> ç½‘ç»œåº“ä¸­çš„ä¾‹å­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">shared_ptr</span>&lt;foo&gt; localPtr;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">MutexLockGuard <span class="title">lock</span><span class="params">(mutex)</span></span>;</span><br><span class="line">        localPtr = globalPtr;</span><br><span class="line">    &#125;</span><br><span class="line">    doit(localPtr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="built_in">shared_ptr</span>&lt;foo&gt; <span class="title">newPtr</span><span class="params">(<span class="keyword">new</span> foo)</span></span>;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">MutexLockGuard <span class="title">lock</span><span class="params">(mutex)</span></span>;</span><br><span class="line">        globalPtr = newPtr;</span><br><span class="line">    &#125;</span><br><span class="line">    doit(newPtr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒæ–‡çŒ®ï¼š</p>
<p><a href="https://book.douban.com/subject/20471211/" target="_blank" rel="noopener">Linux å¤šçº¿ç¨‹æœåŠ¡ç«¯ç¼–ç¨‹</a><br>
<a href="https://book.douban.com/subject/25923597/" target="_blank" rel="noopener">Effective Modern C++</a><br>
<a href="https://en.cppreference.com/w/Main_Page" target="_blank" rel="noopener">cppreference</a></p>
]]></content>
      <categories>
        <category>C/C++</category>
      </categories>
      <tags>
        <tag>C/C++</tag>
        <tag>Smart-Pointer</tag>
        <tag>RAII</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨ç®€å•çš„é€»è¾‘æ–¹æ³•è¿›è¡Œç‹¬ç«‹æ€è€ƒã€è½¬ã€‘</title>
    <url>/posts/8cfab1d1/</url>
    <content><![CDATA[<blockquote>
<ul>
<li>å¯è€ƒè¯çš„æ•°æ®å¾ˆé‡è¦å¾ˆé‡è¦å¾ˆé‡è¦</li>
<li>ç†è§£é›†åˆçš„åŒ…å«ä¸è¢«åŒ…å«ï¼Œä»¥å°è§å¤§å¾€å¾€ä¸å…·æœ‰ç§‘å­¦æ€§ä¸¥è°¨æ€§</li>
<li>è°¨æ…é¢ å€’å› æœå…³ç³»çš„äº‹æƒ…ä¸æ··æ·†æ— å…³äº‹æƒ…ä¹‹é—´çš„å› æœå…³ç³»</li>
<li>åšäº‹è¦æ‰¾åˆ°é è°±çš„åŸºå‡†çº¿</li>
<li>æ€è€ƒè¦æ·±å…¥ï¼Œè¦é«˜ç»´</li>
</ul>
</blockquote>
<a id="more"></a>
<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„ä¸–ç•Œï¼Œè¿™ä¸ªä¸–ç•Œä¸Šæœ‰å¾ˆå¤šå„å¼å„æ ·çš„è§‚ç‚¹å’Œæ€ç»´æ–¹å¼ï¼Œä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜çš„æˆ‘ï¼Œä¹Ÿä¼šæœ‰ç¨‹åºå‘˜çš„æ€ç»´æ–¹å¼ï¼Œç¨‹åºå‘˜çš„æ€ç»´æ–¹å¼æ›´æ¥è¿‘æ•°å­¦çš„æ€ç»´æ–¹å¼ï¼Œæ•°å­¦çš„æ€ç»´æ–¹å¼è®©å¯ä»¥å¾ˆå®¹æ˜“åœ°ç†æ¸…æ¥šè¿™ä¸ªæ··ä¹±çš„ä¸–ç•Œï¼Œå…¶å®ï¼Œå¹¶ä¸éœ€è¦å¤ªå¤æ‚çš„æ•°å­¦é€»è¾‘ï¼Œåªéœ€è¦ä½¿ç”¨ä¸€äº›ç®€å•çš„æ•°å­¦æ–¹æ³•ï¼Œå°±å¯ä»¥å¤§å¹…æå‡è‡ªå·±çš„è®¤è¯†èƒ½åŠ›ï¼Œæ‰€ä»¥ï¼Œåœ¨è¿™é‡Œï¼Œè®°å½•ä¸€ç¯‡æˆ‘è‡ªå·±çš„æ€ç»´æ–¹å¼ï¼Œä¸€æ–¹é¢ç»™å¤§å®¶åšä¸ªå‚è€ƒï¼Œå¦ä¸€æ–¹é¢ä¹Ÿä¾›æ›´é«˜é˜¶çš„äººç»™æˆ‘è¿›è¡ŒæŒ‡æ­£ã€‚ç®—æ˜¯â€œå¼€æºæˆ‘çš„æ€ç»´æ–¹å¼â€ï¼Œå¼€æ”¾ä¸ä»…ä»…æ˜¯ä¸ºäº†è¾“å‡ºï¼Œæ›´æ˜¯ä¸ºäº†çœ‹çœ‹æœ‰æ²¡æœ‰æ›´å¥½çš„æ–¹å¼ã€‚</p>
<p>æˆ‘çš„æ€ç»´æ–¹å¼ä¸­ï¼Œä½¿ç”¨æ•°å­¦é€»è¾‘çš„æ–¹å¼è¿›è¡Œæ€è€ƒï¼Œé€šå¸¸æ¥è¯´ï¼Œæˆ‘ä¼šä½¿ç”¨äº”æ­¥æ€è€ƒçš„æ–¹å¼ï¼š</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼šä¿¡æ¯æ•°æ®å¯è€ƒè¯</strong>ã€‚å¦‚æœä¸€ä¸ªè§‚ç‚¹æˆ–æ˜¯ä¸€ä¸ªè§è§£çš„æ•°æ®æ˜¯é”™è¯¯çš„ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆåé¢çš„è§‚ç‚¹å…¨æ˜¯é”™çš„ï¼Œæ‰€ä»¥ï¼Œ<em><strong>é¦–è¦çš„æ˜¯è¦è¿›è¡Œæ•°æ®çš„æŸ¥è¯æˆ–è€ƒè¯</strong></em>ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¦‚æœä¸€ç¯‡æ–‡ç« çš„ä½œè€…è¶³å¤Ÿä¸¥è°¨çš„è¯ï¼Œä»–çš„éœ€è¦ç»™ä»–çš„æ•°æ®å»ºç«‹ç›¸å…³çš„å¼•ç”¨æˆ–æ˜¯å¯ä»¥è€ƒè¯çš„æ–¹æ³•æ–¹å¼ã€‚å¦‚æœä¸€ç¯‡æ–‡ç« ä¸­å‡ºç°çš„æ˜¯ï¼Œâ€œæœ‰å…³ä¸“å®¶è¡¨æ˜â€ã€â€œç¾å›½ç§‘å­¦å®¶è¯æ˜â€ã€â€œç»æµå­¦å®¶æŒ‡å‡ºâ€ï¼Œä½†æ˜¯æ²¡æœ‰ä»»å‡ºå¤„ï¼Œä¹Ÿæ²¡æœ‰ç‚¹æ˜è¿™ä¸ªä¸“å®¶æˆ–æ˜¯ç§‘å­¦å®¶çš„åå­—ï¼Œæˆ–æ˜¯ï¼Œä¹Ÿæ²¡æœ‰è¯´æ˜æˆ–å¼•ç”¨è®©è¯»è€…å¯ä»¥è‡ªå·±å»éªŒè¯çš„æ–¹æ³•ã€‚é‚£ä¹ˆï¼Œå…¶å¼•ç”¨çš„è¯æˆ–æ˜¯æ•°æ®æ˜¯æ— æ³•è€ƒè¯çš„ï¼Œå¦‚æœæ˜¯æ— æ³•è€ƒè¯çš„ï¼Œé‚£ä¹ˆï¼Œè¿™ç¯‡æ–‡ç« çš„æ°´ä»½å°±éå¸¸å¤§äº†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå½“æˆ‘è¯»åˆ°ä¸€ç¯‡æ–‡ç« ä¸­çš„ä¸œè¥¿æ²¡æœ‰å¯è€ƒè¯çš„æ¥æºæˆ–æ˜¯æ–¹æ³•æ—¶ï¼Œé€šå¸¸æ¥è¯´ï¼Œæˆ‘å°±ä¸ä¼šå†è¯»äº†ï¼Œå› ä¸ºè¿™ç¯‡æ–‡ç« çš„ä»·å€¼å·²ç»ä¸å¤§äº†ï¼Œå¦‚æœæˆ‘å…³å¿ƒè¿™ç¯‡æ–‡ç« ä¸­çš„ä¸œè¥¿ï¼Œæˆ‘ä¼šæ”¹ä¸ºè‡ªå·±å»æŸ¥æ‰¾çš„æ–¹å¼ï¼Œè™½ç„¶å˜â€œé‡â€äº†ï¼Œä½†æ˜¯å¾ˆå®‰å…¨ã€‚ï¼ˆæ‰€ä»¥ï¼Œåƒ Wikipedia è¿™æ ·çš„ç½‘ç«™æ˜¯æˆ‘ç»å¸¸å»è·å¾—ä¿¡æ¯çš„åœ°æ–¹ï¼Œå› ä¸ºä¿¡æ¯å¯ä»¥è¢«è€ƒè¯æ˜¯å…¶åŸºæœ¬ä»·å€¼è§‚ï¼‰</p>
<p><strong>ç¬¬äºŒæ­¥ï¼šå¤„ç†é›†åˆå’Œå…¶åŒ…å«å…³ç³»</strong>ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„äººäººéƒ½ä¼šçš„æ•°å­¦é€»è¾‘ã€‚æ¯”å¦‚ï¼šå“²å­¦å®¶æ˜¯äººï¼ŒæŸæ‹‰å›¾æ˜¯å“²å­¦å®¶ï¼Œæ‰€ä»¥ï¼ŒæŸæ‹‰å›¾æ˜¯äººã€‚å°±æ˜¯ä¸€ä¸ªåœ¨åŒ…å«å…³ç³»ä¸‹çš„æ¨ç†ã€‚ä½ ä¸è¦å°çœ‹è¿™ä¸ªç®€å•çš„é€»è¾‘ï¼Œå…¶å®å¾ˆå¤šäººå¹¶ä¸ä¼šå¾ˆå¥½çš„åº”ç”¨ï¼Œç›¸åï¼Œ<em><strong>å½“æ„Ÿæƒ…æ”¯é…äº†ä»–ä»¬ä»¥åï¼Œä»–ä»¬ä¼šä»¥ç‚¹ä»£é¢ï¼Œä»¥ç‰¹ä¾‹ä»£æ›¿æ™®éæ€§</strong></em>ã€‚æ¯”å¦‚ï¼Œåœ°å›¾ç‚®å°±æ˜¯ä¸€ç§ï¼Œä»–ä»¬çœ‹åˆ°äº†å¤šä¸ªæ¡ˆä¾‹ï¼Œä»–ä»¬å°±å¼€å§‹æŠŠè¿™ä¸ªæ¡ˆä¾‹ä¸Šå‡ä¸Šæ›´å¤§çš„èŒƒå›´ï¼Œæ¯”å¦‚ï¼šæ²³å—äººæ–°ç–†äººéƒ½æ˜¯å°å·ï¼Œä¸Šæµ·äººéƒ½æ˜¯å°å¸‚æ°‘ã€‚æ—¥æœ¬äººéƒ½æ˜¯å˜æ€å’Œåäººç±»â€¦â€¦ç­‰ç­‰ã€‚é™¤äº†è¿™äº›åœ°å›¾ç‚®å¤–ï¼Œè¿˜æœ‰å¦å®šæ•´ä¸ªäººçš„ï¼Œæ¯”å¦‚ä¸€ä¸ªäººçŠ¯äº†ä¸ªé”™æˆ–æ˜¯æ€§æ ¼ä¸Šæœ‰ç¼ºé™·ï¼Œå°±ä¼šæŠŠæ•´ä¸ªäººå…¨ç›˜å¦å®šæ‰ï¼Œå‘˜å·¥æŠ¢ä¸ªæœˆé¥¼å°±ä¸Šå‡åˆ°å…¶ä»·å€¼è§‚æœ‰é—®é¢˜â€¦â€¦ã€‚åœ¨æ•°å­¦çš„é€»è¾‘åŒ…å«ä¸­ï¼Œ<em><strong>è¶…é›†çš„å®šä¹‰å¯ä»¥é€‚ç”¨äºå­é›†ï¼Œé€šè¿‡å­é›†çš„ç‰¹å¾å¯ä»¥å¯¹è¶…é›†è¿›è¡Œæ¢ç´¢ï¼Œä½†æ˜¯æ²¡æ³•å®šä¹‰è¶…é›†</strong></em>ã€‚å¦å¤–ï¼Œé›†åˆçš„å¤§å°ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„äº‹ï¼Œå¹¸å­˜è€…åå·®ä¼šæ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“è®©äººæ‰ä¸‹å»çš„é™·é˜±ï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰å¾ˆå¤§çš„æ ·æœ¬é›†å¯èƒ½åœ¨ä½ çš„è§†çº¿ç›²åŒºã€‚</p>
<p><strong>ç¬¬ä¸‰æ­¥ï¼šå¤„ç†é€»è¾‘å› æœå…³ç³»</strong>ã€‚æ‰€è°“å› æœå…³ç³»ï¼Œå…¶å®å°±æ˜¯åˆ†è¾¨å……åˆ†æ¡ä»¶ã€å¿…è¦æ¡ä»¶å’Œå……åˆ†å¿…è¦æ¡ä»¶ï¼Œç„¶åå¤„ç†å…¶ä¸­çš„é€»è¾‘æ˜¯å¦æœ‰å…³è”æ€§ï¼Œè€Œä¸”æœ‰éå¸¸å¼ºçš„å› æœå…³ç³»ã€‚æ²¡æœ‰èƒ½åŠ›åˆ†è¾¨å……åˆ†å¿…è¦æ¡ä»¶å¤„ç†å› æœå…³ç³»æ˜¯å¾ˆå¤šäººçš„ç¡¬ä¼¤ã€‚å°±åƒæˆ‘åœ¨ã€Š<a href="https://coolshell.cn/articles/19271.html" target="_blank" rel="noopener">åŠªåŠ›å°±ä¼šæˆåŠŸ</a>ã€‹ä¸­è¯´çš„ä¸€æ ·ï¼Œâ€œåŠªåŠ›â€ å’Œ â€œæˆåŠŸâ€æ˜¯å¦æœ‰å› æœå…³ç³»ï¼Ÿå„ç§é€»è¾‘æ··æ·†ã€æ¦‚å¿µå·æ¢ã€æ¨¡ç³Šå› æœã€ä¼¼æ˜¯è€Œéå…¨æ˜¯åœ¨è¿™é‡Œã€‚æ¯”å¦‚ï¼šæ©è€³ç›—é“ƒã€åˆ»èˆŸæ±‚å‰‘å°±æ˜¯å› æœå…³ç³»æ··ä¹±çš„è¡¨ç°ã€‚<em><strong>äººä»¬ä¼šç»å¸¸åœ°æ··æ·†ä¸¤ä¸ªçœ‹æ¥ä¸€èµ·å‘ç”Ÿï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å…³è”åœ¨ä¸€èµ·çš„äº‹</strong></em>ã€‚å› æœå…³ç³»æ˜¯æœ€å®¹æ˜“è¢«æ¨¡ç³Šå’Œå·æ¢çš„ï¼Œæ¯”å¦‚ï¼šå¾ˆå¤šäººéƒ½å®¹æ˜“æ··æ·†â€œåŠ ç­â€å°±ä¼šæœ‰â€œäº§å‡ºâ€ï¼Œæ··æ·†äº†â€œè¡ŒåŠ¨â€å°±ä¼šæœ‰â€œç»“æœâ€ï¼Œæ··æ·†äº†â€œæŠµåˆ¶â€å°±ä¼šèµ¢å¾—â€œå°Šé‡â€ï¼Œæ··æ·†äº†â€œæ‰¹è¯„â€ç­‰äºâ€œåå¯¹â€â€¦â€¦ç­‰ç­‰ã€‚é™¤äº†è¿™äº›ä»¥å¤–ï¼Œå¾®ä¿¡å…¬ä¼—å·é‡Œçš„å¾ˆå¤šæ—¶è¯„æ–‡ç« ï¼Œä»–ä»¬çš„æ–‡ç« ä¸­çš„ç»“è®ºå’Œå…¶è®ºæ®æ˜¯æ²¡æœ‰å› æœå…³ç³»çš„ï¼Œå¥½å¤šæ–‡ç« å°±æ˜¯æ··æ·†ã€æ¨¡ç³Šã€å·æ¢â€¦â€¦<em><strong>å› æœå…³ç³»å‡ºé—®é¢˜çš„æ–‡ç« è¯»å¤šäº†æ˜¯å¯¹å¤§è„‘æœ‰æŸä¼¤çš„ï¼Œè¦å°½é‡è¿œç¦»</strong></em>ã€‚</p>
<p><strong>ç¬¬å››æ­¥ï¼šæ‰¾åˆ°é è°±çš„åŸºå‡†çº¿</strong>ã€‚å°±åƒæˆ‘ä»¬å†™ä»£ç ä¸€æ ·ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä¼šå»æ‰¾ä¸€äº›æœ€ä½³å®è·µæˆ–æ˜¯ä¸šå†…æ ‡å‡†ï¼ŒåŸå› æ˜¯å› ä¸ºï¼Œè¿™æ ·çš„ä¸œè¥¿éƒ½æ˜¯ç»è¿‡é•¿æ—¶é—´è¢«è¿™ä¸ªä¸–ç•Œä¸Šå¾ˆå¤šäººReviewè¿‡çš„ï¼Œæ˜¯å€¼å¾—ä¾èµ–å’Œé è°±çš„ï¼Œä»–ä»¬ä¼šè€ƒè™‘åˆ°å¾ˆå¤šä½ æ²¡æœ‰è€ƒè™‘è¿‡çš„é—®é¢˜ã€‚æ‰€ä»¥ï¼Œä½ ä¹Ÿä¼šçœ‹åˆ°å¾ˆå¤šæ—¶è¯„éƒ½ä¼šæ‰¾æ¬§ç¾å‘è¾¾å›½å®¶çš„ä½œå‚è€ƒçš„åšæ³•ï¼Œå› ä¸ºæ¯•ç«Ÿäººå®¶çš„æ–‡åŒ–æ˜¯ç›¸å¯¹æ¯”è¾ƒæ–‡æ˜ã€ç§‘å­¦ã€å¼€æ”¾å’Œå…ˆè¿›çš„ã€‚æ‰¾åˆ°ä¸–ç•Œæˆ–æ˜¯å›½é™…çš„é€šè¡Œæ ‡å‡†ï¼Œä¼šæ›´å®¹æ˜“è®©äººè¿›æ­¥ã€‚æ¯”å¦‚ï¼š<em><strong>ä»¥å¼€æ”¾åŒ…å®¹åŠ å¼ºæ²Ÿé€šçš„å¿ƒæ€ï¼Œå°±ä¼šæ¯”å°é—­æŠµåˆ¶æ•Œå¯¹çš„å¿ƒæ€è¦å¥½å¾—å¤šå¾—å¤šï¼Œæ™ºè€…å»ºæ¡¥ï¼Œæ„šè€…å»ºå¢™</strong></em>ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¼€å§‹å‘ç°ï¼Œæœ‰ä¸€äº›äº‹ä¸Šï¼Œæœ‰åˆ©äºè‡ªå·±çš„å°±å¯¹æ ‡ï¼Œä¸åˆ©äºè‡ªå·±çš„å°±ä¸å¯¹æ ‡ï¼Œè€Œä¸”ï¼Œé™¤äº†å¥½çš„äº‹ï¼Œä¸å¥½çš„äº‹ä¹Ÿåœ¨æ‰¾æ¬§ç¾ä½œå¯¹æ ‡ï¼Œäºæ˜¯å¼€å§‹â€œå¤šåŸºå‡†çº¿â€å’Œâ€œä¹±åŸºå‡†çº¿â€ï¼Œè¿™ç§æ–¹å¼éœ€è¦æˆ‘ä»¬å°å¿ƒåˆ†è¾¨ã€‚</p>
<p><strong>ç¬¬äº”æ­¥ï¼šæ›´ä¸ºæ·±å…¥å’Œé«˜ç»´çš„æ€è€ƒ</strong>ã€‚å¦‚æœä¸€ä»¶äº‹æƒ…åªåœ¨è¡¨é¢ä¸Šè¿›è¡Œæ€è€ƒå…¶å®åªæ˜¯ä¸€ç§æµ…åº¦æ€è€ƒï¼Œåœ¨ Amazonï¼Œçº¿ä¸Šç³»ç»Ÿå‡ºç°æ•…éšœçš„æ—¶å€™ï¼Œéœ€è¦å†™ä¸€ä¸ª Correction of Errors çš„æŠ¥å‘Šï¼Œå…¶ä¸­éœ€è¦ Ask 5 Whysï¼ˆå‚çœ‹ Wikipedia çš„ Five Whys è¯æ¡ï¼‰ï¼Œè¿™ç§æ€è€ƒæ–¹å¼å¯ä»¥è®©ä½ ä¸æ–­è¿½é—®åˆ°æ·±å±‚æ¬¡çš„æœ¬è´¨é—®é¢˜ï¼Œä¼šè®©ä½ è‡ªå·±åšå¤§é‡çš„è°ƒæŸ¥å’Œç ”ç©¶ï¼Œè®©ä½ ä¸ä¼šæˆä¸ºä¸€ä¸ªåªä¼šåœ¨è¡¨é¢ä¸Šè¿›è¡Œæ€è€ƒçš„ç®€å•åŠ¨ç‰©ã€‚æ¯”å¦‚ï¼šå½“ä½ çœ‹åˆ°æœ‰å‡ºä¹ä½ æ„æ–™çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼ˆæ¯”å¦‚è´Ÿé¢çš„æš´åŠ›äº‹ä»¶ï¼‰ï¼Œä½ éœ€è¦é—®ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆä¼šå‘ç”Ÿï¼ŒåŸå› æ˜¯ä»€ä¹ˆï¼Ÿç„¶åç½—åˆ—å°½å¯èƒ½å…¨çš„åŸå› ï¼Œå†ä¸æ–­åœ°è¿½é—®å¹¶æ‹·è¯ä¸‹å»ï¼ˆè¿™è·Ÿå†™ç¨‹åºä¸€æ ·ï¼Œéœ€è¦ä»æ­£å‘æ¡ˆä¾‹å’Œè´Ÿå‘æ¡ˆä¾‹è¿›è¡Œè€ƒè™‘åˆ†æï¼Œæ‰å¯èƒ½å†™å‡ºå¥å£®æ€§å¾ˆå¼ºçš„ä»£ç ï¼‰ï¼Œæˆ‘ä»¬æ‰ä¼šå¾—å‡ºä¸€ä¸ªæ¯”è¾ƒå¥å£®çš„ç­”æ¡ˆæˆ–ç»“æ„ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸Šè¿°çš„è¿™äº”ç§æ€ç»´æ–¹å¼ä¸‹ï¼Œä½ çš„æ€è€ƒæ˜¯ä¸å¯èƒ½å¿«å¾—èµ·æ¥çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªâ€œæ…¢æ€è€ƒâ€ï¼ˆæ³¨ï¼šå¦‚æœè¯»è¿‡ã€Š<a href="https://book.douban.com/subject/10785583//" target="_blank" rel="noopener">æ€è€ƒï¼Œå¿«ä¸æ…¢</a>ã€‹è¿™æœ¬ä¹¦çš„äººå°±çŸ¥é“æˆ‘åœ¨è¯´ä»€ä¹ˆï¼‰ï¼Œ<em><strong>ç‹¬ç«‹æ€è€ƒæ˜¯éœ€è¦ä½¿ç”¨å¤§è„‘ä¸­çš„â€œæ…¢ç³»ç»Ÿâ€ï¼Œæ…¢ç³»ç»Ÿæ˜¯åäººæ€§çš„ï¼Œæ‰€ä»¥ï¼Œèƒ½çœŸæ­£åšåˆ°ç‹¬ç«‹æ€è€ƒçš„äººå¾ˆå°‘</strong></em>ã€‚æ›´å¤šçš„äººçš„â€œç‹¬ç«‹æ€è€ƒâ€å…¶å®åªä¸è¿‡æ˜¯æ¯«æ— ç« æ³•çš„ä¹±æ€è€ƒç½¢äº†ã€‚</p>
<p>é€šè¿‡ä¸Šè¿°çš„è¿™äº”ç‚¹ï¼Œæˆ‘ç›¸ä¿¡ä½ æ˜¯å¾ˆå®¹æ˜“è¯†åˆ«æˆ–æ˜¯åˆ†è¾¨å‡ºå“ªäº›ä¿¡æ¯æ˜¯é è°±çš„ï¼Œå“ªäº›ä¿¡æ¯æ˜¯å¾ˆæ‰¯çš„ï¼Œç”šè‡³ä¼šæ”¹å–„ä½ è‡ªå·±çš„è¨€è®ºå’Œæ€è€ƒã€‚ä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œè¿™äº›æ–¹æ³•å¹¶ä¸èƒ½è®©ä½ è·å¾—çœŸç†æˆ–æ˜¯çœŸç›¸ã€‚ä½†æ˜¯è¿™ä¹Ÿå¤Ÿäº†ï¼Œä¸€ä¸ªäººå¦‚æœæ‹¥æœ‰äº†èƒ½å¤Ÿåˆ†è¾¨æ˜¯éçš„èƒ½åŠ›ï¼Œä¹Ÿæ˜¯å¾ˆä¸é”™çš„äº†ã€‚è™½ç„¶ä¸çŸ¥é“äº‹å®æ˜¯ä»€ä¹ˆï¼Œä½†æ˜¯ä½ ä¹Ÿä¸ä¼šç›²ä»å’Œåä¿¡ï¼Œä»è€Œä¸ä¼šè¢«äººç…½åŠ¨ï¼Œè€Œæˆä¸ºå¹•åé»‘æ‰‹çš„çš„ä¸€åªâ€œè‚‰é¸¡â€ã€‚</p>
<p>å¤šè¯´ä¸¤å¥ï¼Œä¸‹é¢æ˜¯ä¸€äº›æˆ‘ä¸ªäººçš„ä¸€äº›å®è·µï¼š</p>
<p>å½“æ–°é—»æŠ¥é“æŠ¥é“çš„ä¸æ˜¯å®¢è§‚äº‹å®ï¼Œè€Œæ˜¯åŠ å…¥äº†å¾ˆå¤šè§‚ç‚¹ï¼Œé‚£ä¹ˆè¿™ç¯‡æ–°é—»æŠ¥é“æ˜¯ä¸å¯ä¿¡çš„ã€‚<br>
å¯¹äºè¯„è®ºæ€§çš„æ–‡ç« ï¼Œæ²¡æœ‰å……è¶³æƒå¨å¯ä¿¡çš„è®ºæ®æ—¶ï¼Œä¸èƒ½å®Œå…¨ç›¸ä¿¡ã€‚<br>
ä¸æ˜¯å½“äº‹äººï¼Œä¸æ˜¯è§è¯äººï¼Œè¿˜è¦è£…ä½œè‡ªå·±æ˜¯çŸ¥æƒ…çš„â€¦â€¦ä¸çŸ¥é“è¿™ç§äººçš„è‡ªä¿¡æ€ä¹ˆæ¥çš„ï¼Ÿ<br>
ä¿¡æ¯ä¸å…¬å¼€çš„ï¼Œå¹¶æœ‰æ„å±è”½ä¿¡æ¯çš„ï¼Œä¸èƒ½ä½œä¸ºå¯ä¿¡çš„ä¿¡æ¯æºã€‚<br>
å½“å‡ºç°å¤§æ˜¯æˆ–æ˜¯å¤§éçš„äº‹æ—¶ï¼Œä¸€å®šè¦éå¸¸å°å¿ƒï¼Œè¿™ä¸ªä¸–ç•Œä¸å­˜åœ¨å®Œå…¨çš„ç¾å’Œå®Œå…¨çš„ä¸‘ï¼Œè¿™æ ·çš„è§‚ç‚¹é€šå¸¸æ¥è¯´éƒ½æ˜¯å±é™©çš„ï¼Œæ­¤æ—¶è¦å¤šçœ‹çœ‹ä¸åŒè§’åº¦çš„æŠ¥é“å’Œè¯„è®ºï¼Œè¦å¤šæ”¶é›†ä¸€äº›ä¿¡æ¯ï¼Œè¿˜è¦å¤šé—®é—®ä¸ºä»€ä¹ˆã€‚<br>
æ¬¢è¿ä½ å‘Šè¯‰æˆ‘ä¸€äº›ä½ çš„å®è·µå’Œæ€ç»´æ–¹å¼ã€‚</p>
<p>è½¬è½½è‡ªé™ˆçš“ CoolShell åšå®¢<br>
åŸæ–‡é“¾æ¥ï¼š<a href="https://coolshell.cn/articles/20533.html" target="_blank" rel="noopener">ä½¿ç”¨ç®€å•çš„é€»è¾‘æ–¹æ³•è¿›è¡Œç‹¬ç«‹æ€è€ƒ</a></p>
]]></content>
      <categories>
        <category>Perception</category>
      </categories>
      <tags>
        <tag>Perception</tag>
      </tags>
  </entry>
</search>
